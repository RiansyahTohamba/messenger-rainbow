Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(e){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,n=Object(this),r=n.length>>>0,i=arguments[1],a=0;a<r;a++)if(t=n[a],e.call(i,t,a,n))return t}}),String.prototype.splice||(String.prototype.splice=function(e,t,n){"use strict";return this.slice(0,e)+n+this.slice(e+Math.abs(t))}),String.prototype.repeat||(String.prototype.repeat=function(e){"use strict";if(null===this)throw new TypeError("can't convert "+this+" to object");var t=String(this),n=Number(e);if(n!==e&&(e=0),n<0)throw new RangeError("repeat count must be non-negative");if(n===1/0)throw new RangeError("repeat count must be less than infinity");if(n=Math.floor(n),0===t.length||0===n)return"";if(t.length*n>=1<<28)throw new RangeError("repeat count must not overflow maximum string size");for(var r="";1==(1&n)&&(r+=t),0!==(n>>>=1);)t+=t;return r});var compareUnorderedArray=function(e,t){if(e.length!==t.length)return!1;var n={};return e.forEach(function(e){n[e]=++n[e]||1}),t.every(function(e){return n[e]--})},anonymizePhoneNumber=function(e){if(null===e||void 0===e)return null;if(config&&config.debug)return e;var t="";return 0===e.indexOf("+")&&(t="+"),t=e.length>4?t+"*".repeat(e.length-4-t.length)+e.slice(e.length-4):e},sortObjectByProperty=function(e){return function(t,n){return t[e]<n[e]?-1:t[e]>n[e]?1:0}},minFirefoxWebRTCVersion=38,minChromeWebRTCVersion=42,minEdgeWebRTCVersion=25;function serializeAllPromises(e,t){return 0===e?Promise.resolve():t[e-=1].then(function(){serializeAllPromises(e,t)}).catch(function(n){serializeAllPromises(e,t)})}function RBError(e,t){this.name="RainbowError",this.message=e,this.details=t,this.stack=(new Error).stack}RBError.prototype=Object.create(Error.prototype),RBError.prototype.constructor=RBError;var version="1.37.6";window.sdkversion="1.37.0",window.app=angular.module("rainbow",["angular-jwt"]),window.rainbowAdmin=angular.module("rainbowAdmin",[]),window.rainbow=angular.module("rainbow",["rainbowAdmin"]),angular.module("rainbow").factory("Company",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,u,d,f,h,p,v,m,g,E,S,C,b,R,y,N,T,A,I,O,D,w,_,P,M,U,F,L,k){this.id=e,this.name=t||"",this.companyContactId=n,this.adminEmail=r||"",this.supportEmail=i||"",this.status=a||"active",this.economicActivityClassification=o||"NONE",this.website=s,this.description=c,this.size=g,this.slogan=E,this.visibility=l||"private",this.visibleBy=u||[],this.organisationId=d||"",this.userSelfRegisterEnabled=f||!1,this.userSelfRegisterAllowedDomains=h||[],this.country=v,this.state=m||("USA"===v?"ALABAMA":null),this.isBP=S||!1,C&&(this.bpType=C),b&&(this.bpBusinessModel=b),b&&(this.bpApplicantNumber=R),y&&(this.bpCRDid=y),N&&(this.bpHasRightToSell=N),this.bpHasRightToConnect=A,this.bpId=T,this.offerType=p||"freemium",this.externalReference=D,this.externalReference2=w,this.logo=null,this.lastAvatarUpdateDate=null,this.lastBannerUpdateDate=null,this.adminHasRightToUpdateSubscriptions=I||!1,this.adminAllowedUpdateSubscriptionsOps=O||"all",this.avatarShape=_||"circle",this.catalogId=P,this.office365Tenant=M,null!==U&&void 0!==U&&(this.isCentrex=U),F&&(this.tenantCallNumber=F),L&&(this.tenantName=L),k&&(this.numberUsers=k),this.updateFromData=function(e){this.id=e.id,this.name=e.name?e.name:"",this.companyContactId=e.companyContactId,this.adminEmail=e.adminEmail?e.adminEmail:"",this.supportEmail=e.supportEmail?e.supportEmail:"",this.status=e.status?e.status:"active",this.visibility=e.visibility?e.visibility:"private",this.visibleBy=e.visibleBy?e.visibleBy:[],this.organisationId=e.organisationId?e.organisationId:"",this.userSelfRegisterEnabled=!!e.userSelfRegisterEnabled&&e.userSelfRegisterEnabled,this.userSelfRegisterAllowedDomains=e.userSelfRegisterAllowedDomains?e.userSelfRegisterAllowedDomains:[],this.country=e.country,this.state=e.state,this.offerType=e.offerType?e.offerType:"freemium",this.website=e.website?e.website:"",this.description=e.description?e.description:"",this.size=e.size,this.economicActivityClassification=e.economicActivityClassification?e.economicActivityClassification:"NONE",this.slogan=e.slogan?e.slogan:"",this.isBP=!!e.isBP&&e.isBP,this.bpId=e.bpId,this.lastAvatarUpdateDate=e.lastAvatarUpdateDate,this.lastBannerUpdateDate=e.lastBannerUpdateDate,e.avatarShape&&(this.avatarShape=e.avatarShape),e.bpType&&(this.bpType=e.bpType),e.bpBusinessModel&&(this.bpBusinessModel=e.bpBusinessModel),e.bpApplicantNumber&&(this.bpApplicantNumber=e.bpApplicantNumber),e.bpCRDid&&(this.bpCRDid=e.bpCRDid),e.catalogId&&(this.catalogId=e.catalogId),e.office365Tenant&&(this.office365Tenant=e.office365Tenant),null!==e.isCentrex&&void 0!==e.isCentrex&&(this.isCentrex=e.isCentrex),e.tenantCallNumber&&(this.tenantCallNumber=e.tenantCallNumber),e.tenantName&&(this.tenantName=e.tenantName),this.bpHasRightToSell&&!e.bpHasRightToSell||(this.bpHasRightToSell=!!e.bpHasRightToSell&&e.bpHasRightToSell),this.bpHasRightToConnect&&!e.bpHasRightToConnect||(this.bpHasRightToConnect=!!e.bpHasRightToConnect&&e.bpHasRightToConnect),this.adminHasRightToUpdateSubscriptions&&!e.adminHasRightToUpdateSubscriptions||(this.adminHasRightToUpdateSubscriptions=!!e.adminHasRightToUpdateSubscriptions&&e.adminHasRightToUpdateSubscriptions),this.adminAllowedUpdateSubscriptionsOps&&!e.adminAllowedUpdateSubscriptionsOps||(this.adminAllowedUpdateSubscriptionsOps=e.adminAllowedUpdateSubscriptionsOps?e.adminAllowedUpdateSubscriptionsOps:"all"),e.externalReference&&(this.externalReference=e.externalReference),e.externalReference2&&(this.externalReference2=e.externalReference2)},this.isActive=function(){return"active"===this.status},this.isInitializing=function(){return"initializing"===this.status},this.isInvited=function(){return"invited"===this.status},this.isFreemium=function(){return"freemium"===this.offerType},this.isPremium=function(){return"premium"===this.offerType}}return e.createFromData=function(t){var n=new e(t.id,t.name,t.companyContactId,t.adminEmail,t.supportEmail,t.status,t.economicActivityClassification,t.website,t.description,t.visibility,t.visibleBy,t.organisationId,t.userSelfRegisterEnabled,t.userSelfRegisterAllowedDomains,t.offerType,t.country,t.state,t.size,t.slogan,t.isBP,t.bpType,t.bpBusinessModel,t.bpApplicantNumber,t.bpCRDid,t.bpHasRightToSell,t.bpId,t.bpHasRightToConnect,t.adminHasRightToUpdateSubscriptions,t.adminAllowedUpdateSubscriptionsOps,t.externalReference,t.externalReference2,t.avatarShape,t.catalogId,t.office365Tenant,t.isCentrex,t.tenantCallNumber,t.tenantName,t.numberUsers);return n.filterName=n.name.toLowerCase(),n.lastAvatarUpdateDate=t.lastAvatarUpdateDate,n.lastBannerUpdateDate=t.lastBannerUpdateDate,n.avatarShape=t.avatarShape?t.avatarShape:"circle",n},e.create=function(t,n){var r=new e(t,n);return r.filterName=r.name.toLowerCase(),r},e.prune=function(e,t){var n=Object.assign({},e);return n.isBP||(delete n.bpType,delete n.bpBusinessModel,delete n.bpApplicantNumber,delete n.bpCRDid,delete n.bpHasRightToSell,delete n.bpHasRightToConnect,delete n.bpIsContractAccepted),t&&(t.isSuperadmin()||t.isBPAdminFinance())||(delete n.bpType,delete n.adminHasRightToUpdateSubscriptions,delete n.adminAllowedUpdateSubscriptionsOps),""===n.economicActivityClassification&&delete n.economicActivityClassification,n},e.StatusValues=["initializing","active","alerting","hold","terminated"],e.VisibilityValues=["private","organization","public"],e.SizeValues=["self-employed","1-10 employees","11-50 employees","51-200 employees","201-500 employees","501-1000 employees","1001-5000 employees","5001-10,000 employees","10,001+ employees"],e.OfferTypes=["freemium","premium"],e.BPTypes=["VAD","DR","IR"],e.BPTypeLabels={IR:"Indirect Reseller",VAD:"Value Added Distributor",DR:"Direct Reseller"},e.BPBusinessModels=["resell"],e.BPBusinessModelLabels={resell:"Resell",referral:"Referral"},e.adminAllowedUpdateSubscriptionsOperations=["all","increase_only"],e.EconomicActivityClassificationTypes={NONE:"notDefined-f",A:"agriculture",B:"mining",C:"manufacturing",D:"electricity",E:"water supply",F:"construction",G:"wholesale",H:"transportation",I:"accommodation",J:"information and communication",K:"financial",L:"real estate activities",M:"professional",N:"administrative",O:"public administration",P:"education",Q:"human health",R:"arts",S:"other service activities",T:"activities of households as employer",U:"activities of extraterritorial organisations and bodies"},e}]),angular.module("rainbow").filter("companyOfferFilter",[function(){"use strict";return function(e){return"freemium"===e?"Freemium":"premium"===e?"Premium":e?e.charAt(0).toUpperCase()+e.slice(1).toLowerCase():e}}]),angular.module("rainbow").factory("CompanyInvitation",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,u,d,f,h){this.id=e,this.companyId=t,this.companyName=n,this.invitedUserId=r,this.invitedUserEmail=i,this.invitingAdminId=a,this.invitingAdminLoginEmail=o,this.invitationDate=s,this.lastNotificationDate=c,this.requestedNotificationLanguage=l,this.status=u,this.acceptationDate=d,this.declinationDate=f,this.invitedToBeCompanyAdmin=h}return e.createFromData=function(t){return new e(t.id,t.companyId,t.companyName,t.invitedUserId,t.invitedUserEmail,t.invitingAdminId,t.invitingAdminLoginEmail,t.invitationDate,t.lastNotificationDate,t.requestedNotificationLanguage,t.status,t.acceptationDate,t.declinationDate,t.invitedToBeCompanyAdmin)},e}]);var FileState=function(){function e(){}return e.DELETED="deleted",e.UPLOADING="uploading",e.UPLOADED="uploaded",e.NOT_UPLOADED="not_uploaded",e.DOWNLOADING="downloading",e.UNKNOWN="unknown",e}(),ThumbnailPlaceholder=function(){return function(e,t){this.icon=e,this.style=t}}(),Thumbnail=function(){function e(e){e?(this.availableThumbnail=e.availableThumbnail,this.md5sum=e.md5sum,this.size=e.size,this.wantThumbnailDate=e.wantThumbnailDate):this.availableThumbnail=!1}return e.prototype.isThumbnailAvailable=function(){return this.availableThumbnail},e}(),FileDescriptor=function(){function e(e,t,n,r,i,a,o,s,c,l,u,d,f,h){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),void 0===r&&(r=null),void 0===i&&(i=null),void 0===a&&(a=null),void 0===o&&(o=null),void 0===s&&(s=null),void 0===c&&(c=null),void 0===l&&(l=null),void 0===u&&(u=null),void 0===d&&(d=null),void 0===f&&(f=null),this.id=e,this.url=t,this.ownerId=n,this.fileName=r,this.extension=i,this.typeMIME=a,this.thumbnailPlaceholder=this.getThumbnailPlaceholderFromMimetype(a),this.size=o,this.registrationDate=s,this.uploadedDate=c,this.dateToSort=l,this.viewers=u,this.state=d,this.thumbnail=new Thumbnail(f),this.fileToSend=void 0,this.previewBlob=void 0,this.orientation=h||void 0}return e.prototype.isMicrosoftFile=function(){var e=this;return["docx","doc","ppt","pptx","xls","xlsx"].some(function(t){return t===e.extension})},e.prototype.isPDF=function(){return"application/pdf"===this.typeMIME},e.prototype.isImage=function(){return this.typeMIME&&this.typeMIME.length>="image/".length&&"image/"===this.typeMIME.slice(0,"image/".length)},e.prototype.isAudioVideo=function(){var e=this;return["avi","mpg","wma","mp3","wmv","mkv","mov","wav","ogg","mp4","aac"].some(function(t){return t===e.extension})},e.prototype.isUploaded=function(){return this.state&&this.state===FileState.UPLOADED},e.prototype.isAlreadyFileViewer=function(e){return!(!this.ownerId||this.ownerId!==e)||!!this.viewers&&this.viewers.some(function(t){return t.viewerId===e})},e.prototype.getDisplayName=function(){return this.fileName.replace(/\.[^/.]+$/,"")},e.prototype.getDisplayNameTruncated=function(){var e=this.fileName.replace(/\.[^/.]+$/,"");return[e.substring(0,e.length-4),e.slice(-4)]},e.prototype.getExtension=function(){return this.fileName.toUpperCase()===this.extension.toUpperCase()?"":"."+this.extension},e.prototype.getThumbnailPlaceholderFromMimetype=function(e){return e?0===e.indexOf("image")?new ThumbnailPlaceholder("icon_image","imageStyle"):"application/msword"===e||/^application\/vnd.openxmlformats-officedocument.wordprocessingml.*$/.test(e)||"application/vnd.oasis.opendocument.text"===e?new ThumbnailPlaceholder("icon_doc","docStyle"):/^application\/vnd.ms-powerpoint.*$/.test(e)||/^application\/vnd.openxmlformats-officedocument.presentationml.*$/.test(e)||"application/vnd.oasis.opendocument.presentation"===e?new ThumbnailPlaceholder("icon_ppt","pptStyle"):0===e.indexOf("application/vnd.ms-excel")||/^application\/vnd.openxmlformats-officedocument.spreadsheetml.*$/.test(e)?new ThumbnailPlaceholder("icon_xls","xlsStyle"):"application/pdf"===e||"application/vnd.oasis.opendocument.spreadsheet"===e?new ThumbnailPlaceholder("icon_pdf","pdfStyle"):0===e.indexOf("video/")||0===e.indexOf("audio/")?new ThumbnailPlaceholder("icon_file-video","imageStyle"):new ThumbnailPlaceholder("icon_filestandard","otherStyle"):new ThumbnailPlaceholder("icon_filestandard","otherStyle")},e}();function FileDescriptorFactory(){return function(e,t,n,r,i,a,o,s,c,l,u,d,f,h){return new FileDescriptor(e,t,n,r,i,a,o,s,c,l,u,d,f,h)}}angular.module("rainbow").factory("fileDescriptorFactory",[FileDescriptorFactory]);var FileViewerType=function(){function e(){}return e.USER="user",e.ROOM="room",e}(),FileViewer=function(){function e(e,t,n,r){void 0===r&&(r=null),this.contactService=r,this.viewerId=e,this.type=t,this.contact=n}return Object.defineProperty(e.prototype,"avatarSrc",{get:function(){var e=this;return this.contact?this._avatarSrc=this.contact.avatar.src:(this._avatarSrc=null,this.contactService.getContactByDBId(this.viewerId).then(function(t){e.contact=t,e._avatarSrc=e.contact.avatar.src})),this._avatarSrc},enumerable:!0,configurable:!0}),e}();function FileViewerFactory(){return function(e){for(var t=[],n=0,r=e;n<r.length;n++){var i=r[n];t.push(new FileViewer(i.viewerId,i.type,i.contact,i.contactService))}return t}}function FileViewerElementFactory(){return function(e,t,n,r){return new FileViewer(e,t,n,r)}}angular.module("rainbow").factory("fileViewerFactory",[FileViewerFactory]),angular.module("rainbow").factory("fileViewerElementFactory",[FileViewerElementFactory]),angular.module("rainbow").factory("CompanyRequest",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,u){this.id=e,this.requestingUserId=t,this.requestingUserLoginEmail=n,this.requestedCompanyId=r,this.requestedCompanyName=i,this.status=a,this.requestingDate=o,this.requestedNotificationLanguage=s,this.lastNotificationDate=c,this.requestedToCompanyAdmin=l,this.requestedCompanyInvitationId=u}return e.createFromData=function(t){return new e(t.id,t.requestingUserId,t.requestingUserLoginEmail,t.requestedCompanyId,t.requestedCompanyName,t.status,t.requestingDate,t.requestedNotificationLanguage,t.lastNotificationDate,t.requestedToCompanyAdmin,t.requestedCompanyInvitationId)},e}]),angular.module("rainbow").factory("CompanyBpLinkInvitation",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,u,d,f,h,p){this.id=e,this.invitedCompanyId=t,this.invitedCompanyName=n,this.invitedToBeBpIr=r,this.invitingAdminId=i,this.invitingAdminLoginEmail=a,this.invitingCompanyId=o,this.invitingCompanyName=s,this.invitationDate=c,this.lastNotificationDate=l,this.requestedNotificationLanguage=u,this.status=d,this.acceptationDate=f,this.cancelationDate=h,this.declinationDate=p}return e.createFromData=function(t){return new e(t.id,t.invitedCompanyId,t.invitedCompanyName,t.invitedToBeBpIr,t.invitingAdminId,t.invitingAdminLoginEmail,t.invitingCompanyId,t.invitingCompanyName,t.invitationDate,t.lastNotificationDate,t.requestedNotificationLanguage,t.status,t.acceptationDate,t.cancelationDate,t.declinationDate)},e}]),angular.module("rainbow").factory("CompanyBpLinkRequest",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,u,d,f,h,p){this.id=e,this.requestingAdminId=t,this.requestingAdminLoginEmail=n,this.requestingCompanyId=r,this.requestingCompanyName=i,this.requestedCompanyId=a,this.requestedCompanyName=o,this.requestedToBeBpIr=s,this.requestDate=c,this.lastNotificationDate=l,this.requestedNotificationLanguage=u,this.status=d,this.acceptationDate=f,this.cancelationDate=h,this.declinationDate=p}return e.createFromData=function(t){return new e(t.id,t.requestingAdminId,t.requestingAdminLoginEmail,t.requestingCompanyId,t.requestingCompanyName,t.requestedCompanyId,t.requestedCompanyName,t.requestedToBeBpIr,t.requestDate,t.lastNotificationDate,t.requestedNotificationLanguage,t.status,t.acceptationDate,t.cancelationDate,t.declinationDate)},e}]),angular.module("rainbow").factory("Conference",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,u,d,f,h){this.companyId=e,this.id=t,this.mediaType=n,this.name=r,this.phoneNumbers=i||[],this.passCodes=a||[],this.scheduled=o,this.scheduledDuration=s,this.scheduledEndDate=c,this.scheduledStartDate=l,this.lastUpdateDate=u,this.scheduledTimezone=d,this.userId=f,this.confDialOutDisabled=h,this.updateFromData=function(e){this.companyId=e.companyId,this.id=e.id,this.mediaType=e.mediaType,this.name=e.name,this.phoneNumbers=e.phoneNumbers,this.passCodes=e.passCodes,this.scheduled=e.scheduled,this.scheduledDuration=e.scheduledDuration,this.scheduledEndDate=e.scheduledEndDate,this.scheduledStartDate=e.scheduledStartDate,this.lastUpdateDate=e.lastUpdateDate,this.scheduledTimezone=e.scheduledTimezone,this.userId=e.userId,this.confDialOutDisabled=e.confDialOutDisabled}}return e.createFromData=function(t){return new e(t.companyId,t.id,t.mediaType,t.name,t.phoneNumbers,t.passCodes,t.scheduled,t.scheduledDuration,t.scheduledEndDate,t.scheduledStartDate,t.lastUpdateDate,t.scheduledTimezone,t.userId,t.confDialOutDisabled)},e}]),angular.module("rainbow").factory("ConferenceSession",["$log","ConferenceParticipant","contactService",function(e,t,n){"use strict";function r(r,i,a,o){var s=this;s.id=r,s.participants=i,s.active=a,s.talkerActive=void 0,s.recordingStarted=void 0,s.talkers=void 0,s.isLeaderAlreadyConnected=!1,s.status=null,s.localStreams=[],s.sessions={},s.publishers=[],s.type=o,s.callId=null,s.updateFromData=function(e,t,n){s.id=e,s.participants=t,s.active=n},s.updateActiveState=function(e){s.active=e},s.updateStateFromData=function(e,t,n){s.active=e,s.talkerActive=t,s.recordingStarted=n},s.updateParticipants=function(n){n&&(s.participants||(s.participants=[]),n.forEach(function(n){if(n.participantId){e.debug("[conferenceSession] updateParticipants participantId="+n.participantId);var r=s.getParticipantById(n.participantId);r?(e.debug("[conferenceSession] updateParticipants update participantId="+n.participantId),r.updateFromData(n)):(e.debug("[conferenceSession] updateParticipants create participantId="+n.participantId),s.participants.push(t.createFromData(n)))}}))},s.removeParticipants=function(t){t&&t.forEach(function(t){var n=s.getParticipantIndexById(t);-1!==n&&(e.debug("[conferenceSession] removeParticipants remove participantId="+t),s.participants.splice(n,1))})},s.removePublisher=function(t){if(t){var n=s.getPublisherIndexById(t);-1!==n&&(e.debug("[conferenceSession] removePublisher remove participantId="+t),s.publishers.splice(n,1))}},s.updateTalkers=function(t){e.debug("[conferenceSession] updateTalkers talkers="+t),s.talkers=t},s.isActive=function(){return void 0!==s.active&&s.active},s.isTalkerActive=function(){return void 0!==s.talkerActive&&s.talkerActive},s.isRecordingStarted=function(){return void 0!==s.recordingStarted&&s.recordingStarted},s.getParticipants=function(){return s.participants},s.getConnectedParticipants=function(){return s.participants?s.participants.filter(function(e){return"disconnected"!==e.state}):void 0},s.getConnectedParticipantsExceptLeader=function(){return s.participants?s.participants.filter(function(e){return"disconnected"!==e.state&&"moderator"!==e.role}):void 0},s.getConnectedParticipantsExcept=function(e){return s.participants?s.participants.filter(function(t){return t.jid_im!==e&&"disconnected"!==t.state}):void 0},s.getLeaderParticipant=function(){return s.participants?s.participants.find(function(e){return"moderator"===e.role&&"disconnected"!==e.state}):void 0},s.getParticipantById=function(e){return s.participants?s.participants.find(function(t){return t.participantId===e}):void 0},s.getParticipantByJid=function(e){return s.participants?s.participants.find(function(t){return t.jid_im===e}):void 0},s.getParticipantIndexById=function(e){return s.participants?s.participants.findIndex(function(t){return t.participantId===e}):-1},s.getPublisherIndexById=function(e){return s.publishers?s.publishers.findIndex(function(t){return t.participantId===e}):-1},s.isParticipantConnectedByJid=function(e){return void 0!==s.participants&&s.participants.some(function(t){return t.jid_im===e&&"connected"===t.state})},s.isParticipantRingingByJid=function(e){return void 0!==s.participants&&s.participants.some(function(t){return t.jid_im===e&&"ringing"===t.state})},s.getTalkers=function(){return s.talkers},s.setCallId=function(e){s.callId=e},s.getListOfRemoteVideoPublishers=function(){var e=[];if(s.publishers)for(var t=0;t<s.publishers.length;t++)"video"===s.publishers[t].mediaType&&s.publishers[t].jid_im!==n.userContact.jid&&e.push(s.publishers[t]);return e}}return r.createFromData=function(e,t,n,i){return i||(i="pstnAudio"),new r(e,t,n,i)},r}]),angular.module("rainbow").factory("ConferenceParticipant",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,u){this.participantId=e,this.userId=t,this.jid_im=n,this.jid_tel=r,this.role=i,this.mute=a,this.held=o,this.confStartDate=s,this.startDate=c,this.phoneNumber=l,this.state=u,this.updateFromData=function(e){e.userId&&(this.userId=e.userId),this.jid_im=e.jid_im,e.jid_tel&&(this.jid_tel=e.jid_tel),this.role=e.participantRole,this.mute=e.mute,this.held=e.held,this.confStartDate=e.confStartDate,this.startDate=e.startDate,this.phoneNumber=e.phoneNumber,this.state=e.participantState}}return e.createFromData=function(t){return new e(t.participantId,t.userId,t.jid_im,t.jid_tel,t.participantRole,t.mute,t.held,t.confStartDate,t.startDate,t.phoneNumber,t.participantState)},e}]);var ConferenceUser=function(){return function(e,t,n,r,i,a,o,s,c){this.id=e,this.providerUserId=t,this.providerCompanyId=n,this.confCompanyId=r,this.userId=i,this.companyId=a,this.firstName=o,this.lastName=s,this.providerType=c}}();function ConferenceUserFactory(){return function(e){return new ConferenceUser(e.id,e.providerUserId,e.providerCompanyId,e.confCompanyId,e.userId,e.companyId,e.firstName,e.lastName,e.providerType)}}angular.module("rainbow").factory("conferenceUserFactory",ConferenceUserFactory);var Channel=function(){function e(e,t,n,r,i,a,o,s){this.lastMessage=null,this.name=e,this.id=t,this.visibility=n,this.topic=r,this.creatorId=i,this.companyId=a,this.creationDate=o,Array.isArray(s)?this.users_count=s.length:this.users_count=s}return e.prototype.attachLastmessage=function(e){this.lastMessage=e},e.ChannelFactory=function(){return function(t){return new e(t.name,t.id,t.visibility,t.topic,t.creatorId,t.companyId,t.creationDate,t.users_count)}},e}();angular.module("rainbow").factory("Channel",Channel.ChannelFactory),angular.module("rainbow").factory("Contact",["$q","$rootScope","$interval","$document","$translate","settingsService","Company","$log","randomString","xmppService",function(e,t,n,r,i,a,o,s,c,l){"use strict";function u(e,n,r){var i=this;this.id=e,this.jid=e,this.fullJid=null,this.jidtel=null,this.dbId=null,this.login=null,this.temp=!1,this.status="unknown",this.telStatus="",this.imStatus="offline",this.imStatusStamp=[],this.resources={},this.loginEmail="",this.lastname="",this.firstname="",this.company=r,this.nickname="",this.title="",this.jobTitle="",this.country="",this.timezone="",this.roles=null,this.confId="",this.phonePro="",this.phoneProCan="",this.phonePbx="",this.phoneInternalNumber="",this.pbxId="",this.mobilePro="",this.mobileProCan="",this.phonePerso="",this.phonePersoCan="",this.mobilePerso="",this.mobilePersoCan="",this.emailPro="",this.emailPerso="",this.oldImStatus=null,this.roster=!1,this.initialized=!1,this._displayName=n||e,this.name={value:this._displayName},this.initials="",this.message="",this.cellStyle="",this.ask="none",this.subscription="none",this.conversation=null,this.adminType=null,this.capabilities=null,this.groups=null,this.mobileResource=null,this.language=null,this.lastActivityDate=null,this.nameUpdatePrio=u.NameUpdatePrio.MAX_UPDATE_PRIO,this.isInDefaultCompany=!1,this.calendarState={},this.guest=!1,t.$on("$destroy",t.$on("ON_DISPLAY_ORDER_EVENT",function(){i.computeDisplayName()}))}return u.create=function(e,t,n,r,i){var a=new u(e,null,r);return t&&n&&(t=t.charAt(0).toUpperCase()+t.slice(1),n=n.charAt(0).toUpperCase()+n.slice(1),a.computeCompleteDisplayName(t,n)),a.login=i,a},u.createByPhoneNumber=function(e){var t=new u(null,e);return t.id=e,t},u.createBotContact=function(e,t,n){var r=new u(e),i=new Image;return i.src="/resources/skins/rainbow/images/emily.jpg",r.lastname=t,r.isBot=!0,r.computeDisplayName(),r.status="online",r.imStatus="online",r.subscription="both",r.avatar=i,r.dbId=n,r},u.updateContactToBot=function(e,t,n){var r=new Image;return r.src="/resources/skins/rainbow/images/emily.jpg",e.lastname=t,e.isBot=!0,e.computeDisplayName(),e.status="online",e.imStatus="online",e.subscription="both",e.avatar=r,e.dbId=n,e},u.AdminType={ORGANIZATION_ADMIN:"organization_admin",COMPANY_ADMIN:"company_admin",SITE_ADMIN:"site_admin",UNDEFINED:"undefined"},u.NameUpdatePrio={NO_UPDATE_PRIO:0,OUTLOOK_UPDATE_PRIO:1,SERVER_UPDATE_PRIO:2,MAX_UPDATE_PRIO:99},Object.defineProperty(u.prototype,"displayName",{set:function(e){this._displayName=e,this.name.value=e,this.displayNameMD5=MD5.hexdigest(e)},get:function(){return this._displayName}}),Object.defineProperty(u.prototype,"lastActivityDate",{set:function(e){this._lastActivityDate=e,this.updateLastActivityMessage()},get:function(){return this._lastActivityDate}}),Object.defineProperty(u.prototype,"statusMessage",{get:function(){if((this._currentStatus!==this.status||this._currentLastActivityMessage!==this.lastActivityMessage||this._currentMessage!==this.message)&&(this._currentStatus=this.status,this._currentMessage=this.message,this._currentLastActivityMessage=this.lastActivityMessage,"unknown"===this.status?this._statusMessage=this.company&&this.company.name?this.company.name:i.instant("unknown"):this._statusMessage=i.instant(this.status,{offlineDate:this.lastActivityMessage}),this.message)){var e=i.instant(this.message);"("!==e.charAt(0)&&(e="("+e+")"),this._statusMessage+=" "+e}return this._statusMessage}}),Object.defineProperty(u.prototype,"lastActivityMessage",{get:function(){var e=this;if(!e._lastActivityMessage&&!e._lastActivityInProgress){e._lastActivityInProgress=!0;try{l.connection.lastactivity.query(e.jid,{onResponse:function(t){var n=1e3*$(t).find("query").attr("seconds"),r=(new Date).getTime()-n;e.lastActivityDate=new Date(r),e._lastActivityInProgress=!1}})}catch(t){s.error("[Contact] lastActivityDate getter accessor for contact "+e.jid_im+" -- failure : "+t),e._lastActivityInProgress=!1}return null}return this._lastActivityMessage}}),u.prototype.updateLastActivityMessage=function(){if(this._lastActivityDate){var e=moment(this._lastActivityDate);moment.locale().startsWith("de")?this._lastActivityMessage=e.fromNow(!0).replace("Tage","Tagen"):this._lastActivityMessage=e.fromNow(!0)}else this._lastActivityMessage=""},u.prototype.getLastAvailableDate=function(){var e=null,t=this.imStatusStamp;return Object.keys(t).forEach(function(n){var r=t[n];e?e<r&&(e=r):e=r}),e},u.prototype.updateCalendarPresenceInfo=function(){var e=this.calendarState,t=null;e.iconId=null;var n=null;e.autoReplyOn?(e.iconId="icon_outofoffice",t={meetingDate:e.autoReplyInfos.until,message:e.autoReplyInfos.message},n=e.autoReplyInfos.until?e.autoReplyInfos.untilDate?"calendarAutoReply-date":"calendarAutoReply":"calendarAutoReplySimple"):("busy"===e.message?(e.iconId="icon_inameeting",n=e.untilDate?"calendar-busy-date":"calendar-busy"):"out_of_office"===e.message&&(n=e.untilDate?"calendar-outofoffice-date":"calendar-outofoffice"),t={meetingDate:e.until}),n&&(e.tooltip=i.instant(n,t))},u.prototype.displayNameForLog=function(){return config&&config.debug?this.displayName:this.displayNameMD5},u.prototype.isMobileResource=function(e){return-1!==e.indexOf("mobile_android")||-1!==e.indexOf("mobile_ios")},u.prototype.calculateStatusFromResources=function(e){var t="offline",n="",r="",i="",a=this.fullJid,o=!1,s=config.webrtcWithMobiles;for(var c in this.resources)if(this.resources.hasOwnProperty(c)){if("dnd"===this.resources[c].show&&"phone"===this.resources[c].status){t="busy",n="phoneMsg",o=!0,a=c;break}if("xa"===this.resources[c].show||"dnd"===this.resources[c].show&&""===this.resources[c].status){var l=!1;this.resources[c].initStamp?r?this.resources[c].initStamp.getTime()>r.getTime()&&(r=this.resources[c].initStamp,l=!0):(r=this.resources[c].initStamp,l=!0):i?this.resources[c].stamp.getTime()>i.getTime()&&(i=this.resources[c].stamp,r=this.resources[c].stamp,l=!0):(i=this.resources[c].stamp,r=this.resources[c].stamp,l=!0),l&&(t=this.resources[c].show,n=this.resources[c].status)}else if("xa"!==t&&("dnd"!==t||"dnd"===t&&""!==n)&&"dnd"===this.resources[c].show&&""!==this.resources[c].status)"presentation"===this.resources[c].status?(t=this.resources[c].show,n="presentation"):(t="busy",n=this.resources[c].status),a=c,o=!0;else{if(e&&"online"===this.resources[c].show&&"mode=auto"===this.resources[c].status&&c===this.fullJid){t="online",n="",this.resources[c].status="",this.isMobileResource(c)?t="online-mobile":o=!0;break}"online"===this.resources[c].show&&"xa"!==t&&"dnd"!==t&&"busy"!==t?(n="","online-mobile"!==t&&(t="online"),this.resources[c].status="",this.isMobileResource(c)?t="online-mobile":(a=c,o=!0),s&&(a=c)):"away"===this.resources[c].show&&"offline"===t&&(t="away",n="",a=c)}"mode=auto"===this.resources[c].status&&(this.resources[c].status="")}for(var c in this.resources)this.resources.hasOwnProperty(c)&&"mode=auto"===this.resources[c].status&&(this.resources[c].status="");return e||this.fullJid||(this.fullJid=a),"online-mobile"===t&&o?(t="online",n=""):"online-mobile"!==t||e||s||(this.fullJid=null,n=""),{presence:t,message:n}},u.prototype.hasAdminRights=function(){return this.isSuperadmin()||this.isAdmin()||this.isBPAdmin()},u.prototype.isSuperadmin=function(){return this.roles.indexOf("superadmin")>=0},u.prototype.isAdmin=function(){return this.roles.indexOf("admin")>=0&&(!this.isOrganizationAdmin()||!this.isBPAdmin())},u.prototype.isOrganizationAdmin=function(){return this.roles.indexOf("admin")>=0&&this.adminType===u.AdminType.ORGANIZATION_ADMIN},u.prototype.isCompanyAdmin=function(){return this.roles.indexOf("admin")>=0&&this.adminType===u.AdminType.COMPANY_ADMIN},u.prototype.isSiteAdmin=function(){return this.roles.indexOf("admin")>=0&&this.adminType===u.AdminType.SITE_ADMIN},u.prototype.getAdminType=function(){return this.roles.indexOf("admin")>=0?this.adminType:u.AdminType.UNDEFINED},u.prototype.isBPAdmin=function(){return this.isBPAdminOperations()||this.isBPAdminFinance()},u.prototype.isBPAdminOperations=function(){return this.roles.indexOf("bp_admin")>=0},u.prototype.isBPAdminFinance=function(){return this.roles.indexOf("bp_finance")>=0},u.prototype.updateIMStatus=function(e,n){if(this.imStatusStamp[e.jid]&&this.imStatusStamp[e.jid]>e.stamp)s.info("[Contact] Ignore obsolete presence message for contact "+this.jid);else{s.info("[Contact] updateIMStatus "+JSON.stringify(e)),this.imStatusStamp[e.jid]=e.stamp,e.status&&(this.imStatus=e.status);var r=e.message?e.message:"";if("offline"===this.imStatus)this.fullJid===e.jid&&(this.fullJid=null),delete this.resources[e.jid],delete this.imStatusStamp[e.jid],0===this.resources.length&&(this.message="");else{this.resources[e.jid]?(this.resources[e.jid].show=this.imStatus,this.resources[e.jid].status=r,this.resources[e.jid].stamp=e.stamp):this.resources[e.jid]={show:this.imStatus,status:r,initStamp:e.stamp,stamp:e.stamp},s.info("[Contact] updateIMStatus user resources after update "+JSON.stringify(this.resources)),this.isMobileResource(e.jid)||n||(this.fullJid=e.jid);var i=config.webrtcWithMobiles;!n&&i&&(this.fullJid=e.jid)}if(this.updateRichStatus(n),n&&this.isMobileResource(e.jid)&&("offline"!==e.status&&null===this.mobileResource&&(this.mobileResource=e.jid,s.info("[telephonyService] === STARTED ==="),t.$broadcast("ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT","started")),"offline"===e.status)){var a=null;for(var o in this.resources)if(this.resources.hasOwnProperty(o)&&this.isMobileResource(o)){a=o;break}this.mobileResource=a,null===this.mobileResource&&t.$broadcast("ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT","stopped")}}},u.prototype.updateTelephonyStatus=function(e,t){this.telStatus=e,this.updateRichStatus(t)},u.prototype.updatePresenceStatus=function(e){this.status=e},u.prototype.updateRichStatus=function(e){if("EVT_SERVICE_INITIATED"===this.telStatus||"EVT_ESTABLISHED"===this.telStatus)this.status="busy",this.message="audioPhone";else if("subscribe"===this.ask)this.status="wait";else if("none"===this.subscription||"from"===this.subscription)this.status="unknown";else{var n=this.calculateStatusFromResources(e);"xa"===n.presence&&(""!==n.message||e?"away"===n.message&&(n.presence="away",n.message=""):n.presence="offline"),this.status=n.presence,this.message=n.message,e?s.info("[Contact] updateRichStatus MY PRESENCE : "+n.presence+" || message : "+n.message):s.info("[Contact] updateRichStatus presence : "+n.presence+" || message : "+n.message),"offline"!==this.status&&(this.lastActivityDate=null)}e&&t.$broadcast("ON_UPDATE_MYCONTACT_EVENT")},u.prototype.updateFromUserData=function(e){this.dbId=e.id,this.loginEmail=e.loginEmail,this.firstname=e.firstName,this.lastname=e.lastName,this.nickname=e.nickName?e.nickName:"",this.title=e.title?e.title:"",this.jobTitle=e.jobTitle?e.jobTitle:"",this.organisationId=e.organisationId,this.siteId=e.siteId,this.country=e.country?e.country:"FRA",this.timezone=e.timezone,this.roles=e.roles,this.adminType=e.adminType,this.isBot=!1,this.isTerminated=e.isTerminated,this.isInDefaultCompany=e.isInDefaultCompany,this.lastAvatarUpdateDate=e.lastAvatarUpdateDate,this.initialized=e.isInitialized,e.jid_im&&(this.id=e.jid_im,this.jid=e.jid_im,this.jidtel=e.jid_tel),this.company&&this.company.id===e.companyId||(this.company=o.create(e.companyId,e.companyName)),this.phonePro=this.phoneProCan="",this.phonePbx="",this.phoneInternalNumber="",this.pbxId="",this.mobilePro=this.mobileProCan="",this.phonePerso=this.phonePersoCan="",this.mobilePerso=this.mobilePersoCan="",this.voicemailNumber="",this.hasPhoneNumber=!1;var t=this;e.emails&&(t.emailPerso="",e.emails.forEach(function(e){switch(e.type){case"work":t.emailPro=e.email;break;case"home":t.emailPerso=e.email}})),e.phoneNumbers&&e.phoneNumbers.forEach(function(e){var n=e.number,r=e.numberE164,i=e.deviceType;switch(t.hasPhoneNumber=!0,e.type){case"work":"landline"===i&&(t.phonePro=n,t.phoneProCan=r,e.isFromSystem&&(t.phonePbx=e.shortNumber,e.internalNumber&&(t.phoneInternalNumber=e.internalNumber),t.pbxId=e.pbxId,t.voicemailNumber=e.voiceMailNumber)),"mobile"===i&&(t.mobilePro=n,t.mobileProCan=r);break;case"home":"landline"===i&&(t.phonePerso=n,t.phonePersoCan=r),"mobile"===i&&(t.mobilePerso=n,t.mobilePersoCan=r)}}),this.computeDisplayName()},u.prototype.updateName=function(e,t){this.firstname=e,this.lastname=t,this.computeDisplayName()},u.prototype.getNameUpdatePrio=function(){return this.nameUpdatePrio},u.prototype.setNameUpdatePrio=function(e){switch(e){case u.NameUpdatePrio.NO_UPDATE_PRIO:case u.NameUpdatePrio.OUTLOOK_UPDATE_PRIO:case u.NameUpdatePrio.SERVER_UPDATE_PRIO:case u.NameUpdatePrio.MAX_UPDATE_PRIO:this.nameUpdatePrio=e}},u.prototype.containsEmail=function(e){var t=e.toLowerCase();return!(!this.loginEmail||this.loginEmail.toLowerCase()!==t)||(!(!this.emailPro||this.emailPro.toLowerCase()!==t)||!(!this.emailPerso||this.emailPerso.toLowerCase()!==t))},u.prototype.computeDisplayName=function(){var e=this.firstname?this.firstname.charAt(0).toUpperCase()+this.firstname.slice(1):null,t=this.lastname?this.lastname.charAt(0).toUpperCase()+this.lastname.slice(1):null,n=this.nickname?this.nickname.charAt(0).toUpperCase()+this.nickname.slice(1):null;t&&e?this.computeCompleteDisplayName(e,t):t&&!e?(this.displayName=t,this.initials=t.charAt(0)):n?(this.displayName=n,this.initials=n.charAt(0)):this.loginEmail?(this.displayName=this.loginEmail,this.initials=this.loginEmail.substring(0,2).toUpperCase()):(this.displayName="Anonymous",this.initials="A")},u.prototype.computeCompleteDisplayName=function(e,t){var n="",r="";1!==t.length&&2!==e.length?"firstLast"===a.getSetting("displayOrder")?(n=e+" "+t,r=e.charAt(0)+t.charAt(0)):(n=t+" "+e,r=t.charAt(0)+e.charAt(0)):(n="firstLast"===a.getSetting("displayOrder")?e+" "+t:t+" "+e,r=e.charAt(0)+e.charAt(1)),this.displayName=n,this.initials=r;for(var i=this.displayName.toUpperCase(),o=0,s=0;s<i.length;s++)o+=i.charCodeAt(s);this.colorIndex=o%12,this.color=u.textAvatarColor[this.colorIndex]},u.prototype.getAvatarInBase64=function(){var t=this,n=this;return e(function(e){try{if(t&&t.avatar&&t.avatar.src||e(),t.avatar.src&&!t.avatar.src.startsWith("data:image/png")){var i=new Image,a=r[0].createElement("canvas");a.width=120,a.height=120;var o=a.getContext("2d");o.rect(0,0,120,120),o.fillStyle=n.color,o.fill(),i.onload=function(){o.drawImage(this,0,0,120,120);var t=a.toDataURL("image/png");e(t)},i.src=t.avatar.src}else e(t.avatar.src)}catch(t){s.warn("[contactService] getAvatarInBase64 error "+t),e()}})},u.prototype.getAvatar=function(r,i){var a=config.webservices.protocol+"://"+config.webservices.currentServer;t.cdn&&(a=t.cdnServer);var o=this;return e(function(e){if(o.createTextAvatarImage(),o.lastAvatarUpdateDate){var t=new Image;if(t.onload=function(){var t=this;n(function(){o.avatar.src=t.src,s.log("[contactService] Load avatar for "+o.displayNameForLog()+" success"),e(o)},0,1,!0)},t.onerror=function(){s.warn("[contactService] Load avatar for "+o.displayNameForLog()+" failure : use text avatar"),e(o)},o.dbId){var l=a+"/api/avatar/"+o.dbId+"?size="+(r||256);o.lastAvatarUpdateDate&&(l+="&update="+MD5.hexdigest(o.lastAvatarUpdateDate)),i&&(l+="&rand="+c(10)),t.src=l}else e(o)}else e(o)})},u.prototype.createTextAvatarImage=function(t){var i=e.defer(),a=this,o=new Image,s=r[0].createElement("canvas");s.width=o.width=225,s.height=o.height=225;var c=s.getContext("2d");if(c.rect(0,0,225,225),c.fillStyle=this.color,c.fill(),t){var l=new Image;l.onload=function(){c.drawImage(l,10,10,100,100),o.src=s.toDataURL("image/png"),n(function(){a.avatar=o,i.resolve(a)},0,1,!0)},l.src="/resources/images/leftArea/rooms.png"}else c.font="bold 100px Helvetica",c.textAlign="center",c.fillStyle="white",c.fillText(this.initials,110,150),o.src=s.toDataURL("image/png"),a.avatar=o,i.resolve(a);return i.promise},u.prototype.getGroups=function(){return this.groups},u.prototype.setGroups=function(e){this.groups=e},u.textAvatarColor=["#ff4500","#d38700","#348833","#007356","#00b2a9","#00b0e5","#0085ca","#6639b7","#91278a","#cf0072","#a50034","#d20000"],u}]),angular.module("rainbow").factory("Conversation",["$log","$rootScope","$interval","$filter","contactService","xmppService","fileTransfertService","Message","uuid4","utilService","fileStorageService","fileServerService","$q","fileViewerFactory","Call","roomService","pstnConferenceService",function(e,t,n,r,i,a,o,s,c,l,u,d,f,h,p,v,m){"use strict";function g(e){this.id=e,this.dbId=null,this.type=null,this.owner=null,this.contact=null,this.room=null,this.capabilities=null,this.avatar=null,this.presenceStatus=null,this.name=function(){return{}},this.filterName="",this.missedCounter=0,this.missedCalls=0,this.messages=[],this.participantStatuses={},this.draft="",this.uploadFiles=null,this.status=g.Status.ACTIVE,this.historyIndex=-1,this.historyMessages=[],this.historyDefered=null,this.historyComplete=!1,this.lastModification=void 0,this.creationDate=new Date,this.lastMessageText="",this.lastMessageSender="",this.pip=!0,this.videoCall={status:p.Status.UNKNOWN},this.audioCall=null,this.pstnConferenceSession=null,this.webConferenceSession=null,this.isMutedAudio=!1,this.isMutedVideo=!1,this.infoVisible=null,this.muted=!1}g.ChatstatesNS="http://jabber.org/protocol/chatstates",g.ReceiptNS="urn:xmpp:receipts",g.Type={ONE_TO_ONE:0,ROOM:1,BOT:2},g.Status={ACTIVE:{key:0,value:"active"},INACTIVE:{key:1,value:"inactive"},COMPOSING:{key:2,value:"composing"},PAUSED:{key:3,value:"paused"}},g.createOneToOneConversation=function(t){e.info("[Conversation] Create one to one conversation ("+t.id+")");var n=new g(t.id);return n.contact=t,t.conversation=n,t.isBot?(n.avatar="",n.type=g.Type.BOT):(n.avatar=t.avatar?t.avatar.src:null,n.type=g.Type.ONE_TO_ONE),n.name=t.name,n.filterName=l.removeDiacritis(t.displayName.toLowerCase()),n},g.createRoomConversation=function(t){e.info("[Conversation] Create room conversation ("+t.jid+")");var n=new g(t.jid);return n.type=g.Type.ROOM,n.room=t,n.filterName=l.removeDiacritis(t.name.toLowerCase()),n};var E=c.generate(),S=0;return g.getUniqueMessageId=function(){var e="web_"+E+S;return S++,e},g.stringToStatus=function(e){switch(e){case"composing":return g.Status.COMPOSING;case"paused":return g.Status.PAUSED;default:return g.Status.ACTIVE}},g.prototype.reset=function(){this.messages=[],this.historyIndex=-1,this.historyMessages=[],this.historyComplete=!1,this.currentHistoryId=null,this.chatRenderer&&this.chatRenderer.removeAllMessages()},g.prototype.isInCall=function(){return this.pstnConferenceSession?this.pstnConferenceSession.isParticipantConnectedByJid(i.userContact.jid):this.webConferenceSession?this.webConferenceSession.isParticipantConnectedByJid(i.userContact.jid):this.videoCall&&this.videoCall.status&&"Unknown"!==this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"Unknown"!==this.audioCall.status.value&&"incommingCall"!==this.audioCall.status.value&&"queued"!==this.audioCall.status.value},g.prototype.isNotInCall=function(){return!(this.videoCall&&this.videoCall.status&&"Unknown"!==this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"Unknown"!==this.audioCall.status.value||"busy"===i.userContact.status&&""!==i.userContact.message)},g.prototype.isActive=function(){return this.videoCall&&this.videoCall.status&&"active"===this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"active"===this.audioCall.status.value},g.prototype.isHeld=function(){return this.videoCall&&this.videoCall.status&&"held"===this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"held"===this.audioCall.status.value},g.prototype.getMessageById=function(e){return this.messages.find(function(t){return t.id===e})},g.prototype.sendChatMessage=function(e){this.sendAckReadMessages();var t=r("emojiShortToUnicode")(e),o=null,c=this,l=g.getUniqueMessageId();if(this.type===g.Type.ONE_TO_ONE){var u=this.contact.jid;o=$msg({to:u,type:"chat",id:l,"xml:lang":i.currentLanguage}).c("body",{"xml:lang":i.currentLanguage}).t(t).up().c("request",{xmlns:g.ReceiptNS}).up().c("active",{xmlns:g.ChatstatesNS}).up()}else o=$msg({to:this.room.jid,type:"groupchat",id:l}).c("body",{"xml:lang":i.currentLanguage}).t(t).up().c("request",{xmlns:g.ReceiptNS}).up().c("active",{xmlns:g.ChatstatesNS}).up();var d=null;return(d=this.addChatMessage(i.userContact,new Date,t,l,!0))?(d.serverAckTimer=n(function(){d.receiptStatus=s.ReceiptStatus.ERROR,c.updateMessage(d)},1e4),a.send(o),d):null},g.prototype.sendIsTypingState=function(e){this.sendAckReadMessages();var t=null,n=g.getUniqueMessageId(),r=e?"composing":"active";if(this.type===g.Type.ONE_TO_ONE){var o=this.contact.jid;t=$msg({to:o,type:"chat",id:n,"xml:lang":i.currentLanguage}).c(r,{xmlns:g.ChatstatesNS}).up()}else t=$msg({to:this.room.jid,type:"groupchat",id:n}).c(r,{xmlns:g.ChatstatesNS}).up();a.send(t)},g.prototype.sendRecordingMessage=function(e){this.sendAckReadMessages();var t=r("emojiShortToUnicode")(e),o=null,c=this,l=g.getUniqueMessageId();if(this.type===g.Type.ONE_TO_ONE){var u=this.contact.jid;o=$msg({to:u,type:"recording",id:l,"xml:lang":i.currentLanguage}).c("body",{"xml:lang":i.currentLanguage}).t(t).up().c("request",{xmlns:g.ReceiptNS}).up().c("active",{xmlns:g.ChatstatesNS}).up()}e=null;return(e=this.addRecordingMessage(i.userContact,new Date,t,l))?(e.serverAckTimer=n(function(){e.receiptStatus=s.ReceiptStatus.ERROR,c.updateMessage(e)},1e4),a.send(o),e):null},g.prototype.sendExistingFSMessage=function(e,t){if(this.sendAckReadMessages(),!e)return null;var n=e.data,r=null,o=e.id;if(this.type===g.Type.ONE_TO_ONE){var c=this.contact.jid;r=$msg({to:c,type:"chat",id:o,"xml:lang":i.currentLanguage}).c("body",{"xml:lang":i.currentLanguage}).t(n).up().c("request",{xmlns:g.ReceiptNS}).up().c("active",{xmlns:g.ChatstatesNS}).up()}else r=$msg({to:this.room.jid,type:"groupchat",id:o}).c("body",{"xml:lang":i.currentLanguage}).t(n).up().c("request",{xmlns:g.ReceiptNS}).up().c("active",{xmlns:g.ChatstatesNS}).up();var l=config.restServerUrl+"/api/rainbow/fileserver/v1.0/files/"+t.id;return r.c("x",{xmlns:"jabber:x:oob"}).c("url",{},l).c("mime",{},t.typeMIME).c("filename",{},t.fileName).c("size",{},t.size).up().up().c("store",{xmlns:"urn:xmpp:hints"}),e.fileId=t.id,e.setReceiptStatus(s.ReceiptStatus.SENT),this.updateMessage(e),a.send(r),e},g.prototype.sendAckReceivedMessage=function(t){if(!(t.receiptStatus>=s.ReceiptStatus.UNREAD)){e.info("[Conversation] "+this.id+" send received ack for message "+t.id);var n=this.type===g.Type.ONE_TO_ONE?this.contact.jid:this.room.jid,r=i.userContact.jid,o=$msg({to:n,from:r,type:"chat"}).c("received",{xmlns:g.ReceiptNS,event:"received",entity:"client",id:t.id});this.type!==g.Type.ONE_TO_ONE&&(o=$msg({to:n,from:r,type:"groupchat"}).c("received",{xmlns:g.ReceiptNS,event:"received",entity:"client",type:"muc",id:t.id})),a.send(o),t.setReceiptStatus(s.ReceiptStatus.UNREAD)}},g.prototype.sendAckReadMessage=function(t){if(t.receiptStatus!==s.ReceiptStatus.READ){e.info("[Conversation] "+this.id+" send read ack for message "+t.id);var n=this.type===g.Type.ONE_TO_ONE?this.contact.jid:this.room.jid,r=i.userContact.jid,o=$msg({to:n,from:r,type:"chat"}).c("received",{xmlns:g.ReceiptNS,event:"read",entity:"client",id:t.id});return this.type!==g.Type.ONE_TO_ONE&&(o=$msg({to:n,from:r,type:"groupchat"}).c("received",{xmlns:g.ReceiptNS,event:"read",entity:"client",type:"muc",id:t.id})),a.send(o),t.setReceiptStatus(s.ReceiptStatus.READ)}},g.prototype.sendAckReadMessages=function(){var e=!1,t=this;return this.messages.forEach(function(n){n.receiptStatus!==s.ReceiptStatus.SENT&&n.receiptStatus!==s.ReceiptStatus.UNREAD||n.side!==s.Side.LEFT&&n.side!==s.Side.ADMIN||(t.sendAckReadMessage(n),e=!0)}),e},g.prototype.sendFTMessage=function(e,t){var n=new FileTransfert(null,null,e.name,e.size,e.type,null,t);this.addFTMessage(i.userContact,new Date,n,g.getUniqueMessageId());var r=this,s=this.contact.jid;o.sendFile(e,this.contact.fullJid,t,n).then(function(){var e=g.getUniqueMessageId(),t=n.message+"||"+n.filename+"||"+n.filesize+"||"+n.filetype+"||done||"+n.transfertId,o=$msg({to:s,type:"file",id:e}).c("body").t(t).up();a.send(o),r.addFileMessage(i.userContact,new Date,t,e)}).catch(function(e){var t="refused";-1!==e.toString().indexOf("timed out")&&(t="expired");var o=g.getUniqueMessageId(),c=n.message+"||"+n.filename+"||"+n.filesize+"||"+n.filetype+"||"+t+"||"+n.transfertId,l=$msg({to:s,type:"file",id:o}).c("body").t(c).up();a.send(l),r.addFileMessage(i.userContact,new Date,c,o)})},g.prototype.sendFSMessage=function(n,r){e.debug("[conversation] >sendFSMessage");var i,a=f.defer(),o=this,c=n.name.split(".").pop(),l=n.type,p=[],v="object"==typeof r?r:void 0;return p=this.type===g.Type.ONE_TO_ONE?h([{viewerId:this.contact.dbId,type:"user"}]):h([{viewerId:this.room.dbId,type:"room"}]),u.createFileDescriptor(n.name,c,n.size,p).then(function(a){return i=a,a.fileToSend=n,a.isImage()&&n.preview&&(a.previewBlob=n.preview),v||(v=o.addFSMessage(a.id,l,r,"uploading")),v.fileId=a.id,a.state="uploading",o.chatRenderer&&o.chatRenderer.updateFileTransferState(v,a),d.uploadAFileByChunk(a,n,v,function(e,t){o.chatRenderer&&o.chatRenderer.updateFileTransferState(e,t)}).then(function(t){return e.debug("uploadAFileByChunk success"),o.chatRenderer&&o.chatRenderer.updateFileTransferState(v,t),f.resolve(a)},function(n){e.debug("uploadAFileByChunk error"),u.deleteFileDescriptor(i.id);var r=n.translatedMessage?n.translatedMessage:"Unable to share file";return t.$broadcast("ON_SHOW_INFO_MESSAGE",{type:"error",messageKey:r}),i.state="uploadError",v.receiptStatus=s.ReceiptStatus.ERROR,v.fileErrorMsg=r,o.updateMessage(v),f.reject(n)})}).then(function(e){e.state="uploaded",e.chunkPerformed=0,e.chunkTotalNumber=0,o.sendExistingFSMessage(v,e),a.resolve(v)},function(t){e.debug("createFileDescriptor error"),a.reject(t)}),a.promise},g.prototype.sendEFSMessage=function(e,n){var r=this,i=e.extension,a="",o=null,c=this.addFSMessage(e.id,i,n,e.state);return this.type===g.Type.ONE_TO_ONE?(a="user",o=this.contact.dbId):(a="room",o=this.room.dbId),u.addFileViewer(e.id,o,a).then(function(){r.sendExistingFSMessage(c,e)}).catch(function(e){var n=e.translatedMessage?e.translatedMessage:"Unable to share file";t.$broadcast("ON_SHOW_INFO_MESSAGE",{type:"error",messageKey:n}),c.receiptStatus=s.ReceiptStatus.ERROR,r.updateMessage(c)}),c},g.prototype.addAdminBubbleMessage=function(t,n,r,i){if(this.getMessageById(i))return e.info("[Conversation] "+this.id+" add addAdminBubbleMessage message ("+i+") already exists."),null;e.info("[Conversation] "+this.id+" add addAdminBubbleMessage from "+t.jid+" : "+r);var a=r+"MsgRoom",o=s.Side.ADMIN,c=s.create(i,n,t,o,a,!1);return c.setReceiptStatus(s.ReceiptStatus.SENT),this.addMessage(c)},g.prototype.addFTMessage=function(t,n,r,a){e.info("[Conversation] "+this.id+" add FT message from "+t.jid+" : "+r.message);var o=i.isUserContact(t)?"R":"L",c=s.createFTMessage(a,n,t,o,r.message,!1,r);return this.addMessage(c)},g.prototype.addFSMessage=function(t,n,a,o){e.info("[Conversation] "+this.id+" add FS message from me");var c=g.getUniqueMessageId(),l=r("emojiShortToUnicode")(a),u=new Date;e.info("[Conversation] "+this.id+" add FILE SHARING message from me");var d=s.createFileSharingMessage(c,u,i.userContact,"R",l,o,t);return d.setReceiptStatus(s.ReceiptStatus.IN_PROGRESS),this.addMessage(d)},g.prototype.addChatMessage=function(t,n,r,a,o,c,l){if(this.getMessageById(a))return e.info("[Conversation] "+this.id+" add CHAT message ("+a+") already exists."),null;e.info("[Conversation] "+this.id+" add CHAT message ("+a+") from "+t.jid);var u=i.isUserContact(t)?"R":"L",d=s.create(a,n,t,u,r,!1,c,l);return o?d.setReceiptStatus(s.ReceiptStatus.IN_PROGRESS):d.setReceiptStatus(s.ReceiptStatus.SENT),this.addMessage(d)},g.prototype.addRecordingMessage=function(e,t,n,r){var i=s.createRecordingAdminMessage(r,t,e,"ADMIN",n);return this.addMessage(i)},g.prototype.addFileMessage=function(t,n,r,a){e.info("[Conversation] "+this.id+" add FILE message from "+t.jid+" : "+r);var o=i.isUserContact(t)?"R":"L",c=s.createFileMessage(a,n,t,o,r,!1);return this.addMessage(c)},g.prototype.addFileSharingMessage=function(t,n,r,a,o){e.info("[Conversation] "+this.id+" add FILE SHARING message from "+t.jid+" : "+r);var c=i.isUserContact(t)?"R":"L",l=s.createFileSharingMessage(a,n,t,c,r,!1,o);return this.addMessage(l)},g.prototype.addConferenceMessage=function(t,n,r,a){if("reminder"===a.type){var o=v.getRoomByJid(a.roomjid),c=m.conferenceSessions[o.getPstnConfEndpointId()];if(c&&c.isActive()&&c.isParticipantConnectedByJid(i.userContact.jid))return}e.info("[Conversation] "+this.id+" add CONFERENCE message from "+t.jid);var l=s.createConferenceMessage(r,n,t,"ADMIN",!1,a);return this.addMessage(l)},g.prototype.addWebRTCMessage=function(t,n,r,a){if(this.getMessageById(a))return e.info("[Conversation] "+this.id+" add addWebRTCMessage message ("+a+") already exists."),null;e.info("[Conversation] "+this.id+" add WebRTC message from "+t.jid+" : "+r);var o=i.isUserContact(t)?s.Side.RIGHT:s.Side.LEFT,c=s.createWebRTCMessage(a,n,t,o,r,!1);return this.addMessage(c)},g.prototype.updateMessage=function(e){this.chatRenderer&&this.chatRenderer.updateMessage(e,this.room)},g.prototype.addMessage=function(n){return this.messages.find(function(e){return e.id===n.id})?(e.info("[Conversation] "+this.id+" try to add an already stored message with id "+n.id),n):(n.side===s.Side.LEFT&&(n.type===s.Type.WEBRTC&&(this.missedCalls+=1),this.setStatusMessage(n.from,g.Status.ACTIVE)),this.messages.push(n),this.chatRenderer&&this.chatRenderer.appendMessages([n],this.room),this.lastModification=new Date,this.lastMessageText=n.data,t.$broadcast("ON_CONVERSATION_UPDATED_EVENT",this.id),n)},g.prototype.removeMessage=function(e){var t=this.messages.lastIndexOf(e);-1!==t&&this.messages.splice(t,1)},g.prototype.sendChatStatus=function(t){if(e.info("[Conversation] "+this.id+" setStatus "+t.value),this.status!==t&&(this.status=t,t!==g.Status.IDLE)){var n=null,r="";this.type===g.Type.ONE_TO_ONE?(r=this.contact.jid,n=$msg({to:r,type:"chat"}).c(t.value,{xmlns:g.ChatstatesNS})):(r=this.room.jid,n=$msg({to:r,type:"groupchat"}).c(t.value,{xmlns:g.ChatstatesNS}));try{a.connection.send(n)}catch(t){e.error("[Conversation] sendChatStatus error "+t)}}},g.prototype.setStatusMessage=function(t,n){e.info("[Conversation] "+this.id+" add status message from "+t.jid+" : "+n.value),this.participantStatuses[t.jid]=n,this.chatRenderer&&this.chatRenderer.updateStatuses&&this.chatRenderer.updateStatuses()},g.prototype.sendInvitation=function(t){try{var n=t.jid,r={xmlns:"jabber:x:conference",jid:this.id},i=$msg({from:a.connection.jid,to:n}).c("x",r);a.connection.send(i)}catch(t){e.error("[Conversation] sendInvitation error "+t)}},g}]),angular.module("rainbow").factory("Message",["$log","$filter","$interval","roomService",function(e,t,n,r){"use strict";function i(e,t,n,r,a,o,s,c,l,u){this.id=e,this.index=null,this.type=t,this.date=n,this.from=r,this.side=a,this.data=o,this.status=s,this.receiptStatus=i.ReceiptStatus.NONE,this.serverAckTimer=null,this.fileId=c,this.isMarkdown=l,this.subject=u}return i.Type={CHAT:{key:0,value:"Chat"},FILE:{key:1,value:"File"},FS:{key:2,value:"FileSharing"},FT:{key:3,value:"FileTransfert"},WEBRTC:{key:4,value:"WebRTC CAll"},RECORDING:{key:5,value:"Recording"}},i.ReceiptStatus={NONE:0,ERROR:1,IN_PROGRESS:2,SENT:3,UNREAD:4,READ:5},i.Side={LEFT:"L",RIGHT:"R",ADMIN:"ADMIN"},i.ReceiptStatusText=["none","ko","inProgress","sent","received","read"],i.create=function(e,n,r,a,o,s,c,l){var u=t("emojiUnicodeToShort")(o);return new i(e,i.Type.CHAT,n,r,a,u,s,null,c,l)},i.createFileSharingMessage=function(e,n,r,a,o,s,c){var l=t("emojiUnicodeToShort")(o);return new i(e,i.Type.FS,n,r,a,l,s,c)},i.createConferenceMessage=function(e,n,a,o,s,c){var l=r.getRoomByJid(c.roomjid),u="";switch(c.type){case"invite":u=t("translate")("headerConferenceMessage",{sender:a._displayName,firstname:a.firstname,bubblename:l.name});break;case"reminder":u=l&&l.owner?t("translate")("conferenceReminderMessageforOwner",{sender:a._displayName}):t("translate")("conferenceReminderMessage",{sender:a._displayName});break;default:u=t("translate")("headerConferenceMessage",{sender:a._displayName,firstname:a.firstname,bubblename:l.name})}l.desc&&(u+="<br>"+t("translate")("conferenceSuject")+l.desc);var d=u;return new i(e,i.Type.CHAT,n,a,o,d,s)},i.createFileMessage=function(e,t,n,r,a,o){return new i(e,i.Type.FILE,t,n,r,a,o)},i.createWebRTCMessage=function(e,t,n,r,a,o){return new i(e,i.Type.WEBRTC,t,n,r,a,o)},i.createFTMessage=function(e,t,n,r,a,o,s){var c=new i(e,i.Type.FT,t,n,r,a,o);return c.fileTransfert=s,c},i.createBubbleAdminMessage=function(e,t,n,r){var a=r+"MsgRoom",o=i.Side.ADMIN;return i.create(e,t,n,o,a,!1)},i.createRecordingAdminMessage=function(e,t,n,r,a){var o=r+"Recording";a&&(o+=a);var s=i.Side.ADMIN;return new i(e,i.Type.RECORDING,t,n,s,o,!1)},i.prototype.setReceiptStatus=function(t){return this.serverAckTimer&&t>i.ReceiptStatus.IN_PROGRESS&&(n.cancel(this.serverAckTimer),this.serverAckTimer=null),t>this.receiptStatus&&(this.receiptStatus=t,e.info("[Message] "+this.id+" : "+i.ReceiptStatusText[t])),this},i}]),angular.module("rainbow").factory("Room",[function(){"use strict";function e(t,n,r,i,a,o,s,c,l,u){this.dbId=t,this.jid=n,this.name=r,this.desc=i,this.type=e.Type.PRIVATE,this.users=[],this.history=s||e.History.NONE,this.customData=c||{},this.ownerContact=null,this.organizers=[],this.members=[],this.avatarContacts=[],this.owner=!1,this.isModerator=!1,this.confEndpoints=o||[],this.conference=void 0!==l?l:null,this.status="none",this.creationDate=a,this.initPresPromise=null,this.avatar=u,this.guestEmails=[],e.prototype.toString=function(){return"Room "+this.dbId+" "+this.name+" "+this.jid},e.prototype.updateAvatarInfo=function(){var e=[],t=this.users;if(!this.avatar){t.sort(function(e,t){return new Date(e.date)-new Date(t.date)});for(var n=0;n<t.length;n++){var r=t[n].contact,i=t[n].status;if(r.dbId!==this.ownerContact.dbId&&("accepted"!==i&&"invited"!==i||e.push(r),2===e.length))break}this.avatarContacts=e}},e.prototype.isUserOwner=function(e){return!!e&&this.ownerContact.jid===e.jid},e.prototype.isUserModerator=function(e){return void 0!==this.getOrganizerFromContactJid(e.jid)},e.prototype.isUserStatusAccepted=function(e){var t=this.getUserByJid(e.jid);return void 0!==t&&"accepted"===t.status},e.prototype.isUserStillBelongToRoom=function(e){var t=this.getUserByJid(e);return"unsubscribed"!==t.status&&"deleted"!==t.status},e.prototype.getOrganizerFromContactJid=function(e){var t;return this.organizers.forEach(function(n){n.contact.jid===e&&(t=n)}),t},e.prototype.getUserByJid=function(e){for(var t=0;t<this.users.length;t++)if(e===this.users[t].contact.jid)return this.users[t];return null},e.prototype.getPstnConfEndpointId=function(){if(this.confEndpoints&&this.confEndpoints.length)for(var e=0;e<this.confEndpoints.length;e++)if("webrtc"!==this.confEndpoints[e].mediaType)return this.confEndpoints[e].confEndpointId;return null},e.prototype.getSFUConfEndpointId=function(){if(this.confEndpoints&&this.confEndpoints.length)for(var e=0;e<this.confEndpoints.length;e++)if("webrtc"===this.confEndpoints[e].mediaType)return this.confEndpoints[e].confEndpointId;return null},e.prototype.isMeetingRoom=function(){return!(!this.conference||"pstnAudio"!==this.conference.mediaType)},e.prototype.isWebConferenceRoom=function(){return!(!this.conference||"pstnAudio"===this.conference.mediaType)},e.prototype.isMeetingOrWebConferenceRoom=function(){return this.isMeetingRoom()||this.getSFUConfEndpointId()}}return e.Type={PRIVATE:0,PUBLIC:1},e.Privilege={USER:"user",MODERATOR:"moderator",GUEST:"guest"},e.History={ALL:"all",NONE:"none"},e.create=function(t,n,r,i,a,o,s,c,l,u){return new e(t,n,r,i,a,o,s,c,l,u)},e}]),angular.module("rainbow").factory("Call",["$log",function(e){"use strict";function t(t,n,r,i){this.status=t,this.id=n,this.conversationId=null,this.connectionId=null,this.type=r,this.isVm=!1,this.contact=i,this.remoteMedia=0,this.localMedia=0,this.isEscalated=!1,this.startDate=new Date,this.isInitiator=!1,this.participants=null,this.isRemoteVideoMuted=!1,this.isConference=!1,this.avatars=i&&i.avatar?[this.contact.avatar.src]:[],this.currentCalled={contactPhoneNumber:"",contact:null,participantsPhoneNumbers:[],participants:[]},this.fullJid="",e.debug("[CALL] createCall : "+this)}return t.Status={UNKNOWN:{key:0,value:"Unknown"},DIALING:{key:1,value:"dialing"},QUEUED_INCOMMING:{key:2,value:"queuedIncomming"},QUEUED_OUTGOING:{key:10,value:"queuedOutGoing"},RINGING_INCOMMING:{key:3,value:"incommingCall"},RINGING_OUTGOING:{key:4,value:"ringingOutgoing"},ACTIVE:{key:5,value:"active"},HOLD:{key:6,value:"held"},PUT_ON_HOLD:{key:7,value:"putOnHold"},RELEASING:{key:8,value:"releasing"},ANSWERING:{key:9,value:"answering"},CONNECTING:{key:12,value:"connecting"},ERROR:{key:11,value:"error"}},t.Type={WEBRTC:{key:1,value:"Video"},PHONE:{key:2,value:"Phone"}},t.Media={AUDIO:1,VIDEO:2,PHONE:4,SHARING:8},t.create=function(e,n,r,i){return new t(e,n,r,i)},t.prototype.setCallId=function(t){this.id=t,e.debug("[CALL] setId : "+this)},t.prototype.isInConversationWithMobile=function(){return!!this.fullJid&&(-1!==this.fullJid.indexOf("mobile_android")||-1!==this.fullJid.indexOf("mobile_ios"))},t.prototype.setConversationId=function(t){this.conversationId=t,e.debug("[CALL] setConversationId : "+this)},t.prototype.setConnectionId=function(n){this.connectionId=n,this.id=t.getIdFromConnectionId(n),e.debug("[CALL] setId : "+this)},t.prototype.setStatus=function(t){this.status=t,e.debug("[CALL] setStatus : "+this)},t.prototype.setType=function(t){this.type=t,e.debug("[CALL] setType : "+this)},t.prototype.setIsVm=function(t){this.isVm=t,e.debug("[CALL] setVm : "+this)},t.prototype.setContact=function(t){this.contact=t,this.avatars=[this.contact.avatar.src],e.debug("[CALL] setContact : "+t)},t.prototype.setParticipants=function(t){this.participants=t,this.avatars=[];var n=this;this.participants.forEach(function(e){n.avatars.push(e.avatar.src)}),e.debug("[CALL] setParticipants : "+t.join())},t.prototype.getCurrentCalled=function(){return this.currentCalled},t.prototype.setCurrentCalled=function(t){t?this.contact&&this.contact.id?(this.currentCalled.contactPhoneNumber=t.contactPhoneNumber&&""!==t.contactPhoneNumber?t.contactPhoneNumber:"",this.currentCalled.contact=t.contact?t.contact:null,this.currentCalled.participantsPhoneNumbers=null,this.currentCalled.participants=null,e.debug("[CALL] setCurrentCalled contactPhoneNumber : "+t.contactPhoneNumber),e.debug("[[TelephonyServiceEventHandler]] setCurrentCalled call "+this.id+" contactPhoneNumber = "+t.contactPhoneNumber)):(this.currentCalled.contactPhoneNumber="",this.currentCalled.contact=null,this.currentCalled.participantsPhoneNumbers=t.participantsPhoneNumbers&&t.participantsPhoneNumbers.length>0?t.participantsPhoneNumbers:null,this.currentCalled.participants=t.participants&&t.participants.length>0?t.participants:null,this.currentCalled.participantsPhoneNumbers&&this.currentCalled.participantsPhoneNumbers.length>0&&(e.debug("[CALL] setCurrentCalled participantsPhoneNumbers : "+t.participantsPhoneNumbers.join()),e.debug("[[TelephonyServiceEventHandler]] setCurrentCalled "+this.id+" participantsPhoneNumbers : "+t.participantsPhoneNumbers.join()))):(this.currentCalled.contactPhoneNumber="",this.currentCalled.contact=null,this.currentCalled.participantsPhoneNumbers=null,this.currentCalled.participants=null)},t.prototype.setCurrentCalledContactNumber=function(t){e.debug("[[TelephonyServiceEventHandler]] setCurrentCalledContactNumber call "+this.id+" phoneNumber = "+t),this.currentCalled.contactPhoneNumber=t},t.getIdFromConnectionId=function(e){return e.split("#")[0]},t.getDeviceIdFromConnectionId=function(e){return e.split("#")[1]},t.prototype.toString=function(){return"(type:"+this.type.value+", id:"+this.id+", status:"+this.status.value+(this.vm?"(voicemail))":")")},t}]),function(){"use strict";angular.module("rainbow").factory("RBNotification",["$log","$rootScope","$notification","$filter","notify",function(e,t,n,r,i){var a=8e5,o=this;function s(t){e.info("[RBNotification] Create notification"),this.icon=t.icon,this.displayName=t.displayName,this.message=t.body,this.type=t.type,this.tag=t.tag,this.delay=t.delay?t.delay:a,this.focusAction=t.focusAction,this.sound=null,this.answerAudioButton=null,this.answerVideoButton=null,this.answerSharingButton=null,this.answerClick=!1,this.declineButton=null,this.declineClick=!1,this.answerWithTemplateIMClick=!1,this.answerWithIMButton=null,this.bottomRightButton=null,this.handler=null}return s.notifs=[],s.create=function(e){var t=new s(e);return s.notifs[e.id]=t,t},s.hide=function(e){var t=s.notifs[e];t&&t.handler.close()},s.createNotificationListener=function(e){t.$on("$destroy",t.$on("NOTIFICATION_EVENT",function(t,n){n.display(e)}))},s.prototype.send=function(){t.$broadcast("NOTIFICATION_EVENT",this)},s.prototype.addAnswerAudioButton=function(e){this.answerAudioButton=e},s.prototype.addAnswerVideoButton=function(e){this.answerVideoButton=e},s.prototype.addAnswerSharingButton=function(e){this.answerSharingButton=e},s.prototype.addDeclineButton=function(e){this.declineButton=e},s.prototype.addAnswerWithIMButton=function(e){this.answerWithIMButton=e},s.prototype.addBottomRightButton=function(e){this.bottomRightButton=e},s.prototype.display=function(e){if(!t.appVisible){var a=n(this.displayName,{tag:this.tag,body:this.message,icon:this.icon,delay:4e3});this.focusAction&&a.$on("click",this.focusAction)}o.answerClick=!1,o.declineClick=!1,o.answerWithTemplateIMClick=!1;var s=null,c=e.$new(!0);c.notification=this,c.showIMTemplates=!1,c.answerAudioButtonClick=function(e){o.answerClick||(e.answerAudioButton.action(),o.answerClick=!0)},c.answerVideoButtonClick=function(e){o.answerClick||(e.answerVideoButton.action(),o.answerClick=!0)},c.answerSharingButtonClick=function(e){o.answerClick||(e.answerSharingButton.action(),o.answerClick=!0)},c.declineButtonClick=function(e){o.declineClick||(e.declineButton.action(),o.declineClick=!0)},c.answerWithIMButtonClick=function(e){if(c.showIMTemplates)c.showIMTemplates=!1,c.templatesIM=[];else{s=e;var t=[];e.answerWithIMButton&&Array.isArray(e.answerWithIMButton.choice)&&e.answerWithIMButton.choice.forEach(function(e){t.push(e)}),c.templatesIM=t,c.showIMTemplates=!0}},c.addBottomRightButtonClick=function(e){e.bottomRightButton.action()},c.answerWithTemplateIM=function(e){if(!o.answerWithTemplateIMClick){if(s){var t="";s.answerWithIMButton.label!==e.label&&(t=r("translate")(e.label)),s.answerWithIMButton.action(t)}o.answerWithTemplateIMClick=!0}},this.handler=i({position:"right",templateUrl:"gui/common/notification/notificationCallTemplate.html",message:this.title,duration:this.delay,startTop:80,scope:c})},s}])}(),angular.module("rainbow").factory("CallLog",[function(){"use strict";function e(t,n,r,i,a,o,s,c){this.id=t,this.contact=n,this.state=r,this.duration=i,this.direction=c,a="unknown"===a||"audio"===a||"webrtc"===a?e.Type.WEBRTC:"telephone"===a?e.Type.TELEPHONE:e.Type.CONFERENCE,this.type=a,this.read=o,this.date=s}return e.create=function(t,n,r,i,a,o,s,c){return new e(t,n,r,i,a,o,s,c)},e.getNames=function(e){var t={firstname:"",lastname:""};return e&&e.contact&&(t.firstname=e.contact.firstname.toUpperCase(),t.lastname=e.contact.lastname.toUpperCase(),e&&e.date&&(t.date=e.date.getTime())),t},e.getDate=function(e){return e&&e.date?e.date.getTime():0},e.sortByContact=function(e,t){var n=-1;if(e&&e.value.lastname&&t&&t.value.lastname){var r=e.value.lastname,i=t.value.lastname;0===(n=r.localeCompare(i))&&(r=e.value.firstname,i=t.value.firstname,0===(n=r.localeCompare(i))&&t.value.date&&e.value.date&&(n=t.value.date-e.value.date))}return n},e.sortByDate=function(e,t){var n=1;return e&&t&&(n=t.value-e.value),n},e.Type={WEBRTC:"webrtc",TELEPHONE:"telephone",CONFERENCE:"conference"},e}]);var FileTransfertIndex=12,FileTransfert=function(e,t,n,r,i,a,o){"use strict";this.index=FileTransfertIndex,this.from=e,this.requestId=a,this.transfertId=t,this.filename=n,this.filesize=r,this.filetype=i,this.message=o,this.buffer=null,this.status=FileTransfert.Status.WAIT,this.progressValue=0,this.progressSurvey=null,this.progressHandler=null,this.acceptHandler=null,FileTransfertIndex+=1};FileTransfert.Status={WAIT:0,TRANSFER:1,FINISH:2,REJECT:3},FileTransfert.prototype.toString=function(){"use strict";return"[FileTransfert] "+this.transfertId+" "+this.filename},function(){"use strict";angular.module("rainbow").factory("Document",["$log","$filter",function(e,t){function n(t,n,r,i,a,o){this.publisher=t,this.item_id=a,this.data=n,this.timestamp=r,this.authorjid=i,this.pub_id=o,e.debug("[Document] createActu : "+this)}return n.create=function(e,t){return new n(e,t,Date.now(),e.jid)},n.createForSharing=function(e,t){return console.log(t.item_id),""===t.item_id?new n(e,"Repost",Date.now(),t.authorjid,t.pub_id):new n(e,"Repost",Date.now(),t.authorjid,t.item_id)},n.createFromXML=function(e,t){return new n(e,t.childNodes[0].childNodes[0].nodeValue,parseInt(t.childNodes[1].childNodes[0].nodeValue,10),t.childNodes[2].childNodes[0].nodeValue,1!==t.childNodes[3].childNodes.length?"":t.childNodes[3].childNodes[0].nodeValue,t.parentNode.attributes.getNamedItem("id").nodeValue)},n.prototype.messageFilter=function(e){return t("quoteFilter")(t("emojione")(t("linky")(t("emojiUnicodeToShort")(e,"_blank"))))},n.prototype.setPubId=function(e){this.pub_id=e},n.prototype.setItemId=function(e){this.item_id=e},n.prototype.getXML=function(){return[{data:$build("entry").c("data",this.data).up().c("timestamp",this.timestamp).up().c("jidauthor",this.authorjid).up().c("item_id",this.item_id).tree()}]},n.prototype.getTime=function(e){return moment(this.timestamp).format(e)},n.prototype.toString=function(){return"(jid:"+this.contact+", id:"+this.pub_id+", data:"+this.data+", tsmp:"+this.timestamp+" )"},n}])}(),angular.module("rainbow").factory("Group",[function(){"use strict";function e(e,t,n,r){this.id=e,this.name=t,this.comment=n||"",this.isFavorite=r||!1,this.users=[],this.sortedUserList=[]}return e.createFromData=function(t){return new e(t.id,t.name,t.comment,t.isFavorite)},e}]),angular.module("rainbow").factory("Invitation",["userInfoService",function(e){"use strict";function t(t,n,r,i,a,o,s,c,l,u,d){this.id=t,this.invitedUserId=n,this.invitedUserEmail=r,this.invitingUserId=i,this.invitingUserEmail=a,this.requestNotificationLanguage=o,this.invitingDate=s,this.lastNotificationDate=c,this.status=l,this.type=u,this.defaultAvatar=null,this.inviteToJoinMeeting=d,this.createDefaultAvatar=function(){if(!this.defaultAvatar&&this.invitedUserEmail){var t=e.computeUserColor(this.invitedUserEmail),n=this.invitedUserEmail.substring(0,2).toUpperCase();this.defaultAvatar=e.createDefaultAvatarImage(n,t)}}}return t.create=function(e,n,r,i,a,o,s,c,l,u,d){return new t(e,n,r,i,a,o,s,c,l,u,d)},t.createFromData=function(e){var n=new t(e.id,e.invitedUserId,e.invitedUserEmail,e.invitingUserId,e.invitingUserEmail,e.requestNotificationLanguage,e.invitingDate,e.lastNotificationDate,e.status,e.type,e.inviteToJoinMeeting);return n.createDefaultAvatar(),n},t}]),angular.module("rainbow").factory("VoiceMail",["profileService",function(e){"use strict";function t(){this.VMFlag=!1,this.VMCounter=0,this.infoMsg="",this.voiceMailFeatureEnabled=e.isFeatureEnabled(e.FeaturesEnum.TELEPHONY_VOICE_MAIL),this.setVMFlag=function(e){this.VMFlag=e},this.getVMFlag=function(){return this.VMFlag},this.setVMCounter=function(e){e>0?(this.VMFlag=!0,this.VMCounter=e):this.VMCounter=0},this.getVMCounter=function(){return this.VMCounter},this.setInfoMsg=function(e){this.infoMsg=e},this.getInfoMsg=function(){return this.infoMsg},this.getDisplayState=function(){return this.voiceMailFeatureEnabled}}return t.create=function(){return new t},t}]),angular.module("rainbowAdmin").factory("Offer",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,u){this.id=e,this.name=t,this.description=n,this.offerReference=r,this.profileId=i,this.canBeSold=a||!1,this.businessModel=o,this.isPrepaid=l,this.prepaidDuration=u,this.isDefault=s,this.isExclusive=c;var d=this.name.toLowerCase();d&&(-1!==d.indexOf("enterprise")?d="enterprise":-1!==d.indexOf("business")?d="business":-1!==d.indexOf("conference")&&(d="conference")),this.logo="logo-offer-"+d+".svg",this.isEnterprise=function(){return this.name.toLowerCase().startsWith("enterprise")},this.isBusiness=function(){return this.name.toLowerCase().startsWith("business")},this.isEssential=function(){return this.name.toLowerCase().startsWith("essential")}}return e.createFromData=function(t){return new e(t.id,t.name,t.description,t.offerReference,t.profileId,t.canBeSold,t.businessModel,t.isDefault,t.isExclusive,t.isPrepaid,t.prepaidDuration)},e.createFromSubscriptionData=function(t){return new e(t.offerId,t.offerName,void 0,t.offerReference,t.profileId,t.canBeSold,t.businessModel,t.isDefault,t.isExclusive,t.isPrepaid,void 0)},e.createFromSubscriptionCountersData=function(t){return new e(t.offerId,t.offerName,void 0,t.offerReference,void 0,t.canBeSold,t.businessModel,t.isDefault,t.isExclusive,t.isPrepaid,t.prepaidDuration)},e.createFromProfileData=function(t){return new e(t.offerId,t.offerName,void 0,void 0,t.profileId,!1,void 0,t.isDefault,t.isExclusive,t.isPrepaid,t.prepaidDuration)},e.createFromOperationLog=function(t){var n="delete"===t.operationType?t.previousData:t.newData;return new e(n.offerId,n.offerName,n.offerDescription,n.offerReference,n.profileId,n.canBeSold,n.businessModel,n.isDefault,n.isExclusive,n.isPrepaid,n.prepaidDuration)},e.offerComparator=function(e,t){var n=["Essential","Business","Enterprise","Conference"],r=n.findIndex(function(t){return e.name.startsWith(t)}),i=n.findIndex(function(e){return t.name.startsWith(e)});return(r=-1===r?n.length:r)<(i=-1===i?n.length:i)?-1:r>i?1:e.name>t.name?r===n.length?1:-1:e.name<t.name?r===n.length?-1:1:0},e.isExclusive=function(e){return e.isDefault||e.isExclusive},e.isOptional=function(t){return!e.isExclusive(t)},e.isEssential=function(e){return e.isEssential()},e.isNotEssential=function(e){return!e.isEssential()},e.isModelByNbUser=function(e){return"nb_users"===e.businessModel},e.isPrepaid=function(e){return e.isPrepaid},e.isNotPrepaid=function(e){return!e.isPrepaid},e}]),angular.module("rainbow").factory("Organisation",[function(){"use strict";function e(e,t,n){this.id=e,this.name=t,this.visibility=n,this.companies=[]}return e.createFromData=function(t){return new e(t.id,t.name,t.visibility)},e}]),angular.module("rainbow").factory("Site",[function(){"use strict";function e(e,t,n,r,i,a){this.id=e,this.name=t||"",this.status=n||"",this.companyId=r||"",this.settings=i||"",angular.isDefined(a)&&(this.isCentrex=a)}return e.createFromData=function(t){return new e(t.id,t.name,t.status,t.companyId,t.settings,t.isCentrex)},e.create=function(t,n,r,i){return new e(t,n,r,i)},e.StatusValues=["active","alerting","hold","terminated"],e}]),angular.module("rainbow").factory("System",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,u,d,f,h,p,v,m){this.id=e||null,this.jid_pbxagent=n||"",this.jid_password=r||"",this.pbxMainBundlePrefix=i||["0"],this.usePbxMainBundlePrefix=!angular.isDefined(p)||p,this.pbxNumberingTranslator=v||[],this.type=o||null,this.country=u||"FRA",this.name=d||"",this.jid_pbxagent_password=f||"",this.jid_pbxagent_password_activating=h||"",l&&(this.siteId=l),t&&(this.pbxId=t),a&&(this.serverPingTimeout=a),s&&(this.status=s),c&&(this.version=c),angular.isDefined(m)&&(this.isCentrex=m)}return e.createFromData=function(t){return new e(t.id,t.pbxId,t.jid_pbxagent,t.jid_password,t.pbxMainBundlePrefix,t.serverPingTimeout,t.type,t.status,t.version,t.siteId,t.country,t.name,t.jid_pbxagent_password,t.jid_pbxagent_password_activating,t.usePbxMainBundlePrefix,t.pbxNumberingTranslator,t.isCentrex)},e.create=function(){return new e},e.StatusValues=["created","activating","activated"],e}]),angular.module("rainbow").filter("serverTypeFilter",[function(){"use strict";return function(e){return"oxo"===e?"OXO Connect":"oxe"===e?"OmniPCX Enterprise":"third_party"===e?"Third party PBX":e}}]),angular.module("rainbow").filter("systemStateFilter",[function(){"use strict";return function(e){return"created"===e?"pending":"activating"===e?"connecting":"activated"===e?"normal":void 0}}]),angular.module("rainbow").filter("systemStateColorFilter",[function(){"use strict";return function(e){return"created"===e?"color_orange":"activating"===e?"color_red":"activated"===e?"color_green":void 0}}]),angular.module("rainbow").factory("SystemsGroup",[function(){"use strict";function e(e,t,n,r){this.id=e||null,this.name=t,this.companies=n||[],this.systems=r,this.containsSystem=function(e){return!!this.systems&&this.systems.some(function(t){return t.systemId===e})}}return e.createFromData=function(t){return new e(t.id,t.name,t.companies,t.systems)},e.create=function(t,n,r,i){return new e(t,n,r,i)},e}]),angular.module("rainbow").factory("User",["Subscription","userInfoService",function(e,t){"use strict";function n(n,r,i,a,o,s,c,l,u,d,f,h,p,v,m,g,E,S,C,b,R,y,N,T,A,I,O){this.id=n||null,this.loginEmail=r||"",this.firstName=i||"",this.lastName=a||"",this.displayName=o||"",this.nickName=s||"",this.title=c||"",this.jobTitle=l||"",this.companyId=u||"",this.companyName=d||"",this.siteId=f||"",this.systemId=h||"",this.accountType=p||"free",this.country=v||"FRA",this.timezone=m||"Europe/Paris",this.emails=g||[],this.phoneNumbers=E||[],this.roles=S||["user"],this.adminType=C||"company_admin",this.isActive=b||!1,this.isInitialized=R||!1,this.password=y||y,this.jid_im=N||"",this.jid_tel=T||"",this.language=A||null,this.lastAvatarUpdateDate=I,this.visibility=O,this.subscriptions=[],this.fillSubscriptionMap=function(){var e={};this.subscriptions.forEach(function(t){e[t.id]=t}),this.subscriptionMap=e},this.fillMainSubscriptionField=function(){var t=this.subscriptions.filter(e.isExclusive).sort(e.subscriptionComparator);this.mainSubscriptionName=t[t.length-1].offerName;var n=this.subscriptions.filter(e.isOptional).map(function(e){return e.offerName}).join(", ");n&&n.length&&(this.optionalSubscriptionNames=n),this.subscriptionNames=this.mainSubscriptionName+(this.optionalSubscriptionNames?", "+this.optionalSubscriptionNames:"")},this.getMainSubscriptionName=function(){return this.mainSubscriptionName||this.fillMainSubscriptionField(),this.mainSubscriptionName},this.getOptionalSubscriptionNames=function(){return this.mainSubscriptionName||this.fillMainSubscriptionField(),this.optionalSubscriptionNames},this.hasUserRoleOnly=function(){return 1===this.roles.length&&-1!==this.roles.indexOf("user")},this.isAdmin=function(){return-1!==this.roles.indexOf("admin")},this.isOrganizationAdmin=function(){return!!this.isAdmin()&&"organization_admin"===this.adminType},this.isSiteAdmin=function(){return!!this.isAdmin()&&"site_admin"===this.adminType},this.isCompanyAdmin=function(){return!!this.isAdmin()&&"company_admin"===this.adminType},this.isBPAdmin=function(){return this.isBPAdminOperations()||this.isBPAdminFinance()},this.isBPAdminOperations=function(){return-1!==this.roles.indexOf("bp_admin")},this.isBPAdminFinance=function(){return-1!==this.roles.indexOf("bp_finance")},this.computeDisplayName=function(){var e=t.getNameInformation(this.firstName,this.lastName);this.displayName=e.displayName,this.initials=e.initials}}return n.createFromData=function(t){var r=new n(t.id,t.loginEmail,t.firstName,t.lastName,t.displayName,t.nickName,t.title,t.jobTitle,t.companyId,t.companyName,t.siteId,t.systemId,t.accountType,t.country,t.timezone,t.emails,t.phoneNumbers,t.roles,t.adminType,t.isActive,t.isInitialized,t.password,t.jid_im,t.jid_tel,t.language,t.lastAvatarUpdateDate,t.visibility);return t.profiles&&(t.profiles.forEach(function(t){var n=e.createFromData(t);r.subscriptions.push(n)}),r.fillMainSubscriptionField()),r.computeDisplayName(),r},n.create=function(){return new n},n.prune=function(e,t){var n=Object.assign({},e);return t&&(t.isSuperadmin()||t.isAdmin()||t.isBPAdminOperations()||t.isBPAdminFinance())&&t.dbId===e.id&&delete n.roles,n},n.VisibilityValues=["private","public"],n}]),angular.module("rainbow").factory("Subscription",["Offer",function(e){"use strict";function t(e,t,n,r,i,a,o,s,c,l,u,d,f,h,p,v,m,g,E,S,C,b){this.id=e,this.offerId=t,this.offerName=n,this.offerReference=r,this.profileId=i,this.profileName=a,this.maxNumberUsers=o,this.numberAssignedUsers=s,this.status=c,this.syncOngoing=l||!1,this.updatingMaxNumberUsers=u,void 0!==d&&(this.nbBPLicences=d),void 0!==f&&(this.nbAssignedBPUsers=f),void 0!==h&&(this.nbLicencesAssignedToECs=h),void 0!==p&&(this.nbLicencesUsed=p),void 0!==v&&(this.nbFreeLicences=v),this.businessModel=m,this.canBeSold=g,this.isPrepaid=C,this.expirationDate=b,this.isDefault=E,this.isExclusive=S,this.isEnterprise=function(){return this.offerName.toLowerCase().startsWith("enterprise")},this.isBusiness=function(){return this.offerName.toLowerCase().startsWith("business")},this.isEssential=function(){return this.offerName.toLowerCase().startsWith("essential")},this.isTerminated=function(){return"terminated"===this.status}}return t.createFromData=function(e){return new t(e.id?e.id:e.subscriptionId,e.offerId,e.offerName,e.offerReference,e.profileId,e.profileName,e.maxNumberUsers,e.numberAssignedUsers,e.status,e.syncOngoing,e.updatingMaxNumberUsers,e.nbBPLicences,e.nbAssignedBPUsers,e.nbLicencesAssignedToECs,e.nbLicencesUsed,e.nbFreeLicences,e.businessModel,e.canBeSold,e.isDefault,e.isExclusive,e.isPrepaid,e.expirationDate)},t.subscriptionComparator=function(t,n){var r=new e(t.offerId,t.offerName,null,null,t.profileId,t.canBeSold,t.businessModel,t.isDefault,t.isExclusive,t.isPrepaid),i=new e(n.offerId,n.offerName,null,null,n.profileId,n.canBeSold,n.businessModel,n.isDefault,n.isExclusive,n.isPrepaid);return e.offerComparator(r,i)},t.isExclusive=function(e){return e.isDefault||e.isExclusive},t.isOptional=function(e){return!t.isExclusive(e)},t.withLicenses=function(e){return e.isEssential()||"nb_users"!==e.businessModel||e.maxNumberUsers>0},t}]),angular.module("rainbow").factory("IceServer",[function(){"use strict";function e(e,t,n,r){this.id=e,this.urls=t,this.username=n,this.credential=r}return e.createFromData=function(t){return new e(t.id,t.urls,t.username,t.credential)},e}]),angular.module("rainbow").factory("PhoneNumber",[function(){"use strict";function e(e,t,n,r,i,a,o,s,c,l,u,d,f,h,p,v,m,g){this.id=e,this.shortNumber=t,this.number=n,this.numberE164=r,this.pbxUserId=i,this.userId=a,this.type=o,this.deviceType=s,this.pbxId=c,this.isFromSystem=l,this.isMonitored=u,this.systemId=d,this.country=f,this.voiceMailNumber=h,this.deviceName=p,this.firstName=v,this.lastName=m,this.internalNumber=g}return e.createFromData=function(t){return new e(t.id?t.id:t.phoneNumberId,t.shortNumber,t.number,t.numberE164,t.pbxUserId,t.userId,t.type,t.deviceType,t.pbxId,t.isFromSystem,t.isMonitored,t.systemId,t.country,t.voiceMailNumber,t.deviceName,t.firstName,t.lastName,t.internalNumber)},e}]),angular.module("rainbow").service("helpersService",[function(){"use strict";this.findIndex=function(e,t){return e.findIndex(t)}}]),angular.module("rainbow").service("userInfoService",["$q","$log","$interval","$rootScope","settingsService",function(e,t,n,r,i){"use strict";var a=this;a.userColors=["#ff4500","#d38700","#348833","#007356","#00b2a9","#00b0e5","#0085ca","#6639b7","#91278a","#cf0072","#a50034","#d20000"],a.getAvatarImage=function(i,o,s,c,l){return e(function(e){l=void 0!==l&&l;var u=o?a.createDefaultAvatarImage(o,s):null;if(l){var d=config.webservices.protocol+"://"+config.webservices.currentServer;r.cdn&&(d=r.cdnServer);var f=d+"/api/avatar/"+i+"?size="+(c||256);l&&(f+="&update="+MD5.hexdigest(l));var h=new Image;h.onload=function(){var r=this;n(function(){t.log("[avatarService] Load avatar for "+i+" success"),e(r)},1,1)},h.onerror=function(){n(function(){t.warn("[avatarService] Load avatar for "+i+" failure : use text avatar"),e(u)},1,1)},h.src=f}else e(u)})},a.getNameInformation=function(e,t){var n={displayName:"",initials:""};return 1!==t.length&&2!==e.length?"firstLast"===i.getSetting("displayOrder")?(n.displayName=e+" "+t,n.initials=e.charAt(0).toUpperCase()+t.charAt(0).toUpperCase()):(n.displayName=t+" "+e,n.initials=t.charAt(0).toUpperCase()+e.charAt(0).toUpperCase()):("firstLast"===i.getSetting("displayOrder")?n.displayName=e+" "+t:n.displayName=t+" "+e,n.initials=e.charAt(0).toUpperCase()+e.charAt(1).toUpperCase()),n},a.createDefaultAvatarImage=function(e,t){var n=new Image,r=document.createElement("canvas");r.width=n.width=225,r.height=n.height=225;var i=r.getContext("2d");return i.rect(0,0,225,225),i.fillStyle=t,i.fill(),i.font="bold 100px Helvetica",i.textAlign="center",i.fillStyle="white",i.fillText(e,110,150),n.src=r.toDataURL("image/png"),n},a.computeUserColor=function(e){try{for(var n={colorIndex:0,color:a.userColors[0]},r=e.toUpperCase(),i=0,o=0;o<r.length;o++)i+=r.charCodeAt(o);n.colorIndex=i%12,n.color=a.userColors[n.colorIndex]}catch(e){t.error("[UserInfoService] computeUserColor failure"),n.colorIndex=1,n.color=a.userColors[n.colorIndex]}return n}}]),angular.module("rainbow").service("errorHelperService",["$filter",function(e){"use strict";var t=this;t.ErrorCodeLabels={0:"errorNoServerResponse",400210:"invalidPhoneNumber",400400:"errorWrongPassword",400504:"companyNameAlreadyExist",400505:"BPCompanyWithoutPaymentConfigurationData",400506:"NoActiveSubscriptionToOffer",400511:"ActiveDirectoryDomainAlreadyUsed",400552:"BPCompanyAndECCompanyMustNotBeSame",400973:"noCreateUserPermission",400975:"userAlreadyExistsInOtherCompany",400983:"userAlreadyExistsInOtherCompany",400990:"noUserFound",400993:"noUserFound",401202:"errorInvalidToken",401500:"errorUnauthorized",401501:"errorLoginForbidden",401510:"errorUserUnauthorized",401520:"errorUserNotActive",401521:"errorUserNotActive",403000:"accessDeniedNotRequiredRole",403001:"accessDeniedNotOwner",403200:"notAllowedToChangeRole",403203:"notAllowedToChangeRole",403204:"notAllowedToMoveExistingUserToThisCompany",403301:"notAllowedToManageCompany",403304:"notAllowedToAddAnotherAdmin",403500:"notAllowedBlacklistedEmail",403501:"notAllowedBlacklistedEmail",403503:"NotAllowedSelfRegistrationEmail",403504:"notAllowedLoggedInUserEmail",403507:"notAllowedSupportEmail",403513:"companyNotABpCompany",403516:"companyNotABpCompany",403517:"companySeenAsTerminated",403518:"companyBpTypeIncompatible",403519:"companyAlreadyLinkedToBp",403520:"companyNotVadBp",403531:"resetPasswordBlocked",403532:"resetPasswordForbidden",403608:"errorAssignSubscriptionSyncOngoing",403609:"errorAssignSubscriptionSyncOngoing",403610:"maxSubscriptionAllocationReached",403615:"maximumNumberConferenceParticipantsReach",403616:"subscriptionCompanyAdminEssentialAlreadyExists",403617:"roleCompanyAdminEssentialAlreadyExists",403620:"MaximumNumberRoomUsersReach",403630:"uploadErrorMaxQuotaReached",403655:"userAlreadyCompanyMember",403700:"errorDeleteSiteWithSystems",403701:"errorDeleteOrganisationLinkedCompany",403702:"errorDeleteCompanyWithSubscriptions",403703:"errorDeleteCompanyWithSites",403704:"errorDeleteCompanyWithUsers",403705:"errorDeleteCompanyStillTerminated",403706:"errorRemoveBusinessPartnerRole",404000:"resourceNotFound",404001:"resourceNotFoundUpdateImpossible",404002:"resourceNotFoundDeleteImpossible",404300:"noValidOfferReferenceInACTISFile",404301:"offerNotFound",409000:"userAlreadyCreated",409011:"noMessagesToExport",409552:"internalNumberAlreadyUsed",409600:"userAlreadyExist",409601:"invitationReSentConflict",409602:"userAlreadyNetworkMember",409603:"invitationReSentConflict",409620:"offerAlreadySubscribed",409800:"companyNotIrBp",409801:"companyNotLinkedToBp",409802:"actisCompanyAdminMismatch",409803:"actisCompanyNameMismatch",413000:"uploadErrorTooLarge",500:"errorInternalServerError",1001:"extensionNotLinkedToEquipment",1002:"extensionHasNoIdentifier",1003:"extensionDoesNotExist",1004:"extensionLookupFailure",1005:"extensionConflict",1006:"nonUniqueEquipmentForExtension",1007:"userAlreadyAssociatedToExtension",1008:"extensionAssociatedToAnotherUser",1009:"failedToAttachExtension",1010:"userHasNoExtension",1011:"userHasTooManyExtensions",1012:"failedToDetachExtension"},t.handleErrorMessage=function(e,n){t.getErrorFullMessage(e,n)},t.handleError=function(e,n){var r=e.status;e.data&&e.data.errorDetailsCode&&(r=e.data.errorDetailsCode);var i=new Error(t.getDetailedErrorMessage(e));return i.status=e.status,i.fieldErrors=t.getBadRequestFieldErrors(e),i.errorDetailsCode=r,i.errorDetailsLabel=t.getErrorCodeLabel(r),i.translatedMessage=t.getTranslatedErrorMessage(e,n),i},t.getBadRequestFieldErrors=function(e){var n={};return 400===e.status&&(e.data&&e.data.errorDetails instanceof Array&&e.data.errorDetails.forEach(function(e){n[e.param]||(n[e.param]={ok:!1,message:e.msg,value:e.value})}),e.data&&400511===e.data.errorDetailsCode&&(n.office365Tenant={ok:!1,message:t.ErrorCodeLabels[400511]})),n},t.getErrorMessage=function(e){var n=t.getStatusErrorMessage(e);return e.data&&e.data.errorMsg&&(n="",e.data.errorDetails?e.data.errorDetails instanceof Array?n+="one or more fields are invalid":e.data.errorDetails.msg?n+=e.data.errorDetails.msg:n+=e.data.errorDetails:n+=e.data.errorMsg),n},t.getStatusErrorMessage=function(e){return 500===e.status?"Internal server error":415===e.status?"Unsupported Media Type":413===e.status?"Request Entity Too Large":404===e.status?"Resource not found":403===e.status?"Access is forbidden":401===e.status?"Authorization failure":400===e.status?"Bad request":e.statusText?e.statusText:"Unknown error"},t.getDetailedErrorMessage=function(e){var n=t.getErrorMessage(e);return e.data&&e.data.errorDetails&&e.data.errorDetails instanceof Array&&e.data.errorDetails.length>0&&(n+=" : "+e.data.errorDetails[0].msg),n},t.getTranslatedErrorMessage=function(e,n){if(500===e.status)return t.getLocalizedError("500");var r=null;e.data&&e.data.errorDetailsCode&&(r=e.data.errorDetailsCode);var i=null;return i=e.data&&e.data.errorDetailsData?Object.assign(e.data.errorDetailsData,n):n,t.getTranslatedErrorMessageByDetailsCode(r,i,t.getErrorMessage(e))},t.getTranslatedErrorMessageByDetailsCode=function(n,r,i){var a;return n&&(a=t.getLocalizedError(n,r)),a||(a=n?e("translate")("anErrorOccurred",{errorcode:n}):e("translate")("anErrorOccurred"),i&&(a+=" ("+e("translate")(i)+")")),a},t.getLocalizedError=function(n,r){var i;if(n){var a=t.getErrorCodeLabel(n);if(a){var o=e("translate")(a,r);o!==a&&(i=o)}}return i},t.getErrorCodeLabel=function(e){return t.ErrorCodeLabels[e]},t.getErrorFullMessage=function(e,t){var n=t?t+" failure : ":"";return e.data?(n+=e.data.errorMsg,e.data.errorDetails&&(n+=" - ",e.data.errorDetails instanceof Array?e.data.errorDetails.forEach(function(e){n+=e.msg}):e.data.errorDetails.msg?n+=e.data.errorDetails.msg:n+=e.data.errorDetails)):n+="Unknow error - Something goes really wrong",n}}]),angular.module("rainbow").service("pushImageHelperService",["$log","$q","$http","authService","errorHelperService",function(e,t,n,r,i){"use strict";var a=this;a.pushImage=function(o,s,c){return t(function(l,u){var d=null;if(c&&c.nosize)d=function(){var e=new Image;return e.src=s,t.when(e)};else{var f=c&&c.width?c.width:512,h=c&&c.height?c.height:512;d=function(){return a.resizeImage(s,f,h)}}d().then(function(t){var s=a.getBinaryData(t);n({method:"POST",url:o,headers:r.getPostHeader("image/"+s.type),data:s.data,transformRequest:[]}).then(function(){e.info("[pushImageHelperService] pushImage : success"),l()},function(t){var n=i.handleError(t);u(n),e.error("[pushImageHelperService] "+i.getErrorFullMessage(t,"pushImage"))})})})},a.resizeImage=function(e,n,r){return t(function(t){var i=new Image;i.src=e,i.onload=function(){var e=i.width,a=i.height;e>a?e>n&&(a*=n/e,e=n):a>r&&(e*=r/a,a=r);var o=document.createElement("canvas");o.width=e,o.height=a,i.width=e,i.height=a,o.getContext("2d").drawImage(this,0,0,e,a);var s=new Image;s.src=o.toDataURL("image/png"),t(s)}})},a.getBinaryData=function(e){for(var t=e.src.indexOf("image/")+6,n=e.src.indexOf(";base64,"),r=e.src.slice(n+8),i=e.src.slice(t,n),a=window.atob(r),o=a.length,s=new Uint8Array(o),c=0;c<o;c++)s[c]=a.charCodeAt(c);return{type:i,data:s}}}]),angular.module("rainbow").service("$localStorage",["$q",function(e){"use strict";this.get=function(t){for(var n={},r=0;r<t.length;r++)n[t[r]]=localStorage.getItem(t[r]);return e.when(n)},this.set=function(t){for(var n=Object.keys(t),r=0;r<n.length;r++)localStorage.setItem(n[r],t[n[r]]);return e.when()},this.remove=function(t){for(var n=0;n<t.length;n++)localStorage.removeItem(t[n]);return e.when()}}]),angular.module("rainbow").service("authService",["$http","$q","$window","$log","$localStorage","$interval","$rootScope","jwtHelper","settingsService",function(e,t,n,r,i,a,o,s,c){"use strict";var l=this;l.onInit=function(){r.info("[authService] === INITIALIZATION ==="),l.login=null,l.token=null,l.jidIm=null,l.jidTel=null,l.jidPwd=null,l.initialized=null,l.renewAppTokenInterval=null,l.renewTokenInterval=null,l.userData=null,l.firstUse=null===localStorage.getItem("firstUse"),l.browserFingerprint=null,l.isGuest=!1,config.appModuleKey||(config.appModuleKey=angular.module("rainbow").moduleIds?angular.module("rainbow").moduleIds.join(""):"default"),l.sdkHostForced=null,l.appToken=null,l.fromSDK=!1,l.firstUseNewVersion=!1;var e=localStorage.getItem("version");l.getMajorVersion(e)!==l.getMajorVersion(version)&&(l.firstUseNewVersion=!0),i.set({version:version})},l.getMajorVersion=function(e){if(!e)return null;var t=/\d+\.\d+/g.exec(e);return t&&t.length>0?t[0]:null},l.registerEventsHandler=function(){l.visibilityHandlerRemoval&&l.visibilityHandlerRemoval(),l.visibilityHandlerRemoval=o.$on("ON_APP_VISIBLE_CHANGE_EVENT",function(e,t){t&&l.startTokenSurvey()})},l.isInitialized=function(){return l.initialized},l.isFirstUse=function(){return l.firstUse},l.getRequestHeader=function(){var e={Authorization:"Bearer "+l.token,Accept:"application/json"};return l.fromSDK&&l.appToken,e},l.getRequestHeaderWithRange=function(e){var t=l.getRequestHeader();return t.Range=e,t},l.getPostHeader=function(e){var t=l.getRequestHeader(),n=e||"application/json";return t["Content-Type"]=n,t},l.getPostHeaderWithRange=function(e,t){var n=l.getPostHeader(t);return n["Content-Range"]=e,n},l.authenticateOnHost=function(e,t,n,r,i){return l.sdkHostForced=n,l.appToken=r,l.fromSDK=!0,i?(config.xmpp.currentServer=l.sdkHostForced,config.webservices.currentServer=l.sdkHostForced,config.restServerUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port,l.authenticateWithToken(i)):l.authenticate(e,t,!1)},l.authenticate=function(e,n,i,a){return t(function(t,o){r.info('[authService] authenticate with "'+e+'"'),l.getLocalStorageAuthInfo(!1).then(function(){return l.logon(e,n,i,a)}).then(function(){l.registerEventsHandler(),t()}).catch(function(e){r.error("[authService] authenticate failure -- "+e.message),o(e)})})},l.logon=function(a,s,c,u){return t(function(t,d){var f={Authorization:"Basic "+n.btoa(a+":"+s),Accept:"application/json"};config.rainbowApiClientKey&&(f["x-rainbow-app-auth"]="Basic "+n.btoa(config.rainbowApiClientKey+":"+CryptoJS.SHA256(config.appModuleKey+s))),l.fromSDK&&l.appToken&&l.appToken.appID&&(f["x-rainbow-app-auth"]="Basic "+n.btoa(l.appToken.appID+":"+CryptoJS.SHA256(l.appToken.appSecret+s))),e({method:"GET",withCredentials:!0,url:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/authentication/v1.0/login",headers:f,timeout:15e3}).then(function(e){if(r.info('[authService] authenticate with "'+a+'" success'),o.disconnected=!1,l.userData=e.data.loggedInUser,l.token=e.data.token,l.userId=e.data.loggedInUser.id,l.login=e.data.loggedInUser.loginEmail,l.jidIm=e.data.loggedInUser.jid_im,l.jidTel=e.data.loggedInUser.jid_tel,l.jidPwd=e.data.loggedInUser.jid_password,l.initialized=e.data.loggedInUser.isInitialized,l.companyId=e.data.loggedInUser.companyId,l.firstUse=!1,l.handleUserLanguage(),i.set({firstUse:"false"}),c){r.info("[authService] store credentials");var n=(u?"guest_":"")+l.token;i.set({token:n,login:l.login,id:l.userId}),l.startTokenSurvey(!0)}else l.removeCredentials();l.isGuest=u||!1,t()},function(e){var t='authenticate for login "'+a+'" failure : ',n="errorUltimateUnknownError";e||(t+="Ultimate unknown error"),0===e.status||-1===e.status?(t+="No server response",n="errorNoServerResponse"):401===e.status?(l.removeCredentials(),t+=e.data.errorDetails,401500===e.data.errorDetailsCode?n="errorUnauthorized":401501===e.data.errorDetailsCode&&(n="errorLoginForbidden")):500===e.status&&(t+=e.data.errorDetails,n="errorInternalServerError"),r.info("[authService] "+t),d(new RBError(t,n))})})},l.authenticateWithToken=function(e){e&&e.startsWith("guest_")&&(l.isGuest=!0,e=e.substring(6));var n=s.decodeToken(e);return l.token=e,l.login=n.user.loginEmail,l.userId=n.user.id,t(function(e,t){l.startTokenSurvey().then(function(){return l.getUserData()}).then(function(){l.registerEventsHandler(),e()}).catch(function(e){var n=e?e.message:"unknown error";r.error("[authService] authenticateWithToken failure -- "+n),t()})})},l.authenticateWithLocalCredentials=function(){return t(function(e,t){l.getLocalStorageAuthInfo(!0).then(function(){return l.startTokenSurvey()}).then(function(){return l.getUserData()}).then(function(){l.registerEventsHandler(),e()}).catch(function(e){r.error("[authService] authenticateWithLocalCredentials failure -- "+e.message),t()})})},l.getLocalStorageAuthInfo=function(e){return t(function(t,n){i.get(["token","appToken","login","server","support","id"]).then(function(i){r.info("[authService] get authentication token"),i.server&&"null"!==i.server&&"undefined"!==i.server?(config.xmpp.currentServer=i.server,config.webservices.currentServer=i.server):l.sdkHostForced?(config.xmpp.currentServer=l.sdkHostForced,config.webservices.currentServer=l.sdkHostForced):(config.xmpp.currentServer=config.xmpp.server,config.webservices.currentServer=config.webservices.server),config.restServerUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port,e?(l.token=i.token,l.token&&l.token.startsWith("guest_")&&(l.isGuest=!0,l.token=l.token.substring(6)),l.appToken=i.appToken,l.login=i.login,l.userId=i.id,l.token&&l.login?t():n(new Error("No existing token"))):t()})})},l.startTokenSurvey=function(){return t(function(e,t){l.startAppTokenSurvey().then(function(){return l.startUserTokenSurvey()}).then(function(){r.debug("[authService] startTokenSurvey success"),e()}).catch(function(e){e&&e.message||(e=new Error("Unknown error")),r.error("[authService] startTokenSurvey failure -- "+e.message),t(e)})})},l.startUserTokenSurvey=function(e){var n=s.decodeToken(l.token),i=1e3*n.exp,c=(i-1e3*n.iat)/2,u=new Date(i),d=i-(new Date).valueOf();if(e&&r.info("[authService] on logon"),r.info("[authService] Extract auth token info (countRenewed: "+n.countRenewed+", maxTokenRenew: "+n.maxTokenRenew+", tokenExpirationDuration: "+d+")"),d<0)return r.info("[authService] auth token has already expired, display login page"),l.renewTokenInterval&&a.cancel(l.renewTokenInterval),l.token=null,o.$broadcast("ON_AUTH_TOKEN_EXPIRE"),t.reject(new Error("Token expired"));if(d<c)return r.info("[authService] auth token will expire in less "+c/1e3+" seconds, re-new it immediately"),l.renewAuthToken();var f=d-c;return r.info("[authService] start auth token survey (expirationDate: "+u+" tokenExpirationDuration: "+d+"ms usedExpirationDuration: "+f+"ms)"),l.renewTokenInterval&&a.cancel(l.renewTokenInterval),l.renewTokenInterval=a(function(){l.renewAuthToken()},f),t.resolve()},l.renewAuthToken=function(){return t(function(t,n){r.info("[authService] re-new authentication token"),e({method:"GET",url:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/authentication/v1.0/renew",headers:l.getRequestHeader()}).then(function(e){r.info("[authService] renew authentication token success"),l.token=e.data.token,i.set({token:l.token}),o.$broadcast("ON_AUTH_TOKEN_RENEW"),l.startTokenSurvey(),t()},function(e){var t="renew authentication token failure -- "+(e.data&&e.data.errorDetails?e.data.errorDetails:"no details"),i=new Error(t);i.details="AUTH_TOKEN_EXPIRED",r.error("[authService] "+t),a.cancel(l.renewTokenInterval),o.$broadcast("ON_AUTH_TOKEN_EXPIRE"),n(i)})})},l.startAppTokenSurvey=function(){if(!l.appToken||"string"!=typeof l.appToken||!l.appToken.length)return r.info("[authService] No application token."),t.resolve();var e=s.decodeToken(l.appToken),n=1e3*e.exp,i=new Date(n),o=n-(new Date).valueOf();if(r.info("[authService] Extract application token info (countRenewed: "+e.countRenewed+", maxTokenRenew: "+e.maxTokenRenew+")"),o<0)return r.info("[authService] application token has already expired, re-new it immediately"),l.renewAppToken();if(o<3e4)return r.info("[authService] application token will expire in less 5 minutes, re-new it immediately"),l.renewAppToken();var c=o-24e3;return r.info("[authService] start application token survey (expirationDate: "+i+" tokenExpirationDuration: "+o+"ms usedExpirationDuration: "+c+"ms)"),l.renewAppTokenInterval&&a.cancel(l.renewAppTokenInterval),l.renewAppTokenInterval=a(function(){l.renewAppToken()},c),t.when()},l.renewAppToken=function(){return t(function(t,n){r.info("[authService] re-new application token"),e({method:"GET",url:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/applications/v1.0/authentication/renew",headers:l.getRequestHeader()}).then(function(e){r.info("[authService] renew application token success"),l.appToken=e.data.token,i.set({appToken:l.appToken}),o.$broadcast("ON_APP_TOKEN_RENEW"),l.startAppTokenSurvey(),t()},function(e){var t="renew application token failure -- "+(e.data&&e.data.errorDetails?e.data.errorDetails:"no details"),i=new Error(t);i.details="APP_TOKEN_EXPIRED",r.error("[authService] "+t),a.cancel(l.renewAppTokenInterval),o.$broadcast("ON_APP_TOKEN_EXPIRE"),n(i)})})},l.getUserData=function(){return t(function(t,n){e({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+l.userId,headers:l.getRequestHeader()}).then(function(e){l.userData=e.data.data,l.login=e.data.data.loginEmail,l.jidIm=e.data.data.jid_im,l.jidTel=e.data.data.jid_tel,l.jidPwd=e.data.data.jid_password,l.initialized=e.data.data.isInitialized,l.companyId=e.data.data.companyId,l.handleUserLanguage(),t(l.userData)},function(e){l.removeCredentials(),n(new Error("Wrong token -- "+e.message))})})},l.connectedAsGuest=function(){o.guestBannerVisible=!0,o.mainContainerClass="mainContainerWithGuestbanner"},l.connectedAsRegularUser=function(){o.guestBannerVisible=!1,o.mainContainerClass=""},l.getFingerPrint=function(){return t(function(e){if(l.browserFingerprint)e(l.browserFingerprint);else{imprint.test(["audio","canvas","cookies","cpuClass","doNotTrack","indexedDb","installedFonts","language","localStorage","platform","plugins","processorCores","sessionStorage","timezoneOffset","touchSupport","userAgent","webGl"]).then(function(t){l.browserFingerprint=t,e(t)})}})},l.handleUserLanguage=function(){var e=l.userData.language;e&&c.setAppliLangageCodeFromServer(e)},l.removeCredentials=function(){r.info("[authService] remove credentials"),i.remove(["token","id"]),l.connectedAsRegularUser(),l.isGuest=!1},l.onInit()}]);var REQUEST_TIMEOUT=1e4;angular.module("rainbow").service("xmppService",["$rootScope","$log","$q","$interval","authService","randomString",function(e,t,n,r,i,a){"use strict";var o=this;o.disconnectionHandler=null,Strophe.log=function(e,n){switch(e){case Strophe.LogLevel.WARN:t.warn(n);break;case Strophe.LogLevel.ERROR:case Strophe.LogLevel.FATAL:t.error(n);break;default:t.debug(n)}},o.start=function(e){t.info(""),t.info("[xmppService] === STARTING ===");var r=performance.now();o.started=!1,o.connected=!1,o.stropheStatus=null,o.presenceStatus="offline";var a=config.xmpp.pingInterval?config.xmpp.pingInterval:6e4;return this.pingTimeout=2*a,o.serverURL=config.xmpp.protocol+"://"+config.xmpp.currentServer+":"+config.xmpp.port+"/websocket",o.presenceWaitingList=[],o.jidsToRemove=[],o.fullJid=null,i.jidIm&&i.jidPwd?this.connect().then(function(){o.started=!0;var n=Math.round(performance.now()-r);e.push({service:"xmppService",startDuration:n}),t.info("[xmppService] === STARTED ("+n+" ms) ===")}).catch(function(e){return t.error("[xmppService] === STARTING FAILURE ("+e.message+") === "),n.reject(new Error("Starting failure : "+e.message))}):(t.info("Starting failure : No valid XMPP credentials"),n.reject(new Error("No valid XMPP credentials")))},o.stop=function(){try{return this.disconnect("Stop service").finally(function(){o.connection=null,o.started=!1,o.stropheStatus=null,o.presenceWaitingList=[],o.deferDisconnect=null,o.fullJid=null})}catch(e){return t.error("XMPP disconnect error : "+e),o.connection=null,o.started=!1,o.stropheStatus=null,o.presenceWaitingList=[],o.deferDisconnect=null,o.fullJid=null,n.when()}},o.connect=function(){t.info("[xmppService] -- ASK CONNECTION --");try{var a=n.defer();if(o.stropheStatus===Strophe.Status.CONNECTING||o.stropheStatus===Strophe.Status.CONNECTED||o.stropheStatus===Strophe.Status.AUTHENTICATING){t.info("[xmppService] already connecting");var s=new Error("XMPP service already-connected");return s.details="XMPP_ALLREADY_CONNECTED",n.reject(s)}return o.connection=new Strophe.Connection(o.serverURL),o.connection.rawInput=function(e){return o.handleRawXmppMessage(e,"Recv: ")},o.connection.rawOutput=function(e){return o.handleRawXmppMessage(e,"Sent: ")},o.connecting=!0,o.generateRandomFullJid(i.jidIm).then(function(n){o.fullJid&&(n=o.fullJid),o.connection.connect(n,i.jidPwd,function(n,s){switch(o.stropheStatus=n,s=angular.isUndefined(s)?"":s,n){case Strophe.Status.CONNECTING:t.info("[xmppService] -- Connecting --"),e.$broadcast("ON_CONNECTION_STATE_CHANGE_EVENT","inProgress");break;case Strophe.Status.AUTHFAIL:t.error("[xmppService] -- Authentication failure -- "+s),a.reject(new Error("Authentication failure -- "+s));break;case Strophe.Status.CONNFAIL:o.connecting&&(t.error("[xmppService] -- Connection failure -- "+s),a.reject(new Error("Connection failure -- "+s)));break;case Strophe.Status.CONNECTED:t.info("[xmppService] -- Connected -- "+o.connection.jid),o.connecting=!1,o.connected=!0,o.jid=i.jidIm,o.fullJid=o.connection.jid,o.connection.addHandler(o.onRosterChanged,"jabber:iq:roster","iq","set"),o.connection.addHandler(o.onMamMessageReceived,Strophe.NS.MAM,"message",null),o.connection.addHandler(o.onMamMessageReceived,Strophe.NS.MAM,"iq",null),o.addPresenceHandler(),o.presenceWaitingList=[],o.connection.ping.addPingHandler(function(e){var n=new Date;return t.info("[xmppService] -- Receive keepAlive Ping request ("+n+")"),o.connected&&o.connection.ping.pong(e),!0}),o.enableCarbon(),a.resolve();break;case Strophe.Status.DISCONNECTING:t.info("[xmppService] -- Disconnecting -- "+s);break;case Strophe.Status.DISCONNECTED:t.info("[xmppService] -- Disconnected -- "+o.fullJid),o.started?(e.$broadcast("ON_CONNECTION_STATE_CHANGE_EVENT","disconnected"),-1===o.jidsToRemove.indexOf(o.fullJid)&&(o.jidsToRemove.push(o.fullJid),o.jidsToRemove.forEach(function(e){t.info("[xmppService] -- invalid jid to remove -- "+e)})),o.deferDisconnect?(t.info("[xmppService] -- disable ping connection watcher"),o.connectionWatcherPromise&&r.cancel(o.connectionWatcherPromise),o.connected=!1,o.deferDisconnect.resolve()):o.connected&&!o.connecting?(t.error("[xmppService] -- Unexpected disconnection"),o.connecting=!0,o.connected=!1,e.disconnected=!0,o.disconnectionHandler()):o.connected||o.connecting||!o.fullJid?o.connected||o.connecting||o.fullJid||(t.error("[xmppService] -- Unexpected disconnection without fullJid"),o.connecting=!0,o.disconnectionHandler()):(t.error("[xmppService] -- Unexpected disconnection with fullJid"),o.connecting=!0,o.disconnectionHandler())):(t.info("[xmppService] -- received disconnect event but service not started !!"),t.info("[xmppService] -- disable ping connection watcher"),o.connectionWatcherPromise&&r.cancel(o.connectionWatcherPromise),e.disconnected=!0);break;default:t.error("[xmppService] -- Connection to the xmpp server failure -- "+n+" -- "+s),o.connecting?a.reject(new Error("Connection failure -- "+s)):o.disconnectionHandler()}})}),a.promise}catch(s){return t.error("XMPP service connect error : "+s),n.reject("catch-connect-error")}},o.handleRawXmppMessage=function(e,n){if(o.connectionWatcherPromise&&r.cancel(o.connectionWatcherPromise),o.connectionWatcherPromise=r(o.connectionWatcher,o.pingTimeout),!(e.indexOf("<PHOTO>")>-1)){var i=n;if(e.indexOf("<message")>-1&&e.indexOf("<body")>-1)i+=o.messageBodyDiscretion(e);else{var a=$(e).find("data");a&&"http://jabber.org/protocol/ibb"===a.attr("xmlns")?(a.html("Encoded file in base 64"),i+=a.html()):i+=e}t.debug(i)}},o.messageBodyDiscretion=function(e){var t=e.indexOf("<body");if(-1===t)return e;var n=e.indexOf(">",t);return n===e.indexOf("/>",t)+1?e:-1===n?e:e.substr(0,n+2)+"***"+e.substr(e.indexOf("</body>")-1)},this.connectionWatcher=function(){try{if(t.error("[xmppService] -- Connection watcher : so bad, no message since "+o.pingTimeout/1e3+" seconds (no ping)"),o.connection){var e=o.stropheStatus===Strophe.Status.CONNECTED?"Have lost connectivity":"Stuck in reconnecting state";t.info("[xmppService] -- Connection watcher -- "+e),o.stropheStatus=null,o.connection.disconnect("No ping")}}catch(e){t.error("connectionWatcher error "+e)}},o.disconnect=function(e){return o.deferDisconnect=n.defer(),t.info("[xmppService] -- ASK DISCONNECTION --"),this.connected?o.stropheStatus===Strophe.Status.CONNECTED&&o.connection.disconnect(e):(t.info("[xmppService] -- disconnect - service is not started"),o.deferDisconnect.resolve()),o.deferDisconnect.promise},o.generateRandomFullJid=function(e){return o.generateRandomFullJidForWeb(e)},o.generateRandomFullJidForWeb=function(e){return n.when(e+"/web_win_"+version+"_"+a(8))},o.removeOldConnection=function(){r(function(){var e=o.jidsToRemove.map(function(e){if(e!==o.fullJid)return o.disconnectObsoleteJid(e).then(function(){t.info("[xmppService] -- disconnect obsolete jid -- "+e+" done")});t.info("[xmppService] -- ignore disconnect obsolete jid for "+e)});o.jidsToRemove=[],n.all(e).catch(function(e){t.warn("[xmppService] -- somethings goes wrong during obsolete jid removal -- "+e.message)})},1e4,1)},o.disconnectObsoleteJid=function(e){var t=$iq({type:"set",id:a(8),from:o.fullJid}).c("disconnect",{xmlns:"jabber:iq:configuration"}).c("to").t(e);return o.sendIQ(t)},this.onRosterChanged=function(t){try{return angular.element(t).find("item").each(function(){var t=Strophe.getBareJidFromJid(angular.element(this).attr("jid")),n="favorites"===angular.element(this).find("group").first().text(),r=angular.element(this).attr("subscription"),i=angular.element(this).attr("ask");e.$apply(function(){e.$broadcast("ON_ROSTER_CHANGED_EVENT",{jid:t,subscription:r||"none",favorite:n,ask:i||"none"})})}),!0}catch(e){return!0}},this.addHistoryHandler=function(e){this.historyHandler=e},this.addHistoryCallLogsHandler=function(e){this.callLogHandler=e},this.onMamMessageReceived=function(e){try{var t=angular.element(e).find("result").attr("queryid");return t||(t=angular.element(e).find("fin").attr("queryid")),t&&0!==t.indexOf("tel_")&&o.historyHandler?o.historyHandler(e):o.callLogHandler&&o.callLogHandler(e),!0}catch(e){return!0}},this.addPresenceHandler=function(){return t.info("[xmppService] -- Add presence handler"),this.connection.addHandler(o.onPresence,null,"presence"),n.when()},this.sendPresence=function(e,n){if(this.connection||o.stropheStatus===Strophe.Status.CONNECTED)try{t.info("Send presence "+e+" - "+n+" ("+o.jid+")");var r=$pres();if(r.c("priority").t("5"),r.up(),e&&"online"!==e&&r.c("show").t(e),!n||e&&"online"!==e?n&&r.up().c("status").t(n):r.c("status").t(n),!this.connection||!this.connection.send)return void t.error('Try to send "presence IQ" but no xmpp connection');this.connection.send(r)}catch(e){return void t.error("this.connection.send error : "+e)}else t.error('[xmppService] Try to send "presence IQ" but no xmpp connection')},this.resetPresence=function(e){t.info("Reset presence to "+o.presenceStatus+" ("+o.jid+")"),o.sendPresence(e.show,e.status)},this.onPresence=function(n){try{var r=angular.element(n).attr("from"),i=Strophe.getBareJidFromJid(r),a=angular.element(n).find("x").attr("xmlns"),s=angular.element(n).attr("type"),c=angular.element(n).find("show").text();if(a&&0===a.indexOf(Strophe.NS.MUC))return!0;if(angular.element(n).find("actor").length>0&&"jabber:iq:configuration"===angular.element(n).find("actor").attr("xmlns")&&(angular.element(n).find("avatar").length>0?e.$broadcast("ON_VCARD_UPDATE_EVENT",i,"avatar"):angular.element(n).find("data").length>0&&e.$broadcast("ON_VCARD_UPDATE_EVENT",i,"data"),angular.element(n).find("x").length&&"vcard-temp:x:update"===angular.element(n).find("x").attr("xmlns")&&e.$broadcast("ON_PROFILE_FEATURES_UPDATE_NEEDED")),"error"===s)t.error("Receive error presence message");else if("subscribe"===s)t.info("Receive subscribe from ("+i+")"),e.$broadcast("ON_ROSTER_SUBSCRIBE_EVENT",i);else{var l=$(n),u="offline",d="";"unavailable"!==s&&(c=l.find("show").text(),d=l.find("status").text(),u=""===c||"chat"===c?"online":"dnd"===c?"dnd":"xa"===c?"xa":"away");var f=l.find("delay").attr("stamp"),h=f?new Date(f):new Date,p=l.find("until").text(),v={jid:r,status:u,message:d,stamp:h,until:p=p?new Date(p):null};e.$$listeners&&e.$$listeners.ON_ROSTER_PRESENCE_CHANGED_EVENT?e.$broadcast("ON_ROSTER_PRESENCE_CHANGED_EVENT",v):(t.info("[XMPP Service] Receive presence message but contact service is not ready yet"),o.presenceWaitingList.push(v))}return!0}catch(e){return!0}},this.getPresenceWaitingList=function(){return o.presenceWaitingList},this.resetPresenceWaitingList=function(){o.presenceWaitingList=[]},this.enableCarbon=function(){var e=$iq({type:"set"});return e.c("enable",{xmlns:"urn:xmpp:carbons:2"}),o.sendIQ(e)},this.send=function(e){if(!o.connection&&o.stropheStatus!==Strophe.Status.CONNECTED)return t.error('[xmppService] Try to send "stanza" but no xmpp connection'),n.reject(new Error("No XMPP connection"));try{this.connection.send(e)}catch(e){return t.error("[xmppService] this.connection.send error : "+e),n.when()}return n.when()},this.sendIQ=function(e){if(!this.connection&&o.stropheStatus!==Strophe.Status.CONNECTED)return t.error('[xmppService] Try to send "iq" but no xmpp connection'),n.reject(new Error("No XMPP connection"));var r=n.defer();try{this.connection.sendIQ(e,function(e){r.resolve(e)},function(e){null===e?r.reject(new Error("XMPP request timeout")):r.reject(new Error(e.innerHTML))},REQUEST_TIMEOUT)}catch(e){return t.error("[xmppService] this.connection.sendIQ error : "+e),n.reject(new Error("this.connection.sendIQ error"))}return r.promise},this.getBareJidFromJid=function(e){return Strophe.getBareJidFromJid(e)},this.getResourceFromJid=function(e){return Strophe.getResourceFromJid(e)},this.addHandler=function(e,t,n,r,i,a,o){return this.connection.addHandler(e,t,n,r,i,a,o)},this.deleteHandler=function(e){this.connection&&this.connection.deleteHandler(e)},this.addFileTransfertHandlers=function(e,t){this.connection.ibb.addIBBHandler(e),this.connection.si_filetransfer.addFileHandler(t)},this.addCallLogsHandler=function(e){this.rtcStartRef&&(this.connection.deleteHandler(this.rtcStartRef),this.rtcStartRef=null),this.rtcEndRef&&(this.connection.deleteHandler(this.rtcEndRef),this.rtcEndRef=null),this.rtcRingingRef&&(this.connection.deleteHandler(this.rtcRingingRef),this.rtcRingingRef=null),this.rtcStartRef=this.connection.addHandler(e,null,"message","webrtc-start"),this.rtcEndRef=this.connection.addHandler(e,null,"message","webrtc-end"),this.rtcRingingRef=this.connection.addHandler(e,null,"message","webrtc-ringing")},this.addTelephonyCallLogsHandler=function(e){this.telephonyMessageRef&&(this.connection.deleteHandler(this.telephonyMessageRef),this.telephonyMessageRef=null),this.telephonyIqRef&&(this.connection.deleteHandler(this.telephonyIqRef),this.telephonyIqRef=null),this.telephonyMessageRef=o.connection.addHandler(e,Strophe.NS.CALLLOG,"message",null),this.telephonyIqRef=o.connection.addHandler(e,Strophe.NS.CALLLOG,"iq",null)},this.addPubSubPublishHandler=function(e){o.connection.addHandler(e,"jabber:client","message","headline",null,"pubsub.demo-all-in-one-dev-1.opentouch.cloud")},this.getIpAddress=function(){return n(function(e,t){if(RTCPeerConnection){var n=new RTCPeerConnection({iceServers:[]}),r=function(){},i=[];n.createDataChannel(""),n.createOffer(n.setLocalDescription.bind(n),r),n.onicecandidate=function(a){if(a&&a.candidate&&a.candidate.candidate){var o=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(a.candidate.candidate);if(o&&o.length>=2){var s=o[1];i.push(s)}}else{if(n.onicecandidate=r,!i.length)return void t();e(i)}}}else t()})}}]),angular.module("rainbow").service("contactService",["$q","$rootScope","$log","$injector","$http","xmppService","authService","Contact","$interval","settingsService","PromiseQueue","companyService","errorHelperService",function(e,t,n,r,i,a,o,s,c,l,u,d,f){"use strict";var h=this;h.start=function(r){n.info(""),n.info("[contactService] === STARTING ===");var i=performance.now();return e(function(e,f){if(h.userContact=null,h.contacts=[],h.dbContacts=[],h.contactPromises=[],h.networkSize=0,h.started=!1,h.subscriptionPromiseQueue=u.create(),h.presentationModeActive=!1,h.awayStateActive=!1,h.busyState={status:null,message:null},h.forcedState=!1,h.manualState=!1,h.currentLanguage=l.getSetting("lang"),h.langUpdateEventHandlerCleaner&&h.langUpdateEventHandlerCleaner(),h.langUpdateEventHandlerCleaner=t.$on("ON_LANGUAGE_UPDATED_EVENT",function(e,t){h.currentLanguage=t,h.updateContactsLastActivity()}),h.rosterUpdateEventHandlerCleaner&&h.rosterUpdateEventHandlerCleaner(),h.rosterUpdateEventHandlerCleaner=t.$on("ON_ROSTER_CHANGED_EVENT",h.rosterChangedHandler),h.presenceUpdateEventHandlerCleaner&&h.presenceUpdateEventHandlerCleaner(),h.presenceUpdateEventHandlerCleaner=t.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",h.contactPresenceChangedHandler),h.calendarPresenceEventHandlerCleaner&&h.calendarPresenceEventHandlerCleaner(),h.calendarPresenceEventHandlerCleaner=t.$on("ON_CONTACT_CALENDAR_STATUS_CHANGE",h.contactCalendarPresenceChangedHandler),n.info("[contactService] Create userContact ("+a.jid+")"),h.userContact=new s,h.userContact.ask=null,h.userContact.subscription=null,h.userContact.id=a.jid,h.userContact.jid=a.jid,h.userContact.jidtel="tel_"+a.jid,h.userContact.fullJid=a.fullJid,h.userContact.language=h.currentLanguage,h.userContact.updateFromUserData(o.userData),h.userContact.getAvatar(),h.userContact.updateRichStatus(),h.dbContacts[h.userContact.dbId]=h.userContact,h.contacts[h.userContact.id]=h.userContact,!o.userData.language){var p=l.getAppliLanguageCodeForServer();h.updateUserContact({language:p})}h.getUserSettings().then(function(e){return l.settings.activeAlarm=e.activeAlarm,l.settings.activeNotif=e.activeNotif,n.info("[contactService] Get alarm & notif data ("+l.settings.activeAlarm+" / "+l.settings.activeNotif+")"),n.info("[contactService] Subscribe to my telephony presence ("+h.userContact.jidtel+")"),h.sendSubscribeInvitation(h.userContact.jidtel)}).then(function(){return d.getCompanyById(h.userContact.company.id)}).then(function(e){return h.userContact.company=e,h.attachHandlers(),h.getMyNetwork()}).then(function(){return h.updateNetworkWithRosterInfo()}).then(function(){h.appActiveEventHandlerCleaner&&h.appActiveEventHandlerCleaner(),h.appActiveEventHandlerCleaner=t.$watch("appActive",function(e){return n.info("[contactService] AppActive changed : "+e),!e&&h.userContact&&"online"===h.userContact.status&&(h.awayStateActive=!0),e&&h.awayStateActive&&(h.awayStateActive=!1),angular.isDefined(e)&&h.updatePresence(!0),!0}),h.vcardUpdateEventHandlerCleaner&&h.vcardUpdateEventHandlerCleaner(),h.vcardUpdateEventHandlerCleaner=t.$on("ON_VCARD_UPDATE_EVENT",h.onVCardChangeEvent),h.getMissedPresenceMessages();var a=Math.round(performance.now()-i);r.push({service:"contactService",startDuration:a}),n.info("[contactService] === STARTED ("+a+" ms) ==="),h.started=!0,e()}).catch(function(e){n.error("[contactService] === STARTING FAILURE === "+e.message),f(e)}),h.connectionStateEventHandlerCleaner&&h.connectionStateEventHandlerCleaner(),h.connectionStateEventHandlerCleaner=t.$on("ON_CONNECTION_STATE_CHANGE_EVENT",h.onConnectionStateChangeEvent),h.contactLastActivityTimerInterval=c(h.updateContactsLastActivity,6e4)})},h.getMyNetwork=function(){return e(function(e,t){var r=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/networks?limit=2000";i({method:"GET",url:r,headers:o.getRequestHeader()}).then(function(t){var r=t.data.data;n.info("[contactService] GetMyNetwork success -- find "+r.length+" contact(s)"),r.forEach(function(e){var t=new s;t.updateFromUserData(e),t.roster=!0,h.contacts[t.id]=t,h.dbContacts[t.dbId]=t,t.updateRichStatus(),t.getAvatar(),h.sendUpdateEvent(t)}),h.networkSize=r.length,e()},function(){var e="GetMyNetwork failure";n.error("[contactService] "+e),t(new Error(e))})})},h.updateNetworkWithRosterInfo=function(){return e(function(e,t){a.sendIQ($iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"})).then(function(t){n.info("[contactService] Get rosters info successfully"),$(t).find("item").each(function(){var e=$(this),t=a.getBareJidFromJid(e.attr("jid"));if(t&&t.length&&0!==t.indexOf("tel_")){var r=h.contacts[t];if(r){var i=e.attr("ask");r.ask=angular.isDefined(i)?i:"none",r.subscription=e.attr("subscription"),r.updateRichStatus(),n.info("[contactService] Update contact "+r.displayName+" from roster ("+r.ask+", "+r.subscription+")")}}}),e()}).catch(function(e){n.error("[contactService] Get rosters failure : "+e.message),t(e)})})},h.getMissedPresenceMessages=function(){n.info("[contactService] GetMissedPresenceMessages");try{var e=a.getPresenceWaitingList();if(e.length){for(n.info("[contactService] GetMissedPresenceMessages length "+e.length);e.length>0;){var t=e.pop();h.contactPresenceChangedHandler(null,t)}a.resetPresenceWaitingList()}}catch(e){n.error("[contactService] GetMissedPresenceMessages error "+e)}},h.attachHandlers=function(){n.info("[contactService] AttachHandlers"),this.contactConfigRef&&(a.connection.deleteHandler(this.contactConfigRef),this.contactConfigRef=null),this.contactConfigRef=a.connection.addHandler(h.onUserConfigUpdate,null,"message","management")},h.stop=function(){return n.info("[contactService] Stopping"),h.userContact=null,h.contacts=null,h.dbContacts=null,h.started=!1,h.presentationModeActive=!1,h.awayStateActive=!1,h.busyState={status:null,message:null},h.forcedState=!1,h.manualState=!1,n.info("[contactService] Stopped"),h.vcardUpdateEventHandlerCleaner&&(h.vcardUpdateEventHandlerCleaner(),h.vcardUpdateEventHandlerCleaner=null),h.connectionStateEventHandlerCleaner&&(h.connectionStateEventHandlerCleaner(),h.connectionStateEventHandlerCleaner=null),h.contactLastActivityTimerInterval&&(c.cancel(h.contactLastActivityTimerInterval),h.contactLastActivityTimerInterval=null),e.when()},h.onConnectionStateChangeEvent=function(e,t){if("disconnected"===t&&h.userContact){h.userContact.resources={};for(var n in h.contacts)h.contacts.hasOwnProperty(n)&&!h.contacts[n].isBot&&(h.contacts[n].resources={},"unknown"!==h.contacts[n].status&&"none"!==h.contacts[n].subscription&&(h.contacts[n].status="offline",h.contacts[n].imStatusStamp={}));h.presentationModeActive=!1,h.awayStateActive=!1,h.busyState={status:null,message:null},h.forcedState=!1,h.manualState=!1}},h.onVCardChangeEvent=function(t,r,i){n.info("[contactService] onVCardChangeEvent event: "+t+" || status: "+r+" || type: "+i),c(function(){var t=h.getContactByJid(r);t&&("avatar"===i||"data"===i?h.getVCardByDbId(t.dbId,!0).then(function(){return"avatar"===i?t.getAvatar(256,!0):e.when()}).then(function(){h.sendUpdateEvent(t)}):h.sendUpdateEvent(t))},2e3,1)},h.onUserConfigUpdate=function(e){try{return $(e).find("usersettings").length&&"update"===$(e).find("usersettings").attr("action")&&(n.info("[contactService] onUserConfigUpdate - should update the presence"),h.sendPresenceFromConfiguration()),!0}catch(e){return!0}},h.updateUserContactFullJid=function(){h.userContact.fullJid=a.fullJid,h.attachHandlers()},this.getMinimumContactByDBId=function(t){return e(function(e){e(h.createEmptyContactContact(t))})},h.createEmptyContactContact=function(e){var t=h.createBasicContact(e);return t.initials="?",t.displayName="Unknown contact",t.lastname="Unknown contact",t.firstname="",t.temp=!0,t.avatar=new Image,t.avatar.src="/resources/skins/rainbow/images/conversations/unknownContact.png",t},h.getContact=function(e,t){var n=e||t;return this.isUserContactJid(n)?h.userContact:this.contacts[n]},h.getOrCreateContact=function(t,n){if(!t&&!n)return e.reject(new Error("No jid or no phoneNumber"));if(this.contacts||(this.contacts=[]),r=this.getContact(t,n))return e.when(r);var r=h.createBasicContact(t,n);return t?h.getVCardByJid(t):e.when(r)},this.createBasicContact=function(e,t){n.debug("[contactService] CreateContact "+e+" "+anonymizePhoneNumber(t));var r=new s;if(!e)return r.id=t,r.initials="?",r.displayName=t||"Unknown contact",r.lastname=t||"Unknown contact",r.firstname="",r.phoneProCan=t||"",r.temp=!0,r.avatar=new Image,r.avatar.src="/resources/skins/rainbow/images/conversations/unknownContact.png",r.setNameUpdatePrio(s.NameUpdatePrio.NO_UPDATE_PRIO),r;var i=e;return i||(i=t,r.phoneProCan=t),i||(i="anonymous"),r.jid=e,r.jidtel="tel_"+e,r.id=i,r.ask="none",r.subscription="none",r.updateRichStatus(),h.contacts[r.id]=r,r},this.getContactByJid=function(e){var t=null;return this.isUserContactJid(e)?t=h.userContact:this.contacts?t=this.contacts[e]:this.contacts=[],t},this.getContactByEmail=function(e){var t=null;for(var n in this.contacts)this.contacts.hasOwnProperty(n)&&this.contacts[n].containsEmail(e)&&(t=this.contacts[n]);return t},this.getContacts=function(){var e=[];for(var t in this.contacts)this.contacts.hasOwnProperty(t)&&e.push(this.contacts[t]);return e},this.searchContacts=function(e){return this.getContacts().filter(function(t){return(t.roster||t.isBot)&&!t.isTerminated&&h.contactMatcher(t,e)})},this.contactMatcher=function(e,t){var n=e.firstname+" "+e.lastname,r=t.toLowerCase().trim().split(/[ ]+/),i=n.toLowerCase().trim().split(/[ ]+/);return r.every(function(e){return i.some(function(t,n){return!(!t.length||0!==t.indexOf(e))&&(i[n]="",!0)})})},h.getContactById=function(e){return h.dbContacts[e]},h.getContactByDBId=function(t,r){var a=h.dbContacts[t];if(!r&&a)return e.when(a);var s=h.contactPromises[t];if(s)return n.debug("[contactService] getContactByDBId for "+t+" already lauched"),s.promise;var c=e.defer();h.contactPromises[t]=c;var l=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+t;return i({method:"GET",url:l,headers:o.getRequestHeader()}).then(function(e){var r=e.data.data;n.info("[contactService] GetContactByDBId ("+t+") -- "+r.jid_im+" -- success");var i=h.createBasicContact(r.jid_im);i.updateFromUserData(r),i.getAvatar(),h.dbContacts[i.dbId]=i,c.resolve(i),delete h.contactPromises[t]},function(e){var r=f.handleError(e);c.reject(r),delete h.contactPromises[t],n.error("[contactService] "+f.getErrorFullMessage(e,"GetContactByDBId"))}),c.promise},h.getContactByDBIdOld=function(t,r){return e(function(e,a){var s=h.dbContacts[t];if(!r&&s)e(s);else{var c=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+t;i({method:"GET",url:c,headers:o.getRequestHeader()}).then(function(r){var i=r.data.data;n.info("[contactService] GetContactByDBId ("+t+") -- "+i.jid_im+" -- success");var a=h.createBasicContact(i.jid_im);a.updateFromUserData(i),a.getAvatar(),h.dbContacts[a.dbId]=a,e(a)},function(e){var t=f.handleError(e);a(t),n.error("[contactService] "+f.getErrorFullMessage(e,"GetContactByDBId"))})}})},h.getOrCreateContactByEmail=function(t){return e(function(e,r){n.info("[contactService] GetContactByEmail "+t),t||r();var i=h.getContactByEmail(t);i?e(i):h.getVCardInfoByEmail(t).then(function(t){h.createBasicContact(t.jid_im).updateFromUserData(t),i.updateRichStatus(),i.getAvatar(),h.sendUpdateEvent(i),e(i)},function(e){var t=f.handleError(e);r(t),n.error("[contactService] "+f.getErrorFullMessage(e,"GetContactByEmail"))})})},this.getContactsByJids=function(t){return e(function(e,r){n.info("[contactService] getContactsByJids with ["+t.join()+"]");var a=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port;i({method:"POST",headers:o.getPostHeader(),url:a+"/api/rainbow/enduser/v1.0/users/jids?limit=1000",data:{jid_im:t}}).then(function(t){t.data.data.forEach(function(e){var t=h.getContactByJid(e.jid_im);t||(t=new s),t.updateFromUserData(e),h.contacts[t.id]=t,h.dbContacts[t.dbId]=t,t.getAvatar(),t.temp=!1}),e()},function(e){var t=f.handleError(e);r(t),n.error("[contactService] "+f.getErrorFullMessage(e,"getContactsByJids"))})})},this.getContactsByEmails=function(t){return e(function(e,r){n.info("[contactService] getContactsByEmails with ["+t.join()+"]");var a=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/loginemails",c=t.map(function(e){return e.toLowerCase()});i({method:"POST",headers:o.getPostHeader(),url:a,data:{loginEmail:c}}).then(function(t){var n={},r=[];t.data.data.forEach(function(e){var t=h.dbContacts[e.id];t||(t=new s,h.contacts[t.id]=t,h.dbContacts[t.dbId]=t),t.updateFromUserData(e),t.getAvatar(),n[t.loginEmail]=t,r.push(t),c.splice(c.indexOf(t.loginEmail.toLowerCase()),1)}),e({contacts:n,contactsArray:r,emails:c})},function(e){var t=f.handleError(e);r(t),n.error("[contactService] "+f.getErrorFullMessage(e,"getContactsByEmails"))})})},h.getUserSettings=function(){return e(function(e){var t=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+h.userContact.dbId+"/settings";i({method:"GET",url:t,headers:o.getRequestHeader()}).then(function(t){n.info("[contactService] GetUserSettings success");var r=t.data.data.presence||"online",i=t.data.data.activeAlarm||"relax1",a=t.data.data.activeNotif||"notif1";e({presence:r,activeAlarm:i,activeNotif:a})},function(t){n.error("[contactService] "+f.getErrorFullMessage(t,"GetUserSettings")),e({presence:"online",activeAlarm:"relax1",activeNotif:"notif1"})})})},h.setUserSettings=function(t){return e(function(e,r){var a=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+h.userContact.dbId+"/settings";i({method:"PUT",url:a,headers:o.getRequestHeader(),data:t}).then(function(){n.info("[contactService] SetUserSettings "+JSON.stringify(t)+" -- success"),e()},function(e){var t=f.handleError(e);n.error("[contactService] "+f.getErrorFullMessage(e,"SetUserSettings")),r(t)})})},h.getVCardByDbId=function(t,r){return e(function(e,a){var s=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+t;i({method:"GET",url:s,headers:o.getRequestHeader()}).then(function(t){var n=t.data.data,i=h.contacts[n.jid_im];i.updateFromUserData(n),i.updateRichStatus(),r||i.getAvatar(),h.sendUpdateEvent(i),e(i)},function(e){var t=f.handleError(e);a(t),n.error("[contactService] "+f.getErrorFullMessage(e,"getVCardByDbId"))})})},h.getVCardByJid=function(t){return e(function(e,r){var a=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/jids/"+t;i({method:"GET",url:a,headers:o.getRequestHeader()}).then(function(n){var r=n.data.data,i=h.contacts[t];i.updateFromUserData(r),i.updateRichStatus(),i.getAvatar(),h.dbContacts[i.dbId]||(h.dbContacts[i.dbId]=i),h.sendUpdateEvent(i),e(i)},function(e){var t=f.handleError(e);r(t),n.error("[contactService] "+f.getErrorFullMessage(e,"getVCardByJid"))})})},h.getVCardInfoByEmail=function(t){return e(function(e){var r=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/loginemails?format=full";i({method:"POST",url:r,headers:o.getRequestHeader(),data:{loginEmail:[t]}}).then(function(t){e(t.data.users)},function(e){n.error("[contactService] "+f.getErrorFullMessage(e,"getVCardsByEmail")),reject()})})},this.pushAvatarImage=function(t){var r=e.defer(),a=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port;n.info("[contactService] Push avatar image ");var s=h.userContact.avatar;return h.resizeImage(t,512,512).then(function(e){h.userContact.avatar=e;var t=h.getBinaryData(e);i({method:"POST",url:a+"/api/rainbow/enduser/v1.0/users/"+h.userContact.dbId+"/avatar",headers:o.getPostHeader("image/"+t.type),data:t.data,transformRequest:[]}).then(function(){r.resolve()},function(e){h.userContact.avatar=s;var t=f.handleError(e);r.reject(t),n.error("[contactService] "+f.getErrorFullMessage(e,"pushAvatarImage"))})}),r.promise},this.resizeImage=function(t,n,r){var i=e.defer(),a=new Image;return a.src=t,a.onload=function(){var e=a.width,t=a.height;e>t?e>n&&(t*=n/e,e=n):t>r&&(e*=r/t,t=r);var o=document.createElement("canvas");o.width=e,o.height=t,a.width=e,a.height=t,o.getContext("2d").drawImage(this,0,0,e,t);var s=new Image;s.src=o.toDataURL("image/png"),i.resolve(s)},i.promise},this.getBinaryData=function(e){for(var t=e.src.indexOf("image/")+6,n=e.src.indexOf(";base64,"),r=e.src.slice(n+8),i=e.src.slice(t,n),a=window.atob(r),o=a.length,s=new Uint8Array(o),c=0;c<o;c++)s[c]=a.charCodeAt(c);return{type:i,data:s}},this.sendSubscription=function(t){return"to"===t.subscribe||"both"===t.subscribe?e.when(t):(h.sendSubscribeInvitation(t.jid),h.sendSubscribeInvitation(t.jidtel),e.when(t))},h.removeRoster=function(e){n.info("[contactService] Remove roster "+e);var t=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:e,subscription:"remove"});return a.sendIQ(t)},h.sendSubscribeInvitation=function(e){return n.info("[contactService] Send subscribe invitation to "+e),a.send($pres({to:e,type:"subscribe"}))},h.rosterChangedHandler=function(e,t){h.subscriptionPromiseQueue.add(function(){return h.rosterChangedHandlerPromise(t)})},h.rosterChangedHandlerPromise=function(r){return h.isTelJid(r.jid)?(n.debug("[contactService] Contact changed ("+r.jid+") ignored"),e.when()):e(function(e){var i=r.subscription,a=r.ask,o=r.jid;h.getOrCreateContact(o).then(function(o){"remove"===i?(o.ask="none",o.subscription="none",o.roster=!1):(o.ask=a,o.subscription=i,o.roster=!0,"both"===i&&h.updatePresence(!0)),o.updateRichStatus(),h.sendUpdateEvent(o),t.$broadcast("ON_CONTACT_ROSTER_UPDATE_EVENT"),n.info("[contactService] rosterChangedHandler - contact "+r.jid+" changed ("+a+", "+i+") success"),e()}).catch(function(t){n.error("[contactService] rosterChangedHandler - contact "+r.jid+" failure - "+t.message),e()})})},this.updateUserContact=function(t){n.info("[contactService] updateUserContact");var r=e.defer(),a=config.restServerUrl+"/api/rainbow/enduser/v1.0/";return i({method:"PUT",url:a+"users/"+o.userId,headers:o.getPostHeader(),data:t}).then(function(e){n.info("[contactService] updateUserContact successfully"),h.userContact.updateFromUserData(e.data.data),r.resolve()},function(e){var t=f.handleError(e);r.reject(t),n.error("[contactService] "+f.getErrorFullMessage(e,"updateUserContact"))}),r.promise},this.updateUserPassword=function(t,r){n.info("[contactService] Update updateUserPassword");var a=e.defer(),s=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/enduser/v1.0/";return i({method:"PUT",url:s+"users/"+o.userId+"/change-password",headers:o.getPostHeader(),data:{oldPassword:t,newPassword:r}}).then(function(){n.info("[contactService] updateUserPassword successfully"),a.resolve()},function(e){var t=f.handleError(e);a.reject(t),n.warn("[contactService] "+f.getErrorFullMessage(e,"updateUserPassword"))}),a.promise},this.isTelJid=function(e){return 0===e.indexOf("tel_")},this.getImJid=function(e){var t=a.getBareJidFromJid(e);return this.isTelJid(t)?t.substring(4):t},this.getRessourceFromJid=function(e){var t="";if(e){var n=e.indexOf("/");-1!==n&&(t=e.substr(n+1))}return t},this.isUserContactJid=function(e){return!!h.userContact&&h.userContact.jid===e},this.isUserContact=function(e){return!(!e||!e.jid)&&(h.userContact?h.userContact.jid===e.jid:e.jid===a.jid)},h.updateContactsLastActivity=function(){h.contacts&&Object.keys(h.contacts).forEach(function(e){h.contacts[e].updateLastActivityMessage()})},h.updateLastActivity=function(e){"offline"===e.status||"away"===e.status?e.lastActivityDate=e.getLastAvailableDate():e.lastActivityDate=null},this.createBotContact=function(e,t,n){var r;return r=h.contacts[e]?s.updateContactToBot(h.contacts[e],t,n):s.createBotContact(e,t,n),h.contacts[r.id]=r,r},this.contactPresenceChangedHandler=function(e,t){if("calendar"!==h.getRessourceFromJid(t.jid)){var r=h.getImJid(t.jid);h.getOrCreateContact(r).then(function(e){h.isTelJid(t.jid)?(n.info("[contactService] Update telephony presence ("+r+") : "+t.message),e.updateTelephonyStatus(t.message,h.isUserContact(e))):(n.info("[contactService] Update im presence contact ("+r+") : "+t.status+" "+t.stamp),h.isUserContact(e)&&"mode=auto"===t.message&&"online"!==e.status&&e.resources.hasOwnProperty(t.jid)&&t.jid!==e.fullJid&&"EVT_SERVICE_INITIATED"!==e.telStatus&&"EVT_ESTABLISHED"!==e.telStatus&&(h.setUserContactStatus("online","mode=auto"),c(function(){h.updatePresence(!0)},500,1,!0)),e.updateIMStatus(t,h.isUserContact(e)),h.updateLastActivity(e)),h.sendUpdateEvent(e)})}},this.contactCalendarPresenceChangedHandler=function(e,t){t.updateCalendarPresenceInfo()},this.setUserContactStatus=function(e,t){try{if(n.info("[contactService] Set userContact status : "+e+(t?"("+t+")":"")),a.started)"online"===e?(h.manualState=!1,a.sendPresence(null,t)):(h.manualState=!0,"away"===e?a.sendPresence("away",t):"dnd"===e?a.sendPresence("dnd",t):"xa"===e&&a.sendPresence("xa",t));else if("online"===e){r.get("serviceLauncher").startServices()}}catch(e){n.error("[contactService] Set userContact status error : "+e)}},this.sendPresenceFromConfiguration=function(){n.info("[contactService] sendPresenceFromConfiguration");var t=e.defer();return h.getUserSettings().then(function(e){var r="",i=e.presence;if("invisible"===i?i="xa":"away"===i&&(i="xa",r="away"),n.info("[contactService] sendPresenceFromConfiguration -> getUserSettings are "+i+" || message : "+r),h.userContact&&h.userContact.resources&&h.userContact.resources[h.userContact.fullJid]){var a=h.userContact.resources[h.userContact.fullJid];a&&(a.show!==i||"xa"===a.show&&a.status!==r)&&(n.info("[contactService] sendPresenceFromConfiguration should update my status from "+a.show+" to "+i+" ("+r+")"),h.setUserContactStatus(i,r))}else n.info("[contactService] sendPresenceFromConfiguration set initial presence "),h.setUserContactStatus(i,r);t.resolve()}).catch(function(){n.info("[contactService] sendPresenceFromConfiguration failure, send online"),h.setUserContactStatus("online"),t.resolve()}),t.promise},h.updateUserSettings=function(e,t){var n="online";"xa"===e&&"away"===t?n="away":"dnd"===e?n="dnd":"xa"===e&&(n="invisible"),h.setUserSettings({presence:n})};var p,v=null;this.onPresentationModeChangedEvent=function(e,t){"active"===t?h.presentationModeActive=!0:"disable"===t&&(h.presentationModeActive=!1),null===v&&(n.debug("[contactService] onPresentationModeChangedEvent status:"+t+" request presence update"),v=h.presentationModeActive,h.updatePresence()),function e(){n.debug("[contactService] startUpdatePresentationModeRefreshTimer"),null!==p&&(c.cancel(p),p=null),p=c(function(){n.debug("[contactService] startUpdatePresentationModeRefreshTimer interval reach"),v!==h.presentationModeActive?(n.debug("[contactService] startUpdatePresentationModeRefreshTimer interval - request presence update"),v=h.presentationModeActive,h.updatePresence(),e()):(n.debug("[contactService] startUpdatePresentationModeRefreshTimer interval - no presence update needed"),v=null)},1e3,1,!0)}()},this.changeMyPresence=function(e){if(n.info("[contactService] changeMyPresence "+e+" "+h.userContact.message),("dnd"!==e||"presentation"!==h.userContact.message)&&"busy"!==e){var t="";"online"===e&&(t="mode=auto"),"away"===e&&(e="xa",t="away"),h.setUserContactStatus(e,t),"online"===e&&c(function(){h.manualState=!1,h.updatePresence()},1e3,1,!0),h.updateUserSettings(e,t)}},this.computeStatusList=function(){var e=[];return h.userContact&&h.userContact.status&&(n.info("[contactService] computeStatusList "+h.userContact.status+" "+h.userContact.message),e="offline"===h.userContact.status?["online"]:"busy"===h.userContact.status?["busy"]:"dnd"===h.userContact.status&&"presentation"===h.userContact.message?["dnd"]:["online","away","xa","dnd"]),e},this.resetBusyState=function(){h.setBusyState(null,null,!0),h.sendPresenceFromConfiguration()},this.setBusyState=function(e,t,n){h.busyState={status:e,message:t},n||h.updatePresence()},t.$on("$destroy",t.$on("ON_PRESENTATION_MODE_CHANGED_EVENT",h.onPresentationModeChangedEvent)),this.updatePresence=function(e){n.info("[contactService] updatePresence"),h.manualState?(n.info("[contactService] updatePresence manualState"),"away"===h.userContact.status&&h.busyState&&"dnd"===h.busyState.status&&(h.setUserContactStatus("online","mode=auto"),c(function(){h.updatePresence()},1e3,1,!0))):!h.presentationModeActive||h.busyState&&h.busyState.status?h.busyState&&"dnd"===h.busyState.status?(n.info("[contactService] updatePresence dnd "+h.busyState.message),a.sendPresence("dnd",h.busyState.message)):h.awayStateActive?(n.info("[contactService] updatePresence away"),a.sendPresence("away","")):h.userContact&&"online"!==h.userContact.status?(n.info("[contactService] updatePresence online"),h.setUserContactStatus("online")):e&&h.userContact&&"online"===h.userContact.status&&(n.info("[contactService] updatePresence forced online"),h.setUserContactStatus("online")):(n.info("[contactService] updatePresence dnd presentation"),a.sendPresence("dnd","presentation"))},this.removeContact=function(t){var r=e.defer();n.info("[contactService] remove contact : "+t.displayNameForLog());var i=t.jid,a=t.jidtel;return h.removeRoster(i).then(function(){return h.removeRoster(a)}).then(function(){r.resolve()}).catch(function(e){n.error("[contactService] remove contact: "+t.displayNameForLog()+" failure : "+e.message),r.reject(e)}),r.promise},this.sendUpdateEvent=function(e){var n=h.isUserContact(e)?"ON_USER_CONTACT_UPDATED_EVENT":"ON_CONTACT_UPDATED_EVENT";t.$broadcast(n,e)},this.myMobileAvailable=function(){return h.userContact?h.userContact.mobileResource:null}}]),function(){"use strict";angular.module("rainbow").service("botService",["$http","$q","$log","authService","contactService","conversationService",function(e,t,n,r,i,a){var o=this;o.init=function(){o.bots=[],o.emily=null,this.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/"},o.start=function(e){n.info("[botService] === STARTING ===");var r=performance.now();return t(function(t,i){o.init(),o.getBots().then(function(){n.info(""),o.findEmily(),o.unlockWaitingConversations();var i=Math.round(performance.now()-r);e.push({service:"botService",startDuration:i}),n.info("[botService] === STARTED ("+i+" ms) ==="),n.info(""),t()}).catch(function(e){n.info("[botService] === STARTING FAILURE === "+e.message),i()})})},o.stop=function(){n.info("[botService] === STOPPED ===")},o.getBots=function(){return t(function(t,i){e({method:"GET",url:o.portalURL+"bots",headers:r.getRequestHeader()}).then(function(e){n.info("[botService] getBots success"),o.bots=e.data.data,t(o.bots)}).catch(function(e){var t="getBots failure "+e.data.errorDetails+" with status "+e.status;n.error("[botService] "+t),i(new Error(t))})})},o.findEmily=function(){o.bots.forEach(function(e){"Emily"===e.name&&(o.emily=e,n.info("[botService] Emily is found"),i.createBotContact(o.emily.jid,o.emily.name,o.emily.id))})},o.getEmily=function(){return o.emily},o.openConversationWithEmily=function(){return t(function(e,t){n.info("[botService] openConversationWithEmily");var r=i.getContactByJid(o.emily.jid);a.getOrCreateOneToOneConversation(r.jid).then(function(t){a.setActiveConversation(t),e(t)}).catch(function(){n.error("[botService] openConversationWithEmily failure"),t()})})},o.unlockWaitingConversations=function(){a.unlockWaitingBotConversations(!0)}}])}(),angular.module("rainbow").service("conversationService",["$q","$log","$rootScope","$http","$interval","xmppService","authService","contactService","Conversation","Call","fileTransfertService","videoService","telephonyService","roomService","settingsService","ConversationServiceEventHandler","ConversationServiceHistoryHandler","utilService","profileService","PromiseQueue","pstnConferenceService",function(e,t,n,r,i,a,o,s,c,l,u,d,f,h,p,v,m,g,E,S,C){"use strict";var b=this;this.started=!1,b.start=function(r){t.info(""),t.info("[conversationService] === STARTING ===");var i=e.defer(),a=performance.now();return this.pendingMessages={},this.activeConversation=null,this.conversations=[],this.inCallConversations=[],this.idleConversations=[],this.involvedContactIds=[],this.promiseQueue=S.create(),this.waitingBotConversations=[],this.botServiceReady=!1,this.isBasicCallAllowed=E.isFeatureEnabled(E.FeaturesEnum.TELEPHONY_BASIC_CALL),this.isSecondCallAllowed=E.isFeatureEnabled(E.FeaturesEnum.TELEPHONY_SECOND_CALL),this.attachHandlers(),b.getServerConversations().then(function(){b.started=!0,b.linkAllActiveCallsToConversations();var e=Math.round(performance.now()-a);r.push({service:"conversationService",startDuration:e}),t.info("[conversationService] === STARTED ("+e+" ms) ==="),i.resolve()}).catch(function(e){t.info("[conversationService] === STARTING FAILURE === "+e.message),i.reject(e)}),this.contactUpdateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_CONTACT_UPDATED_EVENT, rehandle it"),this.contactUpdateEventHandlerCleaner()),this.contactUpdateEventHandlerCleaner=n.$on("ON_CONTACT_UPDATED_EVENT",this.onContactChangedEvent),this.roomUpdateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event "+h.ROOM_UPDATE_EVENT+", rehandle it"),this.roomUpdateEventHandlerCleaner()),this.roomUpdateEventHandlerCleaner=n.$on(h.ROOM_UPDATE_EVENT,this.onRoomChangedEvent),this.roomHistoryUpdateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event "+h.ROOM_HISTORY_UPDATE_EVENT+", rehandle it"),this.roomHistoryUpdateEventHandlerCleaner()),this.roomHistoryUpdateEventHandlerCleaner=n.$on(h.ROOM_HISTORY_UPDATE_EVENT,this.onRoomHistoryChangedEvent),this.roomAdminMessageEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event "+h.ROOM_ADMIN_MESSAGE_EVENT+", rehandle it"),this.roomAdminMessageEventHandlerCleaner()),this.roomAdminMessageEventHandlerCleaner=n.$on(h.ROOM_ADMIN_MESSAGE_EVENT,this.onRoomAdminMessageEvent),this.callUpdateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_CALL_UPDATED_EVENT, rehandle it"),this.callUpdateEventHandlerCleaner()),this.callUpdateEventHandlerCleaner=n.$on("ON_CALL_UPDATED_EVENT",this.onCallEvent),this.conversationUpdateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_CONVERSATIONS_UPDATED_EVENT, rehandle it"),this.conversationUpdateEventHandlerCleaner()),this.conversationUpdateEventHandlerCleaner=n.$on("ON_CONVERSATIONS_UPDATED_EVENT",this.onConversationEvent),this.capacityUpdateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_UPDATE_MYCONTACT_EVENT, rehandle it"),this.capacityUpdateEventHandlerCleaner()),this.capacityUpdateEventHandlerCleaner=n.$on("ON_UPDATE_MYCONTACT_EVENT",this.onMyContactChangedEvent),this.telephonyStateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_TELEPHONY_STATUS_CHANGED_EVENT, rehandle it"),this.telephonyStateEventHandlerCleaner()),this.telephonyStateEventHandlerCleaner=n.$on("ON_TELEPHONY_STATUS_CHANGED_EVENT",this.onTelephonyStateChangeEvent),this.conferenceStateEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_CONFERENCE_STATE_EVENT, rehandle it"),this.conferenceStateEventHandlerCleaner()),this.conferenceStateEventHandlerCleaner=n.$on("ON_CONFERENCE_STATE_EVENT",this.onConferenceStateChangeEvent),this.conferenceParticipantsEventHandlerCleaner&&(t.warn("[conversationService] already subscribed to event ON_CONFERENCE_PARTICIPANT_EVENT, rehandle it"),this.conferenceParticipantsEventHandlerCleaner()),this.conferenceParticipantsEventHandlerCleaner=n.$on("ON_CONFERENCE_PARTICIPANT_EVENT",this.onConferenceParticipantChangeEvent),i.promise},this.attachHandlers=function(){this.removeHandlers(),t.info("[conversationService] attachHandlers"),this.conversationHistoryHandler=m.create(this),this.conversationServiceEventHandler=v.create(this),a.addHistoryHandler(function(e){return b.conversationHistoryHandler.onHistoryMessageReceived(e)}),u.addFileTransfertHandler(function(e){b.conversationServiceEventHandler.onFileTransfertReceived(e)}),this.messageHandlerRef||(this.messageHandlerRef=a.addHandler(function(e){return b.conversationServiceEventHandler.onChatMessageReceived(e),!0},null,"message","chat")),this.messageMucHandlerRef||(this.messageMucHandlerRef=a.addHandler(function(e){return b.conversationServiceEventHandler.onChatMessageReceived(e),!0},null,"message","groupchat")),this.fileMessageHandlerRef||(this.fileMessageHandlerRef=a.addHandler(function(e){return b.conversationServiceEventHandler.onFileMessageReceived(e),!0},null,"message","file")),this.webrtcMessageHandlerRef||(this.webrtcMessageHandlerRef=a.addHandler(function(e){return b.conversationServiceEventHandler.onWebRTCMessageReceived(e),!0},null,"message","webrtc")),this.convMessageHandlerRef||(this.convMessageHandlerRef=a.addHandler(function(e){return b.conversationServiceEventHandler.onManagementMessageReceived(e),!0},null,"message","management")),this.receiptMessageHandlerRef||(this.receiptMessageHandlerRef=a.addHandler(function(e){return b.conversationServiceEventHandler.onReceiptMessageReceived(e),!0},null,"message")),this.recordingMessageHandlerRef||(this.recordingMessageHandlerRef=a.addHandler(function(e){return b.conversationServiceEventHandler.onRecordingMessageReceived(e),!0},null,"message","recording"))},this.removeHandlers=function(){t.info("[conversationService] removeHandlers "),this.conversationHistoryHandler&&(this.conversationHistoryHandler=null),this.conversationServiceEventHandler&&(this.conversationServiceEventHandler=null),this.messageHandlerRef&&(a.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.fileMessageHandlerRef&&(a.deleteHandler(this.fileMessageHandlerRef),this.fileMessageHandlerRef=null),this.webrtcMessageHandlerRef&&(a.deleteHandler(this.webrtcMessageHandlerRef),this.webrtcMessageHandlerRef=null),this.convMessageHandlerRef&&(a.deleteHandler(this.convMessageHandlerRef),this.convMessageHandlerRef=null),this.receiptMessageHandlerRef&&(a.deleteHandler(this.receiptMessageHandlerRef),this.receiptMessageHandlerRef=null),this.messageMucHandlerRef&&(a.deleteHandler(this.messageMucHandlerRef),this.messageMucHandlerRef=null),this.recordingMessageHandlerRef&&(a.deleteHandler(this.recordingMessageHandlerRef),this.recordingMessageHandlerRef=null)},b.stop=function(){return t.info("[conversationService] === STOPPING ==="),this.conversations=null,this.messageHandlerRef&&(a.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.fileMessageHandlerRef&&(a.deleteHandler(this.fileMessageHandlerRef),this.fileMessageHandlerRef=null),this.webrtcMessageHandlerRef&&(a.deleteHandler(this.webrtcMessageHandlerRef),this.webrtcMessageHandlerRef=null),this.recordingMessageHandlerRef&&(a.deleteHandler(this.recordingMessageHandlerRef),this.recordingMessageHandlerRef=null),this.contactUpdateEventHandlerCleaner&&(this.contactUpdateEventHandlerCleaner(),this.contactUpdateEventHandlerCleaner=null),this.roomUpdateEventHandlerCleaner&&(this.roomUpdateEventHandlerCleaner(),this.roomUpdateEventHandlerCleaner=null),this.roomAdminMessageEventHandlerCleaner&&(this.roomAdminMessageEventHandlerCleaner(),this.roomAdminMessageEventHandlerCleaner=null),this.callUpdateEventHandlerCleaner&&(this.callUpdateEventHandlerCleaner(),this.callUpdateEventHandlerCleaner=null),this.conversationUpdateEventHandlerCleaner&&(this.conversationUpdateEventHandlerCleaner(),this.conversationUpdateEventHandlerCleaner=null),this.capacityUpdateEventHandlerCleaner&&(this.capacityUpdateEventHandlerCleaner(),this.capacityUpdateEventHandlerCleaner=null),this.telephonyStateEventHandlerCleaner&&(this.telephonyStateEventHandlerCleaner(),this.telephonyStateEventHandlerCleaner=null),this.started=!1,t.info("[conversationService] === STOPPED ==="),e.when()},b.getServerConversations=function(){var n=e.defer();return r({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId+"/conversations",headers:o.getRequestHeader()}).then(function(r){var i=[];r.data.data.forEach(function(e){var t=parseInt(e.unreadMessageNumber,10),n=null,r=!0===e.mute;n="user"===e.type?b.getOrCreateOneToOneConversation(e.jid_im,e.id,e.lastMessageDate,e.lastMessageText,t,r,e.creationDate):b.getRoomConversation(e.jid_im,e.id,e.lastMessageDate,e.lastMessageText,t,!0,r,e.creationDate,e.lastMessageSender,e.topic),i.push(n)}),e.all(i).then(function(){return b.removeOlderConversations()}).then(function(){b.orderConversations(),n.resolve()}).catch(function(e){var r="getServerConversations failure: "+e.message;t.error("[conversationService] "+r),n.reject(new Error(r))})},function(e){var r="getServerConversations failure: no server response";e&&(r="getServerConversations failure: "+JSON.stringify(e)),t.error("[conversationService] "+r),n.reject(new Error(r))}),n.promise},this.createServerConversation=function(n){var i=e.defer();if(n.dbId)return e.when(n);var a={};if(n.type===c.Type.ONE_TO_ONE){if(!n.contact.dbId)return e.when(n);a.peerId=n.contact.dbId,a.type="user"}else if(n.type===c.Type.BOT){if(n.type=c.Type.ONE_TO_ONE,!n.contact.dbId)return e.when(n);a.peerId=n.contact.dbId,a.type="bot"}else a.peerId=n.room.dbId,a.type="room";if(n.room&&n.room.avatar)var l=n.room.avatar;return r({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId+"/conversations",headers:o.getRequestHeader(),data:a}).then(function(e){t.info("[conversationService] createServerConversation success: "+n.id),n.dbId=e.data.data.id,n.lastModification=e.data.data.lastMessageDate?new Date(e.data.data.lastMessageDate):void 0,n.creationDate=e.data.data.creationDate?new Date(e.data.data.creationDate):new Date,n.missedCounter=parseInt(e.data.data.unreadMessageNumber),l&&(n.room.avatar=l),b.orderConversations(),i.resolve(n)},function(e){var n="createServerConversation failure: "+e.data.errorDetails;t.warn("[conversationService] "+n),i.reject(new Error(n))}),i.promise},this.deleteServerConversation=function(n){var i=e.defer();return n?(r({method:"DELETE",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId+"/conversations/"+n,headers:o.getRequestHeader()}).then(function(){t.info("[conversationService] deleteServerConversation success: "+n),b.orderConversations(),i.resolve()},function(e){if(404002===e.data.errorDetailsCode)t.info("[conversationService] deleteServerConversation success: "+n),i.resolve();else{var r="deleteServerConversation failure: "+e.data.errorDetails;t.warn("[conversationService] "+r),i.reject(new Error(r))}}),i.promise):e.when()},this.updateServerConversation=function(n,i){var a=e.defer();return n?(r({method:"PUT",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId+"/conversations/"+n,headers:o.getPostHeader(),data:{mute:i}}).then(function(){t.info("[conversationService] updateServerConversation success: "+n),a.resolve()},function(e){var n="updateServerConversation failure: "+e.data.errorDetails;t.warn("[conversationService] "+n),a.reject(new Error(n))}),a.promise):e.when()},this.ackAllMessages=function(n){return e(function(e,i){r({method:"PUT",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId+"/conversations/"+n+"/markallread",headers:o.getPostHeader()}).then(function(){t.info("[conversationService] ackAllMessages success: "+n),e()},function(e){var n="ackAllMessages failure: "+e.data.errorDetails;t.warn("[conversationService] "+n),i(new Error(n))})})},this.getOrCreateOneToOneConversation=function(r,i,a,o,l,u,d){t.info("[conversationService] getOrCreateOneToOneConversation "+r+" "+i+" "+l);var f=b.getConversationById(r);if(f)return f.preload=!0,e.when(f);var h=e.defer();return s.getOrCreateContact(r).then(function(e){var t=c.createOneToOneConversation(e);return t.lastModification=a?new Date(a):void 0,t.lastMessageText=o,t.muted=u,t.creationDate=d?new Date(d):new Date,t.preload=!1,b.computeCapabilitiesForContact(e),t.dbId=i,l&&(t.missedCounter=l),b.conversations[e.id]=t,b.createServerConversation(t)}).then(function(e){n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",e),h.resolve(e)}).catch(function(e){var n="getOrCreateOneToOneConversation "+r+" failure "+e.message;t.error("[conversationService] "+n),h.resolve(new Error(n))}),h.promise},this.getRoomConversation=function(r,i,a,o,s,l,u,d,f,p){t.info("[conversationService] getRoomConversation "+r);var v=b.getConversationById(r);return v?(v.preload=!0,e.when(v)):e(function(e,m){var g=h.getRoomByJid(r);if(g)(v=c.createRoomConversation(g)).dbId=i,v.lastModification=a?new Date(a):void 0,v.lastMessageText=o,v.muted=u,v.creationDate=d?new Date(d):new Date,v.preload=!1,v.lastMessageSender=f,v.room&&p&&(v.room.desc=p),s&&(v.missedCounter=s),b.conversations[v.id]=v,i?b.getRoomConferences(v).then(function(){n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",v),e(v)}):b.createServerConversation(v).then(function(t){g&&h.sendInitialRoomPresence(g),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t),e(t)}).catch(function(n){var a="getRoomConversation ("+r+") failure : "+n.message;t.error("[conversationService] "+a),b.deleteServerConversation(i),l?e():m(new Error(a))});else{t.error("[conversationService] getRoomConversation ("+r+") failure : no such room");var E={jid:r,conversationDbId:i,lastModification:a,lastMessageText:o,missedIMCounter:s,muted:u,creationDate:d};b.waitingBotConversations.push(E),b.unlockWaitingBotConversations(),e()}})},b.getRoomConferences=function(t){return e(function(e){var n=t.room.confEndpoints;n&&n.forEach(function(e){if("pstnAudio"===e.mediaType){var n=C.getConferenceSessionById(e.confEndpointId);n&&(t.pstnConferenceSession=n)}}),e()})},b.updateRoomConferences=function(){b.getConversations().forEach(function(e){if(e.room&&e.room.confEndpoints){var t=C.getConferenceSessionById(e.room.getPstnConfEndpointId());e.pstnConferenceSession=t||null}else e.pstnConferenceSession=null})},this.closeConversation=function(n){return e(function(e,r){t.info("[conversationService] closeConversation "+n.id),b.deleteServerConversation(n.dbId).then(function(){b.removeConversation(n),e()}).catch(function(e){r(e)})})},this.removeConversation=function(e){if(t.info("[conversationService] remove conversation "+e.id),e.videoCall&&e.videoCall.status!==l.Status.UNKNOWN)t.info("[conversationService] Ignore conversation deletion message for conversation"+e.id);else{delete b.conversations[e.id],b.orderConversations();var r=b.getOrderedConversations();!b.activeConversation||r.idle.indexOf(b.activeConversation)>=0||(r.idle.length>0?b.setActiveConversation(r.idle.first()):r.inCall.length>0?b.setActiveConversation(r.inCall.first()):b.setActiveConversation(null)),e.contact&&(e.contact.conversation=null,e.contact=null),n.$broadcast("ON_CONVERSATION_REMOVE_EVENT",e)}},this.getConversationByDbId=function(e){if(b.conversations)for(var t in b.conversations)if(b.conversations.hasOwnProperty(t)&&b.conversations[t].dbId===e)return b.conversations[t];return null},this.getConversationByRoomDbId=function(e){if(b.conversations)for(var t in b.conversations)if(b.conversations.hasOwnProperty(t)&&b.conversations[t].room&&b.conversations[t].room.dbId===e)return b.conversations[t];return null},this.removeOlderConversations=function(){var n=parseInt(p.getSetting("nbMaxConversations")),r=b.getConversations().sort(b.sortFunction);if(r.length>n){t.info("[conversationService] remove older conversations");for(var i=[],a=n;a<r.length;a++)i.push(b.closeConversation(r[a]));return e.all(i)}return e.when()},this.searchConversations=function(e){var t=g.removeDiacritis(e.toLowerCase()).trim().split(/[ ]+/);return b.getOrderedConversations().idle.filter(function(e){var n=e.filterName.trim().split(/[ ]+/);return t.every(function(e){return n.some(function(t){return!(!t.length||0!==t.indexOf(e))})})})},this.sendFSMessage=function(t,r,i){var a=e.defer();return t.sendFSMessage(r,i).then(function(e){b.pendingMessages[e.id]={conversation:t,message:e},a.resolve(e)},function(e){var t=e.translatedMessage?e.translatedMessage:"Unable to share file";n.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"fileTransfer",popupBodyTranslated:t,okLabel:"ok"}),a.reject(e)}),a.promise},this.sendEFSMessage=function(e,t,r){var i=e.sendEFSMessage(t,r);return this.pendingMessages[i.id]={conversation:e,message:i},n.$broadcast("ON_SEND_EFS_MESSAGE",t),i},this.sendChatMessage=function(e,t){var n=e.sendChatMessage(t);return this.pendingMessages[n.id]={conversation:e,message:n},n},this.sendIsTypingState=function(e,t){e.sendIsTypingState(t)},this.sendRecordingMessage=function(e,t){var n=e.sendRecordingMessage(t);return this.pendingMessages[n.id]={conversation:e,message:n},n},this.removeAllMessages=function(n){t.info("[conversationService] removeAllMessage "+n.id);var r=e.defer(),i={deleteid:"remove_"+n.id,with:n.id,before:moment().utc().format("YYYY-MM-DDTHH:mm:ss")+"Z",onComplete:function(){r.resolve()}};return a.connection.mam.delete(n.id,i),r.promise},this.removeMessagesFromConversation=function(n,r,i){t.info("[conversationService] removeMessagesFromConversation "+n.id),t.info("[conversationService] removing "+i+" messages after "+r);var o=e.defer(),s={deleteid:"remove_"+n.id,with:n.id,start:moment(r).format("YYYY-MM-DDTHH:mm:ss.SSSSSSZ"),max:i,onComplete:function(){t.info("[conversationService] MAM Message deleted !!!"),o.resolve()}};return a.connection.mam.delete(n.id,s),o.promise},this.sendConversationByEmail=function(n){var i=e.defer(),a=s.userContact,c=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+a.dbId+"/conversations/"+n.dbId+"/downloads";return r({method:"POST",url:c,headers:o.getRequestHeader(),data:{}}).then(function(){t.error("[conversationService] sendConversationByEmail - success"),i.resolve()},function(e){var n={message:"Impossible to download conversation"};e&&e.data&&409011===e.data.errorDetailsCode&&(n.message="No messages to export for the last 30 days.",n.messageKey="noMessagesToExport"),t.error("[adminUserService] sendConversationByEmail - "+n.message),i.reject(n)}),i.promise},this.getHistoryPage=function(e,t){return b.conversationHistoryHandler.getHistoryPage(e,t)},this.setActiveConversation=function(e){e&&(e.sendAckReadMessages()&&this.ackAllMessages(e.dbId));return t.debug("[conversationService] - setActiveConversation: "+(e?e.id:"null")),this.activeConversation=e,this.activeConversation},this.setMostRecentConversationActive=function(){var e=b.getConversations().sort(b.sortFunction);return e.length>0?this.setActiveConversation(e.first()):this.setActiveConversation(null)},this.getActiveConversation=function(){return this.activeConversation},this.getConversationById=function(e){return b.conversations?b.conversations[e]:null},this.getConversations=function(){var e=[];for(var t in b.conversations)b.conversations.hasOwnProperty(t)&&e.push(b.conversations[t]);return e},this.orderConversations=function(){b.inCallConversations=[],b.idleConversations=[],b.involvedContactIds=[],Object.keys(b.conversations).forEach(function(e){var t=b.conversations[e];if(t.isInCall())b.inCallConversations.push(t);else if(b.idleConversations.push(t),t.type===c.Type.ROOM&&t.room.owner&&t.room.isMeetingRoom()&&!t.room.conference.scheduled){var n=C.getConferenceSessionById(t.room.getPstnConfEndpointId());n&&n.isActive()&&b.idleConversations.pop()}t.type===c.Type.ONE_TO_ONE&&b.involvedContactIds.push(t.contact.id)}),b.idleConversations.sort(b.sortFunction)},this.getOrderedConversations=function(){return{inCall:b.inCallConversations,idle:b.idleConversations,contactIds:b.involvedContactIds}},this.sortFunction=function(e,t){var n=e.lastModification,r=e.creationDate,i=t.lastModification,a=t.creationDate,o=r;return o=!n&&r?r:n,(!i&&a?a:i)-o},this.formatDate=function(e){return moment(e).utc().format("YYYY-MM-DDTHH:mm:ss")+"Z"},this.resetConversationMissedCounters=function(e){n.appVisible&&(e.missedCounter=0,e.missedCalls=0,this.updateMissedCounters())},this.decreaseMissedIMCounterForConversation=function(e){e.missedCounter>0&&(e.missedCounter-=1),this.updateMissedCounters()};var R=0,y=0;this.updateMissedCounters=function(){var e=0,t=[];Object.keys(b.conversations).forEach(function(n){var r=b.conversations[n];0!==r.missedCounter&&(e+=r.missedCounter,t.push(r))}),e===R&&0===y||(R=e,y=0,n.$broadcast("ON_MISSED_COUNTER_CHANGED_EVENT",{missedIMCounter:e,missedCallCounter:0,missedIMDetails:t}))},this.dropConversationCall=function(e){e.audioCall&&f.releaseCall(e.audioCall),e.videoCall&&(d.attachLocalMediaStream(!1),d.attachDistantMediaStream(!1),d.releaseCall(e.videoCall))},this.holdConversationCall=function(e){e.audioCall&&(f.holdCall(e.audioCall),e.videoCall&&(d.attachLocalMediaStream(!1),d.attachDistantMediaStream(!1),d.releaseCall(e.videoCall)))},this.retrieveConversationCall=function(e){e.audioCall&&f.retrieveCall(e.audioCall),e.videoCall&&t.error("Not implemented for the moment")},this.allowDesktopSharing=function(){return!1},this.allowAdvancedDesktopSharing=function(){return!1},this.updateConversationCall=function(e,t){t.type===l.Type.WEBRTC?e.videoCall=t:t.type===l.Type.PHONE&&(e.audioCall=t),t.setConversationId(e.id),this.computeCapabilitiesForContact(e.contact),b.computeCapabilitiesForMyContact()},this.computeCapabilitiesForContact=function(e,r){var i=!1,a=!1,o=!1,c=!1,u=!1,h=e.status,p=e.fullJid,v=s.userContact;if(e.jid!==v.jid){var m=e.company&&s.userContact.company&&"Rainbow"!==e.company.name&&"Default"!==e.company.name&&e.company.name===s.userContact.company.name,g=this.getConversationById(e.id);if(d.started){var E=g?g.videoCall:null;E&&E.status!==l.Status.UNKNOWN||!("unknown"===h&&m||"wait"===h||"online"===h||"online-mobile"===h||"away"===h||"busy"===h&&"audioPhone"===e.message)||(a=!0,p&&(o=!0))}if(f.started){var S=e.phonePro||e.phonePbx&&e.pbxId||e.mobilePro||e.phonePerso||e.mobilePerso,C=f.getActiveCallsForContact(e);0===C.length&&S?i=!0:0!==C.length&&p&&(u=!0)}"online"!==h&&"busy"!==h&&"away"!==h&&"dnd"!==h||(c=!0);var b={telephony:i,webRTC:a,sharedDesktop:o,fileTransfert:c,mediaAvailable:i||a,addMedia:u};(e.isBot||e.displayName&&-1!==e.displayName.indexOf("E-HELPER"))&&(b={telephony:!1,webRTC:!1,sharedDesktop:!1,fileTransfert:!1,mediaAvailable:!1,addMedia:!1}),e.capabilities=b,g&&(g.capabilities=b,r||n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",g)),t.info('[conversationService] update capabilities for contact "'+e.displayNameForLog()+'" capabilities (tel:'+i+", webRTC:"+a+", sharing: "+o+", addMedia: "+u+")")}else this.computeCapabilitiesForMyContact()},this.computeCapabilitiesForMyContact=function(){var e=!1,n=!1,r=!1,i=s.userContact;d.started&&(d.isUserContactInCall()||"busy"===i.status&&("busy"!==i.status||"audioPhone"!==i.message)||(n=!0,b.allowDesktopSharing()&&(r=!0)));if(f.started){var a=f.getCalls();(0===a.length&&b.isBasicCallAllowed||1===a.length&&b.isSecondCallAllowed)&&(e=!0)}var o={telephony:e,webRTC:n,sharedDesktop:r,mediaAvailable:e||n};i.capabilities=o,t.info("[conversationService] update capabilities for my contact : capabilities (tel:"+e+", webRTC:"+n+", sharing: "+r+")")},this.onCallEvent=function(e,t){return t.type===l.Type.WEBRTC?b.getOrCreateOneToOneConversation(t.contact.id).then(function(e){b.updateConversationCall(e,t),b.orderConversations(),n.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:e,call:t})}):(t.type===l.Type.PHONE&&t.status===l.Status.UNKNOWN&&t.contact&&d.endAllCallsForContact(t.contact),n.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:t})),!0},this.onConversationEvent=function(){b.updateMissedCounters()},this.onContactChangedEvent=function(e,t){b.computeCapabilitiesForContact(t),b.computeCapabilitiesForMyContact()},this.onTelephonyStateChangeEvent=function(e){var t=b.getConversations();t&&t.forEach(function(e){e.type===c.Type.ONE_TO_ONE&&b.computeCapabilitiesForContact(e.contact)}),b.computeCapabilitiesForMyContact()},this.onConferenceStateChangeEvent=function(){b.updateRoomConferences(),b.orderConversations(),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")},this.onConferenceParticipantChangeEvent=function(){b.orderConversations(),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")},this.onRoomChangedEvent=function(e,t,n){if(t){var r=b.getConversationById(t.jid);r&&("remove"===n?b.closeConversation(r):r.room=t)}},this.onRoomHistoryChangedEvent=function(e,t){if(t){var n=b.getConversationById(t.jid);n&&n.chatRenderer&&(n.reset(),n.chatRenderer.loadMore())}},this.onRoomAdminMessageEvent=function(e,n,r,i,a){t.info("[conversationService] onRoomAdminMessageEvent");var o=b.getConversationById(n);o&&("welcome"===i||"conferenceAdd"===i||"conferenceRemove"===i)&&o.room&&o.room.ownerContact&&(r=o.room.ownerContact.jid);var c=s.getContactByJid(r);if(o&&c){if(!o.room.owner&&"invitation"===i)return;if(o.room&&o.room.isMeetingRoom())return;b.conversationServiceEventHandler.onRoomAdminMessageReceived(o,c,i,a)}},this.onMyContactChangedEvent=function(){b.getOrderedConversations().idle.forEach(function(e){e.type===c.Type.ONE_TO_ONE&&b.computeCapabilitiesForContact(e.contact)}),b.computeCapabilitiesForMyContact()},this.reinit=function(){var n=e.defer();return t.info("[conversationService] Re-initialize conversation service"),b.activeConversation&&(b.activeConversation.reset(),b.activeConversation=null),delete b.conversations,b.conversations=[],b.botServiceReady=!0,b.getServerConversations().then(function(){b.linkAllActiveCallsToConversations(),n.resolve()}).catch(function(){i(function(){t.info("[conversationService] getServerConversations failure, try again"),b.getServerConversations().then(function(){b.linkAllActiveCallsToConversations()})},1e4,1,!0),n.resolve()}),n.promise},this.linkAllActiveCallsToConversations=function(){for(var e in f.calls)if(f.calls.hasOwnProperty(e)){var t=f.calls[e];n.$broadcast("ON_CALL_UPDATED_EVENT",t)}for(var e in d.calls)if(d.calls.hasOwnProperty(e)){t=d.calls[e];n.$broadcast("ON_CALL_UPDATED_EVENT",t)}},this.unlockWaitingBotConversations=function(e){e&&(b.botServiceReady=!0),b.botServiceReady&&(b.botServiceReady=!1,b.waitingBotConversations.forEach(function(e,t){var n=s.getContactByJid(e.jid);n&&(b.getOrCreateOneToOneConversation(n.jid,null,e.lastModification,e.lastMessageText,e.missedIMCounter,e.muted,e.creationDate),b.waitingBotConversations.splice(t,1))}),b.waitingBotConversations=[])}}]),angular.module("rainbow").factory("ConversationServiceEventHandler",["$q","$log","$rootScope","contactService","xmppService","Conversation","Message","fileStorageService","fileServerService",function(e,t,n,r,i,a,o,s,c){"use strict";function l(e){this.conversationService=e}return l.create=function(e){return new l(e)},l.prototype.onChatMessageReceived=function(e){t.info("[ConversationServiceEventHandler] onChatMessageReceived");try{var n=this,i=$(e);return i.find("event").length>0||i.find("propose").length>0||i.find("received").length>0?t.info("[ConversationServiceEventHandler] onChatMessageReceived ignore the message"):this.extractStanzaData(e).then(function(t){t.body||t.oob||t.conference?n.handleChatMessage(t):t.outgoingMessage||r.isUserContact(t.participant)||!t.status||n.handleStatusMessage(t.conversation,t.participant,e)}),!0}catch(e){return t.error("[ConversationServiceEventHandler] onChatMessageReceived ERROR "+e),!0}},l.prototype.onFileTransfertReceived=function(e){var t=i.getBareJidFromJid(e.from),r=this;this.conversationService.getOrCreateOneToOneConversation(t).then(function(t){var i=t.contact,o=a.getUniqueMessageId(),s=t.addFTMessage(i,new Date,e,o);t.setStatusMessage(i,a.Status.ACTIVE),t===r.conversationService.activeConversation&&n.appVisible&&"conversations"===n.activeApplication||(t.missedCounter+=1),t.sendAckReadMessage(s),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t)})},l.prototype.onRoomAdminMessageReceived=function(e,r,i,o){t.info("[ConversationServiceEventHandler] onRoomAdminMessageReceived");var s=e.addAdminBubbleMessage(r,new Date,i,o);e.setStatusMessage(r,a.Status.ACTIVE),e.sendAckReceivedMessage(s),e===this.conversationService.activeConversation&&n.appVisible&&"conversations"===n.activeApplication?e.sendAckReadMessage(s):e.missedCounter+=1,n.$broadcast("ON_CONVERSATION_MESSAGE_RECEIVED",s,e,!1),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",e)},l.prototype.onFileMessageReceived=function(e){t.info("[ConversationServiceEventHandler] onFileMessageReceived");try{return this.extractStanzaData(e).then(function(e){if(e.body){var t=e.conversation;t.addFileMessage(e.participant,e.date,e.body,e.messageId),t.setStatusMessage(e.participant,a.Status.ACTIVE),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t)}}),!0}catch(e){return t.error("[ConversationServiceEventHandler] onFileMessageReceived ERROR "+e),!0}},l.prototype.onWebRTCMessageReceived=function(e){t.info("[ConversationServiceEventHandler] onWebRTCMessageReceived");try{return angular.element(e).find("call_log").length>0?this.extractWebrtcStanzaData(e).then(function(e){if(e.body){var t=e.conversation;t.addWebRTCMessage(e.participant,e.date,e.body,e.messageId),t.setStatusMessage(e.participant,a.Status.ACTIVE),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t)}}):this.extractStanzaData(e).then(function(e){if(e.body){var t=e.conversation;t.addWebRTCMessage(e.participant,e.date,e.body,e.messageId),t.setStatusMessage(e.participant,a.Status.ACTIVE),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t)}}),!0}catch(e){return t.error("[ConversationServiceEventHandler] onWebRTCMessageReceived error "+e),!0}},l.prototype.onRecordingMessageReceived=function(e){t.info("[ConversationServiceEventHandler] onRecordingMessageReceived");try{return this.extractStanzaData(e).then(function(e){if("start"===e.body)(t=e.conversation).addRecordingMessage(e.participant,e.date,e.body,e.messageId),t.setStatusMessage(e.participant,a.Status.ACTIVE),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",t),n.$broadcast("ON_RECORDING_START_MSG_RECEIVED");else if("stop"===e.body){var t;(t=e.conversation)&&t.addRecordingMessage(e.participant,e.date,e.body,e.messageId),n.$broadcast("ON_RECORDING_STOP_MSG_RECEIVED")}else"remoteStopVideo"===e.body?n.$broadcast("ON_RECORDING_REMOTESTOPVIDEO_MSG_RECEIVED"):"remoteChangeMediaVideo"===e.body?n.$broadcast("ON_RECORDING_REMOTECHANGEMEDIAVIDEO_MSG_RECEIVED"):"remoteStopSharing"===e.body?n.$broadcast("ON_RECORDING_REMOTESTOPSHARING_MSG_RECEIVED"):"remoteChangeMediaSharing"===e.body&&n.$broadcast("ON_RECORDING_REMOTECHANGEMEDIASHARING_MSG_RECEIVED")}),!0}catch(e){return t.error("[ConversationServiceEventHandler] onRecordingMessageReceived error "+e),!0}},l.prototype.onManagementMessageReceived=function(e){try{var n=angular.element(e).find("conversation");if(n)if(r=this.conversationService.getConversationByDbId(n.attr("id")))"delete"===n.attr("action")&&(t.info("[ConversationServiceEventHandler] onManagementMessageReceived (delete conversation)"),this.conversationService.removeConversation(r));if(angular.element(e).find("mute")||angular.element(e).find("unmute")){var r,i=!(0===angular.element(e).find("mute").length),a=angular.element(e).find("mute").attr("conversation")||angular.element(e).find("unmute").attr("conversation");(r=this.conversationService.getConversationByDbId(a))&&(t.info("[ConversationServiceEventHandler] onManagementMessageReceived : mute is changed to "+i),r.muted=i)}return!0}catch(e){return t.error("[ConversationServiceEventHandler] onManagementMessageReceived error "+e),!0}},l.prototype.onReceiptMessageReceived=function(e){t.info("[ConversationServiceEventHandler] onReceiptMessageReceived");try{var a=angular.element(e),s=i.getBareJidFromJid(a.attr("from")),c=a.find("message");r.isUserContactJid(s)&&c.length>0&&(a=angular.element(c));var l=a.find("received");if(l.length&&l.length>0){var u=angular.element(l).attr("id"),d=angular.element(l).attr("entity"),f=angular.element(l).attr("event");if("server"===d&&"received"===f){var h=this.conversationService.pendingMessages[u],p=h.message,v=h.conversation;t.info("[conversationService] Receive server ack ("+v.id+", "+p.id+")"),p.setReceiptStatus(o.ReceiptStatus.SENT),v.updateMessage(p),delete this.conversationService.pendingMessages[u],n.$broadcast("ON_CONVERSATION_RECEIPT_RECEIVED",p,v,"server")}else if("client"===d){var m=this;this.extractStanzaData(e).then(function(t){m.handleReceiptReceiveMessage(t.conversation,e)})}}return!0}catch(e){return t.error("[ConversationServiceEventHandler] onReceiptMessageReceived error "+e),!0}},l.prototype.extractStanzaData=function(n){var a=i.getBareJidFromJid(angular.element(n).attr("from")),o={},s=null,c=null,l=null,u=e.defer(),d=angular.element(n).find("message");if(r.isUserContactJid(a)&&d.length>0){var f=i.getBareJidFromJid(angular.element(d).attr("from")),h=i.getResourceFromJid(angular.element(d).attr("from")),p=i.getBareJidFromJid(angular.element(d).attr("to")),v=i.getResourceFromJid(angular.element(d).attr("to"));if(o.outgoingMessage=r.isUserContactJid(f),o.body=angular.element(d).find("body").text(),o.participant=o.outgoingMessage?r.userContact:null,o.messageId=angular.element(d).attr("id"),o.carbon=!0,s=o.outgoingMessage?p:f,c=o.outgoingMessage?v:h,l=angular.element(d).find("delay"),(O=angular.element(d).find("x[xmlns='jabber:x:oob']"))&&O.length){var m=angular.element(O).find("url").text(),g=angular.element(O).find("mime").text(),E=angular.element(O).find("filename").text(),S=angular.element(O).find("size").text();o.oob={url:m,mime:g,filename:E,filesize:S}}if((D=$(n).find("x[xmlns='jabber:x:audioconference']"))&&D.length){var C=(P=$(D)).attr("subject"),b=P.attr("confendpointid"),R=D.attr("jid"),y=D.attr("type");o.conference={type:y,subject:C,confendpointid:b,roomjid:R,ownerjid:s}}o.status=null;var N=angular.element(n).find("composing"),T=angular.element(n).find("paused"),A=angular.element(n).find("active");N.length?o.status="composing":T.length?o.status="paused":A.length&&(o.status="active")}else{var I=$(n);o.outgoingMessage=!1,o.body=I.find("body").text(),o.messageId=I.attr("id"),o.carbon=!1,s=i.getBareJidFromJid(I.attr("from")),c=i.getResourceFromJid(I.attr("from")),l=I.find("delay");var O,D,w="push"===I.find("retransmission").attr("source");if((O=I.find("x[xmlns='jabber:x:oob']"))&&O.length){var _=$(O);m=_.find("url").text(),g=_.find("mime").text(),E=_.find("filename").text(),S=_.find("size").text();o.oob={url:m,mime:g,filename:E,filesize:S}}if((D=I.find("x[xmlns='jabber:x:audioconference']"))&&D.length){var P,M=(P=$(D)).attr("message");b=P.attr("confendpointid"),R=D.attr("jid"),y=D.attr("type");if(o.conference={type:y,message:M,confendpointid:b,roomjid:R,ownerjid:s},"reminder"!==y)return t.debug("[conversationServiceEventHandler] ignored message stanza for conference"),u.resolve(o),u.promise;s=R}var U=I.find("content[xmlns='urn:xmpp:content']");U&&"text/markdown"===U.attr("type")&&(o.markdown=!0,o.body=U.text()),(C=I.find("subject"))&&""!==C.text()&&(o.subject=C.text()),o.status=null;N=I.find("composing"),T=I.find("paused"),A=I.find("active");N.length?o.status="composing":T.length?o.status="paused":A.length&&(o.status="active")}if(o.date=new Date,o.offline=!1,"Offline Storage"===l.text()&&(o.date=new Date(l.attr("stamp")),o.offline=!0),w){var F=this.conversationService.getConversationById(s);if(F)u.reject();else{var L=this.conversationService;(s.startsWith("room_")?L.getRoomConversation(s):L.getOrCreateOneToOneConversation(s)).then(function(e){F=e,u.reject()})}return u.promise}if(o.body||this.conversationService.getConversationById(s)||o.oob||o.conference)0===s.indexOf("room_")?this.conversationService.getRoomConversation(s).then(function(e){return o.conversation=e,o.conference&&o.conference.ownerjid?r.getOrCreateContact(o.conference.ownerjid):(c&&-1!==c.indexOf("/")&&(c=c.split("/")[0]),r.getOrCreateContact(c))}).then(function(e){o.participant=e,u.resolve(o)}).catch(function(e){t.error("[conversationServiceEventHandler] impossible to fetch conversation "+e.message),u.reject()}):this.conversationService.getOrCreateOneToOneConversation(s).then(function(e){o.conversation=e,o.participant||(o.participant=e.contact),u.resolve(o)}).catch(function(e){t.error("[conversationServiceEventHandler] impossible to fetch conversation "+e.message),u.reject()});else if(I.find("deleted")){var k=I.find("deleted")[0];if(k&&"all"===k.getAttribute("id")){var B=this.conversationService.getConversationById(k.getAttribute("with"));B&&(t.info("[conversationServiceEventHandler] Remove all messages for conversation "+B.id),B.reset())}}else t.debug("[conversationServiceEventHandler] ignored message stanza"),u.reject();return u.promise},l.prototype.extractWebrtcStanzaData=function(n){t.debug("[conversationServiceEventHandler] extractWebrtcStanzaData");var i=e.defer(),a={},o=null;a.messageId=$(n).attr("id"),a.callerJid=$(n).find("caller").text(),a.calleeJid=$(n).find("callee").text(),a.state=$(n).find("state").text();var s=0;$(n).find("duration")&&(s=$(n).find("duration").text(),s=parseInt(s,10)),s=s>0?"("+moment.duration(s,"ms").format("h[H] mm[m] ss[s]")+")":0;var c=$(n).find("date").text();if(c&&(c=new Date(c)),a.duration=s,a.date=c,r.isUserContactJid(a.callerJid)?(o=a.calleeJid,a.participant=r.userContact):o=a.callerJid,a.body="","missed"===a.state){var l="missedCall||"+c;a.body=l}else if("answered"===a.state){l="activeCallMsg||"+c+"||"+s;a.body=l}return-1!==o.indexOf("janusgateway")?(t.debug("[conversationServiceEventHandler] extractWebrtcStanzaData ignore janus message !"),e.reject()):(this.conversationService.getOrCreateOneToOneConversation(o).then(function(e){a.conversation=e,a.participant||(a.participant=e.contact),i.resolve(a)}).catch(function(e){t.error("[conversationServiceEventHandler] impossible to fetch conversation "+e.message),i.reject()}),i.promise)},l.prototype.handleChatMessage=function(e){t.info("[ConversationServiceEventHandler] handleChatMessage");var r=this,i=e.conversation,a=null;if(e.oob){var o=e.oob.url,l=s.extractFileIdFromUrl(o);s.retrieveAndStoreOneFileDescriptor(l).then(function(t){a=i.addFileSharingMessage(e.participant,e.date,e.body,e.messageId,l),r.acknowledgeHandledChatMessage(e,i,a),c.getBlobThumbnailFromFileDescriptor(t).then(function(e){t.previewBlob=e,n.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:t.id})}),n.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:t.id})}).catch(function(e){t.info("[ConversationServiceEventHandler] handleChatMessage error "+e)})}else if(e.conference){var u={type:e.conference.type,message:e.conference.subject,confendpointid:e.conference.confendpointid,roomjid:e.conference.roomjid};if(i=this.conversationService.getConversationByRoomDbId(u.roomjid),n.$broadcast("ROOM_UPDATE_CONFID"),!i)return!0;a=i.addConferenceMessage(e.participant,e.date,e.messageId,u)}else a=i.addChatMessage(e.participant,e.date,e.body,e.messageId,null,e.markdown,e.subject);a&&r.acknowledgeHandledChatMessage(e,i,a)},l.prototype.acknowledgeHandledChatMessage=function(e,i,s){if(t.info("[ConversationServiceEventHandler] acknowledgeHandledChatMessage"),!s)return s=i.getMessageById(e.messageId),i.room&&s&&s.side===o.Side.RIGHT&&(i.sendAckReceivedMessage(s),i.sendAckReadMessage(s)),!0;s.side===o.Side.LEFT?i===this.conversationService.activeConversation&&"away"!==r.userContact.status&&n.appVisible&&"conversations"===n.activeApplication?(i.sendAckReceivedMessage(s),i.sendAckReadMessage(s)):(i.sendAckReceivedMessage(s),!e.offline&&i.preload&&(i.missedCounter+=1)):(e.carbon?s.setReceiptStatus(o.ReceiptStatus.SENT):s.setReceiptStatus(o.ReceiptStatus.IN_PROGRESS),i.updateMessage(s)),i.setStatusMessage(e.participant,a.Status.ACTIVE),n.$broadcast("ON_CONVERSATION_MESSAGE_RECEIVED",s,i,e.carbon),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",i)},l.prototype.handleReceiptReceiveMessage=function(e,i){t.info("[ConversationServiceEventHandler] handleReceiptReceiveMessage");var a=angular.element(i).find("received[xmlns='urn:xmpp:receipts']");if(a.length){var s=angular.element(a).attr("id"),c=e.getMessageById(s);if(c){(d=angular.element(i).attr("from").split("/")[1])||(d=angular.element(i).attr("from"));var l=angular.element(a).attr("event");(e.room&&r.isUserContactJid(d)||!e.room)&&("received"===l?c.setReceiptStatus(o.ReceiptStatus.UNREAD):"read"===l&&(c.setReceiptStatus(o.ReceiptStatus.READ),e.missedCounter=0)),r.isUserContactJid(d)&&"read"===l&&"L"===c.side&&(e.missedCounter=0),e.updateMessage(c),n.$broadcast("ON_CONVERSATION_RECEIPT_RECEIVED",c,e,l),n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",e)}else{var u=angular.element(i).attr("from"),d=(l=angular.element(a).attr("event"),"");u&&(d=u.split("/")[1]),d||(d=u),r.isUserContactJid(d)&&"read"===l&&(e.missedCounter=0,n.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",e))}}},l.prototype.handleStatusMessage=function(e,n,r){t.info("[conversationServiceEventHandler] handleStatusMessage ");var i="";i="thread"===angular.element(r).children().prop("tagName")?a.stringToStatus(angular.element(angular.element(r).children()[1]).prop("tagName")):a.stringToStatus(angular.element(r).children().prop("tagName")),e.setStatusMessage(n,i)},l}]),angular.module("rainbow").factory("ConversationServiceHistoryHandler",["$log","$q","$filter","$rootScope","xmppService","contactService","fileStorageService","fileServerService","Message",function(e,t,n,r,i,a,o,s,c){"use strict";function l(e){this.conversationService=e}return l.create=function(e){return new l(e)},l.prototype.getHistoryPage=function(n,r){if(n.currentHistoryId&&n.currentHistoryId===n.historyIndex)return e.info("[ConversationServiceHistoryHandler] getHistoryPage("+n.id+", "+r+", "+n.historyIndex+") already asked"),t.when();n.currentHistoryId=n.historyIndex,e.info("[ConversationServiceHistoryHandler] getHistoryPage("+n.id+", "+r+", "+n.historyIndex+")");var o=n.historyDefered=t.defer();if(a.isUserContact(n.contact))return o.reject(),o.promise;if(n.historyComplete)return e.info("[ConversationServiceHistoryHandler] getHistoryPage("+n.id+") : already complete"),o.reject(),o.promise;var s={queryid:n.id,with:n.id,max:r,before:""};return-1!==n.historyIndex&&(s.before=n.historyIndex),n.room?(s={queryid:n.id,with:a.userContact.jid,max:r,before:""},-1!==n.historyIndex&&(s.before=n.historyIndex),i.connection.mam.querymuc(n.id,n.room.jid,s)):i.connection.mam.query(n.id,s),o.promise},l.prototype.onHistoryMessageReceived=function(t){try{var l=null,u=$(t),d=u.find("result").attr("queryid");if(d){if(l=this.conversationService.getConversationById(d)){if(u.find("call_log").length)return this.onWebrtcHistoryMessageReceived(t,l);var f,h=u.find("forwarded message").attr("from"),p=!1;if(!(f=0===h.indexOf("room_")?h.split("/")[1]:i.getBareJidFromJid(u.find("forwarded message").attr("from")))&&u.find("event").length&&(p=u.find("event").attr("name"),f=u.find("event").attr("jid"),"welcome"===p&&l.room&&l.room.ownerContact&&(f=l.room.ownerContact.jid)),!f)return e.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived - Receive message without valid fromJid information"),!0;var v=a.getContactByJid(f),m=u.find("forwarded message").attr("type"),g=u.find("forwarded message").attr("id"),E=new Date(u.find("forwarded delay").attr("stamp")),S=u.find("forwarded message body").text(),C=u.find("forwarded message ack"),b=u.find("forwarded message x[xmlns='jabber:x:oob']"),R=u.find("forwarded message x[xmlns='jabber:x:audioconference']"),y=u.find("content[xmlns='urn:xmpp:content']");if(v||(e.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived missing contact for jid : "+f+", ignore message"),v=a.createEmptyContactContact(f)),p){if(e.info("[ConversationServiceHistoryHandler] ("+l.id+") add Room admin event message "+p),m="admin",l.room&&l.room.isMeetingRoom()&&("welcome"===p||"conferenceAdd"===p||"conferenceRemove"===p||"invitation"===p))return!0;("conferenceAdd"===p||"conferenceRemove"===p)&&l.room&&l.room.ownerContact&&(v=l.room.ownerContact)}var N=l.getMessageById(g);if(N||(N=l.historyMessages.find(function(e){return e.id===g})),N)e.info("[ConversationServiceHistoryHandler] ("+l.id+") try to add an already stored message with id "+N.id);else{var T=a.isUserContact(v)?c.Side.RIGHT:c.Side.LEFT;switch(m){case"file":N=c.createFileMessage(g,E,v,T,S,!1);break;case"webrtc":N=c.createWebRTCMessage(g,E,v,T,S,!1);break;case"admin":N=c.createBubbleAdminMessage(g,E,v,p);break;case"recording":N=c.createRecordingAdminMessage(g,E,v,"Admin");break;default:if(b&&b.length){var A=$(b).find("url").text(),I=o.extractFileIdFromUrl(A);N=c.createFileSharingMessage(g,E,v,T,S,!1,I),o.retrieveAndStoreOneFileDescriptor(I).then(function(e){e&&"not_uploaded"===e.state&&(N.receiptStatus=1,N.fileErrorMsg=n("translate")("file_notuploaded")),s.getBlobThumbnailFromFileDescriptor(e).then(function(t){e.previewBlob=t,r.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:e.id})}),r.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:e.id})}).catch(function(t){e.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived error "+t)})}else if(R&&R.length){var O=$(R),D={subject:O.attr("subject"),confendpointid:O.attr("confendpointid"),roomjid:R.attr("jid")};N=c.createConferenceMessage(g,E,v,T,!1,D)}else{var w=y&&"text/markdown"===y.attr("type");S=w?y.text():S,N=c.create(g,E,v,T,S,!1,w)}}N.receiptStatus="true"===angular.element(C).attr("read")?5:"true"===angular.element(C).attr("received")?4:3,l.historyMessages.push(N)}}}else if(d=angular.element(t).find("fin").attr("queryid"),l=this.conversationService.getConversationById(d)){l.historyComplete="true"===angular.element(t).find("fin").attr("complete");var _=angular.element(t).find("fin set first").text();-1===l.historyIndex?(l.messages.unshift.apply(l.messages,l.historyMessages),l.chatRenderer&&l.chatRenderer.prependMessages(l.messages,l.room)):(l.messages.unshift.apply(l.messages,l.historyMessages),l.chatRenderer&&l.chatRenderer.prependMessages(l.historyMessages,l.room)),l.historyIndex=_,l.historyMessages=[],angular.isDefined(l.messages)&&l.messages.length>0?l.lastMessageText=l.messages[l.messages.length-1].data:l.lastMessageText="",l.historyDefered.resolve(l)}return!0}catch(t){return e.error("[ConversationServiceHistoryHandler] onHistoryMessageReceived error : "+t),!0}},l.prototype.onWebrtcHistoryMessageReceived=function(t,n){console.log("onWebrtcHistoryMessageReceived");try{var r=$(t),i=r.find("forwarded message").attr("id"),o=r.find("caller").text(),s=r.find("state").text(),l=0;r.find("duration")&&(l=r.find("duration").text(),l=parseInt(l,10)),l=l>0?"("+moment.duration(l,"ms").format("h[H] mm[m] ss[s]")+")":0;var u=r.find("date").text();u=u?new Date(u):new Date(r.find("forwarded delay").attr("stamp"));var d="";"missed"===s?d="missedCall||"+u:"answered"===s&&(d="activeCallMsg||"+u+"||"+l);var f=n.getMessageById(i);if(f||(f=n.historyMessages.find(function(e){return e.id===i})),f)e.info("[ConversationServiceHistoryHandler] ("+n.id+") try to add an already stored message with id "+f.id);else{var h=a.getContactByJid(o);h||(e.warn("[ConversationServiceHistoryHandler] onWebrtcHistoryMessageReceived missing contact for jid : "+o+", ignore message"),h=a.createEmptyContactContact(o));var p=a.isUserContact(h)?c.Side.RIGHT:c.Side.LEFT;f=c.createWebRTCMessage(i,u,h,p,d,!1);var v=r.find("forwarded message ack");v&&(f.receiptStatus="true"===angular.element(v).attr("read")?5:"true"===angular.element(v).attr("received")?4:3),n.historyMessages.push(f)}return!0}catch(e){return console.error(e),!0}},l}]),angular.module("rainbow").service("telephonyService",["$q","$interval","$http","$rootScope","$log","xmppService","contactService","authService","Call","TelephonyServiceEventHandler","errorHelperService","VoiceMail","profileService",function(e,t,n,r,i,a,o,s,c,l,u,d,f){"use strict";var h=this,p=[],v="urn:xmpp:pbxagent:callservice:1";h.start=function(t){return i.info("[telephonyService] === STARTING ==="),h.startDate=performance.now(),h.stats=t,h.calls=[],h.started=!1,h.agentStatus={phoneApi:"disconnected",xmppAgent:"stopped",agentVersion:"unknown"},h.voicemailNumber=o.userContact.voicemailNumber,h.pbxId=o.userContact.pbxId,h.makingCall=!1,h.starting=!1,h.voiceMail=d.create(),h.isBasicCallAllowed=f.isFeatureEnabled(f.FeaturesEnum.TELEPHONY_BASIC_CALL),h.isSecondCallAllowed=f.isFeatureEnabled(f.FeaturesEnum.TELEPHONY_SECOND_CALL),h.isTransferAllowed=f.isFeatureEnabled(f.FeaturesEnum.TELEPHONY_TRANSFER_CALL),h.isConferenceAllowed=f.isFeatureEnabled(f.FeaturesEnum.TELEPHONY_CONFERENCE_CALL),h.isVMDeflectCallAllowed=f.isFeatureEnabled(f.FeaturesEnum.TELEPHONY_DEFLECT_CALL),h.voiceMailFeatureEnabled=f.isFeatureEnabled(f.FeaturesEnum.TELEPHONY_VOICE_MAIL),h.userJidTel=s.jidTel,i.info("[telephonyService] wait for my telephony presence"),p.push(r.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",h.onTelPresenceChange)),h.telephonyEventHandler=l.create(h),h.portalURL=config.restServerUrl+"/api/rainbow/telephony/v1.0/",e.when()},h.onTelPresenceChange=function(e,t){if(o.isTelJid(t.jid)){if("phone"!==o.getRessourceFromJid(t.jid))return!0;var n=o.getImJid(t.jid),a=t.status;o.isUserContactJid(n)&&("unavailable"===a||"offline"===a?(i.info("[telephonyService] received my telephony presence -- "+a),h.started=!1,h.calls=[],r.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","stopped"),i.info("[telephonyService] === STOPPED ===")):h.started||h.starting||(i.info("[telephonyService] received my telephony presence -- "+a),h.starting=!0,h.getAgentStatus().then(function(){return h.attachHandlers(),h.getTelephonyState()}).then(function(){var e=Math.round(performance.now()-h.startDate);h.stats.push({service:"telephonyService",startDuration:e}),i.info("[telephonyService] === STARTED ("+e+" ms) ==="),h.started=!0,h.starting=!1,r.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","started")}).catch(function(e){h.starting=!1,i.error("[telephonyService] receive telephony presence but no agent response - "+e.message)})))}return!0},h.getTelephonyState=function(){var t=e.defer(),n=$iq({type:"get",to:h.userJidTel+"/phone"}).c("callservice",{xmlns:v}).c("connections");return a.sendIQ(n).then(function(n){var r=h.getErrorMessage(n,"getTelephonyState");if(r)return i.info("[telephonyService] getTelephonyState -- failure -- "+r),t.reject(new Error(r)),t.promise;var a=angular.element(n).find("connection");if(0===a.length)return i.info("[telephonyService] getTelephonyState -- success -- no existing call"),t.resolve(),t.promise;var o=[];return a.each(function(){o.push(h.createCallFromConnectionElem(this))}),e.all(o).then(function(){i.info("[telephonyService] getTelephonyState -- success"),t.resolve()}).catch(function(e){i.error("[telephonyService] getTelephonyState -- failure -- "+e.message),t.reject(e)}),t.promise}).catch(function(e){i.error("[telephonyService] getTelephonyState -- failure -- "+e.message),t.reject(e)}),t.promise},h.getAgentStatus=function(){var t=e.defer(),n=$iq({type:"get",to:h.userJidTel+"/phone"}).c("pbxagentstatus",{xmlns:"urn:xmpp:pbxagent:monitoring:1"});return a.sendIQ(n).then(function(e){var n=angular.element(e).find("phoneapi").text(),r=angular.element(e).find("xmppagent").text(),a=angular.element(e).find("version").text();a&&(h.agentStatus={phoneApi:n,xmppAgent:r,agentVersion:a}),i.info("[telephonyService] getAgentStatus -- success -- version "+a),t.resolve()}).catch(function(e){var n="getAgentStatus -- failure : "+e.message;i.error("[telephonyService] "+n),t.reject(new Error(n))}),t.promise},h.getSnapshotCall=function(t){return i.info("[telephonyService] getSnapshotCall"),e(function(e,n){var r=$iq({type:"get",to:h.userJidTel+"/phone"}).c("callservice",{xmlns:v}).c("snapshotCall",{callId:t});a.sendIQ(r).then(function(t){console.error(t),e()}).catch(function(e){var t="getSnapshotCall failure : "+e.message;i.error("[telephonyService] "+t),n.reject(new Error(t))})})},h.getVoiceMessageCounter=function(){return e(function(e,t){if(!h.voiceMailFeatureEnabled){var n=new Error("getVoiceMessageCounter failure - Not Allowed");n.status=n.errorDetailsCode="403",i.error("[telephonyService] "+n.message),t(n)}var r=$iq({type:"get",to:h.userJidTel+"/phone"}).c("callservice",{xmlns:v}).c("messaging");a.sendIQ(r).then(function(t){console.error(t),e()}).catch(function(e){var n="getVoiceMessageCounter failure : "+e.message;i.error("[telephonyService] "+n),t.reject(new Error(n))})})},h.createCallFromConnectionElem=function(t){return e(function(e,n){var a=angular.element(t),s=a.attr("endpointIm"),l=a.attr("endpointTel"),u=a.attr("callId"),d=a.attr("endpointLci"),p=a.attr("lci"),v=a.find("participant"),m=a.find("identity").attr("firstName"),g=a.find("identity").attr("lastName"),E="",S="";s||l||(l="****"),f.isFeatureEnabled(f.FeaturesEnum.TELEPHONY_PHONE_BOOK)&&0===v.length&&g&&g.length&&(S=g,m&&m.length&&(E=m),i.info("[telephonyService] createCallFromConnectionElem - name resolution for: "+u+" for phoneNumber:"+anonymizePhoneNumber(l)+" with firstname : "+E.slice(0,1)+"***")),"LCI_INITIATED"===p&&e();(0===v.length?o.getOrCreateContact(s,l):h.getParticipantsFromParticipantsElem(v)).then(function(t){var n=c.Status.ACTIVE;"LCI_HELD"===p&&"LCI_CONNECTED"===d&&(n=c.Status.HOLD),"LCI_CONNECTED"===p&&"LCI_HELD"===d&&(n=c.Status.PUT_ON_HOLD),"LCI_CONNECTED"===p&&"LCI_QUEUED"===d&&(n=c.Status.QUEUED_OUTGOING),"LCI_QUEUED"===p&&"LCI_CONNECTED"===d&&(n=c.Status.QUEUED_INCOMMING);var a=null;0===v.length?(t&&t.temp&&""!==S&&t.updateName(E,S),a=h.getOrCreateCall(n,u,t),i.info("[telephonyService] createCallFromConnectionElem - create call for user: "+t.id+" with callId: "+u+" "+p)):((a=h.getOrCreateCall(n,u)).setParticipants(t),a.isConference=!0,i.info("[telephonyService] createCallFromConnectionElem - create conference call with callId: "+u+" "+p));r.$broadcast("ON_CALL_UPDATED_EVENT",a),e(a)}).catch(function(e){i.error("[TelephonyService] createCallFromConnectionElem - failure - "+e.message),n(e)})})},h.getParticipantsFromParticipantsElem=function(t){return e(function(n,r){var i=[],a=[];t.each(function(){var t=angular.element(this),n=t.find("endpointTel").text(),r=t.find("endpointIm").text();r&&o.isUserContactJid(r)||a.push(e(function(e,t){r||n||(n="****"),o.getOrCreateContact(r,n).then(function(t){i.push(t),e()}).catch(function(e){t(e)})}))}),e.all(a).then(function(){n(i)},function(e){r(e)})})},h.getOrCreateCall=function(e,t,n){var r=c.getIdFromConnectionId(t),i=h.calls[r];return i?(i.setConnectionId(t),i.startDate=new Date):((i=c.create(e,null,c.Type.PHONE,n)).setConnectionId(t),h.calls[r]=i),i},h.attachHandlers=function(){i.info("[telephonyService] attachHandlers"),h.started=!1,h.calls=[],h.messageHandlerRef&&(a.deleteHandler(h.messageHandlerRef),h.messageHandlerRef=null),h.messageHandlerRef=a.addHandler(function(e){return h.telephonyEventHandler.onCallserviceMessageReceived(e),!0},v,"message",null)},h.stop=function(){var t;for(i.info(""),i.info("[telephonyService] === STOPPING ==="),h.started=!1,h.userJidTel=null,h.calls=null,h.messageHandlerRef&&(a.deleteHandler(h.messageHandlerRef),h.messageHandlerRef=null);t=p.pop();)t();return i.info("[telephonyService] === STOPPED ==="),r.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","stopped"),e.when()},h.getCallToHangOut=function(){var e=h.getCalls();if(!e||0===e.length)return null;var t=e[0].status;return 1===e.length||t===c.Status.DIALING||t===c.Status.ACTIVE||t===c.Status.PUT_ON_HOLD?e[0]:e[1]},h.getActiveCall=function(){var e=null;return Object.keys(h.calls||[]).forEach(function(t){var n=h.calls[t];n.status===c.Status.ACTIVE&&(e=n)}),e},h.getCalls=function(){var e=[];return Object.keys(h.calls||[]).forEach(function(t){h.calls[t].status!==c.Status.DIALING&&h.calls[t].status!==c.Status.RINGING_OUTGOING&&h.calls[t].status!==c.Status.QUEUED_OUTGOING&&h.calls[t].status!==c.Status.ACTIVE&&h.calls[t].status!==c.Status.HOLD&&h.calls[t].status!==c.Status.PUT_ON_HOLD&&h.calls[t].status!==c.Status.ERROR||e.push(h.calls[t])}),e},h.getActiveCallsForContact=function(e){var t=[];return e&&e.jid&&Object.keys(h.calls||[]).forEach(function(n){!h.calls[n].contact||h.calls[n].contact.jid!==e.jid||h.calls[n].status!==c.Status.DIALING&&h.calls[n].status!==c.Status.RINGING_OUTGOING&&h.calls[n].status!==c.Status.ACTIVE&&h.calls[n].status!==c.Status.HOLD&&h.calls[n].status!==c.Status.PUT_ON_HOLD||t.push(h.calls[n])}),t},h.makeCall=function(t,n){var r=h.getActiveCall();return h.makingCall?(i.warn("[telephonyService] makeCall failure - makeCall already making a call"),e.reject()):(h.makingCall=!0,r?h.makeConsultationCall(t,n,r.connectionId):h.makeSimpleCall(t,n))},h.makeSimpleCall=function(a,o){return e(function(e,l){if(i.info("[telephonyService] makeSimpleCall to "+(a?a.displayName:o)),!h.isBasicCallAllowed){var d=new Error("makeSimpleCall failure - Not Allowed");d.status=d.errorDetailsCode="403",i.error("[telephonyService] "+d.message),h.makingCall=!1,l(d)}var f=h.getPhoneInfo(a,o);n({method:"POST",url:h.portalURL+"calls",headers:s.getRequestHeader(),data:{calleeExtNumber:f.longNumber,calleeIntNumber:f.internalNumber,calleeShortNumber:f.shortNumber,calleePbxId:f.pbxId,calleeDisplayName:a.displayName}}).then(function(t){i.info("[telephonyService] makeSimpleCall success : "+anonymizePhoneNumber(o)+" Call ("+n+")");var n=c.create(c.Status.DIALING,null,c.Type.PHONE,a);n.setConnectionId(t.data.data.callId),h.calls[n.id]=n,h.makingCall=!1,n.setIsVm(o===h.voicemailNumber),r.$broadcast("ON_CALL_UPDATED_EVENT",n),e(n.id)},function(e){var n=c.create(c.Status.ERROR,null,c.Type.PHONE,a);n.errorMessage="invalidPhoneNumber",h.calls[n.contact.id]=n,n.autoClear=t(function(){h.clearCall(n)},5e3,1),h.makingCall=!1,r.$broadcast("ON_CALL_UPDATED_EVENT",n);var o=u.handleError(e);l(o),i.error("[telephonyService] "+u.getErrorFullMessage(e,"makeCall"))})})},h.makeConsultationCall=function(a,o,l){return e(function(e,d){if(!h.isSecondCallAllowed){var f=new Error("makeConsultationCall failure - Not Allowed");f.status=f.errorDetailsCode="403",i.error("[telephonyService] "+f.message),h.makingCall=!1,d(f)}var p=h.getPhoneInfo(a,o);n({method:"POST",url:h.portalURL+"calls/"+encodeURIComponent(l)+"/consultation",headers:s.getRequestHeader(),data:{calleeExtNumber:p.longNumber,calleeIntNumber:p.internalNumber,calleeShortNumber:p.shortNumber,calleePbxId:p.pbxId,calleeDisplayName:a.displayName}}).then(function(t){i.info("[telephonyService] makeConsultationCall success : "+anonymizePhoneNumber(o)+" Call ("+n+")");var n=c.create(c.Status.DIALING,null,c.Type.PHONE,a);n.setConnectionId(t.data.data.callId),h.calls[n.id]=n,h.makingCall=!1,n.setIsVm(o===h.voicemailNumber),r.$broadcast("ON_CALL_UPDATED_EVENT",n),e(n.id)},function(e){var n=c.create(c.Status.ERROR,null,c.Type.PHONE,a);n.errorMessage="invalidPhoneNumber",h.calls[n.contact.id]=n,n.autoClear=t(function(){h.clearCall(n)},5e3,1),h.makingCall=!1,r.$broadcast("ON_CALL_UPDATED_EVENT",n);var o=u.handleError(e);d(o),i.error("[telephonyService] "+u.getErrorFullMessage(e,"makeConsultationCall"))})})},h.makeCallByPhoneNumber=function(n){return e(function(e,a){if(i.info("[telephonyService] makeCallByPhoneNumber : "+anonymizePhoneNumber(n)),o.userContact.phonePro===n||o.userContact.phoneProCan===n||o.userContact.phonePbx===n){var s="makeCallByPhoneNumber failure: impossible to call its own phone number";i.error("[telephonyService] "+s),a(new Error(s))}var l=null;o.getOrCreateContact(null,n).then(function(e){return l=e,h.makeCall(e,n)}).then(function(){e()}).catch(function(e){var n="makeCallByPhoneNumber failure "+(e?e.message:"");i.error("[telephonyService] - callService - "+n);var o=c.create(c.Status.ERROR,null,c.Type.PHONE,l);o.errorMessage="invalidPhoneNumber",h.calls[o.contact.id]=o,o.autoClear=t(function(){h.clearCall(o)},5e3,1),r.$broadcast("ON_CALL_UPDATED_EVENT",o),a(new Error(n))})})},h.getPhoneInfo=function(e,t){var n=t,r="",i="",a="";return e&&(t===e.phonePro||t===e.phoneProCan?(n=e.phoneProCan?e.phoneProCan:"",r=e.phonePbx,a=e.pbxId,i=e.phoneInternalNumber):t===e.phonePbx&&(n="",r=e.phonePbx,a=e.pbxId,i=e.phoneInternalNumber)),{longNumber:n,shortNumber:r,pbxId:a,internalNumber:i}},h.getErrorMessage=function(e,t){var n=t+" failure : ";if("error"===angular.element(e).attr("type")){var r=angular.element(e).find("error");if(r){var a=r.attr("type"),o=r.attr("code");a&&(n+=a+" : ","modify"===a&&(n+=r.find("text").text())),o&&"503"===o&&(n+="Agent error : service unavailable"),i.error("[telephonyService] "+n)}else n+="Unknown error";return n}return null},h.releaseCall=function(t){return e(function(e,a){if(i.info("[telephonyService] releaseCall "+t.id),!h.isBasicCallAllowed){var o=new Error("releaseCall failure - Not Allowed");o.status=o.errorDetailsCode="403",i.error("[telephonyService] "+o.message),a(o)}n({method:"DELETE",url:h.portalURL+"calls/"+encodeURIComponent(t.connectionId),headers:s.getRequestHeader()}).then(function(){t.setStatus(c.Status.UNKNOWN),t.startDate=null,t.vm=!1,i.info("[telephonyService] releaseCall "+t.id+" - success : "),r.$broadcast("ON_CALL_UPDATED_EVENT",t),delete h.calls[t.id],e(t)},function(e){var t=u.handleError(e);a(t),i.error("[telephonyService] "+u.getErrorFullMessage(e,"releaseCall"))})})},h.answerCall=function(t){return e(function(e,a){i.info("[telephonyService] answerCall : "+anonymizePhoneNumber(t.contact.phone)+"("+t.contact.displayNameForLog()+")");var o=h.getActiveCall();if(!h.isBasicCallAllowed){var l=new Error("answerCall failure - Not Allowed");l.status=l.errorDetailsCode="403",i.error("[telephonyService] "+l.message),a(l)}t.status===c.Status.QUEUED_INCOMMING&&o?h.holdCall(o).then(function(){return h.answerCall(t)}).then(function(t){e(t)}).catch(function(e){var t="answerCall failure : "+e.message;i.error("[telephonyService] - callService -  "+t),a(new Error(t))}):n({method:"PUT",url:h.portalURL+"calls/"+encodeURIComponent(t.connectionId)+"/answer",headers:s.getRequestHeader()}).then(function(n){t.setConnectionId(n.data.data.callId),t.setStatus(c.Status.ACTIVE),i.info("[telephonyService] answerCall success : "+anonymizePhoneNumber(t.contact.phone)+" Call ("+t+")"),r.$broadcast("ON_CALL_UPDATED_EVENT",t),e(t)},function(e){var t=u.handleError(e);a(t),i.error("[telephonyService] "+u.getErrorFullMessage(e,"answerCall"))})})},h.holdCall=function(t){return e(function(e,a){if(t&&t.status!==c.Status.HOLD||e(t),!h.isSecondCallAllowed){var o=new Error("holdCall failure - Not Allowed");o.status=o.errorDetailsCode="403",i.error("[telephonyService] "+o.message),a(o)}n({method:"PUT",url:h.portalURL+"calls/"+encodeURIComponent(t.connectionId)+"/hold",headers:s.getRequestHeader()}).then(function(n){i.info("[telephonyService] holdCall success : "+anonymizePhoneNumber(t.contact.phone)+" Call ("+t+")"),t.setConnectionId(n.data.data.callId),t.setStatus(c.Status.HOLD),r.$broadcast("ON_CALL_UPDATED_EVENT",t),e(t)},function(e){var t=u.handleError(e);a(t),i.error("[telephonyService] "+u.getErrorFullMessage(e,"holdCall"))})})},h.retrieveCall=function(t){return e(function(e,a){if(i.info("[telephonyService] retrieveCall : "+t.contact.displayNameForLog()),!h.isSecondCallAllowed){var o=new Error("retrieveCall failure - Not Allowed");o.status=o.errorDetailsCode="403",i.error("[telephonyService] "+o.message),a(o)}var l=h.getActiveCall();l?h.holdCall(l).then(function(){return h.retrieveCall(t)}).then(function(t){e(t)}).catch(function(e){var t="retrieveCall failure : "+e.message;i.error("[telephonyService] - callService -  "+t),a(new Error(t))}):n({method:"PUT",url:h.portalURL+"calls/"+encodeURIComponent(t.connectionId)+"/retrieve",headers:s.getRequestHeader()}).then(function(n){i.info("[telephonyService] retrieveCall success : "+anonymizePhoneNumber(t.contact.phone)+" Call ("+t+")"),t.setConnectionId(n.data.data.callId),t.setStatus(c.Status.ACTIVE),r.$broadcast("ON_CALL_UPDATED_EVENT",t),e()},function(e){var t=u.handleError(e);a(t),i.error("[telephonyService] "+u.getErrorFullMessage(e,"retrieveCall"))})})},h.deflectCallToVM=function(t){return e(function(e,r){if(t||e(t),!h.isVMDeflectCallAllowed){var a=new Error("deflectCall failure - Not Allowed");a.status=a.errorDetailsCode="403",i.error("[telephonyService] "+a.message),r(a)}i.info("[telephonyService] deflectCallToVM "+t.contact.displayNameForLog()),n({method:"PUT",url:h.portalURL+"calls/"+encodeURIComponent(t.connectionId)+"/deflect",headers:s.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:h.voicemailNumber,calleeShortNumber:h.voicemailNumber,calleePbxId:h.pbxId}}).then(function(){i.info("[telephonyService] deflectCall success"),e()},function(e){var t=u.handleError(e);r(t),i.error("[telephonyService] "+u.getErrorFullMessage(e,"deflectCallToVM"))})})},h.transfertCall=function(t,r){return e(function(e,a){if(t&&r||e(),!h.isTransferAllowed){var o=new Error("transferCall failure - Not Allowed");o.status=o.errorDetailsCode="403",i.error("[telephonyService] "+o.message),a(o)}i.info("[telephonyService] transfertCall held("+r.contact.displayName+") to active("+t.contact.displayName+")"),n({method:"PUT",url:h.portalURL+"calls/"+encodeURIComponent(t.connectionId)+"/transfer/"+encodeURIComponent(r.connectionId),headers:s.getRequestHeader()}).then(function(){i.info("[telephonyService] transferCall success"),e()},function(e){var t=u.handleError(e);a(t),i.error("[telephonyService] "+u.getErrorFullMessage(e,"transfertCall"))})})},h.conferenceCall=function(t,r){return e(function(e,a){if(t&&r||e(),!h.isConferenceAllowed){var o=new Error("conferenceCall failure - Not Allowed");o.status=o.errorDetailsCode="403",i.error("[telephonyService] "+o.message),a(o)}i.info("[telephonyService] conferenceCall "+t.contact.displayName+" and "+r.contact.displayName),n({method:"PUT",url:h.portalURL+"calls/"+encodeURIComponent(t.connectionId)+"/conference/"+encodeURIComponent(r.connectionId),headers:s.getRequestHeader()}).then(function(){i.info("[telephonyService] conferenceCall success"),e()},function(e){var t=u.handleError(e);a(t),i.error("[telephonyService] "+u.getErrorFullMessage(e,"conferenceCall"))})})},h.forwardToDevice=function(t){return e(function(e,r){if(i.info("[telephonyService] forwardToDevice : "+t),o.userContact.phonePro===t||o.userContact.phoneProCan===t||o.userContact.phonePbx===t){var a="forwardToDevice failure: impossible to forward its own phone number";i.error("[telephonyService] "+a),r(new Error(a))}o.getOrCreateContact(null,t).then(function(a){var o=h.getPhoneInfo(a,t);n({method:"PUT",url:h.portalURL+"forward",headers:s.getRequestHeader(),data:{calleeExtNumber:o.longNumber,calleeIntNumber:o.internalNumber,calleeShortNumber:o.shortNumber,calleePbxId:o.pbxId,calleeDisplayName:a.displayName}}).then(function(){e()},function(e){var t=u.handleError(e);r(t),i.error("[telephonyService] "+u.getErrorFullMessage(e,"forwardToDevice"))})})})},h.forwardToVoicemail=function(){return e(function(e,t){if(!h.voiceMailFeatureEnabled){var r=new Error("forwardToVoicemail failure - voicemail feature not enabled");r.status=r.errorDetailsCode="404",i.error("[telephonyService] "+r.message),t(r)}n({method:"PUT",url:h.portalURL+"forward",headers:s.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:h.voicemailNumber,calleePbxId:h.pbxId}}).then(function(){e()},function(e){var n=u.handleError(e);t(n),i.error("[telephonyService] "+u.getErrorFullMessage(e,"forwardToVoicemail"))})})},h.cancelForward=function(){return e(function(e,t){o.userContact.phonePbx?n({method:"PUT",url:h.portalURL+"forward",headers:s.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:"CANCELFORWARD",calleePbxId:h.pbxId}}).then(function(){i.info("[telephonyService] cancelForward success"),e()},function(e){var n=u.handleError(e);t(n),i.error("[telephonyService] "+u.getErrorFullMessage(e,"cancelForward"))}):t()})},h.getForwardStatus=function(){return e(function(e,t){o.userContact&&o.userContact.phonePbx?n({method:"GET",url:h.portalURL+"forward",headers:s.getRequestHeader()}).then(function(){e()},function(e){var n=u.handleError(e);t(n),i.error("[telephonyService] "+u.getErrorFullMessage(e,"getForwardStatus"))}):t()})},h.sendDtmf=function(t,r){return e(function(e,a){var o=c.getIdFromConnectionId(t),l=c.getDeviceIdFromConnectionId(t);o&&l&&r?n({method:"PUT",url:h.portalURL+"calls/"+o+"%23"+l+"/dtmf",headers:s.getRequestHeader(),data:{callId:t,dtmf:r}}).then(function(){e()},function(e){var t=u.handleError(e);a(t),i.error("[telephonyService] "+u.getErrorFullMessage(e,"sendDtmf"))}):a()})},h.clearCall=function(e){e.setStatus(c.Status.UNKNOWN),r.$broadcast("ON_CALL_UPDATED_EVENT",e),e.contact&&delete h.calls[e.contact.id],e.getCurrentCalled()&&e.setCurrentCalled(null)},h.startAsPhoneNumber=function(e){var t=e.trim().split(".").join(""),n=t.match(/^(\+|\d|#|\*|\(|\)|\.|-|\s|\/)*$/);return!!n&&n[0]===t},h.updateContactFromOutlookInfos=function(t,n,r,a){return i.info("[telephonyService] default updateContactFromOutlookInfos"),e.reject()}}]),angular.module("rainbow").factory("TelephonyServiceEventHandler",["$log","$q","$rootScope","$interval","contactService","Call","profileService","Contact","PromiseQueue",function(e,t,n,r,i,a,o,s,c){"use strict";function l(e){this.telephonyService=e,this.promiseQueue=c.create()}return l.create=function(e){return new l(e)},l.CallFailureLabels={DESTNOTOBTAINABLE:"outOfService",DONOTDISTURB:"dnd",TRUNKSBUSY:"trunksbusy"},l.prototype.onCallserviceMessageReceived=function(t){try{var n=$(t),r=this;if("Offline Storage"===n.find("delay").text())return!0;var i=n.find("callservice").children(),a=i.prop("tagName").split(":"),o=a[a.length-1].toLowerCase();switch(e.info("[TelephonyServiceEventHandler] onCallserviceMessageReceived -- event -- "+o),o){case"originated":this.promiseQueue.add(function(){return r.onOriginatedEvent(i)});break;case"delivered":this.promiseQueue.add(function(){return r.onDeliveredEvent(i)});break;case"established":this.promiseQueue.add(function(){return r.onEstablishedEvent(i)});break;case"retrievecall":this.promiseQueue.add(function(){return r.onRetrieveCallEvent(i)});break;case"queued":this.promiseQueue.add(function(){return r.onQueuedEvent(i)});break;case"holdcall":case"held":this.promiseQueue.add(function(){return r.onHeldEvent(i)});break;case"diverted":this.promiseQueue.add(function(){return r.onDivertedEvent(i)});break;case"transfercall":case"transferred":this.promiseQueue.add(function(){return r.onTransferEvent(i)});break;case"conferenced":this.promiseQueue.add(function(){return r.onConferenceEvent(i)});break;case"connectioncleared":this.promiseQueue.add(function(){return r.onClearCallEvent(i)});break;case"failed":this.promiseQueue.add(function(){return r.onFailCallEvent(i)});break;case"messaging":this.promiseQueue.add(function(){return r.onVoiceMessageEvent(i)});break;case"updatecall":this.promiseQueue.add(function(){return r.onUpDateCallEvent(i)});break;case"forwarded":this.promiseQueue.add(function(){return r.onCallForwardedEvent(i)});break;case"openDesktop":e.info("[TelephonyServiceEventHandler] openDesktop detected ")}return!0}catch(t){return e.warn("[TelephonyServiceEventHandler] onCallserviceMessageReceived -- failure -- "+t.message),!0}},l.prototype.onOriginatedEvent=function(n){return this.getCall(n).then(function(r){try{var i=n.attr("endpointIm"),a=n.attr("endpointTel"),o={contactPhoneNumber:"",contact:r.contact,participantsPhoneNumbers:null,participants:null};return i||a?o.contactPhoneNumber=a||"":r.contact&&r.contact.temp&&(o.contactPhoneNumber=r.contact.id),r.setCurrentCalled(o),t.when()}catch(n){var s="onOriginatedEvent -- "+n.message;return e.error("[TelephonyServiceEventHandler] "+s),t.reject(new Error(s))}})},l.prototype.onDeliveredEvent=function(n){var r=this;return this.getCall(n).then(function(i){try{if(i.status===a.Status.QUEUED_INCOMMING)return t.when();var o=n.attr("type"),s=n.attr("endpointIm"),c=n.attr("endpointTel");return i.setStatus("outgoing"===o?a.Status.RINGING_OUTGOING:a.Status.RINGING_INCOMMING),i.startDate=null,i.vm=!1,r.updateCallContact(s,c,"delivered",i)}catch(n){var l="onOriginatedEvent -- "+n.message;return e.error("[TelephonyServiceEventHandler] "+l),t.reject(new Error(l))}})},l.prototype.onEstablishedEvent=function(r){var o=this;return this.getCall(r).then(function(s){try{var c=r.attr("endpointIm"),l=r.attr("endpointTel");if(s.contact&&s.contact.id)return s.setStatus(a.Status.ACTIVE),o.updateCallContact(c,l,"established",s);if(s.participants&&s.participants.length>0){for(var u=null,d=0;d<s.participants.length&&!u;d++)s.participants[d].id===c?u=s.participants[d]:s.currentCalled.participantsPhoneNumbers&&s.currentCalled.participantsPhoneNumbers.length>0&&s.currentCalled.participantsPhoneNumbers[d]===l&&(u=s.participants[d]);s.participants=[],s.isConference=!1;var f=s.getCurrentCalled();if(!u)return c||l||(l="****"),i.getOrCreateContact(c,l).then(function(e){return s.setContact(e),s.setStatus(a.Status.ACTIVE),f={contactPhoneNumber:l,contact:e},s.setCurrentCalled(f),n.$broadcast("ON_CALL_UPDATED_EVENT",s),t.when()});s.setContact(u),s.setStatus(a.Status.ACTIVE),f={contactPhoneNumber:l,contact:u},s.setCurrentCalled(f),n.$broadcast("ON_CALL_UPDATED_EVENT",s)}return t.when()}catch(n){var h="onOriginatedEvent -- "+n.message;return e.error("[TelephonyServiceEventHandler] "+h),t.reject(new Error(h))}})},l.prototype.onRetrieveCallEvent=function(e){return this.getCall(e).then(function(e){e.setStatus(a.Status.ACTIVE),n.$broadcast("ON_CALL_UPDATED_EVENT",e)})},l.prototype.onClearCallEvent=function(e){var t=this;return this.getCall(e).then(function(e){e.status!==a.Status.ERROR&&(e.setStatus(a.Status.UNKNOWN),t.telephonyService.clearCall(e),n.$broadcast("ON_CALL_UPDATED_EVENT",e))})},l.prototype.onHeldEvent=function(r){return e.info("[TelephonyServiceEventHandler] onHeldEvent"),this.getCall(r).then(function(i){try{var o=r.attr("callId");return o||(o=r.attr("heldCallId")),a.getDeviceIdFromConnectionId(i.connectionId)===a.getDeviceIdFromConnectionId(o)?i.setStatus(a.Status.HOLD):i.setStatus(a.Status.PUT_ON_HOLD),n.$broadcast("ON_CALL_UPDATED_EVENT",i),t.when()}catch(n){var s="onHeldEvent -- "+n.message;return e.error("[TelephonyServiceEventHandler] "+s),t.reject(new Error(s))}})},l.prototype.onQueuedEvent=function(n){var r=this,i=n.attr("cause");return"PARK"===i?(e.warn("[TelephonyServiceEventHandler] onQueuedEvent - ignore PARK cause"),t.when()):"NEWCALL"===i?(e.warn("[TelephonyServiceEventHandler] onQueuedEvent - ignore NEWCALL cause"),t.when()):this.getCall(n).then(function(i){try{var o=n.attr("type"),s=n.attr("endpointIm"),c=n.attr("endpointTel"),l="outgoing"===o?a.Status.QUEUED_OUTGOING:a.Status.QUEUED_INCOMMING;return i.setStatus(l),i.startDate=null,i.vm=!1,r.updateCallContact(s,c,"queued",i)}catch(n){var u="onOriginatedEvent -- "+n.message;return e.error("[TelephonyServiceEventHandler] "+u),t.reject(new Error(u))}})},l.prototype.onDivertedEvent=function(r){var i=r.attr("oldCallId"),o=a.getIdFromConnectionId(i),s=this.telephonyService.calls[o];return s?(this.telephonyService.clearCall(s),n.$broadcast("ON_CALL_UPDATED_EVENT",s),t.when()):(e.warn("[TelephonyServiceEventHandler] onDivertedEvent - receive divertedEvent on unknown call --- ignored"),t.when())},l.prototype.onTransferEvent=function(e){var r=this,i=e.attr("activeCallId"),o=e.attr("heldCallId"),s=e.attr("newCallId"),c=a.getIdFromConnectionId(i),l=this.telephonyService.calls[c];if(o){var u=a.getIdFromConnectionId(o),d=this.telephonyService.calls[u];d.setStatus(a.Status.UNKNOWN),l.setStatus(a.Status.UNKNOWN),n.$broadcast("ON_CALL_UPDATED_EVENT",d),n.$broadcast("ON_CALL_UPDATED_EVENT",l)}if(s){var f=e.attr("newEndpointIm"),h=e.attr("newEndpointTel"),p=e.attr("deviceState");return p||(p=e.attr("deviceStatus")),l.setStatus(a.Status.UNKNOWN),n.$broadcast("ON_CALL_UPDATED_EVENT",l),f||h||(h="****"),this.getOrCreateCall(s,f,h).then(function(e){return p&&"LCI_ALERTING"===p?e.setStatus(a.Status.RINGING_INCOMMING):e.setStatus(a.Status.ACTIVE),r.updateCallContact(f,h,"transfercall",e)})}return t.when()},l.prototype.onConferenceEvent=function(r){var o=this,s=r.find("primaryOldCallId").text(),c=r.find("secondaryOldCallId").text(),l=r.find("newCallId").text(),u=a.getIdFromConnectionId(s),d=a.getIdFromConnectionId(c),f=this.telephonyService.calls[u],h=this.telephonyService.calls[d],p=[],v=[],m=[];return r.find("participant").each(function(){var n=angular.element(this),r=n.find("endpointTel").text(),a=n.find("endpointIm").text();a&&i.isUserContactJid(a)||v.push(t(function(t,n){a||r||(r="****"),!a&&f&&f.contact&&f.currentCalled.contactPhoneNumber===r?(p.push(f.contact),m.push(r),t()):!a&&h&&h.contact&&h.currentCalled.contactPhoneNumber===r?(p.push(h.contact),m.push(r),t()):i.getOrCreateContact(a,r).then(function(n){o.telephonyService.updateContactFromOutlookInfos(n,r).then(function(t){t?e.debug("[TelephonyServiceEventHandler] on conferenced, update from outlook for contact :"+n.displayNameMD5):e.debug("[TelephonyServiceEventHandler] on conferenced, no update from outlook for contact :"+n.displayNameMD5)},function(){e.debug("[TelephonyServiceEventHandler] on conferenced, no Outlook search available")}).finally(function(){p.push(n),m.push(r),t()})}).catch(function(t){e.error("[TelephonyServiceEventHandler] onConferenceEvent - Impossible to get contact - "+t.message),n()})}))}),t.all(v).then(function(){f&&(f.setStatus(a.Status.UNKNOWN),n.$broadcast("ON_CALL_UPDATED_EVENT",f)),h&&(h.setStatus(a.Status.UNKNOWN),n.$broadcast("ON_CALL_UPDATED_EVENT",h));var e=o.createConferenceCall(l,p),t=e.getCurrentCalled();t.participants=p,t.participantsPhoneNumbers=m,e.setCurrentCalled(t),e.setStatus(a.Status.ACTIVE),n.$broadcast("ON_CALL_UPDATED_EVENT",e)})},l.prototype.onVoiceMessageEvent=function(r){if(!o.isFeatureEnabled(o.FeaturesEnum.TELEPHONY_VOICE_MAIL))return e.info("[TelephonyServiceEventHandler] onVoiceMessageEvent feature not enabled => IGNORED event"),t.when();var i=r.find("voiceMessageCounter").text();if(i){var a=Number(i);Number.isInteger(a)&&a>=0&&(this.telephonyService.voiceMail.setVMCounter(a),this.telephonyService.voiceMail.setVMFlag(a>0),this.telephonyService.voiceMail.setInfoMsg(""),n.$broadcast("ON_VOICE_MESSAGE_UPDATE_EVENT",a))}return"changed"===r.find("voiceMessageWaiting").text()?this.telephonyService.getVoiceMessageCounter():t.when()},l.prototype.onUpDateCallEvent=function(a){return this.getCall(a).then(function(c){var l=a.attr("endpointIm"),u=a.attr("endpointTel"),d="",f="",h=a.find("identity").attr("firstName"),p=a.find("identity").attr("lastName"),v=a.find("identity").attr("displayName"),m=!1;if(!config.permitSearchFromPhoneBook&&!o.isFeatureEnabled(o.FeaturesEnum.TELEPHONY_PHONE_BOOK))return e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent xnames not allowed for the user profile => IGNORED event"),t.when();if(p&&p.length)f=p,h&&h.length&&(d=h),e.info("[TelephonyServiceEventHandler] onUpDateCallEvent received for call "+c.id+" for phoneNumber:"+anonymizePhoneNumber(u)+" with name : "+d.slice(0,1)+"***");else{if(!v||!v.length||v===u)return e.info("[TelephonyServiceEventHandler] onUpDateCallEvent xnames not available => IGNORED event"),t.when();f=v,e.info("[TelephonyServiceEventHandler] onUpDateCallEvent only displayName available")}return i.getOrCreateContact(l,u).then(function(t){if(t.temp){if(t.updateName(d,f),c.contact&&c.contact.id){var i={contactPhoneNumber:u,contact:t};c.contact.id===t.id&&c.contact.displayName!==u&&c.contact.getNameUpdatePrio()!==s.NameUpdatePrio.OUTLOOK_UPDATE_PRIO||(t.setNameUpdatePrio(s.NameUpdatePrio.SERVER_UPDATE_PRIO),c.setContact(t),c.setCurrentCalled(i),m=!0,e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent xnames updated for "+u+"with contact : "+t.displayNameMD5))}else if(c.participants&&c.participants.length>0){i=c.getCurrentCalled();for(var a=0;a<c.participants.length;a++)c.participants[a].temp?c.participants[a].phoneProCan&&c.participants[a].phoneProCan===u&&(e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent temp participant "+c.participants[a].displayNameMD5+" updated with : "+t.displayNameMD5),c.participants[a]=t,c.participants[a].setNameUpdatePrio(s.NameUpdatePrio.SERVER_UPDATE_PRIO),i.participantsPhoneNumbers[a]=u,i.participants[a]=t,m=!0):e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent STRANGE former participant was a rainbow: "+c.participants[a].displayNameMD5);c.setCurrentCalled(i)}}else if(c.contact&&c.contact.id){i={contactPhoneNumber:u,contact:t};c.contact.id!==t.id&&(c.contact.temp&&(c.contact.updateName(d,f),c.contact.setNameUpdatePrio(s.NameUpdatePrio.SERVER_UPDATE_PRIO)),c.setContact(t),c.setCurrentCalled(i),m=!0,e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent call update with rainbow contact : "+t.displayNameMD5))}else if(c.participants&&c.participants.length>0){for(i=c.getCurrentCalled(),a=0;a<c.participants.length;a++)c.participants[a].temp?c.participants[a].phoneProCan&&c.participants[a].phoneProCan===u&&(e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent temp participant "+c.participants[a].displayNameMD5+" updated with : "+t.displayNameMD5),c.participants[a]=t,c.setParticipants(c.participants),i.participantsPhoneNumbers[a]=u,i.participants[a]=t,m=!0):c.participants[a].jid===l?(i.participantsPhoneNumbers[a]=u,i.participants[a]=c.participants[a],m=!0,e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent rainbow participant "+c.participants[a].displayNameMD5+" updated with the same : "+t.displayNameMD5)):e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent other participant not updated : "+c.participants[a].displayNameMD5+" vs "+t.displayNameMD5);c.setCurrentCalled(i)}m?r(function(){n.$broadcast("ON_CALL_UPDATED_EVENT",c)},300,1):e.debug("[TelephonyServiceEventHandler] onUpDateCallEvent, no update needed for call : "+c.id)})})},l.prototype.onFailCallEvent=function(e){var t=e.attr("cause"),i=this;return this.getCall(e).then(function(e){e.setStatus(a.Status.ERROR),e.errorMessage=l.CallFailureLabels[t],e.autoClear=r(function(){i.telephonyService.clearCall(e)},5e3,1),e.errorMessage||(e.errorMessage=t),n.$broadcast("ON_CALL_UPDATED_EVENT",e)})},l.prototype.onCallForwardedEvent=function(e){return n.$broadcast("ON_CALL_FORWARDED_EVENT",{forwardType:e.attr("forwardType"),forwardTo:e.attr("forwardTo")}),t.when()},l.prototype.getCall=function(t){var n=t.attr("endpointIm"),r=t.attr("endpointTel"),i=t.attr("callId");return i||(i=t.attr("heldCallId")),e.info("[telephonyService] getCall - "+n+" - "+anonymizePhoneNumber(r)+" - "+i),this.getOrCreateCall(i,n,r)},l.prototype.getOrCreateCall=function(e,n,r){var o=this,s=a.getIdFromConnectionId(e),c=this.telephonyService.calls[s];return c?t.when(c):t(function(t){n||r?i.getOrCreateContact(n,r).then(function(n){t(o.telephonyService.getOrCreateCall(a.Status.UNKNOWN,e,n))}):t(o.telephonyService.getOrCreateCall(a.Status.UNKNOWN,e))})},l.prototype.createConferenceCall=function(e,t){var n=a.create(a.Status.UNKNOWN,null,a.Type.PHONE);return n.setConnectionId(e),n.isConference=!0,n.setParticipants(t),this.telephonyService.calls[n.id]=n,n},l.prototype.analyzeContactChange=function(e,t,n){var r=!1,i=!1;return e||t?n.isConference?void 0:n.contact?(""!==e?n.contact.id!==e&&(r=!0,i=!1):n.contact.temp?n.contact.id!==t?(r=!0,i=!0):n.contact.displayName===t&&(r=!1,i=!0):""!==n.getCurrentCalled().contactPhoneNumber&&""!==t&&n.getCurrentCalled().contactPhoneNumber!==t&&(r=!0,i=!0),r||i?{updateContactToBeDone:r,searchOutlookToBeDone:i}:null):{updateContactToBeDone:!0,searchOutlookToBeDone:!0}:null},l.prototype.updateCallContact=function(r,a,o,s){var c=this;try{var l=c.analyzeContactChange(r,a,s);return s.isConference||""===a||s.setCurrentCalledContactNumber(a),l?i.getOrCreateContact(r,a).then(function(r){return l.searchOutlookToBeDone?c.telephonyService.updateContactFromOutlookInfos(r,a).then(function(t){t?(e.debug("[TelephonyServiceEventHandler] on "+o+", update from outlook for contact :"+r.displayNameMD5),c.makeUpdateContact(s,r,a,o)):(e.debug("[TelephonyServiceEventHandler] on "+o+", no update from outlook for contact :"+r.displayNameMD5),l.updateContactToBeDone?(e.debug("[TelephonyServiceEventHandler] on "+o+", update contact :"+r.displayNameMD5),c.makeUpdateContact(s,r,a,o)):n.$broadcast("ON_CALL_UPDATED_EVENT",s))},function(){e.debug("[TelephonyServiceEventHandler] on "+o+", no Outlook search available"),l.updateContactToBeDone?(e.debug("[TelephonyServiceEventHandler] on "+o+", update contact :"+r.displayNameMD5),c.makeUpdateContact(s,r,a,o)):n.$broadcast("ON_CALL_UPDATED_EVENT",s)}):(e.debug("[TelephonyServiceEventHandler] on "+o+", update contact :"+r.displayNameMD5),c.makeUpdateContact(s,r,a,o),t.when())}):(n.$broadcast("ON_CALL_UPDATED_EVENT",s),t.when())}catch(n){var u="updateCallContact -- "+n.message;return e.error("[TelephonyServiceEventHandler] "+u),t.reject(new Error(u))}},l.prototype.makeUpdateContact=function(e,t,i,o){e.setContact(t);var s={contactPhoneNumber:i,contact:t};e.setCurrentCalled(s),"delivered"===o&&e.status===a.Status.RINGING_INCOMMING?r(function(){n.$broadcast("ON_CALL_UPDATED_EVENT",e)},300,1):n.$broadcast("ON_CALL_UPDATED_EVENT",e)},l}]),angular.module("rainbow").service("directoryService",["$q","$rootScope","$log","$http","contactService","authService","orderByFilter","conversationService",function(e,t,n,r,i,a,o,s){"use strict";this.search=function(c,l){return n.info("[directoryService] searchContact with text "+c),e(function(e,u){var d=config.restServerUrl+"/api/rainbow/search/v1.0/users?limit=20&displayName="+encodeURIComponent(c);r({method:"GET",url:d,headers:a.getRequestHeader()}).then(function(t){var r=t.data.data;n.info("[directoryService] search find "+r.length+" contact(s)");var a=[];if(r.forEach(function(e){if(!i.isUserContactJid(e.jid_im)){var t;if(!(t=i.getContactByJid(e.jid_im)))(t=i.createBasicContact(e.jid_im)).updateFromUserData(e),t.getAvatar(),i.dbContacts[e.id]=t;t.dbId=e.id,t.updateRichStatus(),s.computeCapabilitiesForContact(t,!1),a.push(t)}}),l){var u=i.searchContacts(c);a=a.concat(u.filter(function(e){return e.roster&&a.indexOf(e)<0}))}a=o(a,"_displayName",!1),e(a)},function(e){401===e.data.errorCode&&t.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT"),n.warn("[directoryService] searchContact failure "+e.data.errorMsg),u(new Error("Directory service failure"))})})},this.searchUserByLogin=function(o){n.info('[directoryService] searchUserByLogin with "'+o+'"');var s=e.defer(),c=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/enduser/v1.0/";return r({method:"POST",url:c+"users/loginEmails",headers:a.getPostHeader(),data:{loginEmail:o}}).then(function(e){var t=e.data.data;1===t.length?i.getOrCreateContact(t[0].jid_im).then(function(e){s.resolve(e)}).catch(function(){s.resolve(null)}):s.resolve(null)},function(e){401===e.data.errorCode&&t.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT"),n.warn('[directoryService] searchUserByLogin with "'+o+'" failure'),s.reject(new Error('Directory searchUserByLogin with "'+o+'" failure'))}),s.promise},this.searchUserByJid=function(o){n.info('[directoryService] searchUserByJid with "'+o+'"');var s=e.defer(),c=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/enduser/v1.0/users/jids/";return r({method:"GET",url:c+encodeURIComponent(o),headers:a.getRequestHeader()}).then(function(e){var t=e.data;t?i.getOrCreateContact(o).then(function(e){e.updateFromUserData(t.data),s.resolve(e)}).catch(function(){s.resolve(null)}):s.resolve(null)},function(e){401===e.data.errorCode&&t.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT"),n.warn('[directoryService] searchUserByJid with "'+o+'" failure'),s.reject(new Error('Directory searchUserByJid with "'+o+'" failure'))}),s.promise}}]),angular.module("rainbow").service("invitationService",["$q","$log","$http","$rootScope","authService","Invitation","contactService","xmppService","errorHelperService","settingsService","PromiseQueue",function(e,t,n,r,i,a,o,s,c,l,u){"use strict";var d=this;d.start=function(n){t.info(""),t.info("[invitationService] === STARTING ===");var i=performance.now();d.receivedInvitations={},d.sentInvitations={},d.acceptedInvitationsArray=[],d.sentInvitationsArray=[],d.receivedInvitationsArray=[],d.listeners=[],this.promiseQueue=u.create(),d.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/",d.attachHandlers(),d.getAllSentInvitations(),d.getAllReceivedInvitations();var a=Math.round(performance.now()-i);return n.push({service:"invitationService",startDuration:a}),t.info("[invitationService] === STARTED ("+a+" ms) ==="),d.listeners.push(r.$on("ON_ROSTER_CHANGED_EVENT",d.getAllSentInvitations)),e.when()},d.stop=function(){var n;for(t.info(""),t.info("[invitationService] === STOPPING ===");n=d.listeners.pop();)n();return t.info("[invitationService] === STOPPED ==="),e.when()},d.attachHandlers=function(){t.info("[invitationService] attachHandlers"),d.contactConfigRef&&(s.connection.deleteHandler(d.contactConfigRef),d.contactConfigRef=null),d.contactConfigRef=s.connection.addHandler(d.onInvitationsUpdate,null,"message","management")},d.onInvitationsUpdate=function(e){var n=$(e).find("userinvite");if(n.length){var r=n.attr("id"),i=n.attr("type"),a=n.attr("action");switch(i){case"received":d.handleReceivedInvitation(r,a);break;case"sent":d.handleSentInvitation(r,a);break;default:t.warn("[invitationService] onInvitationsUpdate - received unexpected type - "+i)}}return!0},d.handleReceivedInvitation=function(e,n){t.info("[invitationService] handleReceivedInvitation"),"delete"===n?(delete d.receivedInvitations[e],d.updateReceivedInvitationsArray()):d.getServerInvitation(e).then(function(e){var t=null,n="none";switch(e.status){case"pending":d.receivedInvitations[e.id]=e,t=e,n="ask";break;case"accepted":case"auto-accepted":d.receivedInvitations[e.id]=e,r.$broadcast("ON_INVITATION_ACCEPTED",e.invitingUserId);break;default:delete d.receivedInvitations[e.id],n="unknown"}e.invitingUserId?d.updateContactInvitationStatus(e.invitingUserId,n,t).then(function(){d.updateReceivedInvitationsArray()}):d.updateReceivedInvitationsArray(),r.$broadcast("ON_INVITATION_CHANGED",e)})},d.handleSentInvitation=function(n,i){return e(function(e){t.info("[invitationService] handleSentInvitation"),"delete"===i?(delete d.sentInvitations[n],d.updateReceivedInvitationsArray(),e()):(d.getServerInvitation(n).then(function(t){var n=null;switch(t.status){case"pending":d.sentInvitations[t.id]=t,n="wait";break;case"accepted":case"auto-accepted":r.$broadcast("ON_INVITATION_ACCEPTED",t.invitedUserId);break;default:delete d.sentInvitations[t.id],n="unknown"}t.invitedUserId?d.updateContactInvitationStatus(t.invitedUserId,n,t).then(function(){d.updateSentInvitationsArray(),e()}):(d.updateSentInvitationsArray(),e())}),"resend"===i&&r.$broadcast("ON_INVITATIONS_RE_SEND",n))})},d.updateReceivedInvitationsArray=function(){d.receivedInvitationsArray=[],d.acceptedInvitationsArray=[];for(var e in d.receivedInvitations)if(d.receivedInvitations.hasOwnProperty(e)){var t=d.receivedInvitations[e];switch(t.status){case"pending":d.receivedInvitationsArray.push(t);break;case"accepted":case"auto-accepted":d.acceptedInvitationsArray.push(t)}}d.receivedInvitationsArray.sort(d.sortInvitationArray),d.acceptedInvitationsArray=d.acceptedInvitationsArray.filter(function(e){var t=moment(e.lastNotificationDate);return moment.duration(moment().diff(t)).asHours()<168}),d.acceptedInvitationsArray.sort(d.sortInvitationArray),r.$broadcast("ON_INVITATIONS_NUMBER_UPDATED")},d.updateSentInvitationsArray=function(){d.sentInvitationsArray=[];for(var e in d.sentInvitations)d.sentInvitations.hasOwnProperty(e)&&d.sentInvitationsArray.push(d.sentInvitations[e]);d.sentInvitationsArray.sort(d.sortInvitationArray),r.$broadcast("ON_INVITATIONS_NUMBER_UPDATED")},d.getServerInvitation=function(r){return e(function(e,s){n({method:"GET",url:d.portalURL+o.userContact.dbId+"/invitations/"+r,headers:i.getRequestHeader()}).then(function(n){t.info("[invitationService] getServerInvitation success");var r=a.createFromData(n.data.data);e(r)},function(e){var n=c.handleError(e);s(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"getServerInvitation"))})})},d.getReceivedInvitations=function(){return d.receivedInvitationsArray},d.getAcceptedInvitations=function(){return d.acceptedInvitationsArray},d.getSentInvitations=function(){return d.sentInvitationsArray},d.getInvitationsNumberForCounter=function(){return d.receivedInvitationsArray.length},d.getAllInvitationsNumber=function(){return d.receivedInvitationsArray.length+d.sentInvitationsArray.length+d.acceptedInvitationsArray.length},d.getInvitation=function(e){var t=d.receivedInvitations[e];return t||(t=d.acceptedInvitationsArray[e]),t||(t=d.sentInvitations[e]),t},d.joinContactInvitation=function(r){return e(function(e,a){t.info("[invitationService] joinContactInvitation"),n({method:"POST",url:d.portalURL+o.userContact.dbId+"/invitations",headers:i.getRequestHeader(),data:{invitedUserId:r.dbId}}).then(function(){t.info("[invitationService] joinContactInvitation - success"),"unknown"===r.status&&d.updateContactInvitationStatus(r.dbId,"wait"),e()},function(e){var n=c.handleError(e);a(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"joinContactInvitation"))})})},d.sendInvitationByEmail=function(r,a){return e(function(e,o){var s=l.getAppliLanguageCodeForServer();t.info("[invitationService] sendInvitationByEmail"),n({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/notifications/emails/invite-by-end-user",headers:i.getRequestHeader(),data:{email:r,lang:s,customMessage:a}}).then(function(){t.info("[invitationService] sendInvitationByEmail - success"),e()},function(e){var n=c.handleError(e);o(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"sendInvitationByEmail"))})})},d.cancelOneSendInvitation=function(r){return e(function(e,a){n({method:"POST",url:d.portalURL+r.invitingUserId+"/invitations/"+r.id+"/cancel",headers:i.getRequestHeader()}).then(function(){t.info("[invitationService] cancelOneSendInvitation success"),e()},function(e){var n=c.handleError(e);a(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"cancelOneSendInvitation"))})})},d.reSendInvitation=function(r){return e(function(e,a){n({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+o.userContact.dbId+"/invitations/"+r+"/re-send",headers:i.getRequestHeader()}).then(function(){t.info("[invitationService] reSendInvitation "+r+" - success"),e()},function(e){var n=c.handleError(e);a(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"reSendInvitation"))})})},d.sendInvitationsParBulk=function(r){return!r.length||r.length>100?(t.error("[invitationService] sendInvitationsParBulk mail list length not correct"),e.reject()):e(function(e,a){n({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+o.userContact.dbId+"/invitations/bulk",headers:i.getRequestHeader(),data:{emails:r}}).then(function(){t.info("[invitationService] sendInvitationsParBulk - success"),e()},function(e){var n=c.handleError(e);a(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"sendInvitationsParBulk"))})})},d.acceptInvitation=function(r){return e(function(e,a){n({method:"POST",url:d.portalURL+r.invitedUserId+"/invitations/"+r.id+"/accept",headers:i.getRequestHeader()}).then(function(){t.info("[invitationService] acceptInvitation success"),e()},function(e){var n=c.handleError(e);a(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"acceptInvitation"))})})},d.declineInvitation=function(r){return e(function(e,a){n({method:"POST",url:d.portalURL+r.invitedUserId+"/invitations/"+r.id+"/decline",headers:i.getRequestHeader()}).then(function(){t.info("[invitationService] declineInvitation success"),e()},function(e){var n=c.handleError(e);a(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"declineInvitation"))})})},d.updateContactInvitationStatus=function(t,n,r){return e(function(e){o.getContactByDBId(t).then(function(t){switch(n){case"ask":t.status="unknown",t.ask="ask",t.invitation=r;break;case"wait":t.status="wait",t.ask="subscribe",t.invitation=r;break;default:t.ask="none",t.invitation=null}t.updateRichStatus(),e()})})},d.sortInvitationArray=function(e,t){return new Date(t.lastNotificationDate)-new Date(e.lastNotificationDate)},d.getAllReceivedInvitations=function(){return e(function(e,r){n({method:"GET",url:d.portalURL+o.userContact.dbId+"/invitations/received?format=full",headers:i.getRequestHeader()}).then(function(n){var r=n.data.data;t.info("[invitationService] getAllReceivedInvitations success (find "+r.length+" invitations)"),d.receivedInvitations={},d.acceptedInvitations={},r.forEach(function(e){if("pending"===e.status&&"registration"!==e.type){var t=a.createFromData(e);d.receivedInvitations[e.id]=t,e.invitingUserId&&d.updateContactInvitationStatus(e.invitingUserId,"ask",t)}else"accepted"!==e.status&&"auto-accepted"!==e.status||(d.receivedInvitations[e.id]=a.createFromData(e))}),d.updateReceivedInvitationsArray(),e(d.receivedInvitations)},function(e){var n=c.handleError(e);r(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"getAllReceivedInvitations"))})})},d.getAllSentInvitations=function(){return e(function(e,r){n({method:"GET",url:d.portalURL+o.userContact.dbId+"/invitations/sent?format=full",headers:i.getRequestHeader()}).then(function(n){var r=n.data.data;t.info("[invitationService] getAllSentInvitations success (find "+r.length+" invitations)"),d.sentInvitations={},r.forEach(function(e){if("pending"===e.status&&!e.inviteToJoinMeeting){var t=a.createFromData(e);d.sentInvitations[e.id]=t,void 0!==t.invitedUserId&&d.updateContactInvitationStatus(t.invitedUserId,"wait",t)}}),d.updateSentInvitationsArray(),e(d.sentInvitations)},function(e){var n=c.handleError(e);r(n),t.error("[invitationService] "+c.getErrorFullMessage(e,"getAllSentInvitations"))})})}}]),angular.module("rainbow").service("roomService",["$q","$log","$rootScope","$http","$filter","$interval","authService","contactService","xmppService","Room","utilService","profileService","errorHelperService","settingsService","randomString","orderByFilter",function(e,t,n,r,i,a,o,s,c,l,u,d,f,h,p,v){"use strict";var m=this;m.ROOM_UPDATE_EVENT="ROOM_UPDATE_EVENT",m.ROOM_HISTORY_UPDATE_EVENT="ROOM_HISTORY_UPDATE_EVENT",m.ROOM_ADMIN_MESSAGE_EVENT="ROOM_ADMIN_MESSAGE_EVENT",m.ROOM_INVITATION="ROOM_INVITATION",m.ROOM_ADD_CONF_ENDPOINT_EVENT="ROOM_ADD_CONF_ENDPOINT_EVENT",m.ROOM_REMOVE_CONF_ENDPOINT_EVENT="ROOM_REMOVE_CONF_ENDPOINT_EVENT",m.ROOM_ADD_USERS_EVENT="ROOM_ADD_USERS_EVENT",m.ROOM_DELETE_USERS_EVENT="ROOM_DELETE_USERS_EVENT",m.ROOM_ADD_CONF_GUESTS_EVENT="ROOM_ADD_CONF_GUESTS_EVENT",m.ROOM_DELETE_CONF_GUESTS_EVENT="ROOM_DELETE_CONF_GUESTS_EVENT",m.RoomUserStatus={INVITED:"invited",ACCEPTED:"accepted",UNSUBSCRIBED:"unsubscribed",REJECTED:"rejected",DELETED:"deleted"},m.start=function(n){return e(function(e){var r=performance.now();t.info(""),t.info("[roomService] === STARTING ==="),m.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/",m.invitationCounter=0,m.meetingInvitationCounter=0,m.rooms={},m.roomsByJids={},m.roomsInProgress={},m.contactsInProgress={},m.updateLater={},m.maxRoomsUsers=d.getFeatureLimitMax(d.FeaturesEnum.BUBBLE_PARTICIPANT_COUNT),m.getServerRooms().then(function(){m.computeInvitationCounter(),m.attachHandlers();var i=Math.round(performance.now()-r);n.push({service:"roomService",startDuration:i}),t.info("[roomService] === STARTED ("+i+" ms) ==="),e()}).catch(function(n){t.error("[roomService] === STARTING FAILURE === "+n.message),m.computeInvitationCounter(),m.reconnect(),e()})})},m.stop=function(){return t.info(""),t.info("[roomService] === STOPPING ==="),m.rooms=null,m.roomsByJids=null,t.info("[roomService] === STOPPED ==="),e.when()},m.attachHandlers=function(){t.info("[roomService] attachHandlers"),this.roomPresenceRef&&(c.connection.deleteHandler(this.roomPresenceRef),this.roomPresenceRef=null),this.roomPresenceRef=c.connection.addHandler(m.onRoomPresence,"http://jabber.org/protocol/muc#user","presence"),this.roomMessageRef&&(c.connection.deleteHandler(this.roomMessageRef),this.roomMessageRef=null),this.roomMessageRef=c.connection.addHandler(m.onRoomMessage,"jabber:x:conference","message"),this.roomInfoMessageRef&&(c.connection.deleteHandler(this.roomInfoMessageRef),this.roomInfoMessageRef=null),this.roomInfoMessageRef=c.connection.addHandler(m.onRoomInfoMessage,null,"message","groupchat"),this.roomMessageConfigRef&&(c.connection.deleteHandler(this.roomMessageConfigRef),this.roomMessageConfigRef=null),this.roomMessageConfigRef=c.connection.addHandler(m.onRoomMessageConfig,null,"message","management"),this.roomHistoryInfoRef&&(c.connection.deleteHandler(this.roomHistoryInfoRef),this.roomHistoryInfoRef=null),this.roomHistoryInfoRef=c.connection.addHandler(m.onRoomHistoryInfoMessage,"jabber:iq:notification","message")},m.reconnect=function(){t.info("[roomService] reconnect"),m.attachHandlers(),Object.keys(m.rooms).forEach(function(e){"accepted"===m.rooms[e].status&&m.sendInitialRoomPresence(m.rooms[e])})},m.getRooms=function(){var e=[];return Object.keys(m.rooms).forEach(function(t){e.push(m.rooms[t])}),e},m.searchRooms=function(e){var t=e.toLowerCase().trim().split(/[ ]+/);return m.getRooms().filter(function(e){if("accepted"!==e.status)return!1;var n=e.name.toLowerCase().trim().split(/[ ]+/);return t.every(function(t){return n.some(function(r,i){return!(!r.length||0!==u.removeDiacritis(r).indexOf(u.removeDiacritis(t)))&&(n[i]="",e.filterName=u.removeDiacritis(e.name),!0)})})})},m.getMyRooms=function(){return m.getRooms().filter(function(e){return e.owner})},m.getRoomById=function(e){return m.rooms[e]},m.getRoomByJid=function(e){return m.roomsByJids[e]},m.computeInvitationCounter=function(){m.invitationCounter=0,m.meetingInvitationCounter=0,Object.keys(m.rooms).forEach(function(e){var t=m.rooms[e];"invited"===t.status&&(t.isMeetingRoom()&&d.isFeatureEnabled("CONFERENCE_PARTICIPANT_ALLOWED")?m.meetingInvitationCounter+=1:m.invitationCounter+=1)})},m.getOrderedRooms=function(){return v(m.getRooms(),m.getCreationDate,!0,m.sortByDate)},m.getMyOrderedRooms=function(){return v(m.getMyRooms(),m.getCreationDate,!0,m.sortByDate)},m.getServerRoom=function(n){return e(function(e,i){t.info("[roomService] getServerRoom("+n+")"),r({method:"GET",url:m.portalURL+"rooms/"+n+"?format=full",headers:o.getRequestHeader()}).then(function(e){var r=e.data.data;return t.info("[roomService] getServerRoom("+n+") successfully"),m.getAllRoomsParticipants([r])}).then(function(t){var n=m.createRoomFromData(t[0]);e(n)},function(e){var r=e.data?e.data.errorDetails:e.data,a="getServerRoom("+n+") failure: "+r;t.error("[roomService] "+a),i(new Error(a))})})},m.getServerRooms=function(){var n=function(i,a,c){return e(function(l,u){var d,f,h;(d=i,f=a,h=c,e(function(e,n){r({method:"GET",headers:o.getRequestHeader(),url:m.portalURL+"rooms?format=full&userId="+s.userContact.dbId+"&offset="+d+"&limit="+f}).then(function(n){h=h.concat(n.data.data),t.info("[roomService] getServerRooms retrieved "+n.data.data.length+" rooms, total "+h.length+", existing "+n.data.total),e({rooms:h,finished:h.length===n.data.total})}).catch(function(e){n(e)})})).then(function(e){e.finished?(t.info("[roomService] getServerRooms no need to loop again. All rooms retrieved..."),l(e.rooms)):(i+=a,t.info("[roomService] getServerRooms need another loop to get more rooms... ["+e.rooms.length+"]"),n(i,a,e.rooms).then(function(e){l(e)}).catch(function(e){u(e)}))}).catch(function(e){u(e)})})};return e(function(e,r){n(0,1e3,[]).then(function(e){var n=e;return t.info("[roomService] getServerRooms successfully: find "+n.length+" room(s)"),m.getAllRoomsParticipants(n)}).then(function(t){t.forEach(function(e){m.createRoomFromData(e)}),e()}).catch(function(e){var n="getServerRooms failure: "+(e.data?e.data.errorDetails:e.message);t.error("[roomService] "+n),r(new Error(n))})})},m.getAllRoomsParticipants=function(n){var r=e.defer(),i=performance.now(),a={},o=[];return n.forEach(function(t){var n=e.defer();return o.push(n),n.resolve(t),n.promise.then(function(e){e.users.forEach(function(e){var t=s.getContactByJid(e.jid_im);a[e.jid_im]||t&&!t.temp||(a[e.jid_im]=e.jid_im)})})}),e.all(o).then(function(){var e=Object.keys(a);if(!e.length){performance.now();return t.info("[roomService] getAllRoomsParticipants - nothing to get, all known."),void r.resolve(n)}return s.getContactsByJids(e).then(function(){var a=performance.now();t.info("[roomService] getAllRoomsParticipants - get "+e.length+" participants in "+Math.round(a-i)+" milliseconds."),r.resolve(n)})}),r.promise},m.createRoomFromData=function(e){var r=l.create(e.id,e.jid,e.name,e.topic,e.creationDate,e.confEndpoints,e.history,e.customData,e.conference),i=s.dbContacts[e.creator];if(i){r.ownerContact=i,r.owner=i.jid===s.userContact.jid,e.users.forEach(function(e){var t=s.getContactById(e.userId);t&&(r.users.push({contact:t,status:e.status,date:new Date(e.additionDate),privilege:e.privilege}),s.isUserContact(t)&&(r.status=e.status))}),r.guestEmails=e.guestEmails,m.refreshMemberAndOrganizerLists(r);var a=r.getUserByJid(s.userContact.jid);return r.isModerator=a.status!==m.RoomUserStatus.UNSUBSCRIBED&&r.isUserModerator(s.userContact),m.rooms[r.dbId]&&m.rooms[r.dbId].initPresPromise&&(r.initPresPromise=m.rooms[r.dbId].initPresPromise),r.updateAvatarInfo(),e.lastAvatarUpdateDate&&(r.avatar=config.restServerUrl+"/api/room-avatar/"+e.id+"?size=512&update="+MD5.hexdigest(e.lastAvatarUpdateDate)),m.rooms[r.dbId]=r,m.roomsByJids[r.jid]=r,n.$broadcast(m.ROOM_UPDATE_EVENT,r),"accepted"===r.status&&m.sendInitialRoomPresence(r),r}t.error("[roomService] createRoomFromData -- failure -- Impossible to find owner of room "+e.name+" --- ignored")},m.refreshMemberAndOrganizerLists=function(e){e.organizers=[],e.members=[],e.users.forEach(function(t){t.status!==m.RoomUserStatus.ACCEPTED&&t.status!==m.RoomUserStatus.INVITED||(t.privilege===l.Privilege.MODERATOR?e.organizers.push(t):e.members.push(t))})},m.equalContactsArrayByDbId=function(e,t){if(e===t)return!0;if(null===e||null===t)return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;++n)if(e[n].dbId!==t[n].dbId)return!1;return!0},m.getOrCreateRoomWithContacts=function(n,r){return e(function(e){var a=null,o=[].concat([s.userContact],n).sort(sortObjectByProperty("dbId"));if(m.getMyRooms().some(function(e){return!(!e||e.status!==m.RoomUserStatus.ACCEPTED||!m.equalContactsArrayByDbId(e.users.map(function(e){return e.contact}).sort(sortObjectByProperty("dbId")),o))&&(a=e,t.debug("[roomService] getOrCreateRoomWithContacts - Found Room "+e.name),!0)}),a)r.length?m.addRoomUsers(a,null,r).then(function(){e(a)}):e(a);else{for(var c=s.userContact.initials+" "+i("translate")("bubble")+" ",l=m.getMyRooms().filter(function(e){return e&&0===e.name.indexOf(c)}),u=function(e){return e&&e.name===h},d=null,f=1;!d;){var h=c+f.toString();l.sort(sortObjectByProperty("name")).some(u)||(d=h),f++}var p=o.map(function(e){return e.displayName}).join(", ");m.createRoomWithContacts(d,p,n,r).then(function(t){e(t)})}})},m.createRoomWithContacts=function(n,r,i,a){return e(function(e,o){m.createRoom(n,r).then(function(e){return m.addRoomUsers(e,i,a)}).then(function(t){e(t)}).catch(function(e){var n="createRoomWithContacts failure: "+e.message;t.error("[roomService] "+n),o(new Error(n))})})},m.setAvatarRoom=function(n,i){var a=e.defer();return i?(m.resizeImage(i,512,512).then(function(e){var i=m.getBinaryData(e);r({method:"POST",url:m.portalURL+"rooms/"+n.id+"/avatar",headers:o.getPostHeader("image/"+i.type),data:i.data,transformRequest:[]}).then(function(e){t.info("[roomService] setAvatarRoom success: "+e.data.status),n.avatar=config.restServerUrl+"/api/room-avatar/"+n.id+"?size=512&rand="+p(),a.resolve(n)},function(e){var n=f.handleError(e);t.error("[roomService] "+f.getErrorFullMessage(e,"setAvatarRoom")),a.reject(n)})}),a.promise):(a.resolve(n),a.promise)},m.deleteAvatarRoom=function(n){return e(function(e,i){r({method:"DELETE",url:m.portalURL+"rooms/"+n+"/avatar",headers:o.getRequestHeader()}).then(function(){t.info("[roomService] avatar room sucessfully deleted"),e()}).catch(function(e){i(e)})})},m.resizeImage=function(t,n,r){var i=e.defer(),a=new Image;return a.src=t,a.onload=function(){var e=a.width,t=a.height;e>t?e>n&&(t*=n/e,e=n):t>r&&(e*=r/t,t=r);var o=document.createElement("canvas");o.width=e,o.height=t,a.width=e,a.height=t,o.getContext("2d").drawImage(this,0,0,e,t);var s=new Image;s.src=o.toDataURL("image/png"),i.resolve(s)},i.promise},m.getBinaryData=function(e){for(var t=e.src.indexOf("image/")+6,n=e.src.indexOf(";base64,"),r=e.src.slice(n+8),i=e.src.slice(t,n),a=window.atob(r),o=a.length,s=new Uint8Array(o),c=0;c<o;c++)s[c]=a.charCodeAt(c);return{type:i,data:s}},m.pushContactInRoom=function(n,r){return e(function(e){s.getContactByDBId(n.userId).then(function(i){r.users.push({contact:i,status:n.status,date:new Date(n.additionDate),privilege:n.privilege}),s.isUserContact(i)&&(r.status=n.status),t.info("[roomService] pushContactInRoom success"),e()}).catch(function(n){t.info("[roomService] pushContactInRoom failure : "+n.message),e()})})},m.addRoomUser=function(i,a,s,c,u){return e(function(e,d){if(i.users.some(function(e){return(e.status===m.RoomUserStatus.INVITED||e.status===m.RoomUserStatus.ACCEPTED||e.status===m.RoomUserStatus.REJECTED)&&e.contact.dbId===a.dbId}))return t.debug("[roomService] user: "+a.dbId+" already invited or accepted, will not be added"),void e(i);if(i.users.filter(function(e){return e.status!==m.RoomUserStatus.DELETED}).length>=m.maxRoomsUsers){var f=new Error("addRoomUser failure - Not Allowed : Participants max limit has been reached: "+m.maxRoomsUsers);return f.status=f.errorDetailsCode="403",t.error("[roomService] "+f.message),void d(f)}var h=m.RoomUserStatus.INVITED;"boolean"==typeof u&&u&&(h=m.RoomUserStatus.ACCEPTED);var p=s||"JustForFun",v=c||l.Privilege.USER;r({method:"POST",url:m.portalURL+"rooms/"+i.dbId+"/users",headers:o.getPostHeader(),data:{userId:a.dbId,privilege:v,reason:p,status:h}}).then(function(r){t.info("[roomService] addRoomUser "+a.displayNameForLog()+" to room "+i.dbId+"("+i.name+") success");var o=r.data.data,s=i.getUserByJid(o.jid_im);s?(s.status=o.status,s.date=new Date,s.privilege=o.privilege):i.users.push({contact:a,status:h,date:new Date,privilege:v}),m.refreshMemberAndOrganizerLists(i),n.$broadcast(m.ROOM_UPDATE_EVENT,i),e(i)},function(e){var n="addRoomUser "+a.displayNameForLog()+" to room "+i.dbId+"("+i.name+") failure: "+e.data.errorDetails;t.error("[roomService] "+n),d(new Error(n))})})},m.addRoomUsers=function(r,i,a){return e(function(o,s){var c=[];i.forEach(function(e){r.users.some(function(t){if(t.contact.dbId===e.dbId){switch(t.status){case m.RoomUserStatus.UNSUBSCRIBED:c.push(m.ownerReinviteRejectedUser(r,e));break;case m.RoomUserStatus.DELETED:c.push(m.ownerReinviteDeletedUser(r,e));break;case m.RoomUserStatus.REJECTED:c.push(m.ownerReinviteRejectedUser(r,e))}return!0}return!1})||c.push(m.addRoomUser(r,e))}),e.all(c).then(function(){t.info("[roomService] addRoomUsers success"),n.$broadcast(m.ROOM_ADD_USERS_EVENT,r),o(r)}).then(function(){m.inviteGuestEmailToJoinRoom(r,a)}).catch(function(e){var n="addRoomUsers failure: "+e.message;t.error("[roomService] "+n),s(new Error(n))})})},m.deleteRoomUsers=function(r,i){return e(function(a,o){var s=[];i.forEach(function(e){r.users.some(function(t){return t.contact.dbId===e.dbId})&&s.push(m.ownerDeletesUserFromRoom(r,e))}),e.all(s).then(function(){t.info("[roomService] deleteRoomUsers success"),n.$broadcast(m.ROOM_DELETE_USERS_EVENT,r),a(r)}).catch(function(e){var n="deleteRoomUsers failure: "+e.message;t.error("[roomService] "+n),o(new Error(n))})})},m.sendInitialRoomPresence=function(e){var t=$pres({to:e.jid+"/"+c.fullJid});t.c("x",{xmlns:"http://jabber.org/protocol/muc"}).c("history",{maxchars:"0"}),c.send(t)},m.sendPresenceWithResponseWait=function(t){if(t.initPresPromiseReceived)return m.sendInitialRoomPresence(t),e.when(t);var n=t.initPresPromise=e.defer();return m.sendInitialRoomPresence(t),n.promise},m.sendUnavailableRoomPresence=function(e){var t=$pres({to:e.jid+"/"+s.userContact.jid,type:"unavailable"});t.c("x",{xmlns:"http://jabber.org/protocol/muc"}),c.send(t)},m.createRoom=function(n,i,a,c){return t.info('[roomService] createRoom "'+n+'"'),e(function(e,u){var d;d=a?"all":"none",r({method:"POST",url:m.portalURL+"rooms/",headers:o.getPostHeader(),data:{name:n,topic:i,history:d}}).then(function(e){var t=e.data.data;return m.setAvatarRoom(t,c)}).then(function(r){m.rooms[r.id]&&(t.info('[roomService] createRoom -- room "'+n+'" already exists'),e(m.rooms[r.id]));var i=l.create(r.id,r.jid,r.name,r.topic,r.creationDate,r.confEndpoints,r.history,r.customData,r.conference,r.avatar);i.ownerContact=s.userContact,i.owner=!0,i.isModerator=!0,i.status="accepted",m.rooms[i.dbId]=i,m.roomsByJids[i.jid]=i,t.info('[roomService] createRoom "'+n+'" -- success'),e(m.sendPresenceWithResponseWait(i))}).catch(function(e){t.error('[roomService] createRoom "'+n+'" -- failure '+e),u(e)})})},m.updateRoomUser=function(i,a,s,c){var l={};return s&&(l.status=s),c&&(l.privilege=c),e(function(e,s){r({method:"PUT",url:m.portalURL+"rooms/"+i.dbId+"/users/"+a.dbId,headers:o.getPostHeader(),data:l}).then(function(r){t.info("[roomService] updateRoomUser "+a.displayNameForLog()+" to room "+i.dbId+"("+i.name+") success");var o=r.data.data;i.users.forEach(function(e){e.contact.jid===o.jid_im&&(e.privilege=o.privilege,e.status=o.status)}),m.refreshMemberAndOrganizerLists(i),n.$broadcast(m.ROOM_UPDATE_EVENT,i),e(i)},function(e){var n="updateRoomUser "+a.displayNameForLog()+" to room "+i.dbId+"("+i.name+") failure: "+e.data.errorDetails;t.error("[roomService] "+n),s(new Error(n))})})},m.ownerArchiveRoom=function(n){return t.info("[roomService] ownerArchiveRoom"),e(function(r,i){var a=[];n.users.forEach(function(e){s.isUserContact(e.contact)||e.status===m.RoomUserStatus.DELETED||e.status===m.RoomUserStatus.REJECTED||a.push(m.unsubscribeUserFromRoom(n,e.contact))}),e.all(a).then(function(){t.info("[roomService] unsubscribe all other users successfully"),m.unsubscribeMeFromRoom(n).then(function(){t.info("[roomService] ownerArchiveRoom successfully"),r(n)})}).catch(function(e){var n="ownerArchiveRoom failure: "+e.message;t.error("[roomService] "+n),i(new Error(n))})})},m.unsubscribeUserFromRoom=function(e,t){return m.updateRoomUser(e,t,m.RoomUserStatus.UNSUBSCRIBED)},m.ownerDeletesUserFromRoom=function(i,a){return t.info("[roomService] ownerDeletesUserFromRoom"),e(function(e,s){var c=a.dbId;r({method:"DELETE",url:m.portalURL+"rooms/"+i.dbId+"/users/"+c,headers:o.getRequestHeader()}).then(function(){t.info("[roomService] ownerDeletesUserFromRoom "+c+" from room "+i.dbId+"("+i.name+") success"),n.$broadcast(m.ROOM_UPDATE_EVENT,i),e(i)},function(e){var n="ownerDeletesUserFromRoom "+c+" from room "+i.dbId+"("+i.name+") failure: "+e.data.errorDetails;t.error("[roomService] "+n),s(new Error(n))})})},m.ownerReinviteRejectedUser=function(n,r,i,a,o){return e(function(e,s){m.ownerDeletesUserFromRoom(n,r).then(function(){m.addRoomUser(n,r,i,a,o).then(function(){t.info("[roomService] ownerReinviteRejectedUser "+r.dbId+" from room "+n.dbId+"("+n.name+") success"),e(n)})}).catch(function(e){var n="ownerReinviteRejectedUser failure: "+e.message;t.error("[roomService] "+n),s(new Error(n))})})},m.ownerReinviteDeletedUser=function(n,r,i,a,o){return e(function(e,s){m.addRoomUser(n,r,i,a,o).then(function(){t.info("[roomService] ownerReinviteDeletedUser "+r.dbId+" from room "+n.dbId+"("+n.name+") success"),e(n)}).catch(function(e){var n="ownerReinviteDeletedUser failure: "+e.message;t.error("[roomService] "+n),s(new Error(n))})})},m.ownerDeleteRoom=function(i){return e(function(e,a){var s=i.dbId;s?r({method:"DELETE",url:m.portalURL+"rooms/"+s,headers:o.getRequestHeader()}).then(function(){t.info("[roomService] ownerDeleteRoom "+i.dbId+"("+i.name+") success"),delete m.rooms[i.dbId],n.$broadcast(m.ROOM_UPDATE_EVENT,i),e(i)},function(e){var n="ownerDeleteRoom ("+s+") failure: "+e.data.errorDetails;t.error("[roomService] "+n),a(new Error(n))}):t.error("[roomService] ownerDeleteRoom failure because the roomId is empty ...")})},m.ownerUpdateRoom=function(n){return t.info("[roomService] ownerUpdateRoom"),e(function(e,i){var a={name:n.name,topic:n.desc,visibility:n.type?"public":"private"};r({method:"PUT",url:m.portalURL+"rooms/"+n.dbId,headers:o.getPostHeader(),data:a}).then(function(n){var r=n.data.data;m.rooms[r.id].desc=r.topic,m.rooms[r.id].type="private"===r.visibility?l.Type.PRIVATE:l.Type.PUBLIC,t.info("[roomService] ownerUpdateRoom successfully ("+r.id+", "+r.jid+")"),e(m.rooms[r.id])},function(e){var n="ownerUpdateRoom failure: "+e.data.errorDetails;t.error("[roomService] "+n),i(new Error(n))})})},m.ownerUpdateRoomCustomData=function(n){return t.info("[roomService] ownerUpdateRoomCustomData"),e(function(e,i){var a={customData:n.customData};r({method:"PUT",url:m.portalURL+"rooms/"+n.dbId+"/custom-data",headers:o.getPostHeader(),data:a}).then(function(n){var r=n.data.data;t.info("[roomService] ownerUpdateRoomCustomData successfully got ("+JSON.stringify(r,null,4)+")"),e(r.customData||{})},function(e){var n="ownerUpdateRoomCustomData failure: "+e.data.errorDetails;t.error("[roomService] "+n),i(new Error(n))})})},m.ownerUpdateRoomNameAndDescription=function(n){return t.info("[roomService] ownerUpdateRoomNameAndDescription"),e(function(e,i){var a={name:n.name,topic:n.desc,visibility:n.type?"public":"private"};r({method:"PUT",url:m.portalURL+"rooms/"+n.dbId,headers:o.getPostHeader(),data:a}).then(function(n){var r=n.data.data;m.rooms[r.id].desc=r.topic,m.rooms[r.id].type="private"===r.visibility?l.Type.PRIVATE:l.Type.PUBLIC,(r.conference||r.confEndpoints)&&(m.rooms[r.id].conference=r.conference?r.conference:null,m.rooms[r.id].confEndpoints=r.confEndpoints?r.confEndpoints:[]),t.info("[roomService] ownerUpdateRoomNameAndDescription successfully ("+r.id+", "+r.jid+")"),e(m.rooms[r.id])},function(e){var n="ownerUpdateRoomNameAndDescription failure: "+e.data.errorDetails;t.error("[roomService] "+n),i(new Error(n))})})},m.updateMyRoomUser=function(n,i){return e(function(e,a){r({method:"PUT",url:m.portalURL+"rooms/"+n.dbId+"/users/"+s.userContact.dbId,headers:o.getPostHeader(),data:{status:i}}).then(function(){t.info("[roomService] updateMyRoomUser "+s.userContact.displayNameForLog()+" to room "+n.dbId+"("+n.name+") success"),e(n)},function(e){var r="updateMyRoomUser "+s.userContact.displayNameForLog()+" to room "+n.dbId+"("+n.name+") failure: "+e.data.errorDetails;t.error("[roomService] "+r),a(new Error(r))})})},m.unsubscribeMeFromRoom=function(e){return m.updateMyRoomUser(e,m.RoomUserStatus.UNSUBSCRIBED)},m.participantCloseRoom=function(i){return t.info("[roomService] participantCloseRoom"),e(function(e,a){var c=s.userContact.dbId;r({method:"DELETE",url:m.portalURL+"rooms/"+i.dbId+"/users/"+c,headers:o.getRequestHeader()}).then(function(){t.info("[roomService] participantCloseRoom "+c+" from room "+i.dbId+"("+i.name+") success"),delete m.rooms[i.dbId],n.$broadcast(m.ROOM_UPDATE_EVENT,i),e(i)},function(e){var n="participantCloseRoom "+c+" from room "+i.dbId+"("+i.name+") failure: "+e.data.errorDetails;t.error("[roomService] "+n),a(new Error(n))})})},m.acceptRoomInvitation=function(e){return m.updateMyRoomUser(e,m.RoomUserStatus.ACCEPTED).then(function(){return m.sendInitialRoomPresence(e)})},m.declineRoomInvitation=function(e){return m.updateMyRoomUser(e,m.RoomUserStatus.REJECTED)},m.getRoomConferenceEndPoint=function(n,i){return t.info("[roomService] getRoomConferenceEndPoint"),e(function(e,a){r({method:"GET",url:m.portalURL+"rooms/"+n.dbId+"/conference/"+i,headers:o.getRequestHeader()}).then(function(r){var a=r.data.data;t.info("[roomService] getRoomConferenceEndPoint "+i+" from room "+n.dbId+"success"),e(a)},function(e){var r="getRoomConferenceEndPoint "+i+" from room "+n.dbId+"failure: "+e.data.errorDetails;t.error("[roomService] "+r),a(new Error(r))})})},m.addRoomConferenceEndPoint=function(i,a){if(t.info("[roomService] addRoomConferenceEndPoint"),null===a||angular.isUndefined(a)){var s=new Error("No ConferenceEndPoint to associate with Room");return e.reject(s)}return e(function(e,s){var c=!1;if(i.confEndpoints.forEach(function(e){e.confEndpointId===a.id&&(c=!0)}),c)return t.info("[roomService] addRoomConferenceEndPoint : already attached to room !"),void e(i);r({method:"POST",url:m.portalURL+"rooms/"+i.dbId+"/conferences",headers:o.getPostHeader(),data:{confId:a.id}}).then(function(r){var o=r.data.data;t.debug("[roomService] addRoomConferenceEndPoint response data:"+JSON.stringify(o)),i.confEndpoints.push(o),t.info("[roomService] addRoomConferenceEndPoint "+a.id+" to room "+i.dbId+"success"),n.$broadcast(m.ROOM_ADD_CONF_ENDPOINT_EVENT,i),e(i)},function(e){var n=f.handleError(e);t.error("[roomService] addRoomConferenceEndPoint "+n.message),s(n)})})},m.deleteRoomConferenceEndPoint=function(i,a){return t.info("[roomService] deleteRoomConferenceEndPoint"),e(function(e,s){if(!i||!a)return t.info("[roomService] deleteRoomConferenceEndPoint : missing parameters "),void e();var c=!1;if(i.confEndpoints&&i.confEndpoints.length)for(var l=0;l<i.confEndpoints.length;l++)if(i.confEndpoints[l].confEndpointId===a){c=!0;break}if(!c)return t.info("[roomService] deleteRoomConferenceEndPoint : room has no such conference attached"),void e();r({method:"DELETE",url:m.portalURL+"rooms/"+i.dbId+"/conferences/"+a,headers:o.getRequestHeader()}).then(function(r){var o=r.data.data;t.info("[roomService] deleteRoomConferenceEndPoint "+a+" from room "+i.dbId+"success"),i.confEndpoints=o,n.$broadcast(m.ROOM_REMOVE_CONF_ENDPOINT_EVENT,i),e()},function(r){var o="deleteRoomConferenceEndPoint "+a+" from room "+i.dbId+"failure: "+r.data.errorDetails;t.error("[roomService] "+o),404===r.status?(i.confEndpoints=[],n.$broadcast(m.ROOM_REMOVE_CONF_ENDPOINT_EVENT,i),e()):s(new Error(o))})})},m.inviteGuestEmailToJoinRoom=function(i,a){return t.info("[roomService] inviteGuestEmailToJoinRoom"),a&&a.length?e(function(e){r({method:"POST",url:m.portalURL+"rooms/"+i.dbId+"/invitations",headers:o.getRequestHeader(),data:{scenario:"chat",emails:a,lang:o.userData.language}}).then(function(){n.$broadcast("ROOM_ADD_CONF_GUESTS_EVENT",i),e(i)}).catch(function(e){var n=f.handleError(e);t.error("[roomService] inviteGuestEmailToJoinRoom "+n.message),reject(n)})}):e.resolve(i)},m.notifyRoomUsersJoinConference=function(i,a,s,c,l){return t.info("[roomService] notifyRoomUsersJoinConference"),c=angular.isDefined(c)?c:"false",l=angular.isDefined(l)?l:"false",e(function(e,u){var d=i.getPstnConfEndpointId();if(d){var f=i.desc;r({method:"POST",url:m.portalURL+"rooms/"+i.dbId+"/conferences/"+d+"/invitations?noMail="+c.toString()+"&update="+l.toString(),headers:o.getPostHeader(),data:{users:a?a.map(function(e){return e.dbId}):void 0,emails:s,instantMessage:f,lang:o.userData.language}}).then(function(){t.info("[roomService] notifyRoomUsersJoinConference "+d+" from room "+i.dbId+"success"),m.rooms[i.dbId].conference.guestEmails=s,n.$broadcast("ROOM_ADD_CONF_GUESTS_EVENT",m.rooms[i.dbId]),e(m.rooms[i.dbId])},function(e){var n="notifyRoomUsersJoinConference "+d+" from room "+i.dbId+"failure: "+e.data.errorDetails;t.error("[roomService] "+n),u(new Error(n))})}else e(i)})},m.notifyUsersCancelConference=function(i,a,s,c){return t.debug("[roomService] notifyUsersCancelConference"),c=angular.isDefined(c)?c:"false",e(function(e,l){var u=i.getPstnConfEndpointId();u?r({method:"DELETE",url:m.portalURL+"rooms/"+i.dbId+"/conferences/"+u+"/invitations?noMail="+c.toString(),headers:o.getPostHeader(),data:{users:a?a.map(function(e){return e.dbId}):void 0,emails:s,lang:o.userData.language}}).then(function(){t.info("[roomService] notifyUsersCancelConference "+u+" from room "+i.dbId+"success"),m.rooms[i.dbId].conference.guestEmails=m.rooms[i.dbId].conference.guestEmails.filter(function(e){return-1===s.indexOf(e)}),n.$broadcast("ROOM_DELETE_CONF_GUESTS_EVENT",m.rooms[i.dbId]),e(m.rooms[i.dbId])},function(e){var n="notifyUsersCancelConference "+u+" from room "+i.dbId+"failure: "+e.data.errorDetails;t.error("[roomService] "+n),l(new Error(n))}):e(i)})},m.getRoomByConferenceEndpointId=function(n){return t.info("[roomService] getRoomFromConferenceEndpointId"),e(function(e,i){r({method:"GET",url:m.portalURL+"rooms?userId="+s.userContact.dbId+"&confId="+n,headers:o.getRequestHeader()}).then(function(r){t.info("[roomService] getRoomFromConferenceEndpointId -- "+n+" -- success");var i=r.data.data;i.length?e(m.getRoomById(i[0].id)):e()},function(e){var r="getRoomFromConferenceEndpointId -- "+n+" -- failure: "+e.data.errorDetails;t.error("[roomService] "+r),i(new Error(r))})})},m.onRoomMessage=function(e){t.info("[roomService] onRoomMessage");try{var r=angular.element(e).find("x").attr("thread");return m.getServerRoom(r).then(function(e){e.isMeetingRoom()&&n.$broadcast("MEETING_CREATED_EVENT",e),m.computeInvitationCounter(),n.$broadcast(m.ROOM_INVITATION,e),n.$broadcast(m.ROOM_UPDATE_EVENT,e)}).catch(function(e){t.error("[roomService] onRoomMessage failure :  impossible to get associated room : "+e.message)}),!0}catch(e){return t.error("[roomService] onRoomMessage error "+e),!0}},m.onRoomInfoMessage=function(e){t.info("[roomService] onRoomInfoMessage");try{if(angular.element(e).find("event").length>0){t.info("[roomService] onRoomInfoMessage : room event message");var r=angular.element(e).attr("from"),i=c.getBareJidFromJid(r),o=angular.element(e).find("event").attr("jid"),l=angular.element(e).find("event").attr("name"),u=angular.element(e).attr("id");if(t.info("[roomService] onRoomInfoMessage : room event message with parameters "+i+" || "+o+" || "+l+" || "+u),i&&o&&l&&u){var d=(h=m.getRoomByJid(i)).getUserByJid(o);switch(d&&"deleted"!==d.status&&n.$broadcast(m.ROOM_ADMIN_MESSAGE_EVENT,i,o,l,u),l){case"conferenceAdd":m.getServerRoom(h.dbId).then(function(e){a(function(){t.info("[roomService] onRoomInfoMessage : conferenceAdd event"),n.$broadcast("ROOM_UPDATE_CONFID",e),n.$broadcast("ROOM_ADD_CONF_ENDPOINT_EVENT",e),n.$broadcast("ON_CONFERENCE_STARTED_INVITATION",e)},2e3,1)});break;case"conferenceRemove":m.getServerRoom(h.dbId).then(function(e){a(function(){t.info("[roomService] onRoomInfoMessage : conferenceRemove event"),n.$broadcast("ROOM_REMOVE_CONFID",e),n.$broadcast("ON_CONFERENCE_ENDED_INVITATION",e)},2e3,1)});break;case"invitation":!h.isUserModerator(s.userContact)||d&&d.status!==m.RoomUserStatus.DELETED||m.getServerRoom(h.dbId).then(function(e){n.$broadcast(m.ROOM_UPDATE_EVENT,e)})}}}else if(angular.element(e).find("subject").length>0){r=angular.element(e).attr("from");var f=c.getBareJidFromJid(r),h=m.getRoomByJid(f),p=angular.element(e).find("subject").text();h&&p&&(t.info("[roomService] onRoomInfoMessage : update subject of room"),h.desc=p,n.$broadcast(m.ROOM_UPDATE_EVENT,h))}return!0}catch(e){return t.error("[roomService] onRoomInfoMessage error "+e),!0}},m.onRoomHistoryInfoMessage=function(e){var r=$(e).find("changed");if(r.length>0){var i=r.attr("with"),a=m.getRoomByJid(i);t.debug("[roomService] onRoomHistoryInfoMessage with "+i),n.$broadcast(m.ROOM_HISTORY_UPDATE_EVENT,a)}return!0},m.onRoomMessageConfig=function(e){try{var r=$(e),i=r.find("room");if("management"===r.attr("type")&&i.length>0){var a=i.attr("roomid"),o=i.attr("userjid"),c=i.attr("status"),u=i.attr("topic"),d=i.attr("name"),f=i.attr("scheduledStartDate"),h=i.attr("scheduledEndDate"),p=i.attr("scheduledTimezone"),v=i.attr("lastAvatarUpdateDate"),g=i.attr("privilege"),E=i.attr("customData"),S=m.getRoomById(a);t.info("[roomService] onRoomMessageConfig -- management -- "+a);var C=i.find("guests");if(C.length>0&&(t.info("[roomService] onRoomMessageConfig -- "+a+" -- update guests list"),"update"===C.attr("action")&&(S.guestEmails=[],$(C).find("email").each(function(e,t){S.guestEmails.push(t.textContent)}))),S&&c)(b=S.getUserByJid(o))?b&&(t.info("[roomService] onRoomMessageConfig update user status"),m.updateUserStatus(S,b,c)):(t.info("[roomService] onRoomMessageConfig room exists, but user not. Update the room"),m.getServerRoom(a).then(function(){S.updateAvatarInfo()}));else if(S&&d)t.info("[roomService] onRoomMessageConfig update Room name or topic"),S.name=d,S.desc=u,m.roomsByJids[S.jid].name=d,m.rooms[S.dbId].name=d,m.roomsByJids[S.jid].desc=u,m.rooms[S.dbId].desc=u,S.isMeetingRoom()&&m.getServerRoom(S.dbId).then(function(){n.$broadcast("MEETING_UPDATE_EVENT",S)}),n.$broadcast(m.ROOM_UPDATE_EVENT,S);else if(S&&E)t.info("[roomService] onRoomMessageConfig update Room customData"),S.customData=E,m.roomsByJids[S.jid].customData=E,m.rooms[S.dbId].customData=E,n.$broadcast(m.ROOM_UPDATE_EVENT,S);else if(S&&S.conference&&f&&h&&p)t.info("[roomService] onRoomMessageConfig update Room conference data"),S.conference.scheduledStartDate=moment(f).toISOString(),S.conference.scheduledEndDate=moment(h).toISOString(),S.conference.scheduledTimezone=p,S.conference.scheduledDuration=moment.duration(moment(h).diff(moment(f))).asMinutes(),n.$broadcast(m.ROOM_UPDATE_EVENT,S);else if(S&&v)t.info("[roomService] onRoomMessageConfig update avatar"),m.getServerRoom(S.dbId).then(function(e){e.updateAvatarInfo()});else if(S&&g){var b;t.info("[roomService] onRoomMessageConfig update user's privilege "+g),(b=o?S.getUserByJid(o):null)&&b.contact&&b.contact.jid!==s.userContact.jid?("moderator"===g?b.privilege=l.Privilege.MODERATOR:"user"===g&&(b.privilege=l.Privilege.USER),m.refreshMemberAndOrganizerLists(S),n.$broadcast(m.ROOM_UPDATE_EVENT,S)):m.getServerRoom(S.dbId).then(function(e){m.refreshMemberAndOrganizerLists(e),n.$broadcast(m.ROOM_UPDATE_EVENT,e)})}else void 0===S&&a&&!m.roomsInProgress[a]&&"deleted"!==c&&"rejected"!==c?(m.roomsInProgress[a]=!0,t.info("[roomService] onRoomMessageConfig -- room does not exist, create new one"),m.getServerRoom(a).then(function(e){delete m.roomsInProgress[a],t.info("[roomService] onRoomMessageConfig -- sendInitialRoomPresence to the new room"),m.sendInitialRoomPresence(e),m.updateLater[a]&&(delete m.updateLater[a],t.info("[roomService] onRoomMessageConfig -- later update of the new room"),m.getServerRoom(a).then(function(e){e.updateAvatarInfo()}))})):m.roomsInProgress[a]&&(m.updateLater[a]=a)}return!0}catch(e){return t.info("[roomService] onRoomMessageConfig  -- failure -- "+e.message),!0}},m.onRoomPresence=function(e){try{var n=angular.element(e).attr("from"),r=c.getBareJidFromJid(n),i=c.getResourceFromJid(n),a=m.getRoomByJid(r);return a&&(t.info("[roomService] onRoomPresence -- "+a.dbId),-1!==i.indexOf("/")&&(i=c.getBareJidFromJid(i)),s.isUserContactJid(i)?a.initPresPromise?(t.info("[roomService] onRoomPresence - initPresPromise resolved"),a.initPresPromise.resolve(a),a.initPresPromise=null):a.initPresPromiseReceived=!0:a.dbId&&!m.rooms[a.dbId]&&m.getServerRoom(a.dbId)),!0}catch(e){return t.error("[roomService] onRoomPresence error "+e),!0}},m.updateUserStatus=function(e,r,i){if(t.info("[roomService] "+r.status+" || "+i),s.isUserContactJid(r.contact.jid)&&r.status!==i)switch(t.info("[roomService] my new status "+i),i){case"deleted":delete m.roomsByJids[e.jid],delete m.rooms[e.dbId],t.info("[roomService] deleteRoom successfully ("+e.dbId+")"),m.sendUnavailableRoomPresence(e),m.computeInvitationCounter(),e.isMeetingRoom()&&n.$broadcast("MEETING_DELETE_EVENT",e),n.$broadcast(m.ROOM_UPDATE_EVENT,e,"remove");break;case"unsubscribed":t.info("[roomService] unsubscribed successfully ("+e.dbId+")"),m.sendUnavailableRoomPresence(e),e.status=m.RoomUserStatus.UNSUBSCRIBED,r.status=i,e.updateAvatarInfo(),e.isModerator=!1,m.computeInvitationCounter(),n.$broadcast(m.ROOM_UPDATE_EVENT,e);break;case"accepted":m.sendInitialRoomPresence(e),e.status=m.RoomUserStatus.ACCEPTED,r.status=i,e.updateAvatarInfo(),m.computeInvitationCounter(),n.$broadcast(m.ROOM_UPDATE_EVENT,e);break;case"rejected":delete m.roomsByJids[e.jid],delete m.rooms[e.dbId],e.status=m.RoomUserStatus.REJECTED,r.status=i,m.computeInvitationCounter(),n.$broadcast(m.ROOM_UPDATE_EVENT,e)}else r&&!s.isUserContactJid(r.contact.jid)&&(t.info("[roomService] Update user with status "+i),r.status===m.RoomUserStatus.DELETED&&i===m.RoomUserStatus.ACCEPTED&&(r.date=new Date,r.privilege===l.Privilege.MODERATOR&&(r.privilege=l.Privilege.USER)),r.status=i,e.updateAvatarInfo(),m.refreshMemberAndOrganizerLists(e),n.$broadcast(m.ROOM_UPDATE_EVENT,e))},m.findRoomWithConfId=function(e){return m.getRooms().filter(function(t){if(t.confEndpoints&&void 0!==t.confEndpoints[0])return t.confEndpoints[0].confEndpointId===e})},m.removeConfIdInAllRooms=function(t){var n=[];return t.forEach(function(e){e.confEndpoints&&e.confEndpoints.length>0&&n.push(m.deleteRoomConferenceEndPoint(e,e.confEndpoints[0].confEndpointId))}),e.all(n)},m.getCreationDate=function(e){return e.creationDate?moment(e.creationDate):moment()},m.sortByDate=function(e,t){var n=1;return e&&t&&(n=e.value-t.value),n}}]),function(){"use strict";angular.module("rainbow").service("groupService",["$q","$rootScope","$log","$http","authService","contactService","xmppService","Group","usersService","utilService",function(e,t,n,r,i,a,o,s,c,l){var u=this;this.started=!1,u.ON_REMOVE_GROUP_USER_EVENT="ON_REMOVE_GROUP_USER_EVENT",u.ON_ADD_GROUP_USER_EVENT="ON_ADD_GROUP_USER_EVENT",u.ON_GROUP_USERS_UPDATE_EVENT="ON_GROUP_USERS_UPDATE_EVENT",u.ON_CREATED_GROUP_EVENT="ON_CREATED_GROUP_EVENT",u.ON_UPDATE_GROUP_EVENT="ON_UPDATE_GROUP_EVENT",u.ON_REMOVED_GROUP_EVENT="ON_REMOVED_GROUP_EVENT",this.start=function(){n.info(""),n.info("[groupService] === STARTING ==="),u.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+i.userId+"/";var t=e.defer();return u.$q=e,u.groups=null,this.attachHandlers(),this.getGroups(),u.started=!0,n.info("[groupService] === STARTED ==="),t.resolve(),t.promise},this.stop=function(){return n.info("[groupService] === STOPPING ==="),u.conversations=null,u.groups=null,this.groupMessageHandlerRef&&(o.deleteHandler(this.groupMessageHandlerRef),this.groupMessageHandlerRef=null),this.started=!1,n.info("[groupService] === STOPPED ==="),e.when()},this.getGroups=function(){return u.groups?e.when(u.groups):u.getRemoteGroups()},u.getGroupsAsArray=function(){var e=[];for(var t in u.groups)u.groups.hasOwnProperty(t)&&e.push(u.groups[t]);return e},this.searchGroups=function(e){var t=e.toLowerCase().trim().split(/[ ]+/);return u.groups.filter(function(e){var n=e.name.toLowerCase().trim().split(/[ ]+/);return t.every(function(t){return n.some(function(r,i){return!(!r.length||0!==l.removeDiacritis(r).indexOf(l.removeDiacritis(t)))&&(n[i]="",e._displayName=l.removeDiacritis(e.name),!0)})})})},this.getRemoteGroups=function(){n.info("[groupService] getGroups");var t=e.defer();return r({method:"GET",url:u.portalURL+"groups?format=full",headers:i.getRequestHeader()}).then(function(t){var r=t.data.data;n.info("[groupService] getGroups success (find "+t.data.total+" group(s))"),u.groups=[];var i=[];return r.forEach(function(e){var t=s.createFromData(e);u.groups.push(t),angular.forEach(e.users,function(e){i=a.getContactByDBId(e).then(function(e){e&&t.users.push(e)})}),u.logGroupUsers(t),u.sortUsersInGroup(t)}),e.all(i)},function(e){var r="getGroups"+u.handleErrorMessage(e);t.reject(new Error(r)),n.error("[groupService] "+r)}).then(function(){t.resolve(u.groups)}),t.promise};this.getGroup=function(t){n.info("[groupService] getGroup  for "+t);var o=e.defer(),c=null;return r({method:"GET",url:u.portalURL+"groups/"+t,headers:i.getRequestHeader()}).then(function(t){var r=t.data.data,i=[];return c=s.createFromData(r),n.info("[groupService] getGroup success for "+c.name+" : "+c.id),u.groups.some(function(e,t){return e.id===r.id&&(u.groups[t]=r,!0)})||(u.groups.push(c),angular.forEach(r.users,function(e){i=a.getContactByDBId(e.id).then(function(e){if(e){c.users.push(e),u.sortUsersInGroup(c);var t=[c];e.getGroups()?e.getGroups().push(c):e.setGroups(t)}})})),e.all(i)},function(e){var t="getGroup"+u.handleErrorMessage(e);o.reject(new Error(t)),n.error("[groupService] "+t)}).then(function(){o.resolve(c)}),o.promise},this.addGroup=function(t){n.info("[groupService] addGroup : "+t.name);var a=e.defer();return r({method:"POST",url:u.portalURL+"groups",headers:i.getPostHeader(),data:{name:t.name,comment:t.comment,isFavorite:t.isFavorite}}).then(function(e){n.info("[groupService] addGroup success for : "+t.name);var r=e.data.data,i=s.createFromData(r);a.resolve(i)},function(e){var t="addGroup"+u.handleErrorMessage(e);a.reject(new Error(t)),n.error("[groupService] "+t)}),a.promise};var d=function(e){angular.forEach(u.groups,function(t,n){t.id===e&&u.groups.splice(n,1)})};this.removeGroup=function(t){n.info("[groupService] removeGroup : "+t);var a=e.defer();return r({method:"DELETE",url:u.portalURL+"groups/"+t,headers:i.getRequestHeader()}).then(function(){n.info("[groupService] removeGroup success for : "+t),d(t),a.resolve()},function(e){var t="removeGroup"+u.handleErrorMessage(e);a.reject(new Error(t)),n.error("[groupService] "+t)}),a.promise},this.updateGroup=function(t){n.info("[groupService] updateGroup for : "+t.name);var a=e.defer();return r({method:"PUT",url:u.portalURL+"groups/"+t.id,headers:i.getRequestHeader(),data:{name:t.name,comment:t.comment,isFavorite:t.isFavorite}}).then(function(){n.info("[groupService] updateGroup success for : "+t.name),a.resolve()},function(e){var t=u.handleErrorMessage(e,"updateGroup");a.reject(t),n.error("[groupService] "+t.message)}),a.promise},this.getGroupUsers=function(t){n.info("[groupService] getGroupUsers : "+t);var a=e.defer();return r({method:"GET",url:u.portalURL+"groups/"+t+"/users",headers:i.getRequestHeader()}).then(function(e){var r=e.data.data;n.info("[groupService] getGroupUsers success for "+t+" (find "+e.data.total+" users(s))"),a.resolve(r.users)},function(e){var t="getGroupUsers"+u.handleErrorMessage(e);a.reject(new Error(t)),n.error("[groupService] "+t)}),a.promise},this.addGroupUser=function(e,a){n.info("[groupService] addGroupUser");var o=u.$q.defer();return e.users.some(function(e){return a.dbId===e.dbId})?(n.info("[groupService] addGroupUser - user: "+a.id+" already exist in group: "+e.name+" - no remote action"),void o.resolve()):(r({method:"POST",url:u.portalURL+"groups/"+e.id+"/users/"+a.dbId,headers:i.getPostHeader()}).then(function(r){n.info("[groupService] addGroupUser success: "+a.id+"/"+e.name);var i=r.data.data,c=s.createFromData(i);t.$broadcast(u.ON_GROUP_USERS_UPDATE_EVENT),o.resolve(c)},function(e){var t="addGroupUser"+u.handleErrorMessage(e);o.reject(new Error(t)),n.error("[groupService] "+t)}),o.promise)};var f=function(e,t){angular.forEach(u.groups,function(n){n.id===e&&(angular.forEach(n.users,function(r,i){r.dbId===t&&(n.users.splice(i,1),r.getGroups()&&angular.forEach(r.getGroups(),function(t,n){t.id===e&&r.getGroups().splice(n,1)}))}),u.sortUsersInGroup(n))})};this.removeGroupUser=function(a,o){n.info("[groupService] removeGroupUser : "+a+"/"+o.id);var s=e.defer();return r({method:"DELETE",url:u.portalURL+"groups/"+a+"/users/"+o.dbId,headers:i.getRequestHeader()}).then(function(){n.info("[groupService] removeGroupUser success : "+a+"/"+o.id),f(a,o.dbId),t.$broadcast(u.ON_GROUP_USERS_UPDATE_EVENT),s.resolve(a)},function(e){var t="removeGroupUser"+u.handleErrorMessage(e);s.reject(new Error(t)),n.error("[groupService] "+t)}),s.promise},this.getUserGroups=function(t){if(!t)return n.info("[groupService] getUserGroups for unknown user !"),e.when();n.info("[groupService] getUserGroups for user : "+t.id);var a=e.defer(),o=t.getGroups();return o?e.when(o):(r({method:"GET",url:u.portalURL+"groups?userId="+t.dbId,headers:i.getRequestHeader()}).then(function(e){var r=e.data.data;n.info("[groupService] getUserGroups success (find "+e.data.total+" group(s))");var i=[];r.forEach(function(e){var t=s.createFromData(e);i.push(t)}),t.setGroups(i),u.logUserGroups(t.displayNameForLog(),i),a.resolve(i)},function(e){var t="getUserGroups"+u.handleErrorMessage(e);a.reject(new Error(t)),n.error("[groupService] "+t)}),a.promise)},this.getGroupFromName=function(t){n.info("[groupService] getGroupFromName : "+t);var r=e.defer();return this.getGroups().then(function(e){var n=null;e.forEach(function(e){e.name===t&&(n=e)}),r.resolve(n)}),r.promise},this.sortUsersInGroup=function(e){e&&(e.sortedUserList=c.getFilterAndOrderUsersGroupedByOrderLabelAndUpdateActivity(e.users,t.orderType,t.filterType,!0))},this.searchLocalGroup=function(e){var t=[];return n.info("[groupService] searchLocalGroup with text "+e),e&&u.groups.forEach(function(n){n.name.toLowerCase().indexOf(e.toLowerCase().toString())>=0&&t.push(n)}),t},this.extractStanzaData=function(t){var n=e.defer(),r={};return r.outgoingMessage=!1,r.body=angular.element(t)[0].firstChild,r.messageId=angular.element(t).attr("id"),n.resolve(r),n.promise},this.onGroupMessageReceived=function(e){try{return this.extractStanzaData(e).then(function(e){if(e.body&&"group"===e.body.tagName){var n=e.body.getAttribute("action"),r=e.body.getAttribute("scope"),i=e.body.getAttribute("id");switch(r){case"group":switch(n){case"create":u.getGroup(i),t.$broadcast(u.ON_CREATED_GROUP_EVENT,i);break;case"update":var o=e.body.getAttribute("name"),s=e.body.getAttribute("comment"),c="true"===e.body.getAttribute("isFavorite");t.$broadcast(u.ON_UPDATE_GROUP_EVENT,i,o,s,c);break;case"delete":d(i),t.$broadcast(u.ON_REMOVED_GROUP_EVENT,i)}break;case"user":var l=e.body.getAttribute("userId");switch(n){case"create":h=i,p=l,u.groups.some(function(e){return e.id===h&&!e.users.some(function(e){return p===e.dbId})&&(a.getContactByDBId(p).then(function(n){e.users.push(n),u.sortUsersInGroup(e);var r=[e];n.getGroups()?n.getGroups().push(e):n.setGroups(r),t.$broadcast(u.ON_ADD_GROUP_USER_EVENT,h,p)}),!0)})||t.$broadcast(u.ON_ADD_GROUP_USER_EVENT,h,p);break;case"delete":f(i,l),t.$broadcast(u.ON_REMOVE_GROUP_USER_EVENT,i,l)}}}var h,p}),!0}catch(e){return!0}},this.attachHandlers=function(){u.removeHandlers(),u.groupMessageHandlerRef||(u.groupMessageHandlerRef=o.addHandler(function(e){return u.onGroupMessageReceived(e)},null,"message","management"))},this.removeHandlers=function(){u.groupMessageHandlerRef&&(o.deleteHandler(u.groupMessageHandlerRef),u.groupMessageHandlerRef=null)},this.handleBadRequest=function(e,t){if(400===t.status&&t.data.errorDetails&&t.data.errorDetails.length>0){var n={};t.data.errorDetails.forEach(function(e){n[e.param]=e.msg});var r=new Error(e+" failure: BadRequest");return r.fieldErrors=n,r}return null},this.handleErrorMessage=function(e){var t=" failure: ";return 500===e.status&&(t+="Internal server error"),403===e.status?t+="Access is forbidden for the current user":404===e.status?t+=e.data.errorMsg:e.data&&e.data.errorDetails&&(t+=e.data.errorDetails),t},this.logUserGroups=function(e,t){var r="";t&&0!==t.length&&(t.forEach(function(e){e.name&&(r+=" "+e.name)}),n.info("[groupService] logUserGroups for "+e+":"+r))},this.logGroupUsers=function(e){var t;e&&e.users&&0!==e.users.length&&(t=e.users.map(function(e){return e.displayNameForLog()}).join(" / "),n.info("[groupService] logGroupUsers for "+e.name+": "+t))}}])}(),angular.module("rainbow").service("callLogService",["$q","$log","$rootScope","$interval","contactService","xmppService","CallLog","orderByFilter","profileService","$injector","telephonyService",function(e,t,n,r,i,a,o,s,c,l,u){"use strict";var d=this;this.started=!1,this.callLogs=[],this.orderByNameCallLogs=[],this.orderByDateCallLogs=[],this.orderByDateCallLogsBruts=[],this.simplifiedCallLogs=[],this.callLogsPromises=[],this.callLogNamespace="jabber:iq:telephony:call_log",this.callLogAckNamespace="urn:xmpp:telephony:call_log:receipts",this.callLogNotificationsNamespace="jabber:iq:notification:telephony:call_log",this.callLogHandlerRef=null,this.callLogMessageAckRef=null,this.callLogNotificationRef=null,this.numberMissedCalls=0,this.lastTimestamp=null,this.callLogsHistory=[],this.telephonyCallLog={},this.telephonyCallLogHistory={},this.deferedObject=null,this.callLogComplete=!1,this.callLogIndex=-1,this.start=function(n){return t.info(""),t.info("[callLogService] === STARTING ==="),this.attachHandlers(),r(function(){var e=performance.now();d.getCallLogHistoryPage().then(function(){var r=Math.round(performance.now()-e);n.push({service:"callLogService",startDuration:r}),t.info("[callLogService] === STARTED ("+r+" ms) ==="),d.started=!0}).catch(function(){t.error("[callLogService] === STARTING FAILURE ===")})},3e3,1,!0),e.when()},this.stop=function(){return t.info("[callLogService] Stopping"),this.started=!1,this.callLogs=[],this.callLogsPromises=[],this.callLogHandlerRef=null,this.callLogMessageAckRef=null,this.orderByNameCallLogs=[],this.orderByDateCallLogs=[],this.orderByDateCallLogsBruts=[],this.simplifiedCallLogs=[],this.numberMissedCalls=0,this.lastTimestamp=null,this.telephonyCallLog={},this.telephonyCallLogHistory={},this.callLogComplete=!1,this.callLogIndex=-1,this.callLogsHistory=[],t.info("[callLogService] Stopped"),e.when()},this.attachHandlers=function(){t.info("[callLogService] attachHandlers"),d.callLogHandlerRef&&(a.connection.deleteHandler(d.callLogHandlerRef),d.callLogHandlerRef=null),d.callLogMessageAckRef&&(a.connection.deleteHandler(d.callLogMessageAckRef),d.callLogMessageAckRef=null),d.callLogNotificationRef&&(a.connection.deleteHandler(d.callLogNotificationRef),d.callLogNotificationRef=null),d.callLogHandlerRef=a.connection.addHandler(d.onCallLogMessageReceived,d.callLogNamespace,null,null),d.callLogMessageAckRef=a.connection.addHandler(d.onCallLogAckReceived,d.callLogAckNamespace,null,null),d.callLogNotificationRef=a.connection.addHandler(d.callLogNotificationReceived,d.callLogNotificationsNamespace,null,null),d.started&&d.lastTimestamp&&r(function(){d.getCallLogHistoryPage(d.lastTimestamp)},1e3,1,!0)},this.getCallLogHistoryPage=function(n){t.info("[callLogService] getCallLogHistoryPage");var r=i.userContact,o=$iq({from:r.jid,type:"set"}).c("query",{xmlns:this.callLogNamespace});return o.c("set",{xmlns:"http://jabber.org/protocol/rsm"}),o.c("max").t(75).up(),n?o.c("after").t(n).up():o.c("before").t("").up(),o.up(),o.up(),a.sendIQ(o),e.when()},this.deleteOneCallLog=function(e){t.info("[callLogService] deleteOneCallLog "+e);var n=i.userContact,r=$iq({from:n.jid,to:n.jid,type:"set"}).c("delete",{xmlns:this.callLogNamespace,call_id:e});a.sendIQ(r)},this.deleteCallLogsForContact=function(e){t.info("[callLogService] deleteCallLogsForContact "+e);var n=i.userContact,r=$iq({from:n.jid,to:n.jid,type:"set"}).c("delete",{xmlns:this.callLogNamespace,peer:e});a.sendIQ(r)},this.deleteAllCallLogs=function(){t.info("[callLogService] deleteAllCallLogs");var e=i.userContact,n=$iq({from:e.jid,to:e.jid,type:"set"}).c("delete",{xmlns:this.callLogNamespace});a.sendIQ(n)},this.markCallLogAsRead=function(e){t.info("[callLogService] markCallLogAsRead "+e);var n=i.userContact,r=$msg({from:n.jid,to:n.jid}).c("read",{xmlns:this.callLogAckNamespace,call_id:e});a.sendIQ(r)},this.markAllCallsLogsAsRead=function(){t.info("[callLogService] markAllCallsLogsAsRead ");for(var e=i.userContact,n=0;n<d.callLogs.length;n++)if(!d.callLogs[n].read){var r=$msg({from:e.jid,to:e.jid}).c("read",{xmlns:this.callLogAckNamespace,call_id:d.callLogs[n].id});a.sendIQ(r)}},this.onCallLogMessageReceived=function(r){try{$(r).find("call_log").length>0?d.callLogsPromises.push(d.createCallLogFromMessage(r)):$(r).find("count").length>0&&$(r).find("query").length>0?(d.lastTimestamp=$(r).find("last").text(),e.all(d.callLogsPromises).finally(function(){t.info("[callLogService] onCallLogMessageReceived : all call logs are ready"),d.callLogsPromises=[],d.orderCallLogsFunction(),n.$broadcast("ON_CALL_LOG_UPDATED");var e=d.getMissedCallLogCounter();e!==d.numberMissedCalls&&(d.numberMissedCalls=e,n.$broadcast("ON_CALL_LOG_ACK_UPDATED"))})):t.info("[callLogService] onCallLogMessageReceived : ignored !")}catch(e){return t.error("[callLogService] onCallLogMessageReceived "+e),!0}return!0},this.onCallLogAckReceived=function(e){try{if(t.info("[callLogService] onCallLogAckReceived"),$(e).find("read").length>0){var r=$(e).find("read").attr("call_id");d.callLogAckUpdate(r);var i=d.getMissedCallLogCounter();i!==d.numberMissedCalls&&(d.numberMissedCalls=i,n.$broadcast("ON_CALL_LOG_ACK_UPDATED"))}}catch(e){return t.error("[callLogService] onCallLogAckReceived "+e),!0}return!0},this.callLogNotificationReceived=function(r){t.info("[callLogService] callLogNotificationReceived");try{if($(r).find("deleted_call_log").length>0){t.info("[callLogService] callLogNotificationReceived : deleted IQ");var i=$(r).find("deleted_call_log").attr("peer");i?d.removeCallLogsForUser(i):d.resetCallLogs()}else $(r).find("updated_call_log").length>0&&(t.info("[callLogService] callLogNotificationReceived : Update call-logs"),d.callLogsPromises.push(d.createCallLogFromMessage(r)),e.all(d.callLogsPromises).finally(function(){t.info("[callLogService] callLogNotificationReceived : update is done"),d.callLogsPromises=[],d.orderCallLogsFunction(),n.$broadcast("ON_CALL_LOG_UPDATED");var e=d.getMissedCallLogCounter();e!==d.numberMissedCalls&&(d.numberMissedCalls=e,n.$broadcast("ON_CALL_LOG_ACK_UPDATED"))}))}catch(e){return t.error("[callLogService] callLogNotificationReceived ERROR "+e),!0}return!0},this.removeCallLogsForUser=function(e){t.info("[callLogService] removeCallLogsForUser with jid: "+e);for(var r=[],i=0;i<d.callLogs.length;i++)(!d.callLogs[i].contact||d.callLogs[i].contact.jid!==e&&d.callLogs[i].contact.id!==e)&&r.push(d.callLogs[i]);d.callLogs=r,d.orderCallLogsFunction(),n.$broadcast("ON_CALL_LOG_UPDATED");var a=d.getMissedCallLogCounter();a!==d.numberMissedCalls&&(d.numberMissedCalls=a,n.$broadcast("ON_CALL_LOG_ACK_UPDATED"))},this.createCallLogFromMessage=function(n){var r=e.defer(),a=$(n),s=null,f=null,h="",p=a.find("call_id").text(),v=a.find("caller").text(),m=a.find("callee").text(),g=a.find("state").text(),E=parseInt(a.find("duration").text(),10),S="",C="",b="",R="webrtc";if(v&&-1!==v.indexOf("janusgateway")||m&&-1!==m.indexOf("janusgateway"))return t.info("[callLogService] createCallLogFromMessage ignore janusgateway call-logs"),void e.when();var y=a.find("call_log").attr("type");y||(y=a.find("type").text());var N="true"===a.find("ack").attr("read"),T=a.find("delay").attr("stamp"),A="conference"===a.find("call_log").attr("service");return(c.isFeatureEnabled(c.FeaturesEnum.TELEPHONY_PHONE_BOOK)||config.permitSearchFromPhoneBook)&&(S=a.find("identity")),E=E>0?moment.duration(E,"ms").format("h[H] mm[m] ss[s]"):0,T&&(T=new Date(T)),A?(s=v,R="conference",h=i.isUserContactJid(v)?"outgoing":"incoming",-1===s.indexOf("@")&&(f=s,s=null)):("phone"===y&&(R="telephone"),i.isUserContactJid(v)?(s=m,h="outgoing"):(s=v,h="incoming"),-1===s.indexOf("@")&&(f=s,s=null,R="telephone")),s||f?i.getOrCreateContact(s,f).then(function(e){if(t.info("[callLogService] createCallLogFromMessage success"),!A&&!s&&e.temp){if(S&&S.length){var n=S.attr("firstName"),i=S.attr("lastName"),a=S.attr("displayName");C=n||"",""===(b=i||"")&&""===C&&a&&0!==a.length&&a!==f&&(b=a),(C.length||b.length)&&(t.debug("[callLogService] createCallLogFromMessage  xNames updated from directories for contact "+e.id),e.updateName(C,b))}else try{var c=l.get("centralizedService");c.outlook.updateContactFromOutlookInfos(e,f,!0).then(function(n){n?t.debug("[callLogService] createCallLogFromMessage  xNames updated from outlook for contact "+e.id):t.debug("[callLogService] createCallLogFromMessage no update from outlook for contact :"+e.id)},function(){t.debug("[callLogService] createCallLogFromMessage  no Outlook search available")})}catch(e){}var v=!1;if(u.started)v=e.displayName.match(/^[0-9A-D #\-\+\*\(\)\./]{1,32}$/)&&u.startAsPhoneNumber(e.displayName);v&&e.phoneProCan&&""!==e.phoneProCan&&(e.displayName=e.phoneProCan)}var m=o.create(p,e,g,E,R,N,T,h);d.logAlreadyExists(m)||"failed"===g||"ongoing"===g?t.info("[callLogService] createCallLogFromMessage ignore call log with id: "+p+", state: "+g):d.callLogs.push(m),r.resolve(m)}).catch(function(e){t.error("[callLogService] createCallLogFromMessage error "+e),r.resolve()}):(t.info("[callLogService] createCallLogFromMessage  No jid or no phoneNumber "),r.resolve()),r.promise},this.getOrderByNameCallLogs=function(){return d.orderByNameCallLogs},this.getOrderByDateCallLogs=function(){return d.orderByDateCallLogs},this.getOrderByDateCallLogsBruts=function(){return d.orderByDateCallLogsBruts},this.getSimplifiedCallLogs=function(){return d.simplifiedCallLogs},this.orderCallLogsFunction=function(){t.info("[callLogService] orderByFunction"),d.orderByNameCallLogs=s(d.callLogs,o.getNames,!1,o.sortByContact),d.orderByDateCallLogsBruts=s(d.callLogs,o.getDate,!1,o.sortByDate),d.simplifiedCallLogs=d.simplifyCallLogs(d.orderByDateCallLogsBruts),d.orderByNameCallLogs=d.fusionInformation(d.orderByNameCallLogs),d.orderByDateCallLogs=d.fusionInformation(d.orderByDateCallLogsBruts)},this.simplifyCallLogs=function(e){for(var t=[],n=0;n<e.length;n++)t[n]={},t[n].contact=e[n].contact.id,t[n].contactDisplayName=e[n].contact.displayName,t[n].contactInitials=e[n].contact.initials,t[n].id=e[n].id,t[n].state=e[n].state,t[n].duration=e[n].duration,t[n].direction=e[n].direction,t[n].type=e[n].type,t[n].read=e[n].read,t[n].date=e[n].date;return t},this.fusionInformation=function(e){for(var t={},n=0,r=[],i=0;i<e.length;i++){var a=e[i],o=a.contact.jid;if(a.contact.jid||(o=a.contact.id),"conference"!==a.type)if(0!==i)if(t[o]){var s=r[t[o]-1];s.editable&&(s.isMissed&&"missed"===a.state&&"incoming"===a.direction?s.count++:s.isNotAnswered&&"missed"===a.state&&"outgoing"===a.direction?s.count++:s.editable=!1)}else n++,t[o]=n+1,r[n]=a,r[n].count=1,r[n].editable=!0,"missed"===a.state&&"incoming"===a.direction?r[n].isMissed=!0:"missed"===a.state&&"outgoing"===a.direction&&(r[n].isNotAnswered=!0);else t[o]=1,r[n]=a,r[n].count=1,r[n].editable=!0,"missed"===a.state&&"incoming"===a.direction?r[n].isMissed=!0:"missed"===a.state&&"outgoing"===a.direction&&(r[n].isNotAnswered=!0);else 0!==i&&n++,r[n]=a,r[n].count=1,r[n].editable=!1}return r},this.callLogAckUpdate=function(e){d.callLogs.forEach(function(t){t.id!==e||(t.read=!0)})},this.getMissedCallLogCounter=function(){var e=0;return d.callLogs.forEach(function(t){t.read||"missed"!==t.state||"incoming"!==t.direction||e++}),e},this.getNumberMissedCalls=function(){return d.numberMissedCalls},this.resetCallLogs=function(){t.info("[callLogService] resetCallLogs"),d.callLogs=[],d.getCallLogHistoryPage()},this.logAlreadyExists=function(e){var t;for(t=0;t<d.callLogs.length;t++)if(d.callLogs[t].id===e.id)return!0;return!1}}]),angular.module("rainbow").service("videoService",["$q","$rootScope","$window","$log","$http","$interval","xmppService","contactService","Call","browserService","gRTCStatsService","fRTCStatsService","platformService","gaService","settingsService","authService","VideoServiceEventHandler","extensionSharingService",function(e,t,n,r,i,a,o,s,c,l,u,d,f,h,p,v,m,g){"use strict";var E=this;this.started=!1,this.connected=!1,this.RTC=null,this.videoEventHandler=null,this.config=null,this.calls={},this.localStream=null,this.autoreleaseTimeout=null,this.callsStats=[],this.localStreams=[],this.makingCall=!1,this.reconnectCall=!1,this.statsInterval=null,this.audioProfileChanging=!1,this.reverseAudioCallInitiated=!1,this.alreadyAttaching=!1;var S=[];this.nameSpace="urn:xmpp:jingle-message:0",this.messageHandlerRef=null,this.allowDesktopSharing=function(){return!1},this.allowAdvancedDesktopSharing=function(){return!1},this.getDesktopSharingSource=function(){return null},this.askToAddSharing=function(e){return!1},this.askToStartSharing=function(e,t){return!1},this.start=function(n){r.webrtc("[videoService] SERVICE | === STARTING ===");var i=performance.now();if(this.RTC=E.getBrowserMethodHandler(),this.RTC){E.started=!0,E.connected=!0,E.setWebrtcConfiguration();var a=Math.round(performance.now()-i);n.push({service:"videoService",startDuration:a}),r.info("[videoService] SERVICE | === STARTED ("+a+" ms) ===")}else r.error("[videoService] SERVICE | === STARTING FAILURE ===  webRTC capable browser is really required !");return S.push(t.$on("ON_CONNECTION_STATE_CHANGE_EVENT",E.onConnectionStateChangeEvent)),S.push(t.$on("ON_INPUT_DEVICE_CHANGED_EVENT",E.onAudioProfileChangeEvent)),S.push(t.$on("ON_VIDEO_INPUT_DEVICE_CHANGED_EVENT",E.onVideoInputChangeEvent)),this.attachHandlers(),e.when()},this.stop=function(){try{if(this.started){var t;for(r.webrtc("[videoService] SERVICE | === STOPPING ==="),this.started=!1;t=S.pop();)t();E.removeHandlers(),E.config=null;for(var n in E.calls)if(E.calls.hasOwnProperty(n)){var i=E.calls[n];E.removeCallObject(i)}o.connection.jingle.terminate(),E.connected=!1,E.reconnectCall=!1,E.statsInterval&&a.cancel(E.statsInterval),r.webrtc("SERVICE | === STOPPED ===")}return e.when()}catch(t){return r.webrtc("[videoService] SERVICE | === STOPPING ERROR : "+t),e.when()}},this.attachHandlers=function(){this.removeHandlers(),r.info("[videoService] attachHandlers"),this.videoEventHandler=m.create(this),this.messageHandlerRef||(this.messageHandlerRef=o.addHandler(function(e){return E.videoEventHandler.onMessageReceived(e),!0},E.nameSpace,"message"))},this.removeHandlers=function(){r.info("[videoService] removeHandlers"),this.videoEventHandler&&(this.videoEventHandler=null),this.messageHandlerRef&&(o.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null)},this.setWebrtcConfiguration=function(){return r.webrtc("[videoService] setWebrtcConfiguration"),e(function(e,t){E.config?(r.webrtc("[videoService] setWebrtcConfiguration from stored variable"),o.connection.jingle.ice_config=E.config,e()):(r.webrtc("[videoService] setWebrtcConfiguration from server"),E.getIceConfig().then(function(t){E.config=t,r.info("Max-bundle enabled"),o.connection.jingle.ice_config=E.config,p.setIceConfig(E.config),r.webrtc("[videoService] setWebrtcConfiguration from server success !"),e()}).catch(function(e){r.error("[videoService] setWebrtcConfiguration from server ERROR : "+e),E.openErrorPopup("IceConfigurationFailed"),t()}))})},this.onConnectionStateChangeEvent=function(e,n){try{if("disconnected"===n){r.info("MEDIA   | onConnectionStateChangeEvent : disconnected"),E.connected=!1;for(var i in E.calls)if(E.calls.hasOwnProperty(i)){var l=E.calls[i];E.reconnectCall=!0,l&&l.status!==c.Status.UNKNOWN&&(r.webrtc("INFO    | onConnectionStateChangeEvent : disconnected -> call goes to connecting state"),l.setStatus(c.Status.CONNECTING),t.$broadcast("ON_CALL_UPDATED_EVENT",l)),E.statsInterval&&a.cancel(E.statsInterval)}}else if("connected"===n){r.info("MEDIA   | onConnectionStateChangeEvent : connected"),E.attachHandlers(),E.setWebrtcConfiguration(),E.connected=!0,E.statsInterval&&(a.cancel(E.statsInterval),E.statsinterval=null);for(var i in E.calls)if(E.calls.hasOwnProperty(i)){l=E.calls[i];var u=o.connection.jingle.sessions[l.id];E.reconnectCall&&u&&u.peerconnection&&(r.info("MEDIA   | onConnectionStateChangeEvent : connected - start reconnection on session "+l.id),u.me=s.userContact.fullJid,u.isInitiator&&(u.initiator=u.me),u.connection=o.connection,s.setBusyState("dnd",E.calculatePresenceMessage(l)),u.sendTransportReplace())}E.reconnectCall=!1}}catch(e){r.info("MEDIA   | onConnectionStateChangeEvent : disconnected error : "+e)}},E.isUserContactInCall=function(){var e=!1;for(var t in E.calls){if(E.calls.hasOwnProperty(t))E.calls[t].status!==c.Status.UNKNOWN&&(e=!0)}return e},E.endAllCallsForContact=function(e){if(e){r.webrtc("[videoService] endAllCallsForContact "+e.jid);for(var t in E.calls)if(E.calls.hasOwnProperty(t)){var n=E.calls[t];n.status!==c.Status.UNKNOWN&&n.contact&&n.contact.jid===e.jid&&E.releaseCall(n)}}},E.onVideoInputChangeEvent=function(){r.webrtc("MEDIA   | onVideoInputChangeEvent");for(var e in E.calls)if(E.calls.hasOwnProperty(e)){var t=E.calls[e];o.connection.jingle.sessions[t.id]&&t.localMedia&&t.localMedia===c.Media.AUDIO+c.Media.VIDEO&&(r.webrtc("MEDIA   | audio + video call, renegotiate the profile"),E.escalateToVideoCall(t,!0))}},E.onAudioProfileChangeEvent=function(){if(r.webrtc("MEDIA   | onAudioProfileChangeEvent"),E.audioProfileChanging)r.webrtc("MEDIA   | onAudioProfileChangeEvent -- already changing");else for(var e in E.calls)if(E.calls.hasOwnProperty(e)){var t=E.calls[e];o.connection.jingle.sessions[t.id]&&t.localMedia&&(E.audioProfileChanging=!0,a(function(e){E.audioProfileChanging=!1,e.localMedia===c.Media.AUDIO||e.localMedia===c.Media.AUDIO+c.Media.SHARING?(r.webrtc("MEDIA   | renegotiate the audio profile"),E.addAudioToCall(e,!0)):e.localMedia!==c.Media.AUDIO+c.Media.VIDEO&&e.localMedia!==c.Media.AUDIO+c.Media.SHARING+c.Media.VIDEO||(r.webrtc("MEDIA   | audio + video call, renegotiate the profile"),E.addVideoToCall(e,!0))},500,1,!0,t))}},this.getCallByJid=function(e){var t=null;if(!e)return t;r.webrtc("[videoService] getCallByJid "+e);for(var n in E.calls)if(E.calls.hasOwnProperty(n)){var i=E.calls[n];if(i.contact&&i.contact.jid===e){t=i;break}}return t},this.disableAudioVideoMedia=function(e){if(e?r.webrtc("MEDIA   | disableAudioVideoMedia for "+JSON.stringify({sid:e.sid})):r.webrtc("MEDIA   | disableAudioVideoMedia"),E.localStreams.length>0)for(E.localStreams.forEach(function(e){e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null});E.localStreams.length>0;){E.localStreams.pop();null}if(e&&e.localStreams.length>0)for(e.localStreams.forEach(function(e){e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null});e.localStreams.length>0;){e.localStreams.pop();null}E.statsInterval&&(a.cancel(E.statsInterval),E.statsinterval=null)},this.attachDistantMediaStreams=function(e,t){if(e){if(E.alreadyAttaching)return;E.alreadyAttaching=!0;var n=o.connection.jingle.sessions[t.id];if(n.remoteStreams){var i,a;if(n.remoteStreams.length>1)n.remoteStreams[0].getAudioTracks().length?(a=n.remoteStreams[0],i=n.remoteStreams[1]):(i=n.remoteStreams[0],a=n.remoteStreams[1]),i.getVideoTracks().length>0&&(r.webrtc("attachDistantMediaStreams video track for element largevideo "+i.id),E.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),i,i.id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0)),i.getAudioTracks().length>0&&(r.webrtc("attachDistantMediaStreams audio track for element globalAudioTag "+i.id),E.RTC.attachMediaStream(angular.element("#globalAudioTag"),i)),a.getVideoTracks().length>0&&(r.webrtc("attachDistantMediaStreams video track for element p2pSecondVideo "+a.id),E.RTC.attachMediaStreamIfNeeded(angular.element("#p2pSecondVideo"),a,a.id),angular.element("#p2pSecondVideo")[0]&&(angular.element("#p2pSecondVideo")[0].muted=!0,angular.element("#p2pSecondVideo")[0].volume=0)),a.getAudioTracks().length>0&&(r.webrtc("attachDistantMediaStreams audio track for element globalAudioTag "+a.id),E.RTC.attachMediaStream(angular.element("#globalAudioTag"),a));else n.remoteStreams.forEach(function(e){e.getVideoTracks().length>0&&(r.webrtc("attachDistantMediaStreams video track"),E.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),e,e.id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0),E.RTC.attachMediaStreamIfNeeded(angular.element("#p2pSecondVideo"),e,e.id),angular.element("#p2pSecondVideo")[0]&&(angular.element("#p2pSecondVideo")[0].muted=!0,angular.element("#p2pSecondVideo")[0].volume=0)),e.getAudioTracks().length>0&&(r.webrtc("attachDistantMediaStreams audio track"),E.RTC.attachMediaStream(angular.element("#globalAudioTag"),e))});E.alreadyAttaching=!1}}else E.isUserContactInCall()||(this.RTC.clearMediaStream(angular.element("#largevideo"),null),this.RTC.clearMediaStream(angular.element("#globalVideoTag"),null),this.RTC.attachMediaStream(angular.element("#globalAudioTag"),null))},this.attachLocalMediaStreams=function(e){r.webrtc("attachLocalMediaStreams "+e),e?(this.localStreams&&this.localStreams.length&&this.localStreams.forEach(function(e){e.getVideoTracks().length&&e.getAudioTracks().length?(E.RTC.attachMediaStream($("#minivideo"),e),E.RTC.attachMediaStream($("#callVideoPip"),e)):e.getVideoTracks().length&&E.RTC.attachMediaStream($("#callSharingPip"),e)}),$("#callVideoPip")[0]&&($("#callVideoPip")[0].volume=0),$("#minivideo")[0]&&($("#minivideo")[0].volume=0),$("#callSharingPip")[0]&&($("#callSharingPip")[0].volume=0)):(this.RTC.clearMediaStream($("#minivideo"),null),this.RTC.clearMediaStream($("#callVideoPip"),null),this.RTC.clearMediaStream($("#callSharingPip"),null))},this.openErrorPopup=function(e){e||(e="cameraNotAvailable"),t.$broadcast("ON_WEBRTC_CALL_ERROR_EVENT",e)},this.makeVideoCall=function(e){E.makeCall(e,"videoOnly")},this.makeCall=function(e,t){r.webrtc("MEDIA   | makeCall to "+JSON.stringify({displayName:e.displayNameForLog(),resources:e.resources})),E.makingCall?r.info("MEDIA   | makeCall already making a call !"):(E.makingCall=!0,this.videoEventHandler.sendProposition(e,t))},this.makeJingleCall=function(e){r.webrtc("MEDIA   | makeJingleCall"),E.setWebrtcConfiguration().then(function(){var n="";e.localMedia&c.Media.AUDIO&&(n="audio"),e.localMedia&c.Media.VIDEO&&(n=n?"audio+video":"video"),o.connection.jingle.initiate(e.fullJid,o.connection.jid,n,E.localStreams,e.id),e.status=c.Status.CONNECTING,t.$broadcast("ON_CALL_UPDATED_EVENT",e)}).catch(function(t){r.webrtc("MEDIA   | makeCall failure : "+JSON.stringify({error:t.message})),E.makingCall=!1,e&&E.removeCallObject(e),E.resetToSafeState()})},this.makeJingleSharingCall=function(e){r.webrtc("MEDIA   | makeJingleSharingCall - make desktop sharing call");var n="sharing";e.localMedia===c.Media.SHARING&&(n="sharing-only"),E.setWebrtcConfiguration().then(function(){r.webrtc("SHARING | getUserMedia success"),o.connection.jingle.initiate(e.fullJid,o.connection.jid,n,E.localStreams,e.id),e.status=c.Status.CONNECTING,t.$broadcast("ON_CALL_UPDATED_EVENT",e)}).catch(function(t){E.makingCall=!1,e&&E.removeCallObject(e),E.resetToSafeState(),r.webrtc("MEDIA   | makeJingleSharingCall failure : "+JSON.stringify({error:t.message}))})},this.startDesktopSharing=function(e,t){E.makingCall?r.info("MEDIA   | startDesktopSharing already making a call !"):(E.makingCall=!0,!E.askToStartSharing(e.jid,t)&&E.makeDesktopSharingCall(e,t))},this.startSharingCancelled=function(){E.makingCall=!1},this.makeDesktopSharingCall=function(e,t){t||(t="sharing"),r.webrtc("MEDIA   | makeDesktopSharingCall - trying to start a desktop sharing call with media "+t),this.videoEventHandler.sendProposition(e,t)},this.answerJingleCall=function(e){r.webrtc("MEDIA   | answerJingleCall "+e.id);var n=[],i="audio";e.localMedia&c.Media.AUDIO&&n.push("audio"),e.localMedia&c.Media.VIDEO&&(n.push("video"),i="audio+video"),e.localMedia===c.Media.VIDEO&&(i="video");var a={};e.isInConversationWithMobile()&&(a=E.getMobileMediaConstraints("video")),E.setWebrtcConfiguration().then(function(){E.getBrowserMedia(n,a.fixedVideoWidth,a.fixedVideoHeight,a.fixedFrameRate).then(function(n){var r=o.connection.jingle.sessions[e.id];n?(E.localStreams.push(n),r.addStream(E.localStreams[0]),r.localStreams.push(E.localStreams[0])):i=null,r.localType=i,r.sendAnswer(),r.accept(),t.$broadcast("ON_CALL_UPDATED_EVENT",e)}).catch(function(t){r.webrtc("MEDIA   | answerJingleCall failure for : "+e+" failure : "+t.message),-1!==t.toString().indexOf("getUserMedia")&&(E.releaseCall(e),E.openErrorPopup()),E.resetToSafeState()})})},this.answerCall=function(e,t){this.videoEventHandler.acceptProposition(e,t)},this.rejectCall=function(e,t){e?(E.makingCall=!1,E.autoreleaseTimeout&&a.cancel(E.autoreleaseTimeout),o.connection.jingle.sessions[e.id]?E.releaseCall(e):e.isInitiator?this.videoEventHandler.retractProposition(e):this.videoEventHandler.rejectProposition(e)):r.webrtc("MEDIA   | rejectCall - trying to rejectCall a non existing call !")},this.releaseCall=function(e,t,n){e?(E.makingCall=!1,this.execute("releaseCall",function(){r.webrtc("MEDIA   | releaseCall : "+e);try{var i=o.connection.jingle.sessions[e.id];E.disableAudioVideoMedia(i),s.resetBusyState(),E.autoreleaseTimeout&&a.cancel(E.autoreleaseTimeout),E.callsStats[e.id]&&(r.webrtc("STATS | "+JSON.stringify(E.callsStats[e.id])),delete E.callsStats[e.id]),E.removeCallObject(e,t,n),E.displayWebRTCStats(e.id)}catch(t){r.webrtc("MEDIA   | releaseCall ERROR"),r.error(t),E.callsStats[e.id]&&(r.webrtc("STATS | "+JSON.stringify(E.callsStats[e.id])),delete E.callsStats[e.id]),E.resetToSafeState(),E.displayWebRTCStats(e.id),E.removeCallObject(e)}})):r.webrtc("MEDIA   | releaseCall - trying to release a non existing call !")},this.askToAddDesktopSharing=function(e){r.webrtc("MEDIA   | askToAddDesktopSharing - Desktop sharing escalation"),!E.askToAddSharing(e.id)&&E.addSharingToCall(e.videoCall)},this.addAudioToCall=function(e,t){r.webrtc("MEDIA   | addAudioToCall");var n=o.connection.jingle.sessions[e.id];n.isRenegotiating=!0;this.getBrowserMedia(["audio"]).then(function(r){E.stopActiveAudioVideoStreams(n),E.localStreams.push(r);for(var i=0;i<E.localStreams.length;i++)n.localStreams.push(E.localStreams[i]);var a=t?"contentModify":"contentAdd";E.updateCurrentCall(e,n,"audio",a)}).catch(function(t){r.webrtc("MEDIA   | addAudioToCall failure : "+t),E.releaseCall(e),E.resetToSafeState()})},this.addSharingToCall=function(e){r.webrtc("MEDIA   | addSharingToCall - Desktop sharing escalation");var t=o.connection.jingle.sessions[e.id];t.isRenegotiating=!0;var n={};e.isInConversationWithMobile()&&(n=E.getMobileMediaConstraints("sharing")),this.getBrowserMedia(["sharing"],null,null,n.fixedFrameRate).then(function(n){for(var r=0;r<E.localStreams.length;r++)t.removeStream(E.localStreams[r]),t.localStreams[r]=null;t.localStreams=[],E.localStreams.push(n);for(r=0;r<E.localStreams.length;r++)t.localStreams.push(E.localStreams[r]);E.updateCurrentCall(e,t,"sharing","contentAdd")}).catch(function(e){r.webrtc("MEDIA   | addSharingToCall failure : "+e),t.isRenegotiating=!1,-1!==e.toString().indexOf("getUserMedia")&&E.openErrorPopup()})},this.addVideoToCall=function(e,t){r.webrtc("MEDIA   | addVideoToCall");var n=o.connection.jingle.sessions[e.id];n.isRenegotiating=!0;var i={};e.isInConversationWithMobile()&&(i=E.getMobileMediaConstraints("video")),E.getBrowserMedia(["audio","video"],i.fixedVideoWidth,i.fixedVideoHeight,i.fixedFrameRate).then(function(r){E.stopActiveAudioVideoStreams(n),E.localStreams.push(r);for(var i=0;i<E.localStreams.length;i++)n.localStreams.push(E.localStreams[i]);var a=t?"contentModify":"contentAdd";E.updateCurrentCall(e,n,"video",a)}).catch(function(t){r.webrtc("MEDIA   | addVideoToCall failure for : "+e+" failure : "+t.message),-1!==t.toString().indexOf("getUserMedia")?(r.info("addVideoToCall impossible, no webcam plugged"),E.openErrorPopup()):(E.releaseCall(e),E.resetToSafeState())})},this.removeSharingFromCall=function(e){r.webrtc("MEDIA   | removeSharingFromCall");var t=o.connection.jingle.sessions[e.id];this.stopAllActiveStreams(t);var n=["audio"];e.localMedia&c.Media.VIDEO&&n.push("video"),t.isRenegotiating=!0,E.getBrowserMedia(n).then(function(n){E.localStreams.push(n);for(var r=0;r<E.localStreams.length;r++)t.localStreams.push(E.localStreams[r]);E.updateCurrentCall(e,t,"sharing","contentRemove")}).catch(function(t){r.webrtc("MEDIA   | removeSharingFromCall failure for : "+e+" failure : "+t.message),-1!==t.toString().indexOf("getUserMedia")&&E.openErrorPopup(),E.releaseCall(e),E.resetToSafeState()})},this.removeVideoFromCall=function(e){r.webrtc("MEDIA   | removeVideoFromCall"),this.reverseAudioCallInitiated=!0;var t=o.connection.jingle.sessions[e.id];this.stopActiveAudioVideoStreams(t);t.isRenegotiating=!0,E.getBrowserMedia(["audio"]).then(function(n){E.localStreams.push(n);for(var r=0;r<E.localStreams.length;r++)t.localStreams.push(E.localStreams[r]);E.updateCurrentCall(e,t,"video","contentRemove")}).catch(function(t){r.webrtc("MEDIA   | reverseToAudioCall failure for : "+e+" failure : "+t.message),-1!==t.toString().indexOf("getUserMedia")&&E.openErrorPopup(),E.releaseCall(e),E.resetToSafeState()})},this.calculatePresenceMessage=function(e){var t="audio";return e&&e.localMedia&c.Media.VIDEO&&(t="video"),e&&e.remoteMedia&c.Media.VIDEO&&(t="video"),e&&e.localMedia&c.Media.SHARING&&(t="sharing"),e&&e.remoteMedia&c.Media.SHARING&&(t="sharing"),t},this.calculateAudioState=function(e){var t=0;return e.availableIncomingAudioBandwidth&&(t=e.availableIncomingAudioBandwidth<15&&e.availableIncomingAudioBandwidth>0?1:e.availableIncomingAudioBandwidth>=15&&e.availableIncomingAudioBandwidth<30?2:3),t},this.calculateVideoState=function(e){var t=0;return e.availableIncomingVideoBandwidth&&(t=e.availableIncomingVideoBandwidth<300?1:e.availableIncomingVideoBandwidth>=300&&e.availableIncomingVideoBandwidth<500?2:3),t},this.execute=function(e,t,n){this.started?t(n):r.webrtc("MEDIA   | "+e+" failure : videoService is not started")},this.getOrCreateCallByCallId=function(e){var t=E.calls[e];if(!t){var n=o.connection.jingle.sessions[e],r=o.getBareJidFromJid(n.peerjid),i=s.getContactByJid(r);t=c.create(c.Status.UNKNOWN,e,c.Type.WEBRTC,i),E.calls[t.id]=t}return t},this.getCallByContact=function(e){for(var t in this.calls)if(this.calls.hasOwnProperty(t)){var n=E.calls[t];if(n.contact&&e.jid===n.contact.jid)return n}return null},this.removeCallObject=function(e,n,i){try{if(e){if(e.status=c.Status.UNKNOWN,E.localStreams.length>0)for(E.localStreams.forEach(function(e){e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null});E.localStreams.length>0;){E.localStreams.pop();null}if(delete E.calls[e.id],t.$broadcast("ON_CALL_UPDATED_EVENT",e),o.connection.jingle.sessions&&o.connection.jingle.sessions[e.id]){var s=o.connection.jingle.sessions[e.id];if(s&&s.localStreams.length)for(s.localStreams.forEach(function(e){e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null});s.localStreams.length>0;){s.localStreams.pop();null}o.connection.jingle.terminate(e.id,n,i),E.statsInterval&&(a.cancel(E.statsInterval),E.statsinterval=null)}}}catch(e){r.error("removeCallObject error "+e)}},this.updateRemoteTypeMedia=function(e,t){switch(e){case"audio":t.remoteMedia=c.Media.AUDIO;break;case"video":t.remoteMedia=c.Media.VIDEO;break;case"audio+video":t.remoteMedia=c.Media.AUDIO|c.Media.VIDEO;break;case"sharing":t.remoteMedia=c.Media.SHARING|c.Media.AUDIO;break;case"sharing-only":t.remoteMedia=c.Media.SHARING;break;default:t.remoteMedia=null}r.debug("REMOTE TYPE || REMOTE MEDIA  "+t.remoteMedia)},this.checkStreamAndStatus=function(e,t){return e&&(0===e.getAudioTracks().length&&0===e.getVideoTracks().length||!1===e.active)?(E.openErrorPopup(),!1):!(t.capabilities&&!t.capabilities.webRTC)||(r.webrtc("MEDIA   | initSharedDesktop failure : remote contact is no more available"),e.stop&&e.stop(),E.openErrorPopup("remoteUserNoMoreAvailable"),!1)},this.displayWebRTCStats=function(e){try{var t=null,n=0;if(u.hasStatsForCall(e)){if(r.webrtc("STATS   | Bundle policy used: "+u.getBundlePolicyForCall(e)),0===(t=u.getStreamsDetailsFromCall(e)).length)r.webrtc("STATS   | No channel information available for call "+e);else for(n=0;n<t.length;n++)r.webrtc("STATS   | "+t[n].id+": "+JSON.stringify(t[n].streams));var i=u.getCodecDetailsFromCall(e);r.webrtc("STATS   | codecs used: "+JSON.stringify(i)),h.trackCodecsUsed(i.codec.audio,i.codec.video)}else if(d.hasStatsForCall(e))if(r.webrtc("STATS   | Bundle policy used: "+d.getBundlePolicyForCall(e)),0===(t=d.getStreamsDetailsFromCall(e)).length)r.webrtc("STATS   | No channel information available for call "+e);else for(n=0;n<t.length;n++)r.webrtc("STATS   | "+t[n].id+": "+JSON.stringify(t[n].streams))}catch(e){r.error("[videoService] displayWebRTCStats error : "+e)}},this.muteAudio=function(e,n){var i=e.videoCall;if(i){r.webrtc("MEDIA   | mute audio: "+i+" | state: "+n),e.isMutedAudio=n;var a=o.connection.jingle.sessions[i.id];a?(a.muteAudio(n),t.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{conversation:e,call:i})):r.webrtc("MEDIA   | muteAudio - trying to mute a non existing session !")}else r.webrtc("MEDIA   | muteAudio - trying to mute a non existing call !")},this.muteVideo=function(e,n){var i=e.videoCall;if(i){r.webrtc("MEDIA   | muteVideo: "+i);var a=o.connection.jingle.sessions[i.id];a&&(a.muteVideo(n),a.sendMute(n)),t.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{conversation:e,call:i})}else r.webrtc("MEDIA   | muteVideo - trying to mute a non existing call !")},this.stopAllActiveStreams=function(e){this.stopActiveAudioVideoStreams(e,!0)},this.stopActiveAudioVideoStreams=function(e,t){if(E.localStreams.length>0)if(E.localStreams.forEach(function(e){(e.getAudioTracks().length||t)&&(e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop(),e=null)}),t)for(;E.localStreams.length;){E.localStreams.pop();null}else for(var n=0;n<E.localStreams.length;n++)if(E.localStreams[n]&&E.localStreams[n].getAudioTracks().length){E.localStreams.splice(n,1);null}if(e&&e.localStreams){if(e.localStreams.forEach(function(e){(e.getAudioTracks().length||t)&&(e.getTracks().forEach(function(e){e.enabled=!1,e.stop(),e=null}),e.stop&&e.stop())}),t)for(;e.localStreams.length;){e.localStreams.pop();null}e.localStreams=[]}e&&o.connection.jingle.localStream&&e.removeStream(o.connection.jingle.localStream)},this.resetToSafeState=function(){r.webrtc("MEDIA   | resetToSafeState"),E.autoreleaseTimeout&&a.cancel(E.autoreleaseTimeout),(E.localStream||E.localStreams.length)&&E.disableAudioVideoMedia(),s.resetBusyState()},this.vidRes={1080:[1920,1080],720:[1280,720],360:[640,360],180:[320,180],960:[960,720],640:[640,480],320:[320,240]},this.getMobileMediaConstraints=function(e){var t={};return"sharing"===e?t.fixedFrameRate=3:"video"===e&&(t.fixedFrameRate=20,t.fixedVideoWidth=640,t.fixedVideoHeight=480),t},this.minFirefoxWebRTCVersion=45,this.minChromeWebRTCVersion=42,this.minEdgeWebRTCVersion=25,this.firefoxPreferedSharing="screen",this.getBrowserMedia=function(n,i,a,o){return n&&0!==n.length?new Promise(function(s,c){var l=e.defer(),u={audio:!1,video:!1},d=i||1280,p=a||720,v=[];if(f.allowDevicesManagement()){if(n.indexOf("audio")>=0){var m=e.defer();f.getCurrentMicrophone().then(function(e){u.audio=!e||{optional:[{sourceId:e.id}]},m.resolve(u);var t="default";e&&(t="id - "+e.id+" and label "+e.label),r.info("[VideoService] GetUserMedia for microphone "+t)}),v.push(m.promise)}if(n.indexOf("video")>=0){var S=o||30,C=e.defer();f.getCurrentCamera().then(function(e){e&&"default"!==e.id?u.video={width:d,height:p,frameRate:S,deviceId:{exact:e.id}}:u.video={width:d,height:p,frameRate:S},C.resolve(u);var t="default";e&&(t="id - "+e.id+" and label "+e.label),r.info("[VideoService] GetUserMedia for camera "+t)}),v.push(C.promise)}}else n.indexOf("audio")>=0&&(u.audio=!0),n.indexOf("video")>=0&&(u.video={width:d,height:p});if(n.indexOf("sharing")>=0){S=o||5;if(g.extensionFound)u.video={mandatory:{chromeMediaSource:"desktop",maxWidth:1920,maxHeight:1080,maxFrameRate:S}},v.push(g.getStreamToShareFromExtension(u));else if("firefox"===adapter.browserDetails.browser)u.video={mediaSource:E.firefoxPreferedSharing};else{var b=E.getDesktopSharingSource(),R=b&&b.chromeMediaSource?b.chromeMediaSource:"desktop",y=b&&b.chromeMediaSourceId?b.chromeMediaSourceId:null;u.video={mandatory:{chromeMediaSource:R,maxWidth:1920,minWidth:1920,maxHeight:1080,minHeight:1080,maxFrameRate:S}},y&&(u.video.mandatory.chromeMediaSourceId=y)}}e.all(v).then(function(){l.resolve(u)}).catch(function(){l.resolve()}),l.promise.then(function(e){if(r.info("[VideoService] GetUserMedia with constraint "+JSON.stringify(e)),e)try{navigator.mediaDevices.getUserMedia(e).then(function(e){r.webrtc("MEDIA   | getUserMedia success"),e&&(0===e.getAudioTracks().length&&0===e.getVideoTracks().length||!1===e.active)&&(r.webrtc("Stream has no active audio or video tracks"),h.trackGetUserMediaErrorNoTrack(),c(new Error("getUserMedia failure : Stream has no active audio or video tracks"))),h.trackGetUserMediaSuccess(),g.extensionFound&&n.indexOf("sharing")>=0&&(e.getVideoTracks()[0].onended=function(){r.info("Stop screensharing in chrome has been triggered"),t.$broadcast("ON_CHROME_STOP_SCREEN_SHARING_TRIGGERED")}),s(e)}).catch(function(e){r.webrtc("MEDIA   | getUserMedia failure: "+e),h.trackGetUserMediaError(),t.$broadcast("ON_WEBRTC_GETUSERMEDIA_ERROR",e),c(new Error("getUserMedia failure "+e))})}catch(e){r.webrtc("MEDIA   | getUserMedia failure: "+e),h.trackGetUserMediaError(),c(new Error("getUserMedia failure "+e))}else c({message:"getUserMedia cancelled"})})}):e.when()},this.getBrowserMethodHandler=function(){var e="",t=null;if(navigator.mozGetUserMedia&&n.mozRTCPeerConnection){if(e=l.extractBrowserVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1),r.webrtc("BROWSER | Detect Firefox navigator (version "+e+")"),e<this.minFirefoxWebRTCVersion)return r.webrtc("BROWSER | Firefox navigator is not WebRTC capable before version "+this.minFirefoxWebRTCVersion),t;t={browser:"firefox",attachMediaStream:function(e,t){e&&e[0]&&(e[0].mozSrcObject=t,e[0].srcObject=t,e[0].play())},pc_constraints:{},clearMediaStream:function(e){try{angular.isDefined(e[0])&&(e[0].pause(),e[0].mozSrcObject=null,e[0].srcObject=null,e[0].uniqueId=null)}catch(e){r.webrtc("BROWSER | clearMediaStream failure "+e)}},attachMediaStreamIfNeeded:function(e,t,n){r.webrtc("BROWSER | attachMediaStreamIfNeeded for ID "+n),e&&e[0]&&(e[0].uniqueId!==n||!e[0].mozSrcObject&&!e[0].srcObject)&&(e[0].uniqueId=n,E.RTC.attachMediaStream(e,t))}}}else if(navigator.webkitGetUserMedia&&n.webkitRTCPeerConnection){if(e=l.extractBrowserVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2),r.webrtc("BROWSER | Detect Chrome navigator (version "+e+")"),e<this.minChromeWebRTCVersion)return r.webrtc("BROWSER | Chrome navigator is not WebRTC capable before version "+this.minChromeWebRTCVersion),t;t={browser:"chrome",attachMediaStream:function(e,t){r.webrtc("BROWSER | attachMediaStream to element"),e&&e[0]&&(e[0].srcObject=t),a(function(){e&&e[0]&&e[0].load&&e[0].load()},1e3,1)},pc_constraints:{},clearMediaStream:function(e){angular.isDefined(e[0])&&(e[0].pause(),e[0].srcObject=null,e[0].uniqueId=null)},attachMediaStreamIfNeeded:function(e,t,n){r.webrtc("BROWSER | attachMediaStreamIfNeeded for ID "+n),!e||!e[0]||e[0].uniqueId===n&&e[0].srcObject||(e[0].uniqueId=n,E.RTC.attachMediaStream(e,t))}}}return t},this.getIceConfig=function(){var t=e.defer();return this.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/",i({method:"GET",url:E.portalURL+"settings/iceservers",headers:v.getRequestHeader()}).success(function(e){r.info("[videoService] getIceConfig success");var n=e.data;n.forEach(function(e){delete e.id},this);var i={iceServers:n};t.resolve(i)}).error(function(e,t){r.error("[videoService] getIceConfig failure "+e+" with status "+t)}),t.promise},this.calculateNewCallType=function(e,t,n,i){var a=t.localType;return"contentAdd"===i&&("video"===n?(a=e.localMedia&c.Media.SHARING?"sharing+video":"video",e.localMedia=e.localMedia|c.Media.VIDEO):"sharing"===n?(a=e.localMedia&c.Media.VIDEO?"sharing+video":"sharing",e.localMedia=e.localMedia|c.Media.SHARING):"audio"===n&&(e.localMedia&c.Media.SHARING?(a="sharing",e.localMedia=e.localMedia|c.Media.AUDIO):(a="audio",e.localMedia=c.Media.AUDIO))),"contentRemove"===i&&("video"===n?e.localMedia&c.Media.SHARING?(a="sharing",e.localMedia=c.Media.AUDIO|c.Media.SHARING):(a="audio",e.localMedia=c.Media.AUDIO):"sharing"===n&&(e.localMedia&c.Media.VIDEO?(a="video",e.localMedia=c.Media.AUDIO|c.Media.VIDEO):(a="audio",e.localMedia=c.Media.AUDIO))),"contentModify"===i&&e.localMedia&c.Media.VIDEO&&!(e.localMedia&c.Media.SHARING)&&(a="video"),r.info("[videoService] calculateNewCallType for type "+n+" and action "+i+" with result "+a),a},this.updateCurrentCall=function(e,n,i,a){r.info("[videoService] updateCurrentCall for type "+i+" and action "+a);for(var o=this.calculateNewCallType(e,n,i,a),c=0;c<E.localStreams.length;c++)"chrome"===adapter.browserDetails.browser?n.addStream(E.localStreams[c]):n.replaceStream(E.localStreams[c]);switch(a){case"contentAdd":n.contentAdd(o);break;case"contentRemove":n.contentRemove(o);break;case"contentModify":n.contentModify(o)}s.setBusyState("dnd",E.calculatePresenceMessage(e)),t.$broadcast("ON_CALL_UPDATED_EVENT",e),t.$broadcast("ON_WEBRTC_CALL_ESCALATION",e)},angular.element(document).bind("transportreplace.jingle",function(e,t){r.webrtc("JINGLE  | transportreplace.jingle "+t);var n=o.connection.jingle.sessions[t];n?n.sendAnswer(void 0,"transport-accept"):r.warn("JINGLE  | transportreplace.jingle no such session !")}),angular.element(document).bind("callactive.jingle",function(e,t,n){r.webrtc("JINGLE  | callactive "+n)}),angular.element(document).bind("remotestreamadded.jingle",function(e,n,i){if(r.webrtc("JINGLE  | remoteStreamadded "+i),0===angular.element("#largevideo_"+i).length){var a=o.connection.jingle.sessions[i];if(a&&a.remoteStreams&&!a.confId){var s=E.calls[i];s&&E.attachDistantMediaStreams(!0,s),t.$broadcast("ON_WEBRTC_REMOTE_STREAM_ADDED",a.remoteStreams)}}else r.webrtc("INFO    | ignoring duplicate remotestreamadded...")}),angular.element(document).bind("remotestreamremoved.jingle",function(e,t){r.webrtc("JINGLE  | remotestreamremoved "+t)}),angular.element(document).bind("callaccepted.jingle",function(e,t){r.webrtc("JINGLE  | callaccepted "+t);var n=E.calls[t];if(n&&n.status.key!==c.Status.ACTIVE.key){r.webrtc("INFO    | call has been accepted. Set current call to ACTIVE state");var i=angular.element("<video autoplay='autoplay' style='display:none'/>").attr("id","largevideo_"+t);angular.element(document).trigger("callactive.jingle",[i,t])}}),angular.element(document).bind("nostuncandidates.jingle",function(e,t){r.webrtc("JINGLE  | nostuncandidates "+t),h.trackICENoSTUNCandidate()}),angular.element(document).bind("ringing.jingle",function(e,t){r.webrtc("JINGLE  | callremoteringing "+t)}),angular.element(document).bind("mediafailure.jingle",function(){r.webrtc("JINGLE  | callmediafailure")}),angular.element(document).bind("mute.jingle",function(e,n){r.webrtc("JINGLE  | mute "+n);var i=E.calls[n];i.isRemoteVideoMuted=!0,t.$broadcast("ON_CALL_UPDATED_EVENT",i)}),angular.element(document).bind("unmute.jingle",function(e,n){r.webrtc("JINGLE  | unmute "+n);var i=E.calls[n];i.isRemoteVideoMuted=!1,t.$broadcast("ON_CALL_UPDATED_EVENT",i)}),angular.element(document).bind("remoteIceFailed.jingle",function(e){r.webrtc("JINGLE  | remoteIceFailed "+e),E.openErrorPopup("IceConnectionFailed")}),angular.element(document).bind("mediamodified.jingle",function(e,t,n){r.webrtc("JINGLE  | mediamodified "+t),E.videoEventHandler.mediaModified(t,n)}),angular.element(document).bind("statsChrome.jingle",function(e,t,n){for(var r=0;r<n.length;++r)switch(n[r].type){case"googComponent":u.addStreamToCall(t,n[r]);break;case"ssrc":u.addSSRCToStream(t,n[r])}}),angular.element(document).bind("statsFirefox.jingle",function(e,t,n){for(var r=0;r<n.length;++r)switch(n[r].type){case"inboundrtp":case"outboundrtp":d.addStreamToCall(t,n[r]);break;case"candidatepair":d.addCandidatePairToCall(t,n[r])}}),angular.element(document).bind("webrtcFirefoxStats.jingle",function(e,n,r){E.callsStats.sid||(E.callsStats.sid={});var i=E.calls[n];if(i){var a=E.calculateAudioState(r),o=0;i.remoteMedia&c.Media.VIDEO&&(o=E.calculateVideoState(r));var s=E.callsStats[n];s&&(r.videoReceived?s.video=r:s.audio=r,E.callsStats[n]=s),t.$broadcast("ON_WEBRTC_CALL_STATS",a,o)}}),angular.element(document).bind("webrtcConnectionType.jingle",function(e,t,n){var i=E.calls[t];n&&(r.webrtc("STATS   | Local candidate ("+n.local.ipAddress+") type is "+n.local.candidateType),r.webrtc("STATS   | Remote candidate  ("+n.remote.ipAddress+") type is "+n.remote.candidateType),i&&i.isInitiator&&h.trackICEUsed(n.local.candidateType,n.remote.candidateType),n.local.networkType&&(r.webrtc("STATS   | Network type is "+n.local.networkType),i&&i.isInitiator&&h.trackICETopology(n.local.networkType)))}),angular.element(document).bind("webrtcChromeStats.jingle",function(e,n,i){E.callsStats.sid||(E.callsStats.sid={});var a=E.calls[n];if(a){var o=E.calculateAudioState(i),s=0;a.remoteMedia&c.Media.VIDEO&&(s=E.calculateVideoState(i)),E.callsStats[n]=i,t.$broadcast("ON_WEBRTC_CALL_STATS",o,s)}i&&r.info("[videoService] webrtcChromeStats audio packets received : "+i.packetsAudioReceived+" / audio packets sent : "+i.packetsAudioSent+" / for session "+n)}),this.escalateToSharingCall=function(e,t){r.webrtc("MEDIA   | escalateToSharingCall - Desktop sharing escalation");var n=o.connection.jingle.sessions[e.id];n.isRenegotiating=!0;this.getBrowserMedia(["sharing"]).then(function(r){n.removeStream(E.localStreams[0]),n.localStreams[0]=null,n.localStreams=[],E.localStreams.push(r),E.updateCurrentSharingCall(e,n,t)}).catch(function(e){r.webrtc("MEDIA   | escalateToSharingCall failure : "+e),n.isRenegotiating=!1,-1!==e.toString().indexOf("getUserMedia")&&E.openErrorPopup()})},this.escalateToVideoCall=function(e,t){r.webrtc("MEDIA   | Escalate to video call");var n=o.connection.jingle.sessions[e.id];n.isRenegotiating=!0,E.getBrowserMedia(["audio","video"]).then(function(r){E.stopActiveAudioVideoStreams(n),E.localStreams.push(r);for(var i=0;i<E.localStreams.length;i++)n.localStreams.push(E.localStreams[i]);E.updateCurrentAudioOrVideoCall(e,n,"video",t)}).catch(function(t){r.webrtc("MEDIA   | escalateToVideoCall failure for : "+e+" failure : "+t.message),-1!==t.toString().indexOf("getUserMedia")?(r.info("Escalation to video impossible, no webcam plugged"),E.openErrorPopup()):(E.releaseCall(e),E.resetToSafeState())})},this.addAudioToSharingCall=function(e){r.webrtc("MEDIA   | addAudioToSharingCall");var t=o.connection.jingle.sessions[e.id];t.isRenegotiating=!0,E.localStreams.length&&t.removeStream(E.localStreams[0]),t.localStreams[0]=null,t.localStreams=[];this.getBrowserMedia(["audio"]).then(function(n){E.localStreams.push(n),E.updateCurrentSharingCall(e,t)}).catch(function(t){r.webrtc("MEDIA   | addAudioToSharingCall failure : "+t),E.releaseCall(e),E.resetToSafeState()})},this.reverseToAudioCall=function(e,t){r.webrtc("MEDIA   | reverseToAudioCall"),this.reverseAudioCallInitiated=!0;var n=o.connection.jingle.sessions[e.id];this.stopActiveAudioVideoStreams(n);n.isRenegotiating=!0,E.getBrowserMedia(["audio"]).then(function(r){E.localStreams.push(r);for(var i=0;i<E.localStreams.length;i++)n.localStreams.push(E.localStreams[i]);E.updateCurrentAudioOrVideoCall(e,n,"audio",t)}).catch(function(t){r.webrtc("MEDIA   | reverseToAudioCall failure for : "+e+" failure : "+t.message),-1!==t.toString().indexOf("getUserMedia")&&E.openErrorPopup(),E.releaseCall(e),E.resetToSafeState()})},E.updateCurrentSharingCall=function(e,n,i){if(r.webrtc("MEDIA   | updateCurrentSharingCall | Add new streams to the current session"),!n||!o.connection.jingle.sessions[e.id])return E.disableAudioVideoMedia(),E.resetToSafeState(),void E.removeCallObject(e);var a="audio";"chrome"===adapter.browserDetails.browser?(n.localStreams.push(E.localStreams[0]),n.addStream(E.localStreams[0]),E.localStreams[1]&&(a=e.localMedia===c.Media.AUDIO||e.localMedia===c.Media.SHARING?"sharing":"sharing+video",e.localMedia=e.localMedia|c.Media.SHARING|c.Media.AUDIO,n.localStreams.push(E.localStreams[1]),n.addStream(E.localStreams[1]),n.localStreams.push(E.localStreams[1]),n.addStream(E.localStreams[1]))):(e.localMedia=c.Media.AUDIO,n.replaceStream(E.localStreams[0])),i?n.contentModify(a):n.contentAdd(a),s.setBusyState("dnd",E.calculatePresenceMessage(e)),t.$broadcast("ON_CALL_UPDATED_EVENT",e),t.$broadcast("ON_WEBRTC_CALL_ESCALATION",e)},this.updateCurrentAudioOrVideoCall=function(e,n,i,a){r.webrtc("MEDIA   | updateCurrentAudioOrVideoCall | Add new stream to the current session");for(var o=0;o<E.localStreams.length;o++)"chrome"===adapter.browserDetails.browser?n.addStream(E.localStreams[o]):n.replaceStream(E.localStreams[o]);a?n.contentModify(n.localType):"audio"===i?e.localMedia&c.Media.SHARING?(n.contentRemove("sharing"),n.localType="sharing",e.localMedia=c.Media.AUDIO|c.Media.SHARING):(n.contentRemove("audio"),n.localType="audio",e.localMedia=c.Media.AUDIO):"video"===i&&(e.localMedia&c.Media.SHARING?(n.contentAdd("sharing+video"),n.localType="sharing+video"):(n.contentAdd("video"),n.localType="audio+video"),e.localMedia=e.localMedia|c.Media.VIDEO),s.setBusyState("dnd",E.calculatePresenceMessage(e)),t.$broadcast("ON_CALL_UPDATED_EVENT",e),t.$broadcast("ON_WEBRTC_CALL_ESCALATION",e)},this.attachLocalMediaStream=function(e){e?(this.localStreams&&this.localStreams.length&&this.localStreams[0].getVideoTracks().length&&this.RTC.attachMediaStream($("#minivideo"),this.localStreams[0]),$("#minivideo")[0]&&($("#minivideo")[0].volume=0)):this.RTC.clearMediaStream($("#minivideo"),null)},this.attachDistantMediaStream=function(e,t){if(e){var n=o.connection.jingle.sessions[t.id];n.remoteStreams?n.remoteStreams.forEach(function(e){e.getVideoTracks().length>0&&(r.webrtc("attachDistantMediaStream video track"),E.RTC.attachMediaStream(angular.element("#largevideo"),e),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0)),e.getAudioTracks().length>0&&(r.webrtc("attachDistantMediaStream audio track"),E.RTC.attachMediaStream(angular.element("#globalAudioTag"),e))}):n.remoteStream&&(n.remoteStream.getVideoTracks().length>0&&(r.error("attachDistantMediaStream NOT GOOD !!! video track"),E.RTC.attachMediaStream(angular.element("#largevideo"),n.remoteStream),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0)),n.remoteStream.getAudioTracks().length>0&&(r.error("attachDistantMediaStream NOT GOOD !!! audio track"),E.RTC.attachMediaStream(angular.element("#globalAudioTag"),n.remoteStream)))}else E.isUserContactInCall()||(this.RTC.clearMediaStream(angular.element("#largevideo"),null),this.RTC.clearMediaStream(angular.element("#globalVideoTag"),null),this.RTC.attachMediaStream(angular.element("#globalAudioTag"),null))}}]),angular.module("rainbow").factory("VideoServiceEventHandler",["$log","$rootScope","$interval","contactService","xmppService","Call","gaService","uuid4",function(e,t,n,r,i,a,o,s){"use strict";function c(e){this.videoService=e,this.nameSpace="urn:xmpp:jingle-message:0"}return c.create=function(e){return new c(e)},c.prototype.setRemoteTypeMedia=function(t,n){n.remoteMedia=0;for(var r=0;r<t.length;r++)switch(t[r]){case"audio":n.remoteMedia=n.remoteMedia|a.Media.AUDIO;break;case"video":n.remoteMedia=n.remoteMedia|a.Media.VIDEO;break;case"sharing":n.remoteMedia=n.remoteMedia|a.Media.SHARING;break;default:n.remoteMedia=null}e.debug("REMOTE TYPE || REMOTE MEDIA  "+n.remoteMedia)},c.prototype.setLocalTypeMedia=function(t,n){n.localMedia=0;for(var r=0;r<t.length;r++)switch(t[r]){case"audio":n.localMedia=n.localMedia|a.Media.AUDIO;break;case"video":n.localMedia=n.localMedia|a.Media.VIDEO;break;case"sharing":n.localMedia=n.localMedia|a.Media.SHARING;break;default:n.localMedia=null}e.debug("LOCAL TYPE || LOCAL MEDIA  "+n.localMedia)},c.prototype.sendProposition=function(o,c){e.info("[VideoServiceEventHandler]   | sendProposition to "+JSON.stringify({displayName:o.displayNameForLog(),resources:o.resources}));var l=this,u=["audio"],d=[];"video"===c?u.push("video"):"videoOnly"===c?u=["video"]:"sharing"===c?(u=["sharing"],d=["audio"]):"sharingOnly"===c&&(u=["sharing"]);var f="web_"+s.generate(),h=a.create(a.Status.DIALING,f,a.Type.WEBRTC,o);this.videoService.getBrowserMedia(u).then(function(a){l.videoService.getBrowserMedia(d).then(function(s){h.isInitiator=!0,l.videoService.localStreams.push(a),s&&(l.videoService.localStreams.push(s),u.push(d.pop())),l.videoService.calls[h.id]=h,l.setLocalTypeMedia(u,h);var c=$msg({from:r.userContact.fullJid,to:o.jid}).c("propose",{xmlns:l.nameSpace,id:f}).c("description",{xmlns:"urn:xmpp:jingle:apps:rtp:1",media:u[0]}).up();u[1]&&(c=c.c("description",{xmlns:"urn:xmpp:jingle:apps:rtp:1",media:u[1]}).up()),i.send(c),l.videoService.makingCall=!1,r.setBusyState("dnd",l.videoService.calculatePresenceMessage(h)),t.$broadcast("ON_CALL_UPDATED_EVENT",h),l.videoService.autoreleaseTimeout&&n.cancel(l.videoService.autoreleaseTimeout),l.videoService.autoreleaseTimeout=n(function(t){e.webrtc("MEDIA   | send proposition : no response after 30 seconds : release the call"),h&&l.videoService.rejectCall(t)},3e4,1,!0,h)}).catch(function(t){e.info("[VideoServiceEventHandler]   | sendProposition failure : "+JSON.stringify({error:t.message})),l.videoService.makingCall=!1,-1!==t.toString().indexOf("getUserMedia")&&l.videoService.openErrorPopup(),l.videoService.removeCallObject(h),l.videoService.resetToSafeState(),l.videoService.autoreleaseTimeout&&n.cancel(l.videoService.autoreleaseTimeout)})}).catch(function(t){e.info("[VideoServiceEventHandler]   | sendProposition failure : "+JSON.stringify({error:t.message})),l.videoService.makingCall=!1,u.indexOf("sharing")>=0||-1===t.toString().indexOf("getUserMedia")||l.videoService.openErrorPopup(),l.videoService.removeCallObject(h),l.videoService.resetToSafeState()})},c.prototype.retractProposition=function(t){e.info("[VideoServiceEventHandler]   | retractProposition for call "+t.id);var n=$msg({from:r.userContact.fullJid,to:t.contact.jid}).c("retract",{xmlns:this.nameSpace,id:t.id});i.send(n),r.resetBusyState(),this.videoService.removeCallObject(t)},c.prototype.acceptProposition=function(o,s){e.info("[VideoServiceEventHandler]   | acceptProposition for call "+o.id);var c=$msg({from:r.userContact.fullJid,to:r.userContact.jid}).c("accept",{xmlns:this.nameSpace,id:o.id});i.send(c),c=$msg({from:r.userContact.fullJid,to:o.fullJid}).c("proceed",{xmlns:this.nameSpace,id:o.id}),i.send(c);var l=["audio"];s&&"video"===s&&l.push("video"),o.remoteMedia===a.Media.VIDEO&&(l=["video"]),o.remoteMedia===a.Media.SHARING&&(l=[]),this.setLocalTypeMedia(l,o),r.setBusyState("dnd",this.videoService.calculatePresenceMessage(o)),o.status=a.Status.ANSWERING,t.$broadcast("ON_CALL_UPDATED_EVENT",o);this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout)},c.prototype.rejectProposition=function(t){e.info("[VideoServiceEventHandler]   | rejectProposition for call "+t.id);var a=$msg({from:r.userContact.fullJid,to:r.userContact.jid}).c("reject",{xmlns:this.nameSpace,id:t.id});i.send(a),a=$msg({from:r.userContact.fullJid,to:t.contact.jid}).c("reject",{xmlns:this.nameSpace,id:t.id}),i.send(a),this.videoService.removeCallObject(t),this.videoService.setWebrtcConfiguration(),this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout)},c.prototype.onMessageReceived=function(t){try{e.info("[VideoServiceEventHandler]   | onMessageReceived"),console.log(t);var n=$(t);n.find("error").length>0||n.find("delay").length>0||$(t).find("service-unavailable").length>0?this.onMessageReceivedError():n.find("propose").length>0?this.onPropositionReceived(t):n.find("retract").length>0?this.onRetractReceived(t):n.find("reject").length>0?this.onRejectReceived(t):n.find("accept").length>0?this.onAcceptReceived(t):n.find("proceed").length>0&&this.onProceedReceived(t)}catch(t){return e.error("[VideoServiceEventHandler]   | onMessageReceived error "+t),!0}return!0},c.prototype.onMessageReceivedError=function(t){e.info("[VideoServiceEventHandler]   | onMessageReceivedError");var n=$(t).find("propose").attr("id"),r=this.videoService.calls[n];r&&e.error("[VideoServiceEventHandler]   | onMessageReceivedError call is in "+r.status.value+" state")},c.prototype.onPropositionReceived=function(o){e.info("[VideoServiceEventHandler]   | onPropositionReceived");var s=$(o).find("propose").attr("id"),c=this.videoService.calls[s],l=this;if(c)c.setStatus(a.Status.RINGING_INCOMMING),this.setRemoteTypeMedia(d,c),t.$broadcast("ON_CALL_UPDATED_EVENT",c);else{var u=$(o).attr("from"),d=[],f=i.getBareJidFromJid(u);r.getOrCreateContact(f).then(function(e){for(var n=$(o).find("description").length,r=0;r<n;r++){var i=$(o).find("description")[r];d.push($(i).attr("media"))}(c=a.create(a.Status.UNKNOWN,s,a.Type.WEBRTC,e)).fullJid=u,l.videoService.calls[c.id]=c,c.setStatus(a.Status.RINGING_INCOMMING),l.setRemoteTypeMedia(d,c),t.$broadcast("ON_CALL_UPDATED_EVENT",c)}).catch(function(t){e.error("[VideoServiceEventHandler]   | onPropositionReceived error "+t),l.videoService.removeCallObject(c)})}l.videoService.autoreleaseTimeout&&n.cancel(l.videoService.autoreleaseTimeout),l.videoService.autoreleaseTimeout=n(function(t){t&&(e.webrtc("[VideoServiceEventHandler]   | onPropositionReceived autoreleaseTimeout after 2 min : remove the call "+t.id),l.videoService.removeCallObject(t))},12e4,1,!0,c)},c.prototype.onRetractReceived=function(t){e.info("[VideoServiceEventHandler]   | onRetractReceveid");var i=$(t).find("retract").attr("id"),o=this.videoService.calls[i];o&&(o.status===a.Status.ANSWERING&&r.resetBusyState(),this.videoService.removeCallObject(o)),this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout)},c.prototype.onRejectReceived=function(t){e.info("[VideoServiceEventHandler]   | onRejectReceived");var i=$(t).find("reject").attr("id"),o=this.videoService.calls[i],s=$(t).attr("from");this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout),o&&(o.status===a.Status.RINGING_INCOMMING&&this.videoService.removeCallObject(o),o.status===a.Status.DIALING&&(r.resetBusyState(),this.videoService.removeCallObject(o)),o.status!==a.Status.ACTIVE&&o.status!==a.Status.CONNECTING||o.fullJid&&o.fullJid===s&&(r.resetBusyState(),this.videoService.removeCallObject(o)))},c.prototype.onAcceptReceived=function(t){e.info("[VideoServiceEventHandler]   | onAcceptReceived");var i=$(t).find("accept").attr("id"),a=this.videoService.calls[i],o=$(t).attr("from");a&&o!==r.userContact.fullJid&&this.videoService.removeCallObject(a),this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout)},c.prototype.onProceedReceived=function(t){e.info("[VideoServiceEventHandler]   | onProceedReceived"),this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout);var r=$(t).find("proceed").attr("id"),i=this.videoService.calls[r],o=$(t).attr("from");if(i.fullJid=o,i.isInConversationWithMobile()&&i.localMedia&a.Media.VIDEO){var s=this,c=[],l=s.videoService.getMobileMediaConstraints("video");c=["audio","video"],i.localMedia&a.Media.AUDIO||(c=["video"]),s.videoService.getBrowserMedia(c,l.fixedVideoWidth,l.fixedVideoHeight,l.fixedFrameRate).then(function(t){e.info("[VideoServiceEventHandler]   | onProceedReceived --\x3e renegociate video quality"),i.localMedia&a.Media.VIDEO&&s.videoService.stopActiveAudioVideoStreams(),s.videoService.localStreams.push(t),s.videoService.makeJingleCall(i)}).catch(function(t){e.info("[VideoServiceEventHandler]   | onProceedReceived "+i+" failure : "+t.message),-1!==t.toString().indexOf("getUserMedia")?(e.info("onProceedReceived impossible, no webcam plugged"),s.videoService.openErrorPopup()):(s.videoService.releaseCall(i),s.videoService.resetToSafeState())})}else i.localMedia&a.Media.SHARING?this.videoService.makeJingleSharingCall(i):this.videoService.makeJingleCall(i)},c.prototype.incomingCall=function(a){e.info("[VideoServiceEventHandler] incomingCall "+a);var o=this,s=null,c=i.connection.jingle.sessions[a];if(c&&c.peerjid){var l=i.getBareJidFromJid(c.peerjid),u=r.getContactByJid(l);s=this.videoService.getCallByJid(u.jid)}s?(c.sendRinging(),n(function(e){o.videoService.answerJingleCall(e)},350,1,!0,s),t.$broadcast("ON_CALL_UPDATED_EVENT",s),this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout)):(e.warn("[VideoServiceEventHandler] incomingCall no such call ! Terminate the session "),r.resetBusyState(),c&&c.terminate())},c.prototype.activeCall=function(r){e.info("[VideoServiceEventHandler] activeCall "+r);var s=i.connection.jingle.sessions[r];this.videoService.statsInterval&&(n.cancel(this.videoService.statsInterval),this.videoService.statsinterval=null),this.videoService.statsInterval=s.getStats(5e3),this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout);var c=this.videoService.calls[r];this.videoService.updateRemoteTypeMedia(s.remoteType,c),c&&c.status.key!==a.Status.RELEASING.key&&c.status.key!==a.Status.UNKNOWN.key&&(c.setStatus(a.Status.ACTIVE),t.$broadcast("ON_CALL_UPDATED_EVENT",c)),c.isInitiator&&o.trackCallSuccessNumber(s.localType)},c.prototype.terminatedCall=function(t,a){0===Object.keys(i.connection.jingle.sessions).length&&e.webrtc("INFO    | all calls terminated");var s=this.videoService.calls[t];s||0===this.videoService.calls.length?("busy"===a&&this.videoService.openErrorPopup("remoteUserNoMoreAvailable"),this.videoService.autoreleaseTimeout&&n.cancel(this.videoService.autoreleaseTimeout),this.videoService.disableAudioVideoMedia(),this.videoService.callsStats[t]&&(e.webrtc("STATS   | "+JSON.stringify(this.videoService.callsStats[t])),delete this.videoService.callsStats[t]),s&&("cancel"!==a&&o.trackCallDuration((new Date).getTime()-s.startDate.getTime()),this.videoService.removeCallObject(s)),n(function(){r.resetBusyState()},1e3,1,!0),this.videoService.statsInterval&&(n.cancel(this.videoService.statsInterval),this.videoService.statsinterval=null),this.videoService.displayWebRTCStats(t)):e.webrtc("INFO    | terminatedCall : no call with "+t+" exists.")},c.prototype.onJingleError=function(e){e&&this.videoService.calls[e]&&this.videoService.calls[e].status!==a.Status.ACTIVE&&(this.videoService.removeCallObject(this.calls[e]),this.videoService.resetToSafeState(),this.videoService.openErrorPopup("IceConnectionFailed"))},c.prototype.iceConnectionStateChange=function(n,s){e.info("[VideoServiceEventHandler] iceConnectionStateChange for "+n);var c=this,l=null,u=c.videoService.calls[s.sid];try{if(s.peerconnection&&"stable"===s.peerconnection.signalingState&&"connected"===s.peerconnection.iceConnectionState){if(e.webrtc("INFO    | ICE Connection established successfully"),angular.element("#globalAudioTag")[0]&&e.info("[VideoServiceEventHandler] sinkId for globalAudioTag is "+angular.element("#globalAudioTag")[0].sinkId),c.videoService.reconnectCall=!1,(l=c.videoService.calls[n])&&l.status!==a.Status.ACTIVE){angular.element("<video autoplay='autoplay' style='display:none'/>").attr("id","largevideo_"+n);e.webrtc("INFO    | ICE Connection : call is active now !"),this.activeCall(n)}s.isRenegotiating&&(e.webrtc("INFO    | Renegotiating done"),s.isRenegotiating=!1,t.$broadcast("ON_WEBRTC_CALL_ESCALATION",l),t.$broadcast("ON_WEBRTC_CALL_ESCALATION_SUCCESS",l)),o.endNegotiationTime();var d=o.negotiationTime();d&&(e.webrtc("INFO    | negotiation time: "+d+"ms"),o.trackNegotiationTime()),l&&l.isInitiator&&o.trackICESuccess(n)}if(s.peerconnection&&"stable"===s.peerconnection.signalingState&&"completed"===s.peerconnection.iceConnectionState&&(e.webrtc("INFO    | ICE Connection completed successfully"),c.videoService.reconnectCall=!1,(l=c.videoService.calls[n])&&l.status!==a.Status.ACTIVE)){angular.element("<video autoplay='autoplay' style='display:none'/>").attr("id","largevideo_"+n);e.webrtc("INFO    | ICE Connection : call is active now !"),this.activeCall(n)}s.peerconnection&&"stable"===s.peerconnection.signalingState&&"disconnected"===s.peerconnection.iceConnectionState&&(e.webrtc("INFO    | signalingState disconnected"),u&&u.status!==a.Status.UNKNOWN&&(e.webrtc("INFO    | iceConnectionStateChange go to connecting state"),u.setStatus(a.Status.CONNECTING),t.$broadcast("ON_CALL_UPDATED_EVENT",u)),c.videoService.connected||(c.videoService.reconnectCall=!0)),s.peerconnection&&"stable"===s.peerconnection.signalingState&&"failed"===s.peerconnection.iceConnectionState&&(e.webrtc("INFO    | signalingState FAILED"),u&&u.status!==a.Status.UNKNOWN&&(e.webrtc("INFO    | iceConnectionStateChange go to connecting state"),u.setStatus(a.Status.CONNECTING),t.$broadcast("ON_CALL_UPDATED_EVENT",u),t.$broadcast("ON_RECORDING_CNXLOST_EVENT")),c.videoService.connected||(c.videoService.reconnectCall=!0))}catch(t){try{e.error("JINGLE  | iceconnectionstatechange error "+t),u?c.videoService.removeCallObject(u,"unsupported-applications"):i.connection.jingle.terminate(null,"unsupported-applications"),r.resetBusyState()}catch(t){e.error("JINGLE  | iceconnectionstatechange error "+t),r.resetBusyState()}}},c.prototype.mediaModified=function(n,o){e.info("[VideoServiceEventHandler] mediaModified "+n);var s=this.videoService.calls[n];i.connection.jingle.sessions[n].isRenegotiating=!0,s.remoteMedia="sharing"===o?a.Media.AUDIO|a.Media.SHARING:"video"===o?a.Media.AUDIO|a.Media.VIDEO:"sharing+video"===o?a.Media.AUDIO|a.Media.VIDEO|a.Media.SHARING:a.Media.AUDIO,r.setBusyState("dnd",this.videoService.calculatePresenceMessage(s)),t.$broadcast("ON_WEBRTC_CALL_ESCALATION",s)},c}]),angular.module("rainbow").service("webrtcServiceEventHandler",["$log","$q","videoService","webConferenceService",function(e,t,n,r){"use strict";this.started=!1,this.start=function(){return this.started=!0,t.when()},this.stop=function(){return this.started=!1,t.when()},angular.element(document).bind("callincoming.jingle",function(t,i){e.webrtc("webrtcServiceEventHandler  | callincoming.jingle "+i),n.calls[i]?n.videoEventHandler.incomingCall(i):r.onIncomingCall(i)}),angular.element(document).bind("callterminated.jingle",function(t,i,a){var o=a||"";e.webrtc("webrtcServiceEventHandler  | callterminated "+i+" reason: "+o),n.calls[i]?n.videoEventHandler.terminatedCall(i,o):r.onTerminatedCall(i)}),angular.element(document).bind("iceconnectionstatechange.jingle",function(t,i,a){a.peerconnection?(e.webrtc("JINGLE  | iceconnectionstatechange "+i+" "+a.peerconnection.iceConnectionState+"|"+a.peerconnection.signalingState),n.calls[i]?n.videoEventHandler.iceConnectionStateChange(i,a):r.onIceConnectionStateChange(i,a)):e.webrtc("JINGLE  | iceconnectionstatechange - peerConnection does not exist anymore !!!")}),angular.element(document).bind("error.jingle",function(t,i){e.error("JINGLE  | callerror"),i&&i.error&&e.error(JSON.stringify(i.error));var a=i.sid;a&&(n.calls[a]?n.videoEventHandler.onJingleError(a):r.onJingleError(a))})}]),angular.module("rainbow").service("settingsService",["$rootScope","$translate","$localStorage",function(e,t,n){"use strict";var r=this;this.initialize=function(){this.languages=[{label:"English",settingCode:"en",code:"en",isoCode:"en",codeMoment:"en",unicode:"1f1ec-1f1e7",beta:!1},{label:"Franais",settingCode:"fr",code:"fr",isoCode:"fr",codeMoment:"fr",unicode:"1f1eb-1f1f7",beta:!1},{label:"Deutsch",settingCode:"de",code:"de",isoCode:"de",codeMoment:"de",unicode:"1f1e9-1f1ea",beta:!1},{label:"Espaol",settingCode:"es-es",code:"es-es",isoCode:"es-ES",codeMoment:"es",unicode:"1f1ea-1f1f8",beta:!1},{label:"Suomi",settingCode:"fi",code:"fi",isoCode:"fi",codeMoment:"fi",unicode:"1f1eb-1f1ee",beta:!0},{label:"Italiano",settingCode:"it",code:"it",isoCode:"it",codeMoment:"it",unicode:"1f1ee-1f1f9",beta:!1},{label:"",settingCode:"he",code:"he",isoCode:"he",codeMoment:"he",unicode:"1f1ee-1f1f1",beta:!1},{label:"Nederlands",settingCode:"nl",code:"nl",isoCode:"nl",codeMoment:"nl",unicode:"1F1F3-1F1F1",beta:!1},{label:"Nynorsk",settingCode:"no",code:"no",isoCode:"no",codeMoment:"nn",unicode:"1F1F3-1F1F4",beta:!0},{label:"Portugus do Brasil",settingCode:"pt-br",code:"pt-BR",isoCode:"pt-BR",codeMoment:"pt-br",unicode:"1F1E7-1F1F7",beta:!1},{label:"Portugus",settingCode:"pt-pt",code:"pt-PT",isoCode:"pt-PT",codeMoment:"pt-pt",unicode:"1F1F5-1F1F9",beta:!1},{label:"Svenskt",settingCode:"sv-se",code:"sv-SE",isoCode:"sv-SE",codeMoment:"sv",unicode:"1F1F8-1F1EA",beta:!0},{label:"Trke",settingCode:"tr",code:"tr",isoCode:"tr",codeMoment:"tr",unicode:"1f1f9-1f1f7",beta:!1},{label:"",settingCode:"zh-cn",code:"zh-cn",isoCode:"zh-CN",codeMoment:"zh-cn",unicode:"1f1e8-1f1f3",beta:!1},{label:"",settingCode:"zh-tw",code:"zh-TW",isoCode:"zh-TW",codeMoment:"zh-tw",unicode:"1F1F9-1F1FC",beta:!1}],this.languageCodes=this.getAvailableLanguages().map(function(e){return e.settingCode}),this.settings={init:!0,lang:"en",imSound:"true",imNotif:"true",imStartSound:"false",notifReminder:"gentle",displayOrder:"firstLast",nbMaxConversations:"15",skin:"rainbow",microphone:"default",headsetMicrophone:null,speakerphoneMicrophone:null,customMicrophone:null,headsetDeviceName:null,speakerphoneDeviceName:null,speaker:"default",headsetSpeaker:null,speakerphoneSpeaker:null,customSpeaker:null,ringingSpeaker:"default",camera:"default",audioProfile:"handfree",currentDevice:null,iceConfig:null,sdk:!1,userWiewOrderType:"lastname",userWiewFilterType:"all",one2oneColors:"true",translationMsg:"false",server:null,activeAlarm:"relax1",activeNotif:"notif1",devMode:"false",hasSecondRinger:!1,validationMode:"false",disableCalendarPresence:"false",giphy:"false",deviceList:"[]"},n.get(Object.keys(this.settings)).then(function(a){if(a.nbMaxConversations||(a.nbMaxConversations=r.settings.nbMaxConversations),a.skin||(a.skin=r.settings.skin),e.default_language&&(a.lang=i(e.default_language),r.setSetting("lang",a.lang)),"default"===a.headsetMicrophone&&(a.headsetMicrophone=null),"default"===a.headsetSpeaker&&(a.headsetSpeaker=null),"default"===a.speakerphoneMicrophone&&(a.speakerphoneMicrophone=null),"default"===a.speakerphoneSpeaker&&(a.speakerphoneSpeaker=null),"default"===a.customMicrophone&&(a.customMicrophone=null),"default"===a.customSpeaker&&(a.customSpeaker=null),null===a.init){var o=navigator.languages?navigator.languages[0]:navigator.language||navigator.userLanguage;r.settings.lang=a.lang?a.lang:i(o),n.set(r.settings)}else Object.keys(a).forEach(function(e){null!==a[e]&&(r.settings[e]=a[e])});var s=r.getAppliLanguage();t.use(s.code),moment.locale(s.codeMoment)})},this.getSetting=function(e){return this.settings[e]},this.setSetting=function(e,t){this.settings[e]=t,n.set(this.settings)},this.getAvailableLanguages=function(){return this.languages.filter(function(e){return!1===e.beta||config.betaLanguages})},this.getAppliLanguage=function(){var e=this.getAvailableLanguages().filter(function(e){return e.settingCode===r.settings.lang})[0];return e||"en"},this.setAppliLanguageCode=function(n,i){i?this.setSetting("lang",n):this.settings.lang=n;var a=r.getAppliLanguage();t.use(a.code),moment.locale(a.codeMoment),e.$broadcast("ON_LANGUAGE_UPDATED_EVENT",n)},this.getAppliLanguageCodeForServer=function(){var e=r.settings.lang.split("-");return 1===e.length?r.settings.lang:e[0]+"-"+e[1].toUpperCase()},this.setAppliLangageCodeFromServer=function(e){var t=e.split("-"),n=t[0];n&&(n=n.toLowerCase()),2===t.length&&(n+="-"+t[1].toLowerCase()),n=i(n),n=this.languageCodes.indexOf(n)>=0?n:"en",this.setAppliLanguageCode(n)},this.getLanguageWithIsoCode=function(e){var t=r.languages.filter(function(t){return t.isoCode===e});return t?t[0]:null},this.setIceConfig=function(e){this.settings.iceConfig=e},this.forceTurn=function(t){config.turnOn=t;var n=t?"Debug mode : Only use turn servers":"Normal mode : use stun and turn servers";e.$broadcast("ON_SETTING_FORCE_TURN_EVENT",n)},this.enableRemoteConsole=function(e){var t=document.createElement("script");t.src="//console.re/connector.js",t.id="consolerescript",t.setAttribute("data-channel",e),t.onreadystatechange=t.onload=function(){app.remoteConsole.info=!0,app.remoteConsole.debug=!0,app.remoteConsole.log=!0,console.re.info("Connected")},document.getElementsByTagName("head")[0].appendChild(t)};var i=function(e){var t="en";if(e)switch(e.split("-")[0]){case"en":t="en";break;case"fr":t="fr";break;case"de":t="de";break;case"es":t="es-es";break;case"fi":t="fi";break;case"it":t="it";break;case"he":t="he";break;case"nl":t="nl";break;case"no":t="no";break;case"pt":t="pt-br"===e.toLowerCase()?"pt-br":"pt-pt";break;case"sv":t="sv-SE";break;case"tr":t="tr";break;case"zh":t=["zh-cn","zh-tw"].indexOf(e.toLowerCase())>=0?e.toLowerCase():"zh-cn";break;default:t="en"}return t};this.initialize()}]);var channelService=function(){function e(e,t,n,r,i,a,o,s,c,l){this.$q=e,this.$http=t,this.$log=n,this.$rootScope=r,this.$filter=i,this.authService=a,this.errorHelperService=o,this.xmppService=s,this.contactService=c,this.Channel=l,this.EVENT_TYPE={ADD:0,UPDATE:1,REMOVE:2},this.xmpp_message_handler=null}return e.prototype.init=function(){this.portalURL=config.restServerUrl+"/api/rainbow/channels/v1.0/channels",this.attachHandlers()},e.prototype.start=function(e){var t=this;this.$log.info("[channelService] === STARTING ==="),this.init();var n=performance.now();return this.channelsList=[],this.$q(function(r,i){t.getMyChannels().then(function(i){var a=[];if(i){t.$log.info("\n[channelService] List of user channels : "),console.dir(i);for(var o=0;o<i.length;o++)a.push(t.getChannelAndLastMessage(i[o].id).then(function(e){null!==e.lastMessage?t.contactService.getOrCreateContact(e.lastMessage.$.from).then(function(n){e.lastMessage.author=n,t.channelsList.push(e),r()}):(t.channelsList.push(e),r())}))}return t.$q.all(a).then(function(){var i=Math.round(performance.now()-n);e.push({service:"channelService",startDuration:i}),t.$log.info("\n[channelService] === STARTED ("+i+" ms) ===\n"),r()})}).catch(function(e){t.$log.info("[channelService] === STARTING FAILURE === "+e.message),i(e)})})},e.prototype.stop=function(){this.$log.info("[channelService] === STOPPED ===")},e.prototype.attachHandlers=function(){var e=this;this.$log.info("[callLogService] attachHandlers"),this.xmpp_message_handler&&(this.xmppService.connection.deleteHandler(this.xmpp_message_handler),this.xmpp_message_handler=null),this.xmpp_message_handler=this.xmppService.connection.addHandler(function(t){return e.onChannelMessageReceived(t)},null,"message","headline")},e.prototype.onChannelMessageReceived=function(t){console.dir(t);try{this.$log.info("(handleXMPPConnection) channel message received");var n=t.children[0].children[0].children[0];if("item"===n.nodeName){var r=n.children[0],i={messageId:n.attributes.id.value,channelId:r.attributes.channelId.value,fromJid:r.attributes.from.value,message:r.children[0].textContent||"",title:r.children[1].textContent||"",url:r.children[2].textContent||"",date:new Date(r.attributes.timestamp.value)};this.$rootScope.$broadcast(e.ON_NEW_CHANNEL_MESSAGE_RECEIVED,i),this.$log.info("New channel message"),console.dir(i)}else if("retract"===n.nodeName){var a=n.attributes.id.value;this.$log.info("Retract channel message "+a),this.$rootScope.$broadcast(e.ON_RETRACT_CHANNEL_MESSAGE_RECEIVED,a)}else this.$log.error("Unexpected channel message received")}catch(e){this.$log.error(this.errorHelperService.getErrorFullMessage(e))}return!0},e.prototype.getChannelsList=function(){return this.channelsList},e.prototype.getChannelAndLastMessage=function(e){var t={channel:this.getChannel(e),messages:this.getChannelItems(e,{max:1})};return this.$q.all(t).then(function(e){return e.messages.length>0&&e.channel.attachLastmessage(e.messages[0]),e.channel})},e.prototype.getMyChannels=function(){var e=this;return this.$q(function(t,n){e.$http({method:"GET",url:e.portalURL,headers:e.authService.getRequestHeader()}).then(function(n){e.$log.info("[channelService] getMyChannels success"),console.dir(n);for(var r=[],i=0;i<n.data.data.length;i++)r[i]=e.Channel(n.data.data[i]);t(r)}).catch(function(e){n(e)})})},e.prototype.createChannel=function(e,t,n,r,i){var a=this;return this.$log.info("[channelService] createChannel called with "+e+", topic "+(t||"<none>")),this.$q(function(o,s){var c={name:e};t&&"string"==typeof t&&t.length&&(c.topic=t),n&&"string"==typeof n&&n.length&&(c.visibility=n),r&&"number"==typeof r&&r>0&&(c.max_items=r),i&&"number"==typeof i&&i>0&&(c.max_payload_size=i),a.$http({method:"POST",url:a.portalURL,headers:a.authService.getPostHeader(),data:c}).then(function(e){a.$log.info("[channelService] createChannel successfully");var t=a.Channel(e.data.data);o(t)}).catch(function(e){s(e)})})},e.prototype.deleteChannel=function(e){var t=this;return this.$log.info("[channelService] deleteChannel called for channel id "+e),this.$q(function(n,r){t.$http({method:"DELETE",url:t.portalURL+"/"+e,headers:t.authService.getPostHeader()}).then(function(e){t.$log.info("[channelService] deleteChannel successfully"),n(e)}).catch(function(e){r(e)})})},e.prototype.findChannels=function(e){var t=this;return this.$q(function(n,r){var i="?";e.sortOrder&&-1===e.sortOrder?i+="sortOrder=-1":i+="sortOrder=1",e.name&&(i+="&name="+e.name),e.topic&&(i+="&topic="+e.topic),e.limit&&(i+="&limit="+e.limit),e.offset&&(i+="&offset="+e.offset),e.sortField&&(i+="&sortField="+e.sortField),t.$http({method:"GET",url:t.portalURL+"/search"+i,headers:t.authService.getRequestHeader()}).then(function(e){console.dir(e),t.$log.info("[channelService] findChannels success"),t.$log.info(t.portalURL+"/search"+i);for(var r=[],a=0;a<e.data.data.length;a++)r[a]=t.Channel(e.data.data[a]);n(r)}).catch(function(e){r(e)})})},e.prototype.getChannel=function(e){var t=this;return this.$q(function(n,r){t.$http({method:"GET",url:t.portalURL+"/"+e,headers:t.authService.getRequestHeader()}).then(function(e){t.$log.info("[channelService] getChannel success");var r=t.Channel(e.data.data);n(r)}).catch(function(e){r(e)})})},e.prototype.publishToChannel=function(e,t,n,r){var i=this;return this.$q(function(a,o){var s={message:t,title:n||"",url:r||""};i.$http({method:"POST",url:i.portalURL+"/"+e+"/publish",headers:i.authService.getRequestHeader(),data:s}).then(function(e){i.$log.info("[channelService] publishToChannel success"),a(e)}).catch(function(e){o(e)})})},e.prototype.subscribeToChannel=function(e){var t=this;return this.$q(function(n,r){t.$http({method:"POST",url:t.portalURL+"/"+e+"/subscribe",headers:t.authService.getRequestHeader()}).then(function(e){t.$log.info("[channelService] subscribeToChannel success"),n(e)}).catch(function(e){r(e)})})},e.prototype.unsubscribeToChannel=function(e){var t=this;return this.$q(function(n,r){t.$http({method:"DELETE",url:t.portalURL+"/"+e+"/subscribe",headers:t.authService.getRequestHeader()}).then(function(e){t.$log.info("[channelService] unsubscribeToChannel success"),n(e)}).catch(function(e){r(e)})})},e.prototype.updateChannel=function(e,t,n,r,i){var a=this;return this.$log.info("[channelService] updateChannel with id "+e+", topic "+(t||"<none>")),this.$q(function(o,s){var c={};t&&"string"==typeof t&&t.length&&(c.topic=t),n&&"string"==typeof n&&n.length&&(c.visibility=n),r&&"number"==typeof r&&r>0&&(c.max_items=r),i&&"number"==typeof i&&i>0&&(c.max_payload_size=i),a.$http({method:"PUT",url:a.portalURL+"/"+e,headers:a.authService.getPostHeader(),data:c}).then(function(e){a.$log.info("[channelService] createChannel successfully");var t=e.data.data,n=a.Channel(t);o(n)}).catch(function(e){s(e)})})},e.prototype.getChannelItems=function(e,t){var n=this;return this.$q(function(r,i){n.$http({method:"POST",url:n.portalURL+"/"+e+"/items",headers:n.authService.getRequestHeader(),data:t}).then(function(e){n.$log.info("[channelService] getChannelItems success");for(var t=e.data.data.items,i=[],a=0;a<t.length;a++)i[a]=t[a].item.entry[0],i[a].id=t[a].item.$.id;r(i)}).catch(function(e){console.dir(e),i(e)})})},e.prototype.getChannelUsers=function(e,t){var n=this;return this.$q(function(r,i){var a={};t&&(t.format&&"string"==typeof t.format&&t.format.length&&(a.format=t.format),t.types&&"string"==typeof t.types&&t.types.length&&(a.types=t.types),t.limit&&"number"==typeof t.limit&&t.limit>0&&(a.limit=t.limit),t.offset&&"number"==typeof t.offset&&t.offset>0&&(a.offset=t.offset),t.sortField&&"string"==typeof t.sortField&&t.sortField.length&&(a.sortField=t.sortField),!t.sortOrder||-1!==t.sortOrder&&1!==t.sortOrder||(a.sortOrder=t.sortOrder)),n.$http({method:"GET",url:n.portalURL+"/"+e+"/users",headers:n.authService.getRequestHeader(),data:a}).then(function(e){n.$log.info("[channelService] getChannelUsers success");var t=e.data.data;r(t)}).catch(function(e){i(e)})})},e.prototype.removeAllUsersFromChannel=function(e){var t=this;return this.$q(function(n,r){t.$http({method:"DELETE",url:t.portalURL+"/"+e+"/users",headers:t.authService.getRequestHeader()}).then(function(e){t.$log.info("[channelService] Removed all users from channel success"),n(e)}).catch(function(e){r(e)})})},e.prototype.updateChannelUsers=function(e,t){var n=this;return this.$q(function(r,i){var a=[];console.dir(t);for(var o=0;o<t.length;o++)a[o]={id:t[o].dbId,type:"member"};n.$http({method:"PUT",url:n.portalURL+"/"+e+"/users",headers:n.authService.getRequestHeader(),data:{data:a}}).then(function(e){n.$log.info("[channelService] updateChannelUsers success");var t=e.data.data;r(t)}).catch(function(e){i(e)})})},e.prototype.getPortalInfos=function(){var e=this;return this.$q(function(t,n){e.$http({method:"GET",url:config.restServerUrl+"/api/rainbow/channels/v1.0/about",headers:e.authService.getRequestHeader()}).then(function(n){e.$log.info("[channelService] successfully retrieved portal infos"),t(n.data)}).catch(function(e){n(e)})})},e.CHANNEL_UPDATE_EVENT="CHANNEL_UPDATE_EVENT",e.ON_NEW_CHANNEL_MESSAGE_RECEIVED="ON_NEW_CHANNEL_MESSAGE_RECEIVED",e.ON_RETRACT_CHANNEL_MESSAGE_RECEIVED="ON_RETRACT_CHANNEL_MESSAGE_RECEIVED",e.$inject=["$q","$http","$log","$rootScope","$filter","authService","errorHelperService","xmppService","contactService","Channel"],e}();angular.module("rainbow").service("channelService",channelService),function(){"use strict";angular.module("rainbow").service("fileTransfertService",["$q","$log","$interval","xmppService","Blob",function(e,t,n,r,i){var a=this;this.started=!1,this.start=function(n){t.info(""),t.info("[fileTransfertService] === STARTING ===");var r=performance.now();this.started=!0,this.fsid=12345,this.chunksize=32768,this.fileTransfertHandler=null,this.fileTransferts={},a.attachHandlers();var i=Math.round(performance.now()-r);return n.push({service:"fileTransfertService",startDuration:i}),t.info("[fileTransfertService] === STARTED ("+i+" ms) ==="),e.when()},this.attachHandlers=function(){r.addFileTransfertHandlers(a.ibbHandler,a.fileHandler)},this.stop=function(){return t.info(""),t.info("[fileTransfertService] === STOPPING ==="),this.started=!1,t.info("[fileTransfertService] === STOPPED ==="),e.when()},this.sendFile=function(e,n,r,i){return t.info('[fileTransfertService] send file "'+e.name+'" ('+e.size+") to "+n),this.readFile(e).then(function(e){return a.transfertFile(i,e,n)})},this.addFileTransfertHandler=function(e){this.fileTransfertHandler=e},this.acceptInvitation=function(e,t,n){var i=this.getFileTransferByIndex(e);i.conversation_id=t,i.message_id=n,r.connection.si_filetransfer.responseOk(i.from,i.transfertId,i.requestId)},this.rejectInvitation=function(e){var t=this.getFileTransferByIndex(e);t&&r.connection.si_filetransfer.responseError(t.from,t.transfertId,t.requestId,403)},this.getFileTransferByIndex=function(e){for(var t in this.fileTransferts)if(this.fileTransferts.hasOwnProperty(t)){var n=this.fileTransferts[t];if(n.index===e)return n}return null},this.readFile=function(n,r){var i=e.defer();t.info('[fileTransfertService] readFile "'+n.name+'"');var a=new FileReader;return a.onload=function(e){t.info('[fileTransfertService] readFile "'+n.name+'" success');var r=e.target.result,a=new Uint8Array(r),o=base64EncArr(a);i.resolve(o)},a.onerror=function(e){t.error('[fileTransfertService] readFile "'+n.name+'" failure'+e.target.error.name),i.reject(new Error("ReadFile failure "+e.target.error.name))},r&&(a.onprogress=function(e){if(e.lengthComputable){var t=e.loaded/e.total;t<1&&r(t)}}),a.readAsArrayBuffer(n),i.promise};var o=function(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<12;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}(),s=0;this.transfertFile=function(i,c,l){var u=e.defer(),d="fsid_"+o+s++;return i.transfertId=d,t.info("[fileTransfertService] transfertFile (id:"+d+")"),i.status=FileTransfert.Status.WAIT,r.connection.si_filetransfer.send(l,d,i.filename,i.filesize,i.filetype,i.message,function(e){if(e)return i.status=FileTransfert.Status.REJECT,i.acceptHandler&&i.acceptHandler(!1),u.reject(new Error("TransfertFile : stream init failure "+e)),u.promise;i.status=FileTransfert.Status.TRANSFER,i.acceptHandler&&i.acceptHandler(!0),t.info("[fileTransfertService] open the connection  (id:"+d+")"),r.connection.ibb.open(l,d,a.chunksize,function(e){if(e)return u.reject(new Error("TransfertFile : open IBB failure "+e)),u.promise;i.progressHandler&&(i.progressSurvey=n(function(){i.progressHandler(i.progressValue),i.progressValue>=1&&(i.progressHandler(1),n.cancel(i.progressSurvey))},300));var o,s=c.length,f=0,h=0,p=0;i.progressValue=0;for(var v=function(e){if(e)return u.reject(new Error("TransfertFile : data IBB failure "+e)),u.promise;p+=1,i.progressValue=p*a.chunksize/c.length};s>=a.chunksize;)t.debug("[fileTransfertService] chunk seq: "+h+" size: "+a.chunksize),o=c.slice(f,f+a.chunksize),r.connection.ibb.data(l,d,h,o,v),s-=a.chunksize,f+=a.chunksize,h+=1;s>0&&(t.debug("[fileTransfertService] last chunk seq: "+h+" size: "+s),o=c.slice(f,f+s),r.connection.ibb.data(l,d,h,o,function(e){if(e)return u.reject(new Error("TransfertFile : last chunck data IBB failure "+e)),u.promise;i.progressValue=1,n.cancel(i.progressSurvey)})),i.status=FileTransfert.Status.FINISH,r.connection.ibb.close(l,d,function(e){i.progressValue=1,n.cancel(i.progressSurvey),i.progressHandler(1),t.debug("[fileTransfertService] close IBB success  (id:"+d+")"),u.resolve()})})}),u.promise},this.ibbHandler=function(e,r,o,s,c,l){var u=a.fileTransferts[o];switch(e){case"open":u.buffer="",u.status=FileTransfert.Status.TRANSFER,u.progressValue=0,u.progressHandler&&(u.progressSurvey=n(function(){u.progressHandler(u.progressValue),u.progressValue>=1&&n.cancel(u.progressSurvey)},300));break;case"data":u.buffer+=s,u.progressValue=c*a.chunksize/u.filesize;break;case"close":u.status=FileTransfert.Status.FINISH,u.progressHandler(1);var d=base64DecToArr(u.buffer);d.length===parseInt(u.filesize,10)?t.info("file is OK"):t.info("file has wrong length");var f=new i([d],{type:"application/octet-stream"}),h={data:f,filename:u.filename,conversation_id:u.conversation_id,message_id:u.message_id,transfert_id:u.transfertId};if(config.chromeApp){var p=function(){t.error("cmlsdfjlmkdfjgmdfksjgdfslmkghkfjhggsfk")};chrome.fileSystem.chooseEntry({type:"saveFile",suggestedName:u.filename},function(e){e.createWriter(function(e){e.onerror=p,e.onwriteend=function(){t.log("write complete")},t.error("writedoc"),e.write(f)},p)})}else a.saveAs(h);delete a.fileTransferts[o];break;default:throw new Error("shouldn't be here.")}},this.fileHandler=function(e,t,n,r,i,o,s){var c=new FileTransfert(e,t,n,r,i,o,s);a.fileTransferts[t]=c,a.fileTransfertHandler&&a.fileTransfertHandler(c)}}])}(),angular.module("rainbow").service("companyService",["$q","$log","$http","$rootScope","authService","errorHelperService","userInfoService","Company",function(e,t,n,r,i,a,o,s){"use strict";var c=this;c.start=function(n){t.info(""),t.info("[companyService] === STARTING ===");var i=performance.now();c.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/",c.companies={};var a=Math.round(performance.now()-i);return n.push({service:"companyService",startDuration:a}),t.info("[companyService] === STARTED ("+a+" ms) ==="),r.$on("$destroy",r.$on("ON_COMPANY_CHANGE_EVENT",function(e,t){c.getCompanyById(t,!0)})),e.when()},c.stop=function(){return t.info(""),t.info("[companyService] === STOPPING ==="),t.info("[companyService] === STOPPED ==="),c.companies={},e.when()},c.searchCompanies=function(r,o,l,u){return e(function(e,d){var f=c.portalURL+"companies?name="+r+"&format=full";void 0!==o&&null!==o&&(f+="&hasBP="+o),void 0!==l&&null!==l&&(f+="&isBP="+l),u&&(f+="&bpType="+u),n({method:"GET",url:f,headers:i.getRequestHeader()}).then(function(n){var i=n.data.data,a=[];angular.forEach(i,function(e){if("Default"!==e.name&&"Rainbow"!==e.name&&"active"===e.status){var t=c.companies[e.id];t||(t=s.createFromData(e),c.companies[t.id]=t,c.getCompanyLogo(t)),a.push(t)}}),t.info("[companyService] searchCompanies with criteria"+r+" - success - found "+i.length+" companies"),e(a)},function(e){var n=a.handleError(e);t.error("[companyService] "+a.getErrorFullMessage(e,"searchCompanies")),d(n)})})},c.getCompanyById=function(r,o){return e(function(e,l){var u=c.companies[r];u&&!o?(t.info("[companyService] getCompanyById (cache) "+r+" - success"),e(u)):n({method:"GET",url:c.portalURL+"companies/"+r,headers:i.getRequestHeader()}).then(function(n){var i=n.data.data;u?(u.updateFromData(i),t.info("[companyService] getCompanyById (update) "+r+" - success")):(u=s.createFromData(i),c.companies[u.id]=u,t.info("[companyService] getCompanyById "+r+" - success")),c.getCompanyLogo(u),c.getCompanyBanner(u),e(u)},function(e){var n=a.handleError(e);t.error("[companyService] "+a.getErrorFullMessage(e,"getCompanyById")),l(n)})})},c.getAdministratorIds=function(r){return e(function(e,o){var s=c.portalURL+"companies/"+r+"/administrators";n({method:"GET",url:s,headers:i.getRequestHeader()}).then(function(n){var r=[];n.data.data.forEach(function(e){r.push(e.id)}),t.info("[companyService] getAdministratorIds success)"),e(r)},function(e){var n=a.handleError(e);t.error("[companyService] "+a.getErrorFullMessage(e,"getAdministratorIds")),o(n)})})},c.getCompanyLogo=function(n){return e(function(e,i){var a=o.computeUserColor(n.name),s=n.name.substr(0,1);o.getAvatarImage(n.id,s,a.color,130,n.lastAvatarUpdateDate).then(function(i){n.logo=i,r.$broadcast("ON_COMPANY_LOGO_UPDATED",n.id),t.info("[companyService] getCompanyLogo - "+n.name+" - success"),e(i)}).catch(function(e){t.error("[companyService] getCompanyLogo - failure - "+e.message),i(e)})})},c.getCompanyBanner=function(n){return e(function(e){var i=new Image;if(n.lastBannerUpdateDate){var a=config.webservices.protocol+"://"+config.webservices.currentServer;r.cdn&&(a=r.cdnServer);var o=a+"/api/banner/"+n.id+"?size=831";o+="&update="+MD5.hexdigest(n.lastBannerUpdateDate),i.onload=function(){var i=this;r.$apply(function(){n.banner=i,r.$broadcast("ON_COMPANY_BANNER_UPDATED",n.id),t.log("[companyService] Load banner for "+n.name+" success"),e(i)})},i.onerror=function(){r.$apply(function(){t.warn("[companyService] Load banner for "+n.name+" failure"),e(null)})},i.src=o}else i.src="/cache/company-banner-01.svg",n.banner=i,r.$broadcast("ON_COMPANY_BANNER_UPDATED",n.id),t.log("[companyService] Load default banner for "+n.name+" success"),e(i)})}}]),function(){"use strict";angular.module("rainbow").service("browserService",[function(){this.extractBrowserVersion=function(e,t,n){var r=e.match(t);return r&&r.length>=n&&parseInt(r[n],10)}}])}(),angular.module("rainbow").service("gRTCStatsService",[function(){"use strict";var e={};this.resetStatsForAllCalls=function(){e={}},this.resetStatsForCall=function(t){t in e&&delete e[t]},this.getCalls=function(){return e},this.nbCalls=function(){return Object.keys(e).length},this.hasStatsForCall=function(t){return t in e},this.addStreamToCall=function(t,n){t in e||(e[t]={});var r=e[t];r[n.id]={},r[n.id].stream=n},this.nbStreamsInACall=function(t){return t in e?Object.keys(e[t]).length:0},this.getBundlePolicyForCall=function(t){if(!(t in e))return"unknown";var n=e[t],r=0,i=this.nbStreamsInACall(t);for(var a in n)"selectedCandidatePairId"in n[a].stream&&r++;if(4===i)switch(r){case 0:return"failed";case 1:return"max-bundle";case 2:return"balanced";case 4:return"max-compat";default:return"unknown"}else{if(2!==i)return"unknown";switch(r){case 0:return"failed";case 1:return"max-bundle";case 2:return"max-compat";default:return"unknown"}}},this.addSSRCToStream=function(t,n){var r,i=null;"ssrc"===n.type&&t in e&&(r=e[t],n.transportId in r&&((i=r[n.transportId]).ssrc||(i.ssrc={}),i.ssrc[n.ssrc]=n))},this.hasSSRCInStream=function(t,n,r){var i,a;return t in e&&(n in(i=e[t])&&(!!(a=i[n]).ssrc&&r in a.ssrc))},this.getSSRCMediaType=function(t,n,r){var i,a;return t in e&&n in(i=e[t])&&(a=i[n]).ssrc&&r in a.ssrc?a.ssrc[r].mediaType:"unknown"},this.getSSRCDirection=function(n,r,i){var a,o,s;return n in e&&r in(a=e[n])&&(o=a[r]).ssrc&&i in o.ssrc?(s=o.ssrc[i],t(s.id)):"unknown"},this.getSSRCAudioCodecName=function(t,n,r){var i,a;return t in e&&n in(i=e[t])&&(a=i[n]).ssrc&&r in a.ssrc?a.ssrc[r].googCodecName:"unknown"},this.isSSRCFlowing=function(n,r,i){var a,o,s;if(!(n in e))return!1;if(!(r in(a=e[n])))return!1;if(!(o=a[r]).ssrc)return!1;if(!(i in o.ssrc))return!1;s=o.ssrc[i];return("IN"===t(s.id)?parseInt(s.bytesReceived,10):parseInt(s.bytesSent,10))>0},this.getStreamsDetailsFromCall=function(t){var n=null,r=null;if(!(t in e))return[];n=e[t];var i=[];for(var a in n)if(n.hasOwnProperty(a)){r=n[a];var o="no",s="no",c=!1,l=!1,u=!1,d=!1;for(var f in r.ssrc)if(r.ssrc&&r.ssrc.hasOwnProperty&&r.ssrc.hasOwnProperty(f)){var h=this.getSSRCMediaType(t,a,f),p=this.getSSRCDirection(t,a,f),v=this.isSSRCFlowing(t,a,f);"audio"===h&&"IN"===p&&v?c=!0:"audio"===h&&"OUT"===p&&v?u=!0:"video"===h&&"IN"===p&&v?l=!0:"video"===h&&"OUT"===p&&v&&(d=!0)}c&&u?o="IN|OUT":c?o="IN":u&&(o="OUT"),l&&d?s="IN|OUT":l?s="IN":d&&(s="OUT"),c||u||l||d?i.push({id:a,streams:{audio:o,video:s}}):i.push({id:a,streams:{}})}return i},this.getCodecDetailsFromCall=function(t){var n=null,r=null,i="-",a="-",o={codec:{audio:i,video:a}};if(!(t in e))return o;n=e[t];for(var s in n)if(n.hasOwnProperty(s)){r=n[s];for(var c in r.ssrc)"audio"===r.ssrc[c].mediaType&&(i=this.getSSRCAudioCodecName(t,s,c)),"video"===r.ssrc[c].mediaType&&(a=this.getSSRCAudioCodecName(t,s,c))}return o.codec.audio=i,o.codec.video=a,o};var t=function(e){return e.indexOf("recv")>-1?"IN":"OUT"}}]),angular.module("rainbow").service("fRTCStatsService",[function(){"use strict";var e={};this.getCalls=function(){return e},this.nbCalls=function(){return Object.keys(e).length},this.addStreamToCall=function(t,n){if(!n.isRemote){t in e||(e[t]={});var r=e[t];r.streams||(r.streams={}),r.streams[n.id]={},r.streams[n.id]=n}},this.nbStreamsInACall=function(t){return t in e?Object.keys(e[t].streams).length:0},this.resetStatsForAllCalls=function(){e={}},this.resetStatsForCall=function(t){t in e&&delete e[t]},this.hasStatsForCall=function(t){return t in e},this.hasSSRCInStream=function(t,n,r){var i;return t in e&&(!!(i=e[t]).streams&&(n in i.streams&&i.streams[n].ssrc===r))},this.hasStreamInCall=function(t,n){return t in e&&n in e[t].streams},this.getSSRCMediaType=function(t,n){var r;return t in e&&n in(r=e[t]).streams?r.streams[n].mediaType:"unknown"},this.getStreamsDetailsFromCall=function(n){var r=null;if(!(n in e))return[];r=e[n];var i=[];for(var a in r.streams)if(r.streams.hasOwnProperty(a)){var o=this.getSSRCMediaType(n,a),s=t(a);"audio"===o?i.push({id:a,streams:{audio:s}}):"video"===o&&i.push({id:a,streams:{video:s}})}return i},this.addCandidatePairToCall=function(t,n){var r=null,i=!1;if(t in e){(r=e[t]).candidatesPairs||(r.candidatesPairs=[]);for(var a=0;a<r.candidatesPairs.length;a++)if(r.candidatesPairs[a].id===n.id){i=!0;break}!i&&"succeeded"===n.state&&n.selected&&r.candidatesPairs.push(n)}},this.getNbCandidatePairs=function(t){var n,r=0;return t in e?((n=e[t]).candidatesPairs&&(r=n.candidatesPairs.length),r):r},this.getBundlePolicyForCall=function(t){var n="unknown";if(!(t in e))return n;switch(this.getNbCandidatePairs(t)){case 0:n="failed";break;case 1:n="max-bundle";break;case 2:n=this.nbStreamsInACall(t)>2?"balanced":"max-compat";break;default:n="max-compat"}return n};var t=function(e){return e.indexOf("inbound")>-1?"IN":"OUT"}}]),angular.module("rainbow").service("platformService",["$log","$rootScope","$window","$interval","settingsService","$q","$filter","$http","authService","errorHelperService",function(e,t,n,r,i,a,o,s,c,l){"use strict";var u=this,d=[];u.$q=a,this.isWin=navigator.platform.toUpperCase().indexOf("WIN")>=0,u.start=function(n){return a(function(i,a){var o=performance.now();e.info(""),e.info("[platformService] === STARTING ==="),u.languages=["en","fr","es","de","it"],u.isDesktop()?u.getCurrentMicrophone().then(function(e){i(e)}).catch(function(t){e.error("[platformService] === STARTING FAILURE === "+t.message),a(t)}):i(),d.push(t.$on("$translateChangeSuccess",function(){u.fixDeviceLabels()})),d.push(t.$on("ON_INPUT_DEVICE_CHANGED_EVENT",S)),d.push(t.$on("ON_OUTPUT_DEVICE_CHANGED_EVENT",C)),u.isAskingMedia=!1,u.hasAudioPermission=!1,u.hasVideoPermission=!1,u.stopWatcher(),r(u.startWatcher,2e3,1);var s=Math.round(performance.now()-o);n.push({service:"platformService",startDuration:s}),e.info("[platformService] === STARTED ("+s+" ms) ===")})},u.stop=function(){return e.info("[platformService] === STOPPING ==="),d.forEach(function(e){e()}),u.stopWatcher(),e.info("[platformService] === STOPPED ==="),a.when()},this.audioDevices=0,this.videoDevices=0,this.detectRTCLoaded=function(){u.hasAudioPermission=DetectRTC.isWebsiteHasMicrophonePermissions,u.hasVideoPermission=DetectRTC.isWebsiteHasWebcamPermissions,u.fixDeviceLabels();var t=!1,n=!1,r=u.shouldAskGetUserMedia();(DetectRTC.audioInputDevices&&DetectRTC.audioInputDevices.length||DetectRTC.audioOutputDevices&&DetectRTC.audioOutputDevices.length)&&(!u.hasAudioPermission||r.audio?t=!0:h=!0),DetectRTC.videoInputDevices&&DetectRTC.videoInputDevices.length&&(!u.hasVideoPermission||r.video?n=!0:f=!0),t||n?u.isAskingMedia||(u.isAskingMedia=!0,u.getUserMedia(t,n)):(_(),M(),S(),u.audioDevices!==DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length&&(u.audioDevices=DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length,u.audioMediaDeviceUpdated()),u.videoDevices!==DetectRTC.videoInputDevices.length&&(u.videoDevices=DetectRTC.videoInputDevices.length,u.videoMediaDeviceUpdated()),angular.forEach(DetectRTC.MediaDevices,function(t){t&&e.info("[PlatformService] DetectRTC.MediaDevices device "+t.id+" with kind "+t.kind+" with label "+t.label)}),u.startWatcher())},this.shouldAskGetUserMedia=function(){var t={audio:!1,video:!1};return angular.forEach(DetectRTC.MediaDevices,function(e){e&&e.label&&-1!==e.label.indexOf("invoke getUserMedia")&&("audioinput"===e.kind||"audiooutput"===e.kind?t.audio=!0:t.video=!0)}),e.info("[platformService] shouldAskGetUserMedia : audio "+t.audio+" and video "+t.video),t},this.mediaDevicesLength=0,this.mediaDevices=[],this.devicesWatcher=function(){navigator.mediaDevices.enumerateDevices().then(function(t){u.mediaDevicesLength!==t.length&&(e.debug("[platformService] MediaDevices count changed ! from "+u.mediaDevicesLength+" to "+t.length),e.debug("[platformService] MediaDevices brut devices list "+JSON.stringify(t)),u.mediaDevicesLength=t.length,u.mediaDevices=t,u.stopWatcher(),DetectRTC.load(u.detectRTCLoaded))})},u.getUserMedia=function(n,r){navigator.mediaDevices.getUserMedia({audio:n,video:r}).then(function(t){angular.forEach(t.getAudioTracks(),function(e){e.stop()}),angular.forEach(t.getVideoTracks(),function(e){e.stop()}),n&&(u.hasAudioPermission=!0,h=!0),r&&(u.hasVideoPermission=!0,f=!0),DetectRTC.load(function(){u.fixDeviceLabels(),_(),M(),S(),u.isAskingMedia=!1,u.audioDevices!==DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length&&(u.audioDevices=DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length,u.audioMediaDeviceUpdated()),u.videoDevices!==DetectRTC.videoInputDevices.length&&(u.videoDevices=DetectRTC.videoInputDevices.length,u.videoMediaDeviceUpdated()),angular.forEach(DetectRTC.MediaDevices,function(t){t&&e.info("[PlatformService] DetectRTC.MediaDevices device "+t.id+" with kind "+t.kind+" with label "+t.label)}),u.startWatcher()})}).catch(function(n){e.error(n),h=!1,f=!1,u.isAskingMedia=!1;t.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"information",popupBody:"devicePermission",okLabel:"ok"}),u.startWatcher()})},u.getWhatsNew=function(){return a(function(t){var n=config.restServerUrl+"/api/rainbow/enduser/v1.0/settings/changelogs";s({method:"GET",url:n,headers:c.getRequestHeader()}).then(function(n){e.info("[adminPlatformService] getWhatsNew -- success");var r={};n.data.data.changeLog.split("%").forEach(function(e,t){r[u.languages[t]]=e}),Object.keys(r).forEach(function(e){0===r[e].length&&(r[e]=r.en)}),r.en||(r={en:"",fr:"",es:"",de:"",it:""}),t(r)},function(n){t({en:"",fr:"",es:"",de:"",it:""}),e.error("[adminPlatformService] "+l.getErrorFullMessage(n,"getWhatsNew"))})})},u.getAvailableLanguage=function(e){var t=e.split("-")[0],n=u.languages.find(function(e){return e===t});return n||"en"},this.isDesktop=function(){return navigator.userAgent.indexOf(" Rainbow/")>=0},this.allowDevicesManagement=function(){return n.chrome||this.isDesktop()};var f=!1;this.isWebsiteHasWebcamPermissions=function(){return!!u.allowDevicesManagement()&&f};var h=!1;this.isWebsiteHasMicrophonePermissions=function(){return!!u.allowDevicesManagement()&&h};var p={HANDFREE:{key:1,value:"handfree",available:!1},HEADSET:{key:2,value:"headset",available:!1},SPEAKERPHONE:{key:3,value:"speakerphone",available:!1},CUSTOM:{key:4,value:"custom",available:!1}};this.audioProfileEnum=p,this.getAudioProfiles=function(){return p},this.currentAudioProfile=p.HANDFREE,this.getCurrentAudioProfile=function(){var e=null;switch(i.getSetting("audioProfile")){case p.HEADSET.value:e=p.HEADSET;break;case p.HANDFREE.value:e=p.HANDFREE;break;case p.SPEAKERPHONE.value:e=p.SPEAKERPHONE;break;case p.CUSTOM.value:e=p.CUSTOM;break;default:e=p.HANDFREE,i.setSetting("audioProfile",e.value)}return e},this.getActiveAudioProfile=function(){var e=this.getCurrentAudioProfile();return e.key===p.HANDFREE.key||e.available?e:p.HANDFREE},this.setCurrentAudioProfile=function(e){e&&(u.currentAudioProfile=e)},this.isHandfreeAvailable=function(){return u.isHandfreeMicrophoneAvailable()&&u.isHandfreeSpeakerAvailable()},this.isHeadsetAvailable=function(){return u.isHeadsetMicrophoneAvailable()&&u.isHeadsetSpeakerAvailable()},this.isSpeakerphoneAvailable=function(){return u.isSpeakerphoneMicrophoneAvailable()&&u.isSpeakerphoneSpeakerAvailable()},this.isCustomAvailable=function(){return u.isCustomMicrophoneAvailable()&&u.isCustomSpeakerAvailable()},this.getCurrentMicrophone=function(){if("sdk"===i.getSetting("apiMode")){var e=u.getMicrophoneForSDK();if(e)return e}switch(u.getActiveAudioProfile()){case p.SPEAKERPHONE:return u.getSpeakerphoneMicrophone();case p.CUSTOM:return u.getCustomMicrophone();case p.HEADSET:return u.getHeadsetMicrophone();default:return u.getHandfreeMicrophone()}},this.getMicrophoneForSDK=function(){var e=a.defer();return u.getMicrophones().then(function(t){e.resolve(u.getDeviceWithId(t,i.getSetting("microphone")))}),e.promise},this.getSecondRingerStatusFromSettings=function(){return i.getSetting("hasSecondRinger")},this.setSecondRingerStatusFromSettings=function(e){return i.setSetting("hasSecondRinger",e)},this.getHandfreeMicrophoneFromSettings=function(){return i.getSetting("microphone")},this.getHandfreeMicrophone=function(){var e=a.defer();return u.getMicrophones().then(function(t){e.resolve(u.getDeviceWithId(t,u.getHandfreeMicrophoneFromSettings()))}),e.promise},this.getHeadsetMicrophoneFromSettings=function(){return i.getSetting("headsetMicrophone")},this.getHeadsetMicrophone=function(){var e=a.defer();return u.getMicrophones().then(function(t){e.resolve(u.getDeviceWithId(t,u.getHeadsetMicrophoneFromSettings()))}),e.promise},this.getHeadsetDeviceName=function(){var e=a.defer();return e.resolve(i.getSetting("headsetDeviceName")),e.promise},this.getSpeakerphoneMicrophoneFromSettings=function(){return i.getSetting("speakerphoneMicrophone")},this.getSpeakerphoneMicrophone=function(){var e=a.defer();return u.getMicrophones().then(function(t){e.resolve(u.getDeviceWithId(t,u.getSpeakerphoneMicrophoneFromSettings()))}),e.promise},this.getSpeakerphoneDeviceName=function(){var e=a.defer();return e.resolve(i.getSetting("speakerphoneDeviceName")),e.promise},this.getCustomMicrophoneFromSettings=function(){return i.getSetting("customMicrophone")},this.getCustomMicrophone=function(){var e=a.defer();return u.getMicrophones().then(function(t){e.resolve(u.getDeviceWithId(t,u.getCustomMicrophoneFromSettings()))}),e.promise},this.getMicrophones=function(){var t=a.defer();return this.allowDevicesManagement()||t.resolve([]),u.getAudioInputDevices().then(function(e){t.resolve(e&&e.constructor===Array&&h?e:[])}).catch(function(n){return e.info("[PlatformService] === SERVICES FAILURE === : "+n.message),t.reject(n),t.promise}),t.promise},this.isHandfreeMicrophoneAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getHandfreeMicrophoneFromSettings(),"audioinput")},this.isHeadsetMicrophoneAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getHeadsetMicrophoneFromSettings(),"audioinput")},this.isSpeakerphoneMicrophoneAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getSpeakerphoneMicrophoneFromSettings(),"audioinput")},this.isCustomMicrophoneAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getCustomMicrophoneFromSettings(),"audioinput")},this.getCurrentSpeaker=function(){if("sdk"===i.getSetting("apiMode")){var e=u.getSpeakerForSDK();if(e)return e}switch(u.getActiveAudioProfile()){case p.SPEAKERPHONE:return u.getSpeakerphoneSpeaker();case p.CUSTOM:return u.getCustomSpeaker();case p.HEADSET:return u.getHeadsetSpeaker();default:return u.getHandfreeSpeaker()}},this.getSpeakerForSDK=function(){var e=a.defer();return u.getSpeakers().then(function(t){e.resolve(u.getDeviceWithId(t,i.getSetting("speaker")))}),e.promise},this.getHandfreeSpeakerFromSettings=function(){return i.getSetting("speaker")},this.getHandfreeSpeaker=function(){var e=a.defer();return u.getSpeakers().then(function(t){e.resolve(u.getDeviceWithId(t,u.getHandfreeSpeakerFromSettings()))}),e.promise},this.getHeadsetSpeakerFromSettings=function(){return i.getSetting("headsetSpeaker")},this.getHeadsetSpeaker=function(){var e=a.defer();return u.getSpeakers().then(function(t){e.resolve(u.getDeviceWithId(t,u.getHeadsetSpeakerFromSettings()))}),e.promise},this.getSpeakerphoneSpeakerFromSettings=function(){return i.getSetting("speakerphoneSpeaker")},this.getSpeakerphoneSpeaker=function(){var e=a.defer();return u.getSpeakers().then(function(t){e.resolve(u.getDeviceWithId(t,u.getSpeakerphoneSpeakerFromSettings()))}),e.promise},this.getCustomSpeakerFromSettings=function(){return i.getSetting("customSpeaker")},this.getCustomSpeaker=function(){var e=a.defer();return u.getSpeakers().then(function(t){e.resolve(u.getDeviceWithId(t,u.getCustomSpeakerFromSettings()))}),e.promise},this.getRingingSpeakerFromSettings=function(){return i.getSetting("ringingSpeaker")},this.getRingingSpeaker=function(){var e=a.defer();return u.getSpeakers().then(function(t){e.resolve(u.getDeviceWithId(t,u.getRingingSpeakerFromSettings()))}),e.promise},this.setSpeakerForElement=function(t,n){var r=a.defer();if(!t||!t.setSinkId)return e.warn("[platformService] setSpeakerForElement -- missing element"),a.when();if(this.allowDevicesManagement()){if(n===t.sinkId)return a.when();t.id&&e.log("[platformService] setSpeakerForElement "+t.id+" with "+n),t.setSinkId(n).then(function(){e.log("[platformService] Success, audio output device attached: "+n),angular.element("#globalAudioTag")[0]&&e.log("[platformService] sinkId for globalAudioTag is "+angular.element("#globalAudioTag")[0].sinkId),r.resolve()}).catch(function(t){var n=t;"SecurityError"===t.name&&(n="[platformService] You need to use HTTPS for selecting audio output device: "+t),e.error("[platformService] "+n),r.resolve()})}else e.warn("[platformService] Browser does not support output device selection."),r.resolve();return r.promise},this.getSpeakers=function(){var t=a.defer();return u.allowDevicesManagement()||t.resolve([]),u.getAudioOutputDevices().then(function(e){t.resolve(e&&e.constructor===Array&&h?e:[])}).catch(function(n){return e.info("[PlatformService] === SERVICES FAILURE === : "+n.message),t.reject(n),t.promise}),t.promise},this.isHandfreeSpeakerAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getHandfreeSpeakerFromSettings(),"audiooutput")};var v=!1;this.isHeadsetSpeakerAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getHeadsetSpeakerFromSettings(),"audiooutput")};var m=!1;this.isSpeakerphoneSpeakerAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getSpeakerphoneSpeakerFromSettings(),"audiooutput")};var g=!1;this.isCustomSpeakerAvailable=function(){return u.isDeviceAvailable(u.mediaDevices,u.getCustomSpeakerFromSettings(),"audiooutput")};var E=!1;function S(){var n,r,i,a;n=u.isHandfreeAvailable(),v!==n&&(e.info("[PlatformService] Handfree is now "+(n?"available":"unavailable")),v=n,p.HANDFREE.available=n,t.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",n),t.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),n||u.getCurrentSpeaker().then(function(e){b(e.id)})),r=u.isHeadsetAvailable(),m!==r&&(e.info("[PlatformService] Headset is now "+(r?"available":"unavailable")),m=r,p.HEADSET.available=r,t.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",r),t.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),r||u.getCurrentSpeaker().then(function(e){b(e.id)})),i=u.isSpeakerphoneAvailable(),g!==i&&(e.info("[PlatformService] Speakerphone is now "+(i?"available":"unavailable")),g=i,p.SPEAKERPHONE.available=i,t.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",i),t.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),i||u.getCurrentSpeaker().then(function(e){b(e.id)})),a=u.isCustomAvailable(),E!==a&&(e.info("[PlatformService] Custom is now "+(a?"available":"unavailable")),E=a,p.CUSTOM.available=a,t.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",a),t.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),a||u.getCurrentSpeaker().then(function(e){b(e.id)}))}function C(t,n){S(),e.info("[PlatformService] updateOutputDevice "+n),u.allowDevicesManagement()&&n&&b(n)}function b(t){e.info("[PlatformService] updateCurrentOutputDevice "+t),angular.element("#globalAudioTag")[0]&&angular.element("#globalAudioTag")[0].sinkId!==t&&(e.info("[PlatformService] updateCurrentOutputDevice current ID "+angular.element("#globalAudioTag")[0].sinkId+" new id "+t),u.setSpeakerForElement(angular.element("#globalAudioTag")[0],"default").then(function(){u.setSpeakerForElement(angular.element("#globalAudioTag")[0],t)}))}var R=[],y=[],N=[],T=[],A=[],I=!0,O=!0,D=["jabra speak","calisto p6","sp10","sp20","sp220"],w=["realtek","soundmax","high definition audio"];u.arrayContains=function(e,t){return e.some(function(e){return t.indexOf(e)>-1})},u.getDeviceType=function(e){return e=e.toLowerCase(),u.arrayContains(w,e)?p.HANDFREE:u.arrayContains(D,e)?p.SPEAKERPHONE:p.HEADSET},this.normalizeAnyLabel=function(e){return e?(e.normalizedLabel||(u.isWin?e.normalizedLabel=e.label.substring(e.label.indexOf("(")+1,e.label.lastIndexOf(")")):e.normalizedLabel=e.label),e):null};var _=function(){var n=a.defer();return u.getMicrophones().then(function(e){return R=e,u.getSpeakers()}).then(function(r){y=r;var i=[];angular.forEach(R,function(e){"default"!==e.id&&"communications"!==e.id&&(e=u.normalizeAnyLabel(e),i.some(function(t){return t.microphone.normalizedLabel===e.normalizedLabel})||angular.forEach(y,function(t){if(t=u.normalizeAnyLabel(t),e.normalizedLabel===t.normalizedLabel&&u.getDeviceType(e.normalizedLabel)===p.HEADSET){var n={label:e.normalizedLabel,microphone:e,speaker:t};i.push(n),I&&N.push(n)}}))});var a=[];!I&&T.length<i.length&&(angular.forEach(i,function(e){T.some(function(t){return t.label===e.label})||(a.push(e),N.push(e))}),a.length>0&&(e.info("[PlatformService] hotplugged headset(s): "+(a.length>1?a.reduce(function(e,t){return{label:e.Label+", "+t.Label}}).label:a[0].label)),t.$broadcast("ON_AUDIO_HOTPLUG_DEVICES_CHANGED_EVENT",{devices:a,action:"add"})));var o=[];!I&&T.length>i.length&&(angular.forEach(T,function(e){if(!i.some(function(t){return t.label===e.label})){o.push(e);var t=N.map(function(e){return e.label}).indexOf(e.label);N.splice(t,1)}}),o.length>0&&(e.info("[PlatformService] unplugged headset(s): "+(o.length>1?o.reduce(function(e,t){return{label:e.Label+", "+t.Label}}).label:o[0].label)),t.$broadcast("ON_AUDIO_HOTPLUG_DEVICES_CHANGED_EVENT",{devices:o,action:"remove"}))),I=!1,T=i,n.resolve(i)}),n.promise};this.getHeadsetDevices=function(){return T};var P,M=function(){var n=a.defer();return u.getMicrophones().then(function(e){return R=e,u.getSpeakers()}).then(function(r){y=r;var i=[];angular.forEach(R,function(e){"default"!==e.id&&"communications"!==e.id&&(e=u.normalizeAnyLabel(e),i.some(function(t){return t.microphone.normalizedLabel===e.normalizedLabel})||angular.forEach(y,function(t){if(t=u.normalizeAnyLabel(t),e.normalizedLabel===t.normalizedLabel&&u.getDeviceType(e.normalizedLabel)===p.SPEAKERPHONE){var n={label:e.normalizedLabel,microphone:e,speaker:t};i.push(n),O&&N.push(n)}}))});var a=[];!O&&A.length<i.length&&(angular.forEach(i,function(e){A.some(function(t){return t.label===e.label})||(a.push(e),N.push(e))}),a.length>0&&(e.info("[PlatformService] hotplugged speakerphone(s): "+(a.length>1?a.reduce(function(e,t){return{label:e.Label+", "+t.Label}}).label:a[0].label)),t.$broadcast("ON_AUDIO_HOTPLUG_DEVICES_CHANGED_EVENT",{devices:a,action:"add"})));var o=[];!O&&A.length>i.length&&(angular.forEach(A,function(e){if(!i.some(function(t){return t.label===e.label})){o.push(e);var t=N.map(function(e){return e.label}).indexOf(e.label);N.splice(t,1)}}),o.length>0&&(e.info("[PlatformService] unplugged speakerphone(s): "+(o.length>1?o.reduce(function(e,t){return{label:e.Label+", "+t.Label}}).label:o[0].label)),t.$broadcast("ON_AUDIO_HOTPLUG_DEVICES_CHANGED_EVENT",{devices:o,action:"remove"}))),O=!1,A=i,n.resolve(i)}),n.promise};this.getSpeakerphoneDevices=function(){return A},this.getAllDevices=function(){return N},this.getHandFreeDevice=function(){var e=a.defer();return u.getHandfreeMicrophone().then(function(t){var n=t;u.getHandfreeSpeaker().then(function(t){var r=t;(!u.handFreeDevice||u.handFreeDevice.microphone&&u.handFreeDevice.microphone.id!==n.id||u.handFreeDevice.speaker&&u.handFreeDevice.speaker.id!==r.id)&&(u.handFreeDevice={label:"",microphone:n,speaker:r,profile:p.HANDFREE}),e.resolve(u.handFreeDevice)})}),e.promise},this.getCustomDevice=function(){var e=a.defer();return u.getCustomMicrophone().then(function(t){var n=t;u.getCustomSpeaker().then(function(t){var r=t;(!u.customDevice||u.customDevice.microphone&&u.customDevice.microphone.id!==n.id||u.customDevice.speaker&&u.customDevice.speaker.id!==r.id)&&(u.customDevice={label:"",microphone:n,speaker:r,profile:p.CUSTOM}),e.resolve(u.customDevice)})}),e.promise},this.getAvailableDevices=function(){var e=a.defer(),t=[];return u.getHandFreeDevice().then(function(n){t.push(n),T.forEach(function(e){e.profile=p.HEADSET,t.push(e)}),A.forEach(function(e){e.profile=p.SPEAKERPHONE,t.push(e)}),u.getCustomDevice().then(function(n){t.push(n),e.resolve(t)})}),e.promise},this.getStoredDeviceList=function(){return i.getSetting("deviceList")},this.saveDeviceList=function(e){for(var t=[],n=0;n<e.length;n++)t[n]=e[n].label;i.setSetting("deviceList",angular.toJson(t))},this.getCurrentCamera=function(){var e=a.defer();return u.getCameras().then(function(t){e.resolve(u.getDeviceWithId(t,i.getSetting("camera")))}),e.promise},this.getCameraForSDK=function(){return{id:i.getSetting("camera")}},this.getCameras=function(){var t=a.defer();return this.allowDevicesManagement()||t.resolve([]),u.getVideoInputDevices().then(function(e){t.resolve(e&&e.constructor===Array&&f?e:[])}).catch(function(n){return e.info("[PlatformService] === SERVICES FAILURE === : "+n.message),t.reject(n),t.promise}),t.promise},this.isDeviceAvailable=function(e,t,n){var r=e.find(function(e){return e.kind===n&&e.deviceId===t});return angular.isDefined(r)},this.getDeviceWithId=function(e,t){if(e.constructor!==Array)return null;var n=e.find(function(e){return e.id===t});return n||(n=e.find(function(e){return"default"===e.id})),n||(e.length>0?e[0]:null)},this.startWatcher=function(){if(u.allowDevicesManagement()){if(angular.isDefined(P))return;P=r(u.devicesWatcher,1e3)}},this.stopWatcher=function(){angular.isDefined(P)&&(r.cancel(P),P=void 0)},this.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},this.fixDeviceLabels=function(){angular.forEach(DetectRTC.MediaDevices,function(t){t&&("default"===t.id?"audioinput"===t.kind?t.label=o("translate")("yourComputerMicrophoneDevice"):"audiooutput"===t.kind&&(t.label=o("translate")("yourComputerSpeakerDevice")):t.id.length<64&&"Please invoke getUserMedia once."===t.label&&(t.label=u.capitalizeFirstLetter(t.id)),e.info("[PlatformService] fixDeviceLabels || update device "+t.id+" with kind "+t.kind+" with label "+t.label))})},this.updatePermissions=function(){var e=!1;return angular.forEach(DetectRTC.MediaDevices,function(t){t&&t.id.length>=64&&("Please invoke getUserMedia once."===t.label?e=!0:("videoinput"!==t.kind||f||(f=!0),"audioinput"!==t.kind||h||(h=!0)))}),e},this.isGetUserMediaRequested=function(){return(!f||!h)&&u.updatePermissions(DetectRTC.MediaDevices)},this.audioMediaDeviceUpdated=function(){u.fixDeviceLabels(),t.$broadcast("ON_USER_AUDIO_MEDIA_CHANGED_EVENT")},this.videoMediaDeviceUpdated=function(){u.fixDeviceLabels(),t.$broadcast("ON_USER_VIDEO_MEDIA_CHANGED_EVENT")};var U=function(e){var t=[];return angular.forEach(e,function(e){t.some(function(t){return t.id===e.id})||t.push(e)}),t};this.getAudioInputDevices=function(){var e=a.defer();return e.resolve(U(DetectRTC.audioInputDevices)),e.promise},this.getAudioOutputDevices=function(){var e=a.defer();return e.resolve(U(DetectRTC.audioOutputDevices)),e.promise},this.getVideoInputDevices=function(){var e=a.defer();return e.resolve(U(DetectRTC.videoInputDevices)),e.promise}}]),angular.module("rainbow").service("gaService",[function(){"use strict";var e={category:"webrtc",action:"CallsSuccessRate",label:"error_failed"},t={category:"webrtc",action:"CallsSuccessRate",label:"success"},n={category:"webrtc",action:"CallsSuccessRate",label:"error_no_stun_candidate"},r={category:"webrtc",action:"ICEDistribution"},i={category:"webrtc",action:"ICETopology"},a={category:"webrtc",action:"ICENegotiation",label:"DurationMs"},o={category:"webrtc",action:"GetUserMediaRate",label:"success"},s={category:"webrtc",action:"GetUserMediaRate",label:"error_no_Track"},c={category:"webrtc",action:"GetUserMediaRate",label:"error"},l={category:"webrtc",action:"CodecsDistribution"},u={category:"webrtc",action:"CallsDistribution"},d={category:"webrtc",action:"CallsDurationRange"},f={category:"ux",action:"dragAndDrop"},h={category:"invitations",action:"inviteFromProvider"},p=null,v=null,m=!1,g=null,E=null,S=null;this.provideGA=function(e){S=e},this.hasGA=function(){return null!==S},this.trackICEUsed=function(e,t){if(S){var n="",i="";switch(e){case"local":n="host";break;case"peerreflexive":case"prflx":case"serverreflexive":n="stun";break;case"relayed":n="relay";break;default:n=e}switch(t){case"local":i="host";break;case"peerreflexive":case"prflx":case"serverreflexive":i="stun";break;case"relayed":i="relay";break;default:i=t}S.send("event",r.category,r.action,n+"|"+i)}},this.trackICEFailed=function(t){S&&t&&E!==t&&(S.send("event",e.category,e.action,e.label),E=t)},this.trackICESuccess=function(e){S&&e&&g!==e&&(S.send("event",t.category,t.action,t.label),g=e)},this.trackICENoSTUNCandidate=function(){S&&S.send("event",n.category,n.action,n.label)},this.trackICETopology=function(e){S&&S.send("event",i.category,i.action,e)},this.trackGetUserMediaSuccess=function(){S&&S.send("event",o.category,o.action,o.label)},this.trackGetUserMediaErrorNoTrack=function(){S&&S.send("event",s.category,s.action,s.label)},this.trackGetUserMediaError=function(){S&&S.send("event",c.category,c.action,c.label)},this.trackCodecsUsed=function(e,t){S&&S.send("event",l.category,l.action,e+"|"+t)},this.negotiationTime=function(){return v&&p?v<p?null:v-p:null},this.startNegotiationTime=function(e){p=e||(new Date).getTime(),m=!0},this.endNegotiationTime=function(e){m&&(v=e||(new Date).getTime(),m=!1)},this.trackNegotiationTime=function(){if(S){var e=this.negotiationTime();e&&S.send("event",a.category,a.action,a.label,e),v=null,p=null}},this.resetProvider=function(){S=null},this.trackCallSuccessNumber=function(e){e&&e.length>0&&S&&S.send("event",u.category,u.action,e)},this.trackCallDuration=function(e){if(S&&angular.isDefined(e)&&e>=0){var t="",n=Math.round(e/1e3);t=n<15?"very_short_less_15s":n<30?"very_short_less_30s":n<60?"short_less_60s":n<120?"short_less_120s":n<300?"short_less_300s":n<600?"normal_less_600s":n<1200?"normal_less_1200s":n<1800?"normal_less_1800s":n<3600?"long_less_3600s":"long_more_3600s",S.send("event",d.category,d.action,t)}},this.trackDragAndDrop=function(e){S&&S.send("event",f.category,f.action,e)},this.inviteContactsFromProvider=function(e,t){S&&S.send("event",h.category,h.action,e,t)}}]),angular.module("rainbow").service("countryService",["$filter",function(e){"use strict";this.countries=[{name:"Australia","alpha-3":"AUS","country-code":"036","alpha-2":"AU"},{name:"Austria","alpha-3":"AUT","country-code":"040","alpha-2":"AT"},{name:"Belgium","alpha-3":"BEL","country-code":"056","alpha-2":"BE"},{name:"Brazil","alpha-3":"BRA","country-code":"076","alpha-2":"BR"},{name:"Canada","alpha-3":"CAN","country-code":"124","alpha-2":"CA"},{name:"China","alpha-3":"CHN","country-code":"156","alpha-2":"CN"},{name:"Czech Republic","alpha-3":"CZE","country-code":"203","alpha-2":"CZ"},{name:"Denmark","alpha-3":"DNK","country-code":"208","alpha-2":"DK"},{name:"Finland","alpha-3":"FIN","country-code":"246","alpha-2":"FI"},{name:"France","alpha-3":"FRA","country-code":"250",default:!0,"alpha-2":"FR"},{name:"Germany","alpha-3":"DEU","country-code":"276","alpha-2":"DE"},{name:"Hong Kong","alpha-3":"HKG","country-code":"344","alpha-2":"HK"},{name:"Ireland","alpha-3":"IRL","country-code":"372","alpha-2":"IE"},{name:"Israel","alpha-3":"ISR","country-code":"376","alpha-2":"IL"},{name:"Italy","alpha-3":"ITA","country-code":"380","alpha-2":"IT"},{name:"Mexico","alpha-3":"MEX","country-code":"484","alpha-2":"MX"},{name:"Netherlands","alpha-3":"NLD","country-code":"528","alpha-2":"NL"},{name:"Norway","alpha-3":"NOR","country-code":"578","alpha-2":"NO"},{name:"Poland","alpha-3":"POL","country-code":"616","alpha-2":"PL"},{name:"Portugal","alpha-3":"PRT","country-code":"620","alpha-2":"PT"},{name:"Russia","alpha-3":"RUS","country-code":"643","alpha-2":"RU"},{name:"South Africa","alpha-3":"ZAF","country-code":"710","alpha-2":"ZA"},{name:"South Korea","alpha-3":"KOR","country-code":"410","alpha-2":"KR"},{name:"Spain","alpha-3":"ESP","country-code":"724","alpha-2":"ES"},{name:"Sweden","alpha-3":"SWE","country-code":"752","alpha-2":"SE"},{name:"Switzerland","alpha-3":"CHE","country-code":"756","alpha-2":"CH"},{name:"Taiwan","alpha-3":"TWN","country-code":"158","alpha-2":"TW"},{name:"Turkey","alpha-3":"TUR","country-code":"792","alpha-2":"TR"},{name:"United Kingdom","alpha-3":"GBR","country-code":"826","alpha-2":"GB"},{name:"United States of America","alpha-3":"USA","country-code":"840","alpha-2":"US"},{name:"Afghanistan","alpha-3":"AFG","country-code":"004","alpha-2":"AF"},{name:"Albania","alpha-3":"ALB","country-code":"008","alpha-2":"AL"},{name:"Algeria","alpha-3":"DZA","country-code":"012","alpha-2":"DZ"},{name:"Andorra","alpha-3":"AND","country-code":"020","alpha-2":"AD"},{name:"Angola","alpha-3":"AGO","country-code":"024","alpha-2":"AO"},{name:"Anguilla","alpha-3":"AIA","country-code":"660","alpha-2":"AI"},{name:"Antigua and Barbuda","alpha-3":"ATG","country-code":"028","alpha-2":"AG"},{name:"Argentina","alpha-3":"ARG","country-code":"032","alpha-2":"AR"},{name:"Armenia","alpha-3":"ARM","country-code":"051","alpha-2":"AM"},{name:"Aruba","alpha-3":"ABW","country-code":"533","alpha-2":"AW"},{name:"Azerbaijan","alpha-3":"AZE","country-code":"031","alpha-2":"AZ"},{name:"Bahamas","alpha-3":"BHS","country-code":"044","alpha-2":"BS"},{name:"Bahrain","alpha-3":"BHR","country-code":"048","alpha-2":"BH"},{name:"Bangladesh","alpha-3":"BGD","country-code":"050","alpha-2":"BD"},{name:"Barbados","alpha-3":"BRB","country-code":"052","alpha-2":"BB"},{name:"Belarus","alpha-3":"BLR","country-code":"112","alpha-2":"BY"},{name:"Belize","alpha-3":"BLZ","country-code":"084","alpha-2":"BZ"},{name:"Benin","alpha-3":"BEN","country-code":"204","alpha-2":"BJ"},{name:"Bermuda","alpha-3":"BMU","country-code":"060","alpha-2":"BM"},{name:"Bhutan","alpha-3":"BTN","country-code":"064","alpha-2":"BT"},{name:"Bolivia","alpha-3":"BOL","country-code":"068","alpha-2":"BO"},{name:"Bosnia and Herzegovina","alpha-3":"BIH","country-code":"070","alpha-2":"BA"},{name:"Botswana","alpha-3":"BWA","country-code":"072","alpha-2":"BW"},{name:"British Virgin Islands","alpha-3":"VGB","country-code":"092","alpha-2":"VG"},{name:"Brunei Darussalam","alpha-3":"BRN","country-code":"096","alpha-2":"BN"},{name:"Bulgaria","alpha-3":"BGR","country-code":"100","alpha-2":"BG"},{name:"Burkina Faso","alpha-3":"BFA","country-code":"854","alpha-2":"BF"},{name:"Burundi","alpha-3":"BDI","country-code":"108","alpha-2":"BI"},{name:"Cambodia","alpha-3":"KHM","country-code":"116","alpha-2":"KH"},{name:"Cameroon","alpha-3":"CMR","country-code":"120","alpha-2":"CM"},{name:"Cape Verde","alpha-3":"CPV","country-code":"132","alpha-2":"CV"},{name:"Cayman Islands","alpha-3":"CYM","country-code":"136","alpha-2":"KY"},{name:"Central African Republic","alpha-3":"CAF","country-code":"140","alpha-2":"CF"},{name:"Chad","alpha-3":"TCD","country-code":"148","alpha-2":"TD"},{name:"Chile","alpha-3":"CHL","country-code":"152","alpha-2":"CL"},{name:"Colombia","alpha-3":"COL","country-code":"170","alpha-2":"CO"},{name:"Comoros","alpha-3":"COM","country-code":"174","alpha-2":"KM"},{name:"Congo","alpha-3":"COG","country-code":"178","alpha-2":"CG"},{name:"Costa Rica","alpha-3":"CRI","country-code":"188","alpha-2":"CR"},{name:"Ivory Coast","alpha-3":"CIV","country-code":"384","alpha-2":"CI"},{name:"Croatia","alpha-3":"HRV","country-code":"191","alpha-2":"HR"},{name:"Cyprus","alpha-3":"CYP","country-code":"196","alpha-2":"CY"},{name:"Djibouti","alpha-3":"DJI","country-code":"262","alpha-2":"DJ"},{name:"Dominica","alpha-3":"DMA","country-code":"212","alpha-2":"DM"},{name:"Dominican Republic","alpha-3":"DOM","country-code":"214","alpha-2":"DO"},{name:"Ecuador","alpha-3":"ECU","country-code":"218","alpha-2":"EC"},{name:"El Salvador","alpha-3":"SLV","country-code":"222","alpha-2":"SV"},{name:"Egypt","alpha-3":"EGY","country-code":"818","alpha-2":"EG"},{name:"Eritrea","alpha-3":"ERI","country-code":"232","alpha-2":"ER"},{name:"Estonia","alpha-3":"EST","country-code":"233","alpha-2":"EE"},{name:"Ethiopia","alpha-3":"ETH","country-code":"231","alpha-2":"ET"},{name:"Fiji","alpha-3":"FJI","country-code":"242","alpha-2":"FJ"},{name:"Gabon","alpha-3":"GAB","country-code":"266","alpha-2":"GA"},{name:"Gambia","alpha-3":"GMB","country-code":"270","alpha-2":"GM"},{name:"Georgia","alpha-3":"GEO","country-code":"268","alpha-2":"GE"},{name:"Ghana","alpha-3":"GHA","country-code":"288","alpha-2":"GH"},{name:"Greece","alpha-3":"GRC","country-code":"300","alpha-2":"GR"},{name:"Grenada","alpha-3":"GRD","country-code":"308","alpha-2":"GD"},{name:"Guadeloupe","alpha-3":"GLP","country-code":"312","alpha-2":"GP"},{name:"Guatemala","alpha-3":"GTM","country-code":"320","alpha-2":"GT"},{name:"Guinea","alpha-3":"GIN","country-code":"324","alpha-2":"GN"},{name:"Guyana","alpha-3":"GUY","country-code":"328","alpha-2":"GY"},{name:"Haiti","alpha-3":"HTI","country-code":"332","alpha-2":"HT"},{name:"Honduras","alpha-3":"HND","country-code":"340","alpha-2":"HN"},{name:"Hungary","alpha-3":"HUN","country-code":"348","alpha-2":"HU"},{name:"Iceland","alpha-3":"ISL","country-code":"352","alpha-2":"IS"},{name:"India","alpha-3":"IND","country-code":"356","alpha-2":"IN"},{name:"Indonesia","alpha-3":"IDN","country-code":"360","alpha-2":"ID"},{name:"Iraq","alpha-3":"IRQ","country-code":"368","alpha-2":"IQ"},{name:"Jamaica","alpha-3":"JAM","country-code":"388","alpha-2":"JM"},{name:"Japan","alpha-3":"JPN","country-code":"392","alpha-2":"JP"},{name:"Jordan","alpha-3":"JOR","country-code":"400","alpha-2":"JO"},{name:"Kazakhstan","alpha-3":"KAZ","country-code":"398","alpha-2":"KZ"},{name:"Kenya","alpha-3":"KEN","country-code":"404","alpha-2":"KE"},{name:"Kuwait","alpha-3":"KWT","country-code":"414","alpha-2":"KW"},{name:"Kyrgyzstan","alpha-3":"KGZ","country-code":"417","alpha-2":"KG"},{name:"Latvia","alpha-3":"LVA","country-code":"428","alpha-2":"LV"},{name:"Lebanon","alpha-3":"LBN","country-code":"422","alpha-2":"LB"},{name:"Lesotho","alpha-3":"LSO","country-code":"426","alpha-2":"LS"},{name:"Liberia","alpha-3":"LBR","country-code":"430","alpha-2":"LR"},{name:"Libya","alpha-3":"LBY","country-code":"434","alpha-2":"LY"},{name:"Liechtenstein","alpha-3":"LIE","country-code":"438","alpha-2":"LI"},{name:"Lithuania","alpha-3":"LTU","country-code":"440","alpha-2":"LT"},{name:"Luxembourg","alpha-3":"LUX","country-code":"442","alpha-2":"LU"},{name:"Macao","alpha-3":"MAC","country-code":"446","alpha-2":"MO"},{name:"Macedonia","alpha-3":"MKD","country-code":"807","alpha-2":"MK"},{name:"Madagascar","alpha-3":"MDG","country-code":"450","alpha-2":"MG"},{name:"Malawi","alpha-3":"MWI","country-code":"454","alpha-2":"MW"},{name:"Malaysia","alpha-3":"MYS","country-code":"458","alpha-2":"MY"},{name:"Maldives","alpha-3":"MDV","country-code":"462","alpha-2":"MV"},{name:"Mali","alpha-3":"MLI","country-code":"466","alpha-2":"ML"},{name:"Malta","alpha-3":"MLT","country-code":"470","alpha-2":"MT"},{name:"Mauritius","alpha-3":"MUS","country-code":"480","alpha-2":"MU"},{name:"Mayotte","alpha-3":"MYT","country-code":"175","alpha-2":"YT"},{name:"Moldova","alpha-3":"MDA","country-code":"498","alpha-2":"MD"},{name:"Monaco","alpha-3":"MCO","country-code":"492","alpha-2":"MC"},{name:"Mongolia","alpha-3":"MNG","country-code":"496","alpha-2":"MN"},{name:"Montenegro","alpha-3":"MNE","country-code":"499","alpha-2":"ME"},{name:"Montserrat","alpha-3":"MSR","country-code":"500","alpha-2":"MS"},{name:"Morocco","alpha-3":"MAR","country-code":"504","alpha-2":"MA"},{name:"Mozambique","alpha-3":"MOZ","country-code":"508","alpha-2":"MZ"},{name:"Myanmar","alpha-3":"MMR","country-code":"104","alpha-2":"MM"},{name:"Namibia","alpha-3":"NAM","country-code":"516","alpha-2":"NA"},{name:"Nepal","alpha-3":"NPL","country-code":"524","alpha-2":"NP"},{name:"New Zealand","alpha-3":"NZL","country-code":"554","alpha-2":"NZ"},{name:"Nicaragua","alpha-3":"NIC","country-code":"558","alpha-2":"NI"},{name:"Niger","alpha-3":"NER","country-code":"562","alpha-2":"NE"},{name:"Nigeria","alpha-3":"NGA","country-code":"566","alpha-2":"NG"},{name:"Oman","alpha-3":"OMN","country-code":"512","alpha-2":"OM"},{name:"Pakistan","alpha-3":"PAK","country-code":"586","alpha-2":"PK"},{name:"Palestine","alpha-3":"PSE","country-code":"275","alpha-2":"PS"},{name:"Panama","alpha-3":"PAN","country-code":"591","alpha-2":"PA"},{name:"Paraguay","alpha-3":"PRY","country-code":"600","alpha-2":"PY"},{name:"Peru","alpha-3":"PER","country-code":"604","alpha-2":"PE"},{name:"Philippines","alpha-3":"PHL","country-code":"608","alpha-2":"PH"},{name:"Puerto Rico","alpha-3":"PRI","country-code":"630","alpha-2":"PR"},{name:"Qatar","alpha-3":"QAT","country-code":"634","alpha-2":"QA"},{name:"Romania","alpha-3":"ROU","country-code":"642","alpha-2":"RO"},{name:"Rwanda","alpha-3":"RWA","country-code":"646","alpha-2":"RW"},{name:"Saint Kitts and Nevis","alpha-3":"KNA","country-code":"659","alpha-2":"KN"},{name:"Saint Lucia","alpha-3":"LCA","country-code":"662","alpha-2":"LC"},{name:"Saint Vincent and the Grenadines","alpha-3":"VCT","country-code":"670","alpha-2":"VC"},{name:"Saudi Arabia","alpha-3":"SAU","country-code":"682","alpha-2":"SA"},{name:"Senegal","alpha-3":"SEN","country-code":"686","alpha-2":"SN"},{name:"Serbia","alpha-3":"SRB","country-code":"688","alpha-2":"RS"},{name:"Sierra Leone","alpha-3":"SLE","country-code":"694","alpha-2":"SL"},{name:"Singapore","alpha-3":"SGP","country-code":"702","alpha-2":"SG"},{name:"Slovakia","alpha-3":"SVK","country-code":"703","alpha-2":"SK"},{name:"Slovenia","alpha-3":"SVN","country-code":"705","alpha-2":"SI"},{name:"South Sudan","alpha-3":"SSD","country-code":"728","alpha-2":"SS"},{name:"Sri Lanka","alpha-3":"LKA","country-code":"144","alpha-2":"LK"},{name:"Sudan","alpha-3":"SDN","country-code":"729","alpha-2":"SD"},{name:"Swaziland","alpha-3":"SWZ","country-code":"748","alpha-2":"SZ"},{name:"Tajikistan","alpha-3":"TJK","country-code":"762","alpha-2":"TJ"},{name:"Tanzania","alpha-3":"TZA","country-code":"834","alpha-2":"TZ"},{name:"Thailand","alpha-3":"THA","country-code":"764","alpha-2":"TH"},{name:"Trinidad and Tobago","alpha-3":"TTO","country-code":"780","alpha-2":"TT"},{name:"Tunisia","alpha-3":"TUN","country-code":"788","alpha-2":"TN"},{name:"Turkmenistan","alpha-3":"TKM","country-code":"795","alpha-2":"TM"},{name:"Turks and Caicos Islands","alpha-3":"TCA","country-code":"796","alpha-2":"TC"},{name:"Uganda","alpha-3":"UGA","country-code":"800","alpha-2":"UG"},{name:"Ukraine","alpha-3":"UKR","country-code":"804","alpha-2":"UA"},{name:"United Arab Emirates","alpha-3":"ARE","country-code":"784","alpha-2":"AE"},{name:"Virgin Islands, US","alpha-3":"VIR","country-code":"850","alpha-2":"VI"},{name:"Uruguay","alpha-3":"URY","country-code":"858","alpha-2":"UY"},{name:"Uzbekistan","alpha-3":"UZB","country-code":"860","alpha-2":"UZ"},{name:"Venezuela","alpha-3":"VEN","country-code":"862","alpha-2":"VE"},{name:"Vietnam","alpha-3":"VNM","country-code":"704","alpha-2":"VN"},{name:"Zambia","alpha-3":"ZMB","country-code":"894","alpha-2":"ZM"},{name:"Zimbabwe","alpha-3":"ZWE","country-code":"716","alpha-2":"ZW"}],this.statesOfAmerica={ALABAMA:"Alabama",ALASKA:"Alaska",ARIZONA:"Arizona",ARKANSAS:"Arkansas",CALIFORNIA:"California",COLORADO:"Colorado",CONNECTICUT:"Connecticut",DELAWARE:"Delaware",FLORIDA:"Florida",GEORGIA:"Georgia",HAVAII:"Hawaii",IDAHO:"Idaho",ILLINOIS:"Illinois",INDIANA:"Indiana",IOWA:"Iowa",KANSAS:"Kansas",KENTUCKY:"Kentucky",LOUISIANA:"Louisiana",MAINE:"Maine",MARYLAND:"Maryland",MASSACHUSSETTS:"Massachusetts",MICHIGAN:"Michigan",MINNESOTA:"Minnesota",MISSISSIPPI:"Mississippi",MISSOURI:"Missouri",MONTANA:"Montana",NEBRASKA:"Nebraska",NEVADA:"Nevada",NEW_HAMPSHIRE:"New Hampshire",NEW_JERSEY:"New Jersey",NEW_MEXICO:"New Mexico",NEW_YORK:"New York",NORTH_CAROLINA:"North Carolina",NOTH_DAKOTA:"North Dakota",OHIO:"Ohio",OKLAHOMA:"Oklahoma",OREGON:"Oregon",PENNSYLVANIA:"Pennsylvania",RODE_ISLAND:"Rhode Island",SOUTH_CAROLINA:"South Carolina",SOUTH_DAKOTA:"South Dakota",TENNESSEE:"Tennessee",TEXAS:"Texas",UTAH:"Utah",VERMONT:"Vermont",VIRGINIA:"Virginia",WASHINGTON:"Washington",WEST_VIRGINIA:"West Virginia",WISCONSIN:"Wisconsin",WYOMING:"Wyoming"},this.getCountries=function(t){var n=Object.assign([],this.countries);return t?n.sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0}):n.splice(30,0,{name:e("translate")("otherCountries"),disabled:"true"}),n},this.getAmericanStates=function(){return this.statesOfAmerica},this.getCountry=function(e,t){if(!e)return t?this.getDefaultCountry():null;var n=this.countries.filter(function(t){return t["alpha-3"]===e});return n.length>0?n[0]:null},this.getDefaultCountry=function(){var e=this.countries.filter(function(e){return!0===e.default});return e.length>0?e[0]:this.countries[0]},this.getCountryName=function(e){return this.getCountry(e).name},this.getCountryCode=function(e){return e?e["alpha-3"]:null},this.getDefaultState=function(e){return e&&"USA"===e["alpha-3"]?"ALABAMA":null},this.getAlpha2Code=function(e){if(!e)return null;var t=this.countries.filter(function(t){return t["alpha-3"]===e});return t.length>0?t[0]["alpha-2"]:null}}]),angular.module("rainbow").filter("countryFilter",["countryService",function(e){"use strict";return function(t){return e.getCountryName(t)}}]),angular.module("rainbow").service("usersService",["$q","$log","$rootScope","contactService",function(e,t,n,r){"use strict";var i=this,a=[];this.started=!1,this.start=function(r){t.info("[usersService] === STARTING ==="),i.started=!0;var o=performance.now();t.info("[usersService] start"),i.contactsInRoster=i.getAllRosterContacts(),i.lastNameList=i.orderContactsByLastName(),i.firstNameList=i.orderContactByFirstName(),i.companyNameList=i.orderContactsByCompany(),a.push(n.$on("ON_CONTACT_ROSTER_UPDATE_EVENT",i.onContactUpdatedEvent));var s=Math.round(performance.now()-o);return r.push({service:"usersService",startDuration:s}),t.info("[usersService] === STARTED ("+s+" ms) ==="),e.when()},this.stop=function(){var n;for(t.info("[usersService] === STOPPING ==="),i.started&&(i.started=!1);n=a.pop();)n();return t.info("[usersService] === STOPPED ==="),e.when()},this.onContactUpdatedEvent=function(){t.info("[usersService] onContactUpdatedEvent");var e=i.getAllRosterContacts();e.length-i.contactsInRoster.length!=0&&(t.info("[usersService] onContactUpdatedEvent - update all user lists"),i.contactsInRoster=e,i.lastNameList=i.orderContactsByLastName(),i.firstNameList=i.orderContactByFirstName(),i.companyNameList=i.orderContactsByCompany(),n.$broadcast("ON_USER_SERVICE_ROSTER_UPDATE_EVENT"))},this.getLastNameList=function(){return i.lastNameList},this.getFirstNameList=function(){return i.firstNameList},this.getCompanyNameList=function(){return i.companyNameList},this.getAllRosterContacts=function(){return r.getContacts().filter(function(e){return e.displayName&&e.roster})},this.addSeparatorsForLastname=function(e){var t=[],n="";return e.forEach(function(e){if(n!==e.lastname.charAt(0).toUpperCase()){var r={value:n=e.lastname.charAt(0).toUpperCase(),type:"separator",id:n};t.push(r)}t.push(e)}),t},this.orderContactsByLastName=function(){var e=i.contactsInRoster;return e=i.getOrderedUsers(e,"lastname"),i.addSeparatorsForLastname(e)},this.addSeparatorsForFirstname=function(e){var t=[],n="";return e.forEach(function(e){if(n!==e.firstname.charAt(0).toUpperCase()){var r={value:n=e.firstname.charAt(0).toUpperCase(),type:"separator",id:n};t.push(r)}t.push(e)}),t},this.orderContactByFirstName=function(){var e=i.contactsInRoster;return e=i.getOrderedUsers(e,"firstname"),i.addSeparatorsForFirstname(e)},this.addSeparatorsForCompany=function(e){var t=[],n="";return e.forEach(function(e){if(n!==e.company.name){var r={value:n=e.company.name,type:"separator",id:n};t.push(r)}t.push(e)}),t},this.orderContactsByCompany=function(){var e=i.contactsInRoster;return e=i.getOrderedUsers(e,"company"),i.addSeparatorsForCompany(e)},this.getFilterAndOrderUsersGroupedByOrderLabel=function(e,t,n,r){r=Boolean(!0&r);var a=i.getFilterAndOrderUsers(e,t,n,r);return"firstname"===t?i.addSeparatorsForFirstname(a):"company"===t?i.addSeparatorsForCompany(a):i.addSeparatorsForLastname(a)},this.getFilterAndOrderUsersGroupedByOrderLabelAndUpdateActivity=function(e,t,n,r){r=Boolean(!0&r);var a=i.getFilterAndOrderUsers(e,t,n,r);return"firstname"===t?i.addSeparatorsForFirstname(a):"company"===t?i.addSeparatorsForCompany(a):i.addSeparatorsForLastname(a)},this.getFilterAndOrderUsers=function(e,t,n,r){var a=i.getFilteredUsers(e,n,r);return i.getOrderedUsers(a,t)},this.getFilteredUsers=function(e,t,n){var r;return r=(r=e.filter(function(e){if("separator"===e.type)return!0;var r=e.displayName&&e.roster||n,i="offline"!==e.status&&"wait"!==e.status&&"xa"!==e.status&&"unknown"!==e.status,a="wait"===e.status;return"online"===t?r&&i:"offline"===t?r&&!i:"pending"===t?r&&a:r})).filter(function(e,t){return!!("separator"!==e.type||r[t+1]&&"separator"!==r[t+1].type)})},this.getOrderedUsers=function(e,t){return e.sort(function(e,n){var r;if("lastname"===t)return 0===(r=e.lastname.localeCompare(n.lastname))?e.firstname.localeCompare(n.firstname):r;if("firstname"===t)return 0===(r=e.firstname.localeCompare(n.firstname))?e.lastname.localeCompare(n.lastname):r;if("company"===t){var i=e.company.name.localeCompare(n.company.name);return 0===i?e.lastname.localeCompare(n.lastname):i}return 0})}}]),angular.module("rainbow").service("utilService",["$q","$http","authService","$log",function(e,t,n,r){"use strict";var i=[{base:"A",letters:/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},{base:"AA",letters:/[\uA732]/g},{base:"AE",letters:/[\u00C6\u01FC\u01E2]/g},{base:"AO",letters:/[\uA734]/g},{base:"AU",letters:/[\uA736]/g},{base:"AV",letters:/[\uA738\uA73A]/g},{base:"AY",letters:/[\uA73C]/g},{base:"B",letters:/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},{base:"C",letters:/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},{base:"D",letters:/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},{base:"DZ",letters:/[\u01F1\u01C4]/g},{base:"Dz",letters:/[\u01F2\u01C5]/g},{base:"E",letters:/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},{base:"F",letters:/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},{base:"G",letters:/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},{base:"H",letters:/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},{base:"I",letters:/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},{base:"J",letters:/[\u004A\u24BF\uFF2A\u0134\u0248]/g},{base:"K",letters:/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},{base:"L",letters:/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},{base:"LJ",letters:/[\u01C7]/g},{base:"Lj",letters:/[\u01C8]/g},{base:"M",letters:/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},{base:"N",letters:/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},{base:"NJ",letters:/[\u01CA]/g},{base:"Nj",letters:/[\u01CB]/g},{base:"O",letters:/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},{base:"OI",letters:/[\u01A2]/g},{base:"OO",letters:/[\uA74E]/g},{base:"OU",letters:/[\u0222]/g},{base:"P",letters:/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},{base:"Q",letters:/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},{base:"R",letters:/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},{base:"S",letters:/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},{base:"T",letters:/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},{base:"TZ",letters:/[\uA728]/g},{base:"U",letters:/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},{base:"V",letters:/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},{base:"VY",letters:/[\uA760]/g},{base:"W",letters:/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},{base:"X",letters:/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},{base:"Y",letters:/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},{base:"Z",letters:/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},{base:"a",letters:/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g},{base:"aa",letters:/[\uA733]/g},{base:"ae",letters:/[\u00E6\u01FD\u01E3]/g},{base:"ao",letters:/[\uA735]/g},{base:"au",letters:/[\uA737]/g},{base:"av",letters:/[\uA739\uA73B]/g},{base:"ay",letters:/[\uA73D]/g},{base:"b",letters:/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},{base:"c",letters:/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},{base:"d",letters:/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},{base:"dz",letters:/[\u01F3\u01C6]/g},{base:"e",letters:/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},{base:"f",letters:/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},{base:"g",letters:/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},{base:"h",letters:/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},{base:"hv",letters:/[\u0195]/g},{base:"i",letters:/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},{base:"j",letters:/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},{base:"k",letters:/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},{base:"l",letters:/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},{base:"lj",letters:/[\u01C9]/g},{base:"m",letters:/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},{base:"n",letters:/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},{base:"nj",letters:/[\u01CC]/g},{base:"o",letters:/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},{base:"oi",letters:/[\u01A3]/g},{base:"ou",letters:/[\u0223]/g},{base:"oo",letters:/[\uA74F]/g},{base:"p",letters:/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},{base:"q",letters:/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},{base:"r",letters:/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},{base:"s",letters:/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},{base:"t",letters:/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},{base:"tz",letters:/[\uA729]/g},{base:"u",letters:/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},{base:"v",letters:/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},{base:"vy",letters:/[\uA761]/g},{base:"w",letters:/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},{base:"x",letters:/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},{base:"y",letters:/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},{base:"z",letters:/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}];this.removeDiacritis=function(e){for(var t=0;t<i.length;t++)e=e.replace(i[t].letters,i[t].base);return e}}]);var Capabilities=function(){return function(){}}(),FileServerService=function(){function e(e,t,n,r,i,a,o,s,c,l,u){this.$q=e,this.$http=t,this.$log=n,this.authService=r,this.fileStorageService=i,this.TransfertPromiseQueue=a,this.FileDescriptorEventHandler=o,this.xmppService=s,this.errorHelperService=c,this.$rootScope=l,this.$interval=u,this.ONE_KILOBYTE=1024,this.ONE_MEGABYTE=1048576,this.ONE_GIGABYTE=1073741824,this.started=!1,this.thumbnailPromises=[]}return e.prototype.start=function(e){var t=this;this.$log.info("[FileServerService] === STARTING ===");var n=performance.now();return this.started=!1,this.portalURL=config.restServerUrl+"/api/rainbow/fileserver/v1.0/files",this.getServercapabilities().then(function(){t.attachHandlers(),t.transfertPromiseQueue=t.TransfertPromiseQueue.create();var r=Math.round(performance.now()-n);e.push({service:"FileServerService",startDuration:r}),t.$log.info("[FileServerService] === STARTED ("+r+" ms) ===")}).catch(function(e){t.$log.error("[FileServerService] === STARTING FAILURE === "+e.message)}),this.$q.when()},e.prototype.stop=function(){return this.$log.info("[FileServerService] === STOPPING ==="),this.started&&(this.started=!1),this.$log.info("[FileServerService] === STOPPED ==="),this.$q.when()},e.prototype.attachHandlers=function(){var e=this;this.removeHandlers(),this.fileDescriptorEventHandler=this.FileDescriptorEventHandler.create(this),this.fileMessageHandlerRef||(this.fileMessageHandlerRef=this.xmppService.addHandler(function(t){return e.$interval(function(){e.fileDescriptorEventHandler.onManagementMessageReceived(t)},250,1),!0},null,"message","management"))},e.prototype.removeHandlers=function(){this.fileDescriptorEventHandler=void 0,this.fileMessageHandlerRef=void 0},e.prototype.getPartialDataFromServer=function(e,t,n,r){var i=this;return this.$q(function(a,o){i.$http({method:"GET",url:e,headers:i.authService.getRequestHeaderWithRange("bytes="+t+"-"+n),responseType:"arraybuffer"}).then(function(e){a({data:e.data,index:r})},function(e){var t=i.errorHelperService.handleError(e),n=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(e.data))),r=i.errorHelperService.getLocalizedError(n.errorDetailsCode);i.$log.error(r),o(t)})})},e.prototype.getFileStorageService=function(){return this.fileStorageService},e.prototype.getBlobThumbnailFromFileDescriptor=function(e){var t=this;if(e.thumbnail.isThumbnailAvailable()||e.size<20*this.ONE_KILOBYTE){var n=this.thumbnailPromises[e.id];if(n)return this.$log.info("[FileServerService] getBlobThumbnailFromFileDescriptor "+e.id+" already lauched"),n.promise;var r=this.$q.defer();this.thumbnailPromises[e.id]=r;var i=e.url;return e.thumbnail.isThumbnailAvailable()&&e.size>=20*this.ONE_KILOBYTE?i+="?thumbnail=true":e.uploadedDate&&(i+="?update="+MD5.hexdigest(e.uploadedDate)),e.state="downloading",this.getBlobFromUrl(i,e.typeMIME,e.size,e.fileName).then(function(n){e.previewBlob=n,e.state="uploaded",t.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"download",url:i,fileId:e.id,mime:e.typeMIME,filename:e.fileName,filesize:e.size}),delete t.thumbnailPromises[e.id],r.resolve(n)}).catch(function(n){e.state="uploaded",t.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"download",message:n.message,url:i,fileId:e.id,mime:e.typeMIME,filename:e.fileName,filesize:e.size}),delete t.thumbnailPromises[e.id],r.reject(n)}),r.promise}return this.$q.reject()},e.prototype.getBlobFromFileDescriptor=function(e){var t=this;if(!e)return this.$log.warn("[FileServerService] getBlobFromFileDescriptor : missing file descriptor"),this.$q.reject();if(this.$log.info("[FileServerService] getBlobFromFileDescriptor: "+e.id),"uploaded"!==e.state)return this.$log.warn("[FileServerService] getBlobFromFileDescriptor : file is not in uploaded state="+e.state),this.$q.reject();var n=e.url;e.uploadedDate&&(n+="?update="+MD5.hexdigest(e.uploadedDate));var r=this.ONE_MEGABYTE;if(this.capabilities.maxChunkSizeDownload&&0!==e.size&&e.size>r){e.size>=100*r&&(r=e.size/100+this.ONE_KILOBYTE,this.$log.debug("[FileServerService] changing chunk size: "+r));var i=this.$q.defer(),a=new Array,o=[];e.state="downloading",e.chunkTotalNumber=Math.ceil(e.size/r),e.chunkPerformed=0,e.chunkPerformedPercent=0,this.$rootScope.$broadcast("ON_DOWNLOAD_FILE_MESSAGE",{fileId:e.id}),this.$log.info("[FileServerService] getBlobFromFileDescriptor: need to download "+e.chunkTotalNumber+" chunks");for(var s,c=function(r,i,c,l){c=c<e.size?c:e.size,o.push(function(){var o=t.$q.defer();return t.getPartialDataFromServer(n,i,c,r).then(function(n){return e.chunkPerformed++,e.chunkPerformedPercent=100*e.chunkPerformed/e.chunkTotalNumber,t.$log.info("[FileServerService] getBlobFromFileDescriptor : chunk downloaded="+e.chunkPerformed),a[n.index]=n.data,t.$rootScope.$broadcast("ON_DOWNLOAD_FILE_MESSAGE",{fileId:e.id}),o.resolve(n)}).catch(function(e){t.$log.info("[FileServerService] error on chunk download="+e),o.reject(e)}),o.promise}),s=c},l=0,u=0,d=r-1,f=Math.ceil(e.size/r);f>0;l++,f--,u+=r,d+=r)c(l,u,d),d=s;return this.transfertPromiseQueue.addPromiseArray(o,function(){var n=new Blob(a,{type:e.typeMIME});t.$log.info("[FileServerService] getBlobFromFileDescriptor success"),e.state="uploaded",e.chunkPerformed=0,e.chunkTotalNumber=0,e.chunkPerformedPercent=0,t.$rootScope.$broadcast("ON_DOWNLOAD_FILE_MESSAGE",{fileId:e.id}),i.resolve(n)},function(r){var a=t.errorHelperService.handleError(r),o=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(r.data))),s=t.errorHelperService.getLocalizedError(o.errorDetailsCode);t.$log.error(s),t.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"download",message:s||a.message,url:n,fileId:e.id,mime:e.typeMIME,filename:e.fileName,filesize:e.size}),i.reject(a)}),i.promise}return e.state="downloading",e.chunkTotalNumber=1,e.chunkPerformed=0,e.chunkPerformedPercent=0,this.getBlobFromUrl(n,e.typeMIME,e.size,e.fileName).then(function(n){return e.state="uploaded",t.$q.resolve(n)}).catch(function(e){return t.$log.info("[FileServerService] arrayPromise : error "+e.message),t.$q.reject(e)})},e.prototype.getBlobFromUrl=function(e,t,n,r){var i=this;return this.$log.debug("[FileServerService] >getBlobFromUrl: "+e),this.$q(function(n,r){i.$http({method:"GET",url:e,headers:i.authService.getRequestHeader(),responseType:"arraybuffer"}).then(function(e){var r=new Blob([e.data],{type:t});i.$log.debug("[FileServerService] getBlobFromUrl success"),n(r)},function(e){var t=i.errorHelperService.handleError(e),n=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(e.data))),a=i.errorHelperService.getLocalizedError(n.errorDetailsCode);i.$log.error(a),r(t)})})},e.prototype.getBlobUrlAndOrientationByFileDescriptorId=function(e){var t=this;return this.$q(function(n,r){var i=t.fileStorageService.getFileDescriptorById(e);i?t.getBlobFromFileDescriptor(i).then(function(r){var a={};if(a.blobUrl=URL.createObjectURL(r),a.id=e,i.orientation)return a.orientation=i.orientation,void n(a);t.setImageOrientationForFileDescriptor(i,r).then(function(e){a.orientation=e,n(a)}).catch(function(){n(a)})}).catch(function(e){r(e)}):(t.$log.error("[FileServerService] getBlobUrlAndOrientationById no file descriptor found for ID "+e),r(new Error("[FileServerService] getBlobUrlAndOrientationById no file descriptor found")))})},e.prototype.setImageOrientationForFileDescriptor=function(e,t){return this.$q(function(n,r){if(e&&e.isImage()){var i=new FileReader;i.onloadend=function(){var t=new DataView(i.result),a=0,o=1;if(i.result.length<2||65496!==t.getUint16(a))r();else{a+=2;for(var s=t.byteLength;a<s-2;){var c=t.getUint16(a);switch(a+=2,c){case 65505:s=t.getUint16(a)-a,a+=2;break;case 274:o=t.getUint16(a+6,!1),s=0}}e.orientation=o,n(o)}},i.readAsArrayBuffer(t)}else r()})},e.prototype.uploadAFile=function(e,t,n){var r=this;return this.$q(function(i,a){var o=r.fileStorageService.getFileDescriptorById(e);o&&(o.state="uploading"),r.$http({method:"PUT",url:r.portalURL+"/"+e,headers:r.authService.getPostHeader("application/octet-stream"),data:t,uploadEventHandlers:{progress:function(e){r.$log.log(e)}}}).then(function(a){var o=r.fileStorageService.getFileDescriptorById(e);o&&(o.state="uploaded"),r.$log.info("[FileServerService] uploadAFile success"),r.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"upload",url:r.portalURL+"/"+e,fileId:e,mime:n,filename:t.name,filesize:t.size}),r.fileStorageService.orderDocuments(),i(o)},function(i){var o=r.errorHelperService.handleError(i);r.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",url:r.portalURL+"/"+e,fileId:e,mime:n,filename:t.name,filesize:t.size}),a(o),r.$log.error("[FileServerService] "+o.message)})})},e.prototype.sendPartialDataToServer=function(e,t,n,r,i,a){var o=this;return this.$q(function(s,c){o.$http({method:"PUT",url:o.portalURL+"/"+e+"/parts/"+a,headers:o.authService.getPostHeaderWithRange("bytes "+r+"-"+i+"/"+n,"application/octet-stream"),data:t,uploadEventHandlers:{progress:function(e){o.$log.log(e)}}}).then(function(e){var t=e.data.data;o.$log.info("[FileServerService] sendPartialDataToServer success"),s(t)},function(e){var t=o.errorHelperService.handleError(e);c(t),o.$log.error("[FileServerService] "+t.message)})})},e.prototype.uploadAFileByChunk=function(e,t,n,r){var i=this;this.$log.info("[FileServerService] >uploadAFileByChunk");var a=this.ONE_MEGABYTE;if(a<t.size){t.size>=100*a&&(a=t.size/100+this.ONE_KILOBYTE,this.$log.debug("[FileServerService] changing chunk size: "+a));var o=this.$q.defer();e.chunkTotalNumber=Math.ceil(t.size/a),e.chunkPerformed=0,e.chunkPerformedPercent=0,e.state="uploading";for(var s=[],c=function(a,o,c,l){var u=c<t.size?c:t.size,d=t.slice(o,u+1);s.push(function(){var s=i.$q.defer();return i.sendPartialDataToServer(e.id,d,t.size,o,u,a).then(function(t){return e.chunkPerformed++,e.chunkPerformedPercent=100*e.chunkPerformed/e.chunkTotalNumber,r(n,e),s.resolve(t)}).catch(function(e){i.$log.info("[FileServerService] error on chunk upload="+e),s.reject(e)}),s.promise})},l=0,u=0,d=a-1,f=Math.ceil(t.size/a);f>0;l++,f--,u+=a,d+=a)c(l,u,d);return this.transfertPromiseQueue.addPromiseArray(s,function(){i.$http({method:"PUT",url:i.portalURL+"/"+e.id+"/parts/end",headers:i.authService.getPostHeader("application/octet-stream"),uploadEventHandlers:{progress:function(e){i.$log.log(e)}}}).then(function(a){i.$log.info("[FileServerService] uploadAFileByChunk success"),e.state="uploaded",e.chunkPerformed=0,e.chunkTotalNumber=0,e.chunkPerformedPercent=0,r(n,e),i.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"upload",url:i.portalURL+"/"+e.id+"/parts/end",fileId:e.id,mime:e.typeMIME,filename:t.name,filesize:t.size}),i.fileStorageService.orderDocuments(),o.resolve(e)},function(n){var r=i.errorHelperService.handleError(n);i.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",url:i.portalURL+"/"+e.id+"/parts/end",fileId:e.id,mime:e.typeMIME,filename:t.name,filesize:t.size}),o.reject(r)})},function(n){var r=i.errorHelperService.handleError(n);i.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",url:i.portalURL+"/"+e.id+"/parts/end",fileId:e.id,mime:e.typeMIME,filename:t.name,filesize:t.size}),o.reject(r)}),o.promise}return r(n,e),this.uploadAFile(e.id,t,e.typeMIME).then(function(t){return i.$log.info("[FileServerService] uploadAFile success"),r(n,e),i.$q.resolve(e)})},e.prototype.isTransferInProgress=function(){return this.transfertPromiseQueue.isTransferInProgress()},e.prototype.cancelAllTransfers=function(){this.transfertPromiseQueue.cancelAllTransfers()},e.prototype.getServercapabilities=function(){var e=this;return this.$q(function(t,n){e.$http({method:"GET",url:config.restServerUrl+"/api/rainbow/fileserver/v1.0/capabilities",headers:e.authService.getRequestHeader()}).then(function(n){e.$log.info("[FileServerService] getServercapabilities -- success"),e.capabilities=n.data.data,t(e.capabilities)},function(t){var r=e.errorHelperService.handleError(t);e.$log.error("[FileServerService] getServercapabilities "+r.message),n(r)})})},e.prototype.getBlobFromUrlWithOptimization=function(e,t,n,r,i){var a=this;return void 0===n&&(n=0),void 0===r&&(r=""),void 0===i&&(i=""),0!==i.length&&(e+="?update="+MD5.hexdigest(i)),this.capabilities.maxChunkSizeDownload&&0!==n&&n>this.capabilities.maxChunkSizeDownload?this.$q(function(r,i){var o=a.capabilities.maxChunkSizeDownload;o>a.ONE_MEGABYTE&&(o=a.ONE_MEGABYTE);var s=0,c=o-1,l=Math.ceil(n/o),u=new Array(l);a.$log.debug("[FileServerService] getBlobFromUrlWithOptimization : "+l+" chunks to be downloaded");for(var d=[],f=0;l>0;f++,l--,s+=o,c+=o)d.push(a.getPartialDataFromServer(e,s,c,f).then(function(e){return u[e.index]=e.data,e.data}));a.$q.all(d).then(function(){var e=new Blob(u,{type:t});a.$log.debug("[FileServerService] getBlobFromUrlWithOptimization success"),r(e)},function(e){var t=a.errorHelperService.handleError(e),n=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(e.data))),r=a.errorHelperService.getLocalizedError(n.errorDetailsCode);a.$log.error(r),i(t)})}):this.getBlobFromUrl(e,t,n,r)},e.prototype.getBlobUrlFromUrl=function(e,t,n,r){var i=this;return void 0===n&&(n=0),void 0===r&&(r=""),this.$q(function(a,o){i.getBlobFromUrlWithOptimization(e,t,n,r).then(function(e){a(URL.createObjectURL(e))}).catch(function(e){o(e)})})},e.$inject=["$q","$http","$log","authService","fileStorageService","TransfertPromiseQueue","FileDescriptorEventHandler","xmppService","errorHelperService","$rootScope","$interval"],e}();angular.module("rainbow").service("fileServerService",FileServerService);var FileStorageService=function(){function e(e,t,n,r,i,a,o,s,c,l,u,d,f,h){this.$q=e,this.$http=t,this.$log=n,this.$rootScope=r,this.authService=i,this.fileViewerFactory=a,this.errorHelperService=o,this.orderByFilter=s,this.contactService=c,this.fileTransfertService=l,this.helpersService=u,this.fileViewerElementFactory=d,this.fileDescriptorFactory=f,this.$injector=h,this.started=!1,this.rotationValues={1:"rotate(0deg)",3:"rotate(180deg)",6:"rotate(90deg)",8:"rotate(270deg)"}}return e.prototype.start=function(e){var t=this;this.$log.info("[FileStorageService] === STARTING ===");var n=performance.now();return this.started=!1,this.portalURL=config.restServerUrl+"/api/rainbow/filestorage/v1.0/files",this.fileDescriptors=[],this.fileDescriptorsByDate=[],this.fileDescriptorsByName=[],this.fileDescriptorsBySize=[],this.receivedFileDescriptors=[],this.receivedFileDescriptorsByName=[],this.receivedFileDescriptorsByDate=[],this.receivedFileDescriptorsBySize=[],this.consumptionData={},this.retrieveFileDescriptorsListPerOwner().then(function(){return t.retrieveReceivedFiles(t.contactService.userContact.dbId)}).then(function(){return t.orderDocuments(),t.retrieveUserConsumption()}).then(function(){t.started=!0;var r=Math.round(performance.now()-n);e.push({service:"FileStorageService",startDuration:r}),t.$log.info("[FileStorageService] === STARTED ("+r+" ms) ===")}).catch(function(e){t.$log.error("[FileStorageService] === STARTING === failure -- "+e.message)}),this.$q.when()},e.prototype.stop=function(){return this.$log.info("[FileStorageService] === STOPPING ==="),this.started&&(this.started=!1),this.$log.info("[FileStorageService] === STOPPED ==="),this.$q.when()},e.prototype.getFileDescriptorById=function(e){for(var t=0,n=this.fileDescriptors;t<n.length;t++){if((a=n[t]).id===e)return a}for(var r=0,i=this.receivedFileDescriptors;r<i.length;r++){var a;if((a=i[r]).id===e)return a}return null},e.prototype.getCompleteFileDescriptorById=function(e){var t=this;return this.$q(function(n,r){var i;if(t.fileDescriptors.some(function(t){return t.id===e&&(i=t,!0)})){for(var a=[],o=function(e){"user"===e.type&&a.push(t.contactService.getContactByDBId(e.viewerId).then(function(t){return e.contact=t,e}).catch(function(e){t.$log.error("[FileStorageService] "+e),r(e)}))},s=0,c=i.viewers;s<c.length;s++){o(c[s])}t.$q.all(a).then(function(){n(i)}).catch(function(e){t.$log.error("[FileStorageService] "+e),r(e)})}else r()})},e.prototype.getDocuments=function(){return this.fileDescriptors},e.prototype.getReceivedDocuments=function(){return this.receivedFileDescriptors},e.prototype.getDocumentsByName=function(e){return e?this.receivedFileDescriptorsByName:this.fileDescriptorsByName},e.prototype.getDocumentsByDate=function(e){return e?this.receivedFileDescriptorsByDate:this.fileDescriptorsByDate},e.prototype.getDocumentsBySize=function(e){return e?this.receivedFileDescriptorsBySize:this.fileDescriptorsBySize},e.prototype.getReceivedFilesFromContact=function(e){return this.receivedFileDescriptorsByDate.filter(function(t){return t.ownerId===e})},e.prototype.getSentFilesToContact=function(e){return this.fileDescriptorsByDate.filter(function(t){for(var n=0;n<t.viewers.length;n++)if(t.viewers[n].viewerId===e)return!0;return!1})},e.prototype.getConsumptionData=function(){return this.consumptionData},e.prototype.createFileDescriptor=function(e,t,n,r){var i=this;return this.$q(function(a,o){i.$http({method:"POST",url:i.portalURL,headers:i.authService.getRequestHeader(),data:{fileName:e,extension:t,size:n,viewers:r}}).then(function(e){var t=i.createFileDescriptorFromData(e.data.data);i.$log.info("[FileStorageService] createFileDescriptor -- "+t.id+" -- success"),t&&i.fileDescriptors.push(t),i.orderDocuments(),a(t)}).catch(function(e){var t=i.errorHelperService.handleError(e,"createFileDescriptor");i.$log.error("[FileStorageService] "+t.message),o(t)})})},e.prototype.createFileDescriptorFromData=function(e){if(e){var t=[];if(e.viewers)for(var n=0,r=e.viewers;n<r.length;n++){var i=r[n];t.push(this.fileViewerElementFactory(i.viewerId,i.type,i.contact,this.contactService))}var a=e.url;a||(a=config.restServerUrl+"/api/rainbow/fileserver/v1.0/files/"+e.id);var o="unknown";return o=e.isUploaded?"uploaded":"not_uploaded",this.fileDescriptorFactory(e.id,a,e.ownerId,e.fileName,e.extension,e.typeMIME,e.size,e.registrationDate,e.uploadedDate,e.dateToSort,t,o,e.thumbnail,e.orientation)}},e.prototype.deleteFileDescriptor=function(e){var t=this;return this.$q(function(n,r){t.$http({method:"DELETE",url:t.portalURL+"/"+e,headers:t.authService.getRequestHeader()}).then(function(){t.$log.info("[FileStorageService] deleteFileDescriptor -- success"),t.deleteFileDescriptorFromCache(e,!1),t.$rootScope.$broadcast("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:e}),n(void 0)}).catch(function(e){var n=t.errorHelperService.handleError(e,"deleteFileDescriptor");r(n),t.$log.error("[FileStorageService] "+n.message)})})},e.prototype.deleteAllFileDescriptor=function(){var e=this;return this.$q(function(t,n){var r=[];e.fileDescriptors.forEach(function(t){"deleted"!==t.state&&r.push(e.deleteFileDescriptor(t.id).then(function(e){return e}))}),e.$q.all(r).then(function(){t()}).catch(function(t){var r=e.errorHelperService.handleError(t,"deleteAllFileDescriptor");n(r)})})},e.prototype.retrieveFileDescriptorsListPerOwner=function(){var e=this;return this.fileDescriptors=[],this.$q(function(t,n){e.$http({method:"GET",url:e.portalURL+"?format=full&limit=1000",headers:e.authService.getRequestHeader()}).then(function(n){var r=n.data.data;r||t();var i=n.data.limit,a=n.data.total,o=null;if(a<=i)o=e.$q.resolve([]);else{for(var s=i,c=a/i,l=[],u=1;u<c;u++)l.push(e.retrieveFileDescriptorsListPerOwnerwithOffset(s,i)),s+=i;o=e.$q.all(l)}o.then(function(n){n.forEach(function(e){r=r.concat(e)});for(var i=0,a=r;i<a.length;i++){var o=a[i],s=e.createFileDescriptorFromData(o);e.fileDescriptors.push(s)}e.$log.info("[FileStorageService] retrieveFileDescriptorsListPerOwner -- success"),t(e.fileDescriptors)})}).catch(function(t){var r=e.errorHelperService.handleError(t,"retrieveFileDescriptorsListPerOwner");n(r),e.$log.error("[FileStorageService] "+r.message)})})},e.prototype.retrieveFileDescriptorsListPerOwnerwithOffset=function(e,t){var n=this;return this.$q(function(r,i){n.$http({method:"GET",url:n.portalURL+"?format=full&limit="+t+"&offset="+e,headers:n.authService.getRequestHeader()}).then(function(e){r(e.data.data)})})},e.prototype.retrieveFilesReceivedFromPeer=function(e,t){var n=this;return this.$q(function(r,i){n.$http({method:"GET",url:n.portalURL+"/viewers/"+e+"?ownerId="+t+"&format=full",headers:n.authService.getRequestHeader()}).then(function(e){var t=[],i=e.data.data;if(i)for(var a=0,o=i;a<o.length;a++){var s=o[a],c=n.createFileDescriptorFromData(s);t.push(c)}n.$log.info("[FileStorageService] retrieveFilesReceivedFromPeer success"),r(t)}).catch(function(e){var t=n.errorHelperService.handleError(e,"retrieveFilesReceivedFromPeer");n.$log.error("[FileStorageService] "+t.message),i(t)})})},e.prototype.retrieveSentFiles=function(e){var t=this;return this.$q(function(n,r){t.$http({method:"GET",url:t.portalURL+"?format=full&viewerId="+e,headers:t.authService.getRequestHeader()}).then(function(e){var r=[],i=e.data.data;if(i)for(var a=0,o=i;a<o.length;a++){var s=o[a],c=t.createFileDescriptorFromData(s);r.push(c)}t.$log.info("[FileStorageService] retrieveSentFiles success"),n(r)}).catch(function(e){var n=t.errorHelperService.handleError(e,"retrieveSentFiles");t.$log.error("[FileStorageService] "+n.message),r(n)})})},e.prototype.retrieveReceivedFilesForRoom=function(e){var t=this;return this.$q(function(n,r){t.$http({method:"GET",url:t.portalURL+"/viewers/"+e+"?format=full",headers:t.authService.getRequestHeader()}).then(function(e){var r=e.data.data;r||n();for(var i=[],a=0,o=r;a<o.length;a++){var s=o[a];s.viewers=[];var c=t.createFileDescriptorFromData(s);c.ownerId!==t.contactService.userContact.dbId&&i.push(c)}t.$log.info("[FileStorageService] retrieveReceivedFilesForRoom  -- success"),i=t.orderDocumentsForRoom(i),n(i)}).catch(function(e){var n=t.errorHelperService.handleError(e,"retrieveReceivedFilesForRoom");t.$log.error("[FileStorageService] "+n.message),r(n)})})},e.prototype.retrieveReceivedFiles=function(e){var t=this;return this.$q(function(n,r){t.$http({method:"GET",url:t.portalURL+"/viewers/"+e+"?format=full",headers:t.authService.getRequestHeader()}).then(function(e){var r=e.data.data;r||n();for(var i=0,a=r;i<a.length;i++){var o=a[i];o.viewers=[];var s=t.createFileDescriptorFromData(o);if(s.ownerId!==t.contactService.userContact.dbId){var c=t.getFileDescriptorById(s.id);c&&(s.previewBlob=c.previewBlob),t.receivedFileDescriptors.push(s)}}t.orderReceivedDocuments(),t.$log.info("[FileStorageService] retrieveReceivedFiles -- success"),n(t.receivedFileDescriptors)}).catch(function(e){var n=t.errorHelperService.handleError(e,"retrieveReceivedFiles");t.$log.error("[FileStorageService] "+n.message),r(n)})})},e.prototype.retrieveUserConsumption=function(){var e=this;return this.$q(function(t,n){e.$http({method:"GET",url:config.restServerUrl+"/api/rainbow/filestorage/v1.0/users/consumption",headers:e.authService.getRequestHeader()}).then(function(n){e.consumptionData=n.data.data,e.$log.info("[FileStorageService] retrieveUserConsumption success"),t(e.consumptionData)}).catch(function(t){var r=e.errorHelperService.handleError(t,"retrieveUserConsumption");e.$log.error("[FileStorageService] "+r.message),n(r)})})},e.prototype.deleteFileViewer=function(e,t){var n=this;return this.$q(function(r,i){n.$http({method:"DELETE",url:n.portalURL+"/"+t+"/viewers/"+e,headers:n.authService.getRequestHeader()}).then(function(i){n.$log.info("[FileStorageService] deleteFileViewer "+i.statusText);var a=n.getFileDescriptorById(t);if(a){for(var o=-1,s=0;s<a.viewers.length;s++)if(a.viewers[s].viewerId===e){o=s;break}-1!==o&&a.viewers.splice(o,1)}r()},function(e){var t=n.errorHelperService.handleError(e,"deleteFileViewer");i(t),n.$log.error("[FileStorageService] "+t.message)})})},e.prototype.addFileViewer=function(e,t,n){var r=this,i=this.getFileDescriptorById(e);return i&&i.isAlreadyFileViewer(t)?this.$q.resolve(i):this.$q(function(i,a){r.$http({method:"POST",url:r.portalURL+"/"+e+"/viewers",headers:r.authService.getRequestHeader(),data:{viewerId:t,type:n}}).then(function(n){r.$log.info("[FileStorageService] addFileViewer success");var o=r.getFileDescriptorById(e);if(o){var s=r.fileViewerFactory([{viewerId:n.data.data.viewerId,type:n.data.data.type}])[0];"user"===s.type?r.contactService.getContactByDBId(t).then(function(e){s.contact=e,o.viewers.push(s),i(o)}).catch(function(e){r.$log.error("[FileStorageService] "+e),a(e)}):(o.viewers.push(s),i(o))}},function(e){var t=r.errorHelperService.handleError(e,"addFileViewer");a(t),r.$log.error("[FileStorageService] "+t.message)})})},e.prototype.retrieveOneFileDescriptor=function(e){var t=this;return this.$q(function(n,r){t.$http({method:"GET",url:t.portalURL+"/"+e+"?format=full",headers:t.authService.getRequestHeader()}).then(function(r){var i=t.createFileDescriptorFromData(r.data.data);t.$log.info("[FileStorageService] getOneFileDescriptor "+e+" -- success"),n(i)}).catch(function(e){var n=t.errorHelperService.handleError(e,"getOneFileDescriptor");t.$log.error("[FileStorageService] "+n.message),r(n)})})},e.prototype.retrieveAndStoreOneFileDescriptor=function(e,t){var n=this,r=this.getFileDescriptorById(e);return r&&!t?(this.$log.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- return existing fileDescriptor "+e),this.$q.resolve(r)):this.retrieveOneFileDescriptor(e).then(function(e){r&&r.isImage()&&(e.previewBlob=r.previewBlob);var t=n.helpersService.findIndex(n.fileDescriptors,function(t){return t.id===e.id});t>-1&&n.fileDescriptors.splice(t,1);var i=n.helpersService.findIndex(n.receivedFileDescriptors,function(t){return t.id===e.id});if(i>-1&&n.receivedFileDescriptors.splice(i,1),e.ownerId===n.contactService.userContact.dbId)n.fileDescriptors.push(e),n.$log.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- fileDescriptor "+e.id+" -- now stored in my files");else{n.receivedFileDescriptors.push(e),n.$log.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- fileDescriptor "+e.id+" -- now stored in received files"),n.$rootScope.$broadcast("ON_MESSAGE_WITH_FILE_RECEIVED_EVENT")}return n.orderDocuments(),n.$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:e.id}),n.$q.resolve(e)}).catch(function(e){n.$log.warn("[FileStorageService] Error on getting FileDescriptor: "+e.errorDetailsCode);var t=n.errorHelperService.handleError(e,"retrieveAndStoreOneFileDescriptor");return t.status>=400&&t.status<500&&r&&(404===t.status&&n.deleteFileDescriptorFromCache(r.id,!0),n.orderDocuments(),n.$log.debug("[FileStorageService] Sending ON_FILE_REMOVED_FROM_STORE_EVENT"),n.$rootScope.$broadcast("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:r.id})),n.$q.reject(e)})},e.prototype.deleteFileDescriptorFromCache=function(e,t){this.$log.info("[FileStorageService] deleteFileDescriptorFromCache "+e);for(var n=0;n<this.receivedFileDescriptors.length;n++)if(this.receivedFileDescriptors[n].id===e){this.receivedFileDescriptors.splice(n,1);break}for(n=0;n<this.fileDescriptors.length;n++)if(this.fileDescriptors[n].id===e){t?this.fileDescriptors.splice(n,1):this.fileDescriptors[n].state="deleted";break}this.orderDocuments()},e.prototype.orderDocuments=function(){this.$log.debug("[FileStorageService] orderDocuments: "+this.fileDescriptors.length),this.replaceOrderedByFilter(this.fileDescriptorsByDate,this.fileDescriptors,this.getDate,!1,this.sortByDate),this.replaceOrderedByFilter(this.fileDescriptorsByName,this.fileDescriptors,this.getName,!1,this.sortByName),this.replaceOrderedByFilter(this.fileDescriptorsBySize,this.fileDescriptors,this.getSize,!1,this.sortBySize),this.orderReceivedDocuments()},e.prototype.orderReceivedDocuments=function(){this.$log.debug("[FileStorageService] orderReceivedDocuments: "+this.receivedFileDescriptors.length),this.replaceOrderedByFilter(this.receivedFileDescriptorsByName,this.receivedFileDescriptors,this.getName,!1,this.sortByName),this.replaceOrderedByFilter(this.receivedFileDescriptorsByDate,this.receivedFileDescriptors,this.getDate,!1,this.sortByDate),this.replaceOrderedByFilter(this.receivedFileDescriptorsBySize,this.receivedFileDescriptors,this.getSize,!1,this.sortBySize)},e.prototype.orderDocumentsForRoom=function(e){return this.orderByFilter(e,this.getDate,!1,this.sortByDate)},e.prototype.replaceOrderedByFilter=function(e,t,n,r,i){this.$log.debug("[FileStorageService] replaceOrderedByFilter"),e.length=0;for(var a=0,o=this.orderByFilter(t,n,r,i);a<o.length;a++){var s=o[a];"deleted"!==s.state&&e.push(s)}},e.prototype.getName=function(e){var t,n={name:"",date:""};return e.fileName&&(n.name=e.fileName),t=e.uploadedDate?new Date(e.uploadedDate):e.registrationDate?new Date(e.registrationDate):new Date(e.dateToSort),n.date=t.getTime(),n},e.prototype.getDate=function(e){return(e.uploadedDate?new Date(e.uploadedDate):e.registrationDate?new Date(e.registrationDate):new Date(e.dateToSort)).getTime()},e.prototype.getSize=function(e){var t={name:"",size:""};return e.name&&(t.name=e.fileName),t.size=e.size,t},e.prototype.sortByName=function(e,t){var n=-1;return e.value.name&&t.value.name&&0===(n=e.value.name.localeCompare(t.value.name))&&(n=t.value.date-e.value.date),n},e.prototype.sortBySize=function(e,t){var n=-1;return e.value.size&&t.value.size&&(n=t.value.size-e.value.size),n},e.prototype.sortByDate=function(e,t){var n=1;return e&&t&&(n=t.value-e.value),n},e.prototype.extractFileIdFromUrl=function(e){var t=e.split("/");return t.pop()||t.pop()},e.$inject=["$q","$http","$log","$rootScope","authService","fileViewerFactory","errorHelperService","orderByFilter","contactService","fileTransfertService","helpersService","fileViewerElementFactory","fileDescriptorFactory","$injector"],e}();angular.module("rainbow").service("fileStorageService",FileStorageService),angular.module("rainbow").factory("FileDescriptorEventHandler",["$log","$rootScope","contactService",function(e,t,n){"use strict";function r(e){this.fileServerService=e,this.fileStorageService=e.getFileStorageService()}return r.create=function(e){return new r(e)},r.prototype.onManagementMessageReceived=function(t){try{var n=$(t);return n.find("file").length>0?this.manageFileStanzaData(n.find("file")):n.find("thumbnail").length>0?this.manageThumbnailStanzaData(n.find("thumbnail")):e.info("[FileDescriptorEventHandler] onManagementMessageReceived  -- ignore the message"),!0}catch(t){return e.error("[FileDescriptorEventHandler] onManagementMessageReceived ERROR "+t),!0}},r.prototype.manageFileStanzaData=function(n){var r=$(n).attr("action"),i=$(n).find("fileid").text(),a=this.fileStorageService.getFileDescriptorById(i);switch(e.info("[FileDescriptorEventHandler] manageFileStanzaData -- "+r+" fileDescriptor "+i),r){case"create":e.debug("[FileDescriptorEventHandler] fileDescriptor "+i+" created on server");break;case"delete":a&&(this.fileStorageService.deleteFileDescriptorFromCache(i),t.$broadcast("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:i}));break;case"update":this.fileStorageService.retrieveAndStoreOneFileDescriptor(i,!0)}},r.prototype.manageThumbnailStanzaData=function(n){var r=$(n).attr("action"),i=$(n).find("fileid").text(),a=$(n).find("url").text(),o=$(n).find("mime").text(),s=$(n).find("filename").text(),c=$(n).find("size").text(),l=$(n).find("md5sum").text();if(e.info("[FileDescriptorEventHandler] manageThumbnailStanzaData -- "+r+" fileDescriptor "+i),e.debug("[FileDescriptorEventHandler]   fileUrl="+a),e.debug("[FileDescriptorEventHandler]   fileMime="+o),e.debug("[FileDescriptorEventHandler]   fileName="+s),e.debug("[FileDescriptorEventHandler]   fileSize="+c),e.debug("[FileDescriptorEventHandler]   md5sum="+l),e.debug("[FileDescriptorEventHandler]   fileId="+i),"create"===r||"update"===r){var u=this.fileStorageService.getFileDescriptorById(i);u?(e.debug("[FileDescriptorEventHandler] updating Thumbnail of found FileDescriptor "+i),u.previewBlob&&!u.thumbnail.availableThumbnail||!u.previewBlob?(u.thumbnail.availableThumbnail=!0,u.thumbnail.md5sum=l,u.thumbnail.size=c,e.info("[FileDescriptorEventHandler] preview not already downloaded for "+i+" -- download it"),this.fileServerService.getBlobThumbnailFromFileDescriptor(u).then(function(){t.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:u.id})})):e.info("[FileDescriptorEventHandler] preview already downloaded for "+i+" -- do nothing")):e.debug("[FileDescriptorEventHandler] FileDescriptor not found")}},r}]),angular.module("rainbow").service("extensionSharingService",["$q","$log","$rootScope",function(e,t,n){"use strict";var r=this;this.extensionFound=!1,this.minVersion="1.5.1",this.port=null,this.currentStreamId="screen",this.start=function(){this.extensionId=this.extensionId||this.getExtensionId(config.webservices.server);var i=e.defer();return t.info("[extensionService] === STARTING ==="),config.extensionSharing?window.chrome&&window.chrome.runtime?(t.info("[extensionService] Chrome extension - try to ping...",this.extensionId),chrome.runtime.sendMessage(this.extensionId,{type:"ping",data:null},null,function(e){e&&"pong"===e.type?(t.info("[extensionService] Chrome extension - pong received"),t.info("[extensionService] Chrome extension - extension installed and detected"),t.info("[extensionService] Chrome extension - try to connect..."),r.port=chrome.runtime.connect(r.extensionId),r.port?(t.info("[extensionService] Chrome extension - port created"),r.port.onDisconnect.addListener(function(){t.info("Extension DISCONNECTED"),r.extensionFound=!1,r.port=null}),r.port.onMessage.addListener(function(e){switch(t.info("[extensionService] Chrome extension - connected"),e.type){case"loginResponse":r.extensionFound=!0,t.info("[extensionService] Chrome extension - ready!"),t.info("[extensionService] === STARTED ==="),n.$broadcast("ON_EXTENSION_SHARING_READY"),i.resolve();break;case"getVersionResponse":0===e.code&&e.version?(n.$broadcast("ON_EXTENSION_VERSION_UPDATED",e.version),t.info("[extensionService] Chrome extension - Detected version "+e.version)):(n.$broadcast("ON_EXTENSION_VERSION_UPDATED",null),t.error("[extensionService] Chrome extension - No version received"));break;case"startsharingResponse":0===e.code&&e.streamID?(t.info("[extensionService] Chrome extension - stream ID received "+e.streamID),n.$broadcast("ON_EXTENSION_SHARING_STREAM_FOUND",e.streamID)):(t.info("[extensionService] Chrome extension - No stream ID received"),n.$broadcast("ON_EXTENSION_SHARING_STREAM_FOUND",null));break;case"endsharingResponse":t.info("[extensionService] Chrome extension - end sharing session received")}}),r.port.postMessage({type:"login",data:null})):(t.info("[extensionService] Chrome extension - can't create port to contact the extension!!!"),t.info("[extensionService] === STARTED ==="),i.resolve())):(t.info("[extensionService] Chrome extension - not found"),chrome.runtime.lastError&&t.info("[extensionService] Chrome extension - error "+chrome.runtime.lastError),i.resolve())})):(t.info("[extensionService] Not in chrome"),t.info("[extensionService] === STARTED ==="),i.resolve()):(t.info("[extensionService] === STARTED ==="),i.resolve()),i.promise},this.stop=function(){return t.info("[extensionService] === STOPPING ==="),t.info("[extensionService] === STOPPED ==="),e.when()},this.getExtensionId=function(e){return t.info("Detected domain : "+e),-1!==e.indexOf("openrainbow.net")?"koefhabbjedbiecnldkolbijjfjinogj":-1!==e.indexOf("openrainbow.org")?"ehamhlkmecdnidihfedapmplddlbidee":-1!==e.indexOf("openrainbow.com")?"mgneongoclkopahpapenfhbbeckhdmnj":(t.error("Unkown domain, extension may not be available"),"mgneongoclkopahpapenfhbbeckhdmnj")},this.setExtensionId=function(e){t.info("set extensionId to : "+e),this.extensionId=e},this.getStreamToShareFromExtension=function(t){var i=e.defer(),a=n.$on("ON_EXTENSION_SHARING_STREAM_FOUND",function(e,n){r.currentStreamId=n,a(),n?(t.video.mandatory.chromeMediaSourceId=n,i.resolve()):i.reject()});return this.port.postMessage({type:"startsharing",data:null}),i.promise},this.getStreamId=function(){return this.currentStreamId},this.isExtensionInstalled=function(){var t=e.defer();return this.extensionFound?t.resolve(!0):this.start().then(function(){t.resolve(r.extensionFound)}),t.promise},this.getExtensionVersion=function(){var t=e.defer(),r=n.$on("ON_EXTENSION_VERSION_UPDATED",function(e,n){r(),n?t.resolve(n):t.reject()});return this.port.postMessage({type:"getVersion",data:null}),t.promise},this.checkExtensionStatus=function(){var t=e.defer();return"chrome"!==adapter.browserDetails.browser?t.resolve("notNeeded"):this.isExtensionInstalled().then(function(e){e?r.checkVersion().then(function(e){e?t.resolve("good"):t.resolve("needUpdate")}):t.resolve("notInstalled")}),t.promise},this.checkVersion=function(){var t=e.defer();return this.getExtensionVersion().then(function(e){t.resolve(r.cmpVersions(e,r.minVersion)>=0)}),t.promise},this.cmpVersions=function(e,t){var n,r,i=/(\.0+)+$/,a=e.replace(i,"").split("."),o=t.replace(i,"").split("."),s=Math.min(a.length,o.length);for(n=0;n<s;n++)if(r=parseInt(a[n],10)-parseInt(o[n],10))return r;return a.length-o.length}}]),angular.module("rainbow").service("pstnConferenceService",["$q","$rootScope","$log","$http","authService","errorHelperService","ConferenceSession","ConferenceParticipant",function(e,t,n,r,i,a,o,s){"use strict";var c=this;c.started=!1,c.start=function(t){return e(function(e){var r=performance.now();n.info(""),n.info("[pstnConferenceService] === STARTING ==="),c.portalURL=config.restServerUrl+"/api/rainbow/conference/v1.0/conferences/",c.conferenceSessions={},c.started=!0;var i=Math.round(performance.now()-r);t.push({service:"pstnConferenceService",startDuration:i}),n.info("[pstnConferenceService] === STARTED ("+i+" ms) ==="),e()})},c.stop=function(){return e(function(e){c.started&&(c.started=!1),n.info(""),n.info("[pstnConferenceService] === STOPPING ==="),n.info("[pstnConferenceService] === STOPPED ==="),e()})},c.updateOrCreateConferenceSession=function(e,r){n.info("[pstnConferenceService] updateOrCreateConferenceSession");var i=c.conferenceSessions[e];return i||(i=o.createFromData(e,[],!1,"pstnAudio"),c.conferenceSessions[e]=i),void 0!==r._started&&i.active!==r._started&&(i.updateActiveState(r._started),t.$broadcast("ON_CONFERENCE_STATE_EVENT",i)),r.data&&(i.participants=[],r.data.forEach(function(e){"disconnected"!==e.participantState&&""!==e.jid_im&&i.participants.push(s.createFromData(e))}),t.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",i)),i},c.getConferenceSessionById=function(e){return c.conferenceSessions[e]},c.removeConferenceSession=function(e){e&&delete c.conferenceSessions[e]},c.initiatesCallParticipant=function(t,a,o,s){return e(function(e,l){n.info("[pstnConferenceService] initiatesCallParticipant( confId="+t+", PhoneNumber="+a+", role="+o.role+" )"),r({method:"POST",url:c.portalURL+t+"/join",headers:i.getPostHeader(),data:{participantPhoneNumber:a,participant:o,country:s}}).then(function(r){var i=r.data.status;n.info("[pstnConferenceService] initiatesCallParticipant( confId="+t+") success : "+i),e()},function(e){var r=e.data?e.data.errorDetails:e.data,i="initiatesCallParticipant( confId="+t+") failure: "+r;n.error("[pstnConferenceService] "+i),l(new Error(i))})})},c.initiatesAudioRecording=function(t,a,o,s){return e(function(e,l){n.info("[pstnConferenceService] initiatesAudioRecording( confId="+t+"participantId="+a+")"),r({method:"POST",url:c.portalURL+t+"/participants/"+a+"/start-recording",headers:i.getPostHeader(),data:{fileName:o,fileExtension:s}}).then(function(){n.info("[pstnConferenceService] initiatesAudioRecording( confId="+t+"participantId="+a+") successfully"),e()},function(e){var r=e.data?e.data.errorDetails:e.data,i="initiatesAudioRecording( confId="+t+"participantId="+a+") failure: "+r;n.error("[pstnConferenceService] "+i),l(new Error(i))})})},c.initiatesAudio=function(t){return c.conferenceSessions[t]&&c.conferenceSessions[t].isActive()?(n.info("[pstnConferenceService] initiatesAudio : conference already started"),e.resolve()):e(function(e,o){n.info("[pstnConferenceService] initiatesAudio( confId="+t+")"),r({method:"PUT",url:c.portalURL+t+"/start",headers:i.getRequestHeader()}).then(function(){n.info("[pstnConferenceService] initiatesAudio( confId="+t+") successfully"),e()},function(e){var t=a.handleError(e);o(t)})})},c.pausesAudioRecording=function(t,a){return e(function(e,o){n.info("[pstnConferenceService] pausesAudioRecording( confId="+t+"participantId="+a+")"),r({method:"POST",url:c.portalURL+t+"/participants/"+a+"/pause-recording",headers:i.getPostHeader()}).then(function(){n.info("[pstnConferenceService] pausesAudioRecording( confId="+t+"participantId="+a+") successfully"),e()},function(e){var r=e.data?e.data.errorDetails:e.data,i="pausesAudioRecording( confId="+t+"participantId="+a+") failure: "+r;n.error("[pstnConferenceService] "+i),o(new Error(i))})})},c.resumesAudioRecording=function(t,a){return e(function(e,o){n.info("[pstnConferenceService] resumesAudioRecording( confId="+t+"participantId="+a+")"),r({method:"POST",url:c.portalURL+t+"/participants/"+a+"/resume-recording",headers:i.getPostHeader()}).then(function(){n.info("[pstnConferenceService] resumesAudioRecording( confId="+t+"participantId="+a+") successfully"),e()},function(e){var r=e.data?e.data.errorDetails:e.data,i="resumesAudioRecording( confId="+t+"participantId="+a+") failure: "+r;n.error("[pstnConferenceService] "+i),o(new Error(i))})})},c.stopsAudioRecording=function(t,a){return e(function(e,o){n.info("[pstnConferenceService] stopsAudioRecording( confId="+t+"participantId="+a+")"),r({method:"POST",url:c.portalURL+t+"/participants/"+a+"/stop-recording",headers:i.getPostHeader()}).then(function(){n.info("[pstnConferenceService] stopsAudioRecording( confId="+t+"participantId="+a+") successfully"),e()},function(e){var r=e.data?e.data.errorDetails:e.data,i="stopsAudioRecording( confId="+t+"participantId="+a+") failure: "+r;n.error("[pstnConferenceService] "+i),o(new Error(i))})})}}]);var WebConferenceService=function(){function e(e,t,n,r,i,a,o,s,c,l,u,d,f,h){var p=this;this.$q=e,this.$rootScope=t,this.$log=n,this.$http=r,this.uuid4=i,this.$interval=a,this.authService=o,this.xmppService=s,this.videoService=c,this.roomService=l,this.errorHelperService=u,this.ConferenceSession=d,this.contactService=f,this.platformService=h,this.started=!1,this.webConferenceRoom=null,this.webConferenceId=null,this.jingleJid=null,this.makingCall=!1,this.connected=!1,this.disconnecting=!1,this.reconnecting=!1,this.attachLocalMediaStream=function(e,t){if(e){var n;if(t.hasLocalVideo)if(n=t.sessions[t.localVideoSessionId]){var r=t.localStreams[n.localStreamId];p.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#conferenceVideoPip"),r,n.sid),p.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#conferenceVideoPipSmall"),r,n.sid)}if(t.hasLocalSharing)if(n=t.sessions[t.localSharingSessionId]){r=t.localStreams[n.localStreamId];p.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#conferenceSharingPip"),r,n.sid)}}else p.videoService.RTC.clearMediaStream(angular.element("#minivideo"),null)}}return e.prototype.start=function(e){var t=this;return this.$q(function(n){var r=performance.now();t.$log.info("[WebConferenceService] === STARTING ==="),t.portalURL=config.restServerUrl+"/api/rainbow/conference/v1.0/conferences/",t.webConfEndpoints={},t.webConferenceSessions={},t.listeners=[],t.connected=!0,t.disconnecting=!1,t.attachHandlers(),t.videoGalleryElementsNumber=4,t.started=!0;var i=Math.round(performance.now()-r);e.push({service:"WebConferenceService",startDuration:i}),t.$log.info("[WebConferenceService] === STARTED ("+i+" ms) ==="),n()})},e.prototype.stop=function(){return this.$log.info("[WebConferenceService] === STOPPING ==="),this.started=!1,this.makingCall=!1,this.listeners&&this.listeners.forEach(function(e){e()}),this.$log.info("[WebConferenceService] === STOPPED ==="),this.$q.when()},e.prototype.attachHandlers=function(){var e=this;this.listeners.push(this.$rootScope.$on(this.roomService.ROOM_ADD_CONF_ENDPOINT_EVENT,function(t){if(t&&t.confEndpoints&&t.confEndpoints.length)for(var n=0;n<t.confEndpoints.length;n++)"webrtc"===t.confEndpoints[n].mediaType&&(e.webConferenceRoom=t)})),this.listeners.push(this.$rootScope.$on(this.roomService.ROOM_REMOVE_CONF_ENDPOINT_EVENT,function(t){t&&e.webConferenceRoom&&e.webConferenceRoom.dbId===t.dbId&&(e.webConferenceRoom=null)})),this.listeners.push(this.$rootScope.$on("ON_CONNECTION_STATE_CHANGE_EVENT",function(t,n){e.$log.info("[WebConferenceService] onConnectionStateChangeEvent : "+n);try{if("disconnected"===n)e.$log.info("[WebConferenceService] onConnectionStateChangeEvent : disconnected"),e.connected=!1;else if("connected"===n){e.$log.info("[WebConferenceService] onConnectionStateChangeEvent : connected"),e.connected=!0;for(var r in e.webConferenceSessions)if(e.webConferenceSessions.hasOwnProperty(r)){var i=e.webConferenceSessions[r];if("reconnecting"===i.status)for(var a in i.sessions)if(i.sessions.hasOwnProperty(a)){var o=i.sessions[a];"audio"===o.localType&&e.sendTransportReplaceForSession(o,1e4)}}}}catch(t){e.$log.info("[WebConferenceService] onConnectionStateChangeEvent error : "+t)}}))},e.prototype.createVideoGalleryElements=function(){this.videoGalleryElements=[];for(var e=1;e<=this.videoGalleryElementsNumber;e++){var t={state:"free",sessionId:"",id:"videoGallery_"+e,publisherId:"",publisherJid:""};this.videoGalleryElements.push(t)}},e.prototype.setVideoGalleryElementsNumber=function(e){this.videoGalleryElementsNumber=e},e.prototype.startOrJoinWebConference=function(e){var t=this.getPontConfIdForRoom(e);t=t||this.webConferenceId;var n=this.webConferenceSessions[t],r=e.owner?"moderator":"member";return this.setSpeakerDevice(),e.owner&&!n?this.startWebConference(e,t,r):(this.$rootScope.$broadcast("ON_CONFERENCE_ENDED_INVITATION",e),this.joinWebConference(e,t,r))},e.prototype.startWebConference=function(e,t,n){var r=this;return this.$q(function(i,a){if(r.makingCall)return r.$log.warn("[webConferenceService] already starting a conference"),i();r.$log.info("[webConferenceService] startWebConference "+t),r.makingCall=!0;var o=r.webConferenceRoom&&r.webConferenceRoom.dbId!==e.dbId?r.webConferenceRoom:null;r.roomService.deleteRoomConferenceEndPoint(o,t).then(function(){return r.roomService.addRoomConferenceEndPoint(e,{id:t})}).then(function(){r.$log.info("[webConferenceService] startWebConference wtih ID "+t);var i=new r.ConferenceSession(t,[],!1,"webrtc");i.status="ringing",r.webConferenceSessions[t]=i,r.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",r.webConferenceSessions[t]);var o=r.portalURL+t+"/start";r.$http({method:"PUT",url:o,headers:r.authService.getRequestHeader(),data:{mediaType:"webrtc"}}).then(function(){return r.joinWebConference(e,t,n)},function(n){r.makingCall=!1;r.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"warning",popupBody:"startMeetingFailure",okLabel:"ok"}),r.$log.error("[webConferenceService] startWebConference wtih ID "+t+" failure ..."),r.leaveWebConference(t),delete r.webConferenceSessions[t],r.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT"),r.roomService.deleteRoomConferenceEndPoint(e,t),a(r.errorHelperService.handleError(n))})}).catch(function(n){r.makingCall=!1,r.$log.error("[webConferenceService] startWebConference -- failure -- "+n.message),r.roomService.deleteRoomConferenceEndPoint(e,t);r.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"warning",popupBody:"startMeetingFailure",okLabel:"ok"})})})},e.prototype.stopWebConference=function(){var e=this;return this.checkConferenceRight().then(function(){return e.$q(function(t,n){var r=e.portalURL+e.webConferenceId+"/stop";e.$http({method:"PUT",url:r,headers:e.authService.getRequestHeader()}).then(function(){t()},function(t){n(e.errorHelperService.handleError(t))})})})},e.prototype.getFreeVideoGalleryElement=function(e){this.$log.info("[webConferenceService] getFreeVideoGalleryElement "+e);var t=this.webConferenceSessions[e],n=null;if(t)for(var r=0;r<t.videoGallery.length;r++)if("free"===t.videoGallery[r].state){n=t.videoGallery[r];break}return n},e.prototype.joinWebConference=function(e,t,n){var r=this;return this.$q(function(e,i){if(r.$log.info("[webConferenceService] joinWebConference with ID "+t+" and role "+n),r.webConferenceSessions[t])r.resetWebConferenceSession(t);else{var a=new r.ConferenceSession(t,[],!1,"webrtc");r.webConferenceSessions[t]=a}r.createVideoGalleryElements(),r.webConferenceSessions[t].videoGallery=r.videoGalleryElements,"ringing"!==r.webConferenceSessions[t].status&&(r.webConferenceSessions[t].status="ringing",r.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",r.webConferenceSessions[t]));var o="web_"+r.uuid4.generate(),s=r.portalURL+t+"/join",c={participant:{role:n,type:"unmuted"},mediaType:"webrtc"};r.$http({method:"POST",url:s,headers:r.authService.getRequestHeader(),data:c}).then(function(n){var i=n.data.data;r.jingleJid=t+"@"+i.jingleJid,r.initCall(r.jingleJid,t,o),r.makingCall=!1,e()},function(e){if(e){var a=e.data?e.data.errorDetails:e.data,o="joinWebConference( confId="+t+") failure: "+a;r.$log.error("[conferenceService] "+o)}r.makingCall=!1;var s={popupTitle:"warning",popupBody:"joinMeetingFailure",okLabel:"ok"};e&&e.data&&403615===e.data.errorDetailsCode?s.popupBody="maximumNumberConferenceParticipantsReach":e&&e.data&&403300===e.data.errorDetailsCode&&"moderator"===n&&r.$rootScope.$broadcast("ON_CONFERENCE_JOIN_FAILED_EVENT",t),r.leaveWebConference(t),delete r.webConferenceSessions[t],r.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT"),r.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",s),i(r.errorHelperService.handleError(e))})})},e.prototype.askToAddSharingToConferenceSession=function(e,t){!this.videoService.askToAddSharing(e.id,"sharing")&&this.addMediaToConferenceSession(t,"sharing")},e.prototype.addMediaToConferenceSession=function(e,t){var n=this;if(e){var r=[t],i=20;"video"!==t&&(i=3),this.$log.info("[webConferenceService] addMediaToConferenceSession to session "+e.id+" with media "+t),this.videoService.getBrowserMedia(r,640,480,i).then(function(r){var i=[r],a=n.xmppService.connection.jingle.initiate(e.jingleJid,n.xmppService.connection.jid,t,i,null,e.id);e.sessions[a.sid]=a,e.localStreams.push(r),a.localStreamId=e.localStreams.length-1,"video"===t?(e.hasLocalVideo=!0,e.localVideoSessionId=a.sid):(e.hasLocalSharing=!0,e.localSharingSessionId=a.sid),n.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e)})}},e.prototype.removeMediaFromConferenceSession=function(e,t){if(e){this.$log.info("[webConferenceService] removeMediaFromConferenceSession from session "+e.id);var n="video"===t?e.localVideoSessionId:e.localSharingSessionId;if(e.sessions[n]){var r=e.sessions[n];this.videoService.disableAudioVideoMedia(r),this.xmppService.connection.jingle.terminate(r.sid),delete e.sessions[n],delete e.localStreams[r.localStreamId],"video"===t?(e.hasLocalVideo=!1,e.localVideoSessionId=null):(e.hasLocalSharing=!1,e.localSharingSessionId=null)}this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e)}},e.prototype.dropRemoteVideoSession=function(e,t){if(e){if(this.$log.info("[webConferenceService] dropRemoteVideoSession fom conference "+e.id+" and session "+t),e.sessions[t]){var n=e.sessions[t];this.xmppService.connection.jingle.terminate(n.sid),delete e.sessions[t]}this.removeSessionFromVideoGallery(e,t),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e)}},e.prototype.initCall=function(e,t,n){var r=this;this.videoService.getBrowserMedia(["audio"]).then(function(i){var a=[i],o=r.xmppService.connection.jingle.initiate(e,r.xmppService.connection.jid,"audio",a,n,t),s=r.webConferenceSessions[t];s||(s=new r.ConferenceSession(t),r.webConferenceSessions[t]=s),s.jingleJid=e,s.sessions[o.sid]=o,s.localStreams=a,s.status="ringing",o.getStats(1e4),r.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",s)}).catch(function(){r.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"warning",popupBody:"devicePermission",okLabel:"ok"}),r.leaveWebConference(t)})},e.prototype.muteAudio=function(e,t){if(e.webConferenceSession){for(var n in e.webConferenceSession.sessions){if(e.webConferenceSession.sessions.hasOwnProperty(n))e.webConferenceSession.sessions[n].muteAudio(t)}e.isMutedAudio=t,this.$rootScope.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{conversation:e})}else this.$log.info("[webConferenceService] muteAudio trying to mute a non existing session ")},e.prototype.resetWebConferenceSession=function(e){var t=this.webConferenceSessions[e];t&&(t.participants=[],t.publishers=[],t.active=!1,t.hasLocalSharing=!1,t.hasLocalVideo=!1,t.reversedVideos=!1,t.jingleJid=null,t.localVideoSessionId=null,t.localSharingSessionId=null,t.videoGallery=null,t.sessions={})},e.prototype.leaveWebConference=function(e){if(this.$log.info("[WebConferenceService] leaveWebConference - "+e),this.contactService.resetBusyState(),e){var t=this.webConferenceSessions[e];if(t){for(var n in t.sessions)if(t.sessions.hasOwnProperty(n)){var r=t.sessions[n];this.videoService.disableAudioVideoMedia(r),this.xmppService.connection.jingle.terminate(r.sid)}t.status="ended",t.participants=[],t.publishers=[],t.active=!1,t.hasLocalSharing=!1,t.hasLocalVideo=!1,t.reversedVideos=!1,t.jingleJid=null,t.localVideoSessionId=null,t.localSharingSessionId=null,t.videoGallery=null,t.sessions={},this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",t)}else this.$log.warn("[WebConferenceService] leaveWebConference - webConference does not exist")}},e.prototype.attachDistantMediaStream=function(e,t){var n=this;if(e){var r=this.getRemoteVideoSessions(t.id);this.updateMainSessionIfNeeded(r),this.$log.info("[WebConferenceService] attachDistantMediaStream for session "+t.id);var i=this.getRemoteSharingSession(t.id);if(i&&i.remoteStreams.forEach(function(e){e.getVideoTracks().length>0&&n.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),e,i.sid)}),r.length)for(var a in r)r.hasOwnProperty(a)&&r[a].remoteStreams&&r[a].remoteStreams.forEach(function(e){if(e.getVideoTracks().length>0){!i&&r[a].mainSession&&n.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),e,r[a].sid);for(var o=0;o<t.videoGallery.length;o++)if(t.videoGallery[o].sessionId===r[a].sid){n.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#"+t.videoGallery[o].id),e,t.videoGallery[o].sessionId);break}}});var o=this.getRemoteAudioSession(t.id);o&&o.remoteStreams&&o.remoteStreams.forEach(function(e){e.getAudioTracks().length>0&&n.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),e)})}},e.prototype.attachMainMediaStream=function(e){var t=this;e&&(this.$log.info("[webConferenceService] attachMainMediaStream"),e.remoteStreams.forEach(function(n){n.getVideoTracks().length>0&&t.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),n,e.sid)}))},e.prototype.attachVideosToGallery=function(e){},e.prototype.updateMainSessionIfNeeded=function(e){if(this.$log.info("[webConferenceService] updateMainSessionIfNeeded"),e&&e.length){var t=null,n=!0;for(var r in e)e.hasOwnProperty(r)&&(t||(t=e[r]),e[r].mainSession&&(n=!1));n&&(t.mainSession=!0)}},e.prototype.getRelatedRoomToActiveConferenceSession=function(){return this.webConferenceRoom},e.prototype.getConferenceBySessionId=function(e){var t=null;for(var n in this.webConferenceSessions)if(this.webConferenceSessions.hasOwnProperty(n)&&this.webConferenceSessions[n].sessions)for(var r in this.webConferenceSessions[n].sessions)if(this.webConferenceSessions[n].sessions.hasOwnProperty(r)&&this.webConferenceSessions[n].sessions[r].sid===e)return t=this.webConferenceSessions[n];return t},e.prototype.getPontConfIdForRoom=function(e){if(e.confEndpoints&&e.confEndpoints.length)for(var t=0;t<e.confEndpoints.length;t++)if("webrtc"===e.confEndpoints[t].mediaType&&e.confEndpoints[t].userId===e.ownerContact.dbId)return e.confEndpoints[t].confEndpointId;return""},e.prototype.checkConferenceRight=function(){return this.$q.when({})},e.prototype.getConferenceSessionById=function(e){return this.webConferenceSessions[e]},e.prototype.updateWebConferenceInfos=function(e){var t=this;this.$log.info("[WebConferenceService] updateWebConferenceInfos"),this.webConfEndpoints=e,this.webConferenceId=this.getWebConfEndpointId(),this.roomService.getRoomByConferenceEndpointId(this.webConferenceId).then(function(e){var n="nothing";e&&(n=e.name),t.webConferenceRoom=e,t.$log.info("[WebConferenceService] === updateWebConferenceInfos : room is currently attached to "+n)},function(){t.$log.info("[WebConferenceService] === updateWebConferenceInfos FAILURE===")})},e.prototype.updateWebConferenceRoom=function(){var e=this;return this.webConferenceId=this.getWebConfEndpointId(),this.$q(function(t,n){e.roomService.getRoomByConferenceEndpointId(e.webConferenceId).then(function(n){var r="nothing";n&&(r=n.name),e.webConferenceRoom=n,e.$log.info("[WebConferenceService] === updateWebConferenceInfos : room is currently attached to "+r),t()},function(){e.$log.info("[WebConferenceService] === updateWebConferenceInfos FAILURE==="),n()})})},e.prototype.getWebConfEndpointId=function(){for(var e in this.webConfEndpoints)if(this.webConfEndpoints.hasOwnProperty(e))return this.webConfEndpoints[e].id;return"598adcff9aff289a22e82cb2"},e.prototype.isCreateWebConferenceAllowed=function(){return!0},e.prototype.isJoinWebConferenceAllowed=function(){return!0},e.prototype.attachConferenceEndpointToRoom=function(e,t){return t=t||this.webConferenceId,this.roomService.addRoomConferenceEndPoint(e,{id:t})},e.prototype.getWebConference=function(e){if(e)return this.webConferenceSessions[e]},e.prototype.removeConferenceSession=function(e){e&&(this.removeAllJingleSessionsForConferenceSession(e),delete this.webConferenceSessions[e])},e.prototype.removeAllJingleSessionsForConferenceSession=function(e){if(e){var t=this.webConferenceSessions[e];if(t){for(var n in t.sessions)if(t.sessions.hasOwnProperty(n)){var r=t.sessions[n];this.videoService.disableAudioVideoMedia(r),this.xmppService.connection.jingle.terminate(r.sid)}t.sessions=[]}}},e.prototype.hasActiveConferenceSession=function(){return 0!==Object.keys(this.webConferenceSessions).length},e.prototype.getActiveConferenceSession=function(){var e=null;for(var t in this.webConferenceSessions)this.webConferenceSessions.hasOwnProperty(t)&&(e=this.webConferenceSessions[t]);return e},e.prototype.hasIncomingVideoStream=function(e){if(e){var t=this.webConferenceSessions[e];if(t)for(var n in t.sessions)if(t.sessions.hasOwnProperty(n)){var r=t.sessions[n];if("video"===r.remoteType||"sharing"===r.remoteType)return!0}return!1}},e.prototype.getRemoteSessionsWithVideoOrSharingStreams=function(e){var t=[];if(!e)return t;var n=this.webConferenceSessions[e];if(n)for(var r in n.sessions)if(n.sessions.hasOwnProperty(r)){var i=n.sessions[r];"video"!==i.remoteType&&"sharing"!==i.remoteType||t.push(i)}return t},e.prototype.getRemoteSharingSession=function(e){var t=null;if(!e)return t;var n=this.webConferenceSessions[e];if(n)for(var r in n.sessions)if(n.sessions.hasOwnProperty(r)){var i=n.sessions[r];if("sharing"===i.remoteType){t=i;break}}return t},e.prototype.getRemoteVideoSessions=function(e){var t=[];if(!e)return t;var n=this.webConferenceSessions[e];if(n)for(var r in n.sessions)if(n.sessions.hasOwnProperty(r)){var i=n.sessions[r];"video"===i.remoteType&&t.push(i)}return t},e.prototype.getRemoteAudioSession=function(e){var t;if(!e)return t;var n=this.webConferenceSessions[e];if(n)for(var r in n.sessions)if(n.sessions.hasOwnProperty(r)){var i=n.sessions[r];if("audio"===i.localType){t=i;break}}return t},e.prototype.isAlreadySubscribedToPublisher=function(e,t){if(!e||!t)return!1;var n=!1,r=this.webConferenceSessions[e];if(r&&r.videoGallery)for(var i=0;i<r.videoGallery.length;i++)if(r.videoGallery[i].publisherId===t){n=!0;break}return n},e.prototype.relatePublisherToElement=function(e,t,n){if(!e||!t||!n)return!1;this.$log.info("[WebConferenceService] relatePublisherToElement");var r=this.webConferenceSessions[e];if(r)for(var i=0;i<r.videoGallery.length;i++)if(r.videoGallery[i].id===n){r.videoGallery[i].state="busy",r.videoGallery[i].publisherId=t.participantId,r.videoGallery[i].publisherJidIm=t.jid_im,r.videoGallery[i].displayName=t.participantId;var a=this.contactService.getContactByJid(t.jid_im);a&&(r.videoGallery[i].displayName=a.displayName);break}},e.prototype.getRelatedPublisherToElement=function(e,t){if(!e||!t)return null;this.$log.info("[WebConferenceService] getRelatedPublisherToElement");var n=null,r=this.webConferenceSessions[e];if(r&&r.videoGallery)for(var i=0;i<r.videoGallery.length;i++)if(t===r.videoGallery[i].id&&r.videoGallery[i].publisherId){n=r.videoGallery[i];break}return n},e.prototype.relateSessionToPublisher=function(e,t,n){if(e&&t&&n){this.$log.info("[WebConferenceService] relateSessionToPublisher pubId "+t+" sessionId "+n);var r=this.webConferenceSessions[e];if(r){for(var i=0;i<r.videoGallery.length;i++)if(t===r.videoGallery[i].publisherId&&!r.videoGallery[i].sessionId){r.videoGallery[i].sessionId=n;break}this.$log.info(r.videoGallery)}}},e.prototype.removeSessionFromVideoGallery=function(e,t){if(e&&t){this.$log.info("[WebConferenceService] removeSessionFromVideoGallery for conference "+e.id+" sessionId "+t);for(var n=0;n<e.videoGallery.length;n++)e.videoGallery[n].sessionId===t&&(e.videoGallery[n].sessionId="",e.videoGallery[n].state="free",e.videoGallery[n].publisherId="",e.videoGallery[n].publisherJidIm="",e.videoGallery[n].displayName="")}},e.prototype.reInitialiseVideoGalleryElementById=function(e,t){if(e&&t){this.$log.info("[WebConferenceService] reInitialiseVideoGalleryElementById for conference "+e.id+" elementId "+t);for(var n=0;n<e.videoGallery.length;n++)e.videoGallery[n].id===t&&(e.videoGallery[n].sessionId&&this.dropRemoteVideoSession(e,e.videoGallery[n].sessionId),e.videoGallery[n].sessionId="",e.videoGallery[n].state="free",e.videoGallery[n].publisherId="",e.videoGallery[n].publisherJidIm="",e.videoGallery[n].displayName="")}},e.prototype.updateMainScreenSession=function(e,t){if(e&&t){this.$log.info("[WebConferenceService] updateMainScreenSession");var n=this.webConferenceSessions[e],r=null;if(n)for(var i in n.sessions)if(n.sessions.hasOwnProperty(i)){var a=n.sessions[i];t===a.sid?(a.mainSession=!0,r=a):a.mainSession=!1}r&&this.attachMainMediaStream(r)}},e.prototype.getListOfAvailableRemoteVideoPublishers=function(e){var t=this;if(e){this.$log.info("[WebConferenceService] getListOfAvailableRemoteVideoPublishers");var n=this.webConferenceSessions[e],r=[];return n&&(r=(r=n.getListOfRemoteVideoPublishers()).filter(function(e){for(var r=0;r<n.videoGallery.length;r++)if(n.videoGallery[r].publisherId===e.participantId)return!1;var i=t.contactService.getContactByJid(e.jid_im);return e.displayName=i?i.displayName:e.participantId,!0})),r}},e.prototype.sendTransportReplaceForSession=function(e,t){if(e)if(this.reconnecting)this.$log.warn("[WebConferenceService] sendTransportReplaceForSession already reconnecting !");else{var n=this;this.reconnecting=!0,t||(t=5e3),this.$interval(function(e){n.reconnecting=!1,n.connected&&e&&e.peerconnection&&"stable"===e.peerconnection.signalingState&&"failed"===e.peerconnection.iceConnectionState&&(n.$log.info("[WebConferenceService] sendTransportReplaceForSession for session "+e.sid),e.connection=n.xmppService.connection,e.sendTransportReplace())},t,1,!0,e)}else this.$log.warn("[WebConferenceService] sendTransportReplaceForSession missing session !")},e.prototype.setSpeakerDevice=function(){var e=this;this.platformService.allowDevicesManagement()&&angular.element("#globalAudioTag").length&&this.platformService.getCurrentSpeaker().then(function(t){var n="default";t&&t.id?(n=" id "+t.id+" and label "+t.label,e.platformService.setSpeakerForElement(angular.element("#globalAudioTag")[0],"default").then(function(){e.platformService.setSpeakerForElement(angular.element("#globalAudioTag")[0],t.id)})):e.platformService.setSpeakerForElement(angular.element("#globalAudioTag")[0],"default"),e.$log.info("[WebConferenceService] setSpeakerDevice "+n)})},e.prototype.onJingleError=function(e){this.$log.info("[WebConferenceService] onJingleError -- "+e);var t=this.getConferenceBySessionId(e);t&&t.sessions&&("audio"===t.sessions[e].localType?this.leaveWebConference(t.id):t.localVideoSessionId===e?this.removeMediaFromConferenceSession(t,"video"):t.localSharingSessionId===e?this.removeMediaFromConferenceSession(t,"sharing"):(this.removeSessionFromVideoGallery(t,e),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",t)))},e.prototype.onIceConnectionFailedForSession=function(e,t){if(this.$log.info("[WebConferenceService] onIceConnectionFailedForSession -- "+t),e&&e.sessions){var n=e.sessions[t];"audio"===n.localType?(e.status="reconnecting",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e),this.connected&&this.sendTransportReplaceForSession(n,5e3)):e.localVideoSessionId===t?this.removeMediaFromConferenceSession(e,"video"):e.localSharingSessionId===t?this.removeMediaFromConferenceSession(e,"sharing"):(this.removeSessionFromVideoGallery(e,t),delete e.sessions[t],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",e))}},e.prototype.onIncomingCall=function(e){this.$log.info("[WebConferenceService] onIncomingCall -- "+e);var t=this.xmppService.connection.jingle.sessions[e],n=t.confId,r=this.webConferenceSessions[n];r?(r.sessions[e]=t,t.localType=t.remoteType,t.sendAnswer(),t.accept(),t.publisherId&&"sharing"!==t.remoteType&&this.relateSessionToPublisher(n,t.publisherId,t.sid),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",r)):this.$log.error("[WebConferenceService] onIncomingCall no such conferenceSession "+n)},e.prototype.onTerminatedCall=function(e){this.$log.info("[WebConferenceService] onTerminatedCall -- "+e);var t=this.xmppService.connection.jingle.sessions[e];if(t){var n=t.confId,r=this.webConferenceSessions[n];r?(this.removeSessionFromVideoGallery(r,e),this.videoService.disableAudioVideoMedia(t),this.xmppService.connection.jingle.terminate(t.sid),delete r.sessions[t.sid],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",r)):this.$log.error("[WebConferenceService] onTerminatedCall no such conferenceSession "+n)}else{var i=this.getActiveConferenceSession();i&&i.sessions&&(this.removeSessionFromVideoGallery(i,e),this.videoService.disableAudioVideoMedia(i.sessions[e]),delete i.sessions[e],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",i))}},e.prototype.onIceConnectionStateChange=function(e,t){var n=this;this.$log.info("[WebConferenceService] onIceConnectionStateChange for session "+e);var r=this.getConferenceBySessionId(e);try{r&&t.peerconnection&&("stable"===t.peerconnection.signalingState&&"connected"===t.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection established successfully"),r.status="connected",t.remoteStreams&&t.remoteStreams.forEach(function(e){e.getAudioTracks().length>0&&n.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),e)}),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",r),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",r)),"stable"===t.peerconnection.signalingState&&"completed"===t.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection completed successfully"),"connected"!==r.status&&(r.status="connected",t.remoteStreams&&t.remoteStreams.forEach(function(e){e.getAudioTracks().length>0&&n.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),e)}),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",r),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",r))),"stable"===t.peerconnection.signalingState&&"disconnected"===t.peerconnection.iceConnectionState&&this.$log.info("[WebConferenceService] ICE Connection State disconnected"),"stable"===t.peerconnection.signalingState&&"failed"===t.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection State failed"),this.onIceConnectionFailedForSession(r,e)))}catch(e){this.$log.error("[WebConferenceService] onIceConnectionStateChange error "+e)}},e.$inject=["$q","$rootScope","$log","$http","uuid4","$interval","authService","xmppService","videoService","roomService","errorHelperService","ConferenceSession","contactService","platformService"],e}();angular.module("rainbow").service("webConferenceService",WebConferenceService),angular.module("rainbow").service("conferenceService",["$q","$rootScope","$interval","$translate","$log","$http","xmppService","authService","Conference","profileService","contactService","conferenceUserFactory","webConferenceService","pstnConferenceService","ConferenceSession","ConferenceParticipant","roomService",function(e,t,n,r,i,a,o,s,c,l,u,d,f,h,p,v,m){"use strict";var g=this;g.started=!1,g.listeners=[],g.start=function(n){var r=performance.now();return i.info(""),i.info("[conferenceService] === STARTING ==="),g.pstnConferenceEndpoints={},g.pstnInstantConferenceEndpoint=null,g.pstnConferenceUser=null,g.isPstnConferenceAvailable=!1,g.computePstnConferencePremission(),g.webConferenceEndpoints={},g.makeSnapshot={},g.portalURL=config.restServerUrl+"/api/rainbow/confprovisioning/v1.0/",g.conferencesPortalURL=config.restServerUrl+"/api/rainbow/conference/v1.0/conferences/",g.conferenceRef=null,g.attachHandlers(),g.listeners.push(t.$on("ON_PROFILE_FEATURES_UPDATED",function(){g.onMyProfileFeaturesChanged()})),g.listeners.push(t.$on("ON_CONFERENCE_DISCONNECTED_EVENT",function(e,t,n){t&&n&&g.disconnectsParticipant(t.id,n.participantId,"webrtc")})),g.listeners.push(t.$on("ON_CONFERENCE_JOIN_FAILED_EVENT",function(e,t){t&&g.stopConference(t,"webrtc")})),g.retrieveConferences().then(function(){return g.pstnInstantConferenceEndpoint?g.retrieveConferenceUser(u.userContact.dbId):e.when()}).then(function(){return g.makeSnapshots()}).then(function(){g.started=!0;var e=Math.round(performance.now()-r);n.push({service:"conferenceService",startDuration:e}),i.info("[conferenceService] === STARTED ("+e+" ms) ===")}).catch(function(e){i.info("[conferenceService] === STARTING FAILURE === "+e.message)}).finally(function(){}),e.when()},g.computePstnConferencePremission=function(){var e=l.isFeatureEnabled(l.FeaturesEnum.CONFERENCE_ALLOWED),n=!0,r=l.getMyProfiles();r&&r.length>0&&r.forEach(function(e){-1!==e.profileName.toLowerCase().indexOf("conference")&&-1!==e.status.toLowerCase().indexOf("active")&&e.provisioningNeeded&&e.provisioningNeeded.length>0&&e.provisioningNeeded.forEach(function(e){-1!==e.providerType.toLowerCase().indexOf("pgi")&&(n=e.provisioningOngoing)&&(g.conferenceProvisionRef&&(o.connection.deleteHandler(g.conferenceProvisionRef),g.conferenceProvisionRef=null),g.conferenceProvisionRef=o.connection.addHandler(g.onConferenceProvisionUpdate,null,"message","management"))})}),g.isPstnConferenceAvailable=e&&!n,t.$broadcast("ON_CONFERENCE_FEATURES_UPDATED")},g.onConferenceProvisionUpdate=function(e){return $(e).find("confuseractivated ").length>0&&(g.conferenceProvisionRef&&(o.connection.deleteHandler(g.conferenceProvisionRef),g.conferenceProvisionRef=null),g.isPstnConferenceAvailable=l.isFeatureEnabled(l.FeaturesEnum.CONFERENCE_ALLOWED),t.$broadcast("ON_CONFERENCE_FEATURES_UPDATED")),!0},g.retrieveConferences=function(){return e(function(e,t){if(i.info("[conferenceService] retrieveConferences"),!l.isFeatureEnabled(l.FeaturesEnum.CONFERENCE_ALLOWED)&&!l.isFeatureEnabled(l.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED))return i.warn("[conferenceService] retrieveConference - user is not allowed"),void t(new Error("notAllowed"));a({method:"GET",url:g.portalURL+"conferences?format=full&userId="+u.userContact.dbId,headers:s.getRequestHeader()}).then(function(t){var n=t.data.data;n&&n.forEach(function(e){if(e.hasOwnProperty("id")){var t=c.createFromData(e);t.userId===u.userContact.dbId&&("pstnAudio"===e.mediaType&&l.isFeatureEnabled(l.FeaturesEnum.CONFERENCE_ALLOWED)?(g.pstnConferenceEndpoints[e.id]=t,t.scheduled||(g.pstnInstantConferenceEndpoint=t,null!==g.pstnInstantConferenceEndpoint.name&&void 0!==g.pstnInstantConferenceEndpoint.name||g.updateConference(g.pstnInstantConferenceEndpoint.id,{name:r.instant("personalAudioConference")}))):"pstnAudio"!==e.mediaType&&l.isFeatureEnabled(l.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED)&&(g.webConferenceEndpoints[e.id]=t))}}),g.webConferenceEndpoints&&f.updateWebConferenceInfos(g.webConferenceEndpoints),null===g.pstnInstantConferenceEndpoint&&g.isPstnConferenceAvailable&&(i.info("[conferenceService] User has no instant conference : we create a new one"),g.retrieveConferenceUser(u.userContact.dbId).then(function(e){g.createInstantConference(e.id,"instantConference").then(function(e){g.pstnInstantConferenceEndpoint=e})})),i.info("[conferenceService] retrieveConferences successfully"),e()},function(e){var n="retrieveConferences failure: "+(e.data?e.data.errorDetails:e.data);i.error("[conferenceService] "+n),t(new Error(n))})})},g.retrieveConference=function(t){return e(function(e,n){i.info("[conferenceService] retrieveConference"),g.pstnConferenceEndpoints[t]?e():a({method:"GET",url:g.portalURL+"conferences/"+t,headers:s.getRequestHeader()}).then(function(t){var n=t.data.data;if(n&&n.hasOwnProperty("id")){var r=c.createFromData(n);"pstnAudio"===n.mediaType&&(g.pstnConferenceEndpoints[n.id]=r)}i.info("[conferenceService] retrieveConference successfully"),e()},function(e){var t="retrieveConference failure: "+(e.data?e.data.errorDetails:e.data);i.error("[conferenceService] "+t),n(new Error(t))})})},g.stop=function(){return e(function(e){if(i.info(""),i.info("[conferenceService] === STOPPING ==="),g.started=!1,g.listeners)for(var t;t=g.listeners.pop();)t();i.info("[conferenceService] === STOPPED ==="),e()})},g.attachHandlers=function(){i.info("[conferenceService] attachHandlers"),g.conferenceRef&&(o.connection.deleteHandler(g.conferenceRef),g.conferenceRef=null),g.conferenceRef=o.connection.addHandler(g.onConferenceUpdate,"jabber:iq:conference","message",null)},g.makeSnapshots=function(){return i.info("[conferenceService] makeSnapshots"),e(function(t){var n=[];for(var r in g.pstnConferenceEndpoints)if(g.pstnConferenceEndpoints.hasOwnProperty(r)){var a=g.pstnConferenceEndpoints[r];n.push(g.snapshot(a.id))}for(var r in g.webConferenceEndpoints)if(g.webConferenceEndpoints.hasOwnProperty(r)){a=g.webConferenceEndpoints[r];n.push(g.snapshot(a.id,"webrtc"))}e.all(n).finally(function(){i.info("[conferenceService] makeSnapshots done"),t()})})},g.markSnapshotAsMade=function(e){e&&(g.makeSnapshot[e]=!0)},g.makeSnapshotsForList=function(t){return e(function(n){if(i.info("[conferenceService] makeSnapshotsForList"),t&&t.length){for(var r=[],a=0;a<t.length;a++)r.push(g.snapshot(t[a].confEndpointId,t[a].mediaType));e.all(r).finally(function(){n(g.getConferenceSessionForRoom(t))})}else n()})},g.snapshot=function(t,n){return i.info("[conferenceService] snapshot for "+t),e(function(e,r){if(!t)return i.error("[conferenceService] snapshot missing conf ID !"),void r();if(g.makeSnapshot[t]){var a=h.getConferenceSessionById(t);if(a||(a=f.getConferenceSessionById(t)),a){if(a.getParticipantByJid(u.userContact.jid))return i.info("[conferenceService] snapshot already done, return result"),void e(a);g.removeConferenceSession(a)}}g.makeSnapshotForConfId(t,n).then(function(t){e(t)}).catch(function(e){r(e)})})},g.makeSnapshotForConfId=function(n,r){return i.info("[conferenceService] makeSnapshotForConfId "+n),e(function(e,o){if(!n)return i.error("[conferenceService] makeSnapshotForConfId missing conf ID !"),void o();var c="";r&&"webrtc"===r&&(c="?mediaType=webrtc"),a({method:"GET",url:g.conferencesPortalURL+n+"/snapshot"+c,headers:s.getRequestHeader(),data:c}).then(function(a){i.info("[conferenceService] makeSnapshotForConfId success for confId "+n),console.log(a),g.makeSnapshot[n]=!0;var o=a.data;if(o=Object.assign({_started:!0},o),"webrtc"===r){var s=null;o.data&&o.data.forEach(function(e){"disconnected"!==e.participantState&&e.jid_im===u.userContact.jid&&(s=e.participantId)}),s&&g.disconnectsParticipant(n,s,"webrtc");var c=p.createFromData(n,[],!1,r);f.webConferenceSessions[n]=c,t.$broadcast("ON_CONFERENCE_STATE_EVENT",c),g.makeSnapshot[n]=!1}else h.updateOrCreateConferenceSession(n,o);e(o)},function(t){if(i.info("[conferenceService] makeSnapshotForConfId failure for confID "+n),console.log(t),g.makeSnapshot[n]=!0,t.data&&404100===t.data.errorDetailsCode)e({_started:!1});else if(t.data&&403300===t.data.errorDetailsCode){var a={_started:!0};"webrtc"===r?g.updateOrCreateConferenceSession(n,a,"webrtc"):h.updateOrCreateConferenceSession(n,a),e(a)}else{if(t.data&&409e3===t.data.errorDetailsCode&&"webrtc"===r)i.info("[conferenceService] makeSnapshotForConfId conflict for confID "+n),g.webConferenceEndpoints[n]&&g.stopConference(n,"webrtc");var s=t.data?t.data.errorDetails:t.data,c="snapshot( confId="+n+") failure: "+s;i.error("[conferenceService] "+c),o(new Error(c))}})})},g.subscribeToPublisher=function(t,n,r){return e(function(e,o){if(!t||!n)return i.warn("[conferenceService] subscribeToPublisher missing parameters !! Ignore !"),void e();i.info("[conferenceService] subscribeToPublisher for confId "+t+" and publisher "+n.participantId),r&&f.relatePublisherToElement(t,n,r),a({method:"POST",url:g.conferencesPortalURL+t+"/participants/"+n.participantId+"/subscribe",headers:s.getRequestHeader()}).then(function(t){console.log(t),i.info("[conferenceService] subscribeToPublisher successfully"),e()},function(e){var t="subscribeToPublisher failure: "+(e.data?e.data.errorDetails:e.data);i.error("[conferenceService] "+t),o(new Error(t))})})},g.updateOrCreateConferenceSession=function(e,n,r){if(i.info("[conferenceService] updateOrCreateConferenceSession"),console.log(n),"webrtc"===r)var a=f.webConferenceSessions[e];else a=h.conferenceSessions[e];return a||(a=p.createFromData(e,[],!1,r),"webrtc"===r?f.webConferenceSessions[e]=a:h.conferenceSessions[e]=a),void 0!==n._started&&a.active!==n._started&&(a.updateActiveState(n._started),t.$broadcast("ON_CONFERENCE_STATE_EVENT",a)),n.data&&(a.participants=[],n.data.forEach(function(e){"disconnected"!==e.participantState&&a.participants.push(v.createFromData(e))}),t.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",a)),a},g.getPstnInstantConferenceEndpoint=function(){return g.pstnInstantConferenceEndpoint},g.getPstnInstantConferenceEndpointId=function(){return g.pstnInstantConferenceEndpoint?g.pstnInstantConferenceEndpoint.id:-1},g.getPstnConferenceUser=function(){return g.pstnConferenceUser},g.getPstnEndpoints=function(){return e.when(g.pstnConferenceEndpoints)},g.getWebConferenceEndpoints=function(){return g.webConferenceEndpoints},g.getConferenceSessionForRoom=function(e){var t=null;if(e&&e.length)for(var n=0;n<e.length;n++)(t=h.conferenceSessions[e[n].confEndpointId])||(t=f.webConferenceSessions[e[n].confEndpointId]);return t},g.removeConferenceSession=function(e){e&&e.id&&(f.removeConferenceSession(e.id),h.removeConferenceSession(e.id))},g.onConferenceUpdate=function(e){i.info("[conferenceService] onConferenceUpdate message: "+e.innerHTML);var t=$(e).find("conference-id").text();if(t){var n=h.getConferenceSessionById(t);if(n||(n=f.getConferenceSessionById(t)),n)g.updateConferenceSession(e,n);else{i.info("[conferenceService] no such session for ID "+t);var r=$(e).find("media-type"),a="";r&&r.text&&(a=r.text()),"webrtc"!==a&&g.makeSnapshotForConfId(t)}}return!0},g.updateConferenceSession=function(e,n){i.info("[conferenceService] updateConferenceSession");var r=$(e).find("conference-state");if(r.length){var a="true"===r.find("active").text(),o="true"===r.find("talker-active").text(),s="true"===r.find("recording-started").text();g.updateState(n,a,o,s)}var c=$(e).find("talkers");if(c.length){var l=[];c.find("participant-id").each(function(){var e=$(this).text();l.push(e)}),g.updateTalkers(n,l)}var u=$(e).find("participants");if(0===u.length&&(u=$(e).find("updated-participants")),u.length||(u=$(e).find("added-participants")),u.length){var d=[];u.find("participant").each(function(){var e=$(this),t=e.find("participant-id").text(),n=e.find("jid-im").text(),r=e.find("phone-number").text(),i=e.find("role").text(),a=e.find("mute").text(),o=e.find("hold").text(),s=e.find("cnx-state").text();d.push({participantId:t,jid_im:n,phoneNumber:r,participantRole:i,mute:"on"===a,held:"on"===o,participantState:s})}),g.createOrUpdateParticipants(n,d)}var f=$(e).find("removed-participants");if(f.length){var h=[];f.find("participant-id").each(function(){var e=$(this).text();h.push(e)}),g.removeParticipants(n,h)}var p=$(e).find("added-publishers");p.length&&(p.find("publisher").each(function(){var e=$(this),t=e.find("publisher-id").text(),r=e.find("media-type").text(),i=e.find("jid-im").text();g.addPublisher(n,t,r,i)}),console.log(n.publishers),t.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",n));var v=$(e).find("removed-publishers");v.length&&(v.find("publisher").each(function(){for(var e=$(this),t=e.find("participant-id").text(),r=e.find("media-type").text(),i=0;i<n.publishers.length;i++){var a=n.publishers[i];if(a.participantId===t&&a.mediaType===r){n.publishers.splice(i,1);break}}}),console.log(n.publishers),t.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",n));var m=$(e).find("publishers");return m.length&&(m.find("publisher").each(function(){var e=$(this),t=e.find("publisher-id").text(),r=e.find("media-type").text(),i=e.find("jid-im").text();g.addPublisher(n,t,r,i)}),console.log(n.publishers),t.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",n)),!0},g.updateState=function(e,n,i,a){if(!n&&g.started&&(u.resetBusyState(),g.started=!1),e.active&&!n){e.participants=[],e.status="ended";var o=m.findRoomWithConfId(e.id);if(o&&o.length)if(o[0].ownerContact.id!==u.userContact.id)if(s.isGuest)t.$broadcast("ON_OPEN_POPUP","concludeInvitation");else{var c={popupTitle:"information",popupBodyTranslated:r.instant("meetingEndBy",{owner:o[0].ownerContact.displayName,meeting:o[0].name}),okLabel:"ok"};t.$broadcast("ON_OPEN_GLOBAL_POPUP",c)}}e.updateStateFromData(n,i,a),t.$broadcast("ON_CONFERENCE_STATE_EVENT",e)},g.addPublisher=function(e,t,r,a){for(var o=!0,s=0;s<e.publishers.length;s++){var c=e.publishers[s];if(c.participantId===t&&c.mediaType===r){o=!1;break}}var l={participantId:t,mediaType:r,jid_im:a};if(o&&e.publishers.push(l),o&&"video"===r){var u=f.getFreeVideoGalleryElement(e.id);u&&!f.isAlreadySubscribedToPublisher(l.participantId)&&(i.info("[conferenceService] subscribe to publisher "+e.id+" for id "+t+"and element id "+u.id),u.state="busy",u.publisherId=l.participantId,n(function(e,t,n){i.info("[conferenceService] subscribe to publisher "+e.id+" for id "+t.participantId+"and element id "+u.id),g.subscribeToPublisher(e.id,t,n).catch(function(){i.error("[conferenceService] subscribe to publisher failed, reset the video gallery element with id "+n),f.reInitialiseVideoGalleryElementById(e,n)})},2500,1,!0,e,l,u.id))}},g.updateTalkers=function(e,n){e.updateTalkers(n),t.$broadcast("ON_CONFERENCE_TALKER_EVENT",e)},g.createOrUpdateParticipants=function(e,n){e.updateParticipants(n),e.participants.find(function(e){return e.jid_im===u.userContact.id&&"disconnected"!==e.state})&&(u.setBusyState("dnd","audio"),g.started=!0),t.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",e)},g.removeParticipants=function(e,i){e&&(e.removeParticipants(i),e.participants.find(function(e){return e.jid_im===u.userContact.id})||(u.resetBusyState(),g.started=!1,"webrtc"===e.type&&f.removeAllJingleSessionsForConferenceSession(e.id),n(function(){if(e.active){var n=m.findRoomWithConfId(e.id);if(n.length&&!n[0].owner)if(s.isGuest)t.$broadcast("ON_OPEN_POPUP","concludeInvitation");else{var i={popupTitle:"information",popupBodyTranslated:r.instant("meetingDisconnect",{meeting:n[0].name}),okLabel:"ok"};t.$broadcast("ON_OPEN_GLOBAL_POPUP",i)}e.active=!1}},1e3,1)),t.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",e),e.participants&&e.participants.length)},g.stopConference=function(n,r){return n?e(function(e,o){i.info("[conferenceService] stopConference( confId="+n+", type="+r+")");var c={};"webrtc"===r&&(c={mediaType:r}),a({method:"PUT",url:g.conferencesPortalURL+n+"/stop",headers:s.getPostHeader(),data:c}).then(function(){var r=h.getConferenceSessionById(n);r||(r=f.getConferenceSessionById(n)),r&&(r.active=!1,r.participants=[],g.removeConferenceSession(r),t.$broadcast("ON_CONFERENCE_STATE_EVENT",r)),u.resetBusyState(),i.info("[conferenceService] stopConference( confId="+n+") successfully"),e()},function(e){var r=e.data?e.data.errorDetails:e.data,a="stopConference( confId="+n+") failure: "+r;if(i.error("[conferenceService] "+a),404e3!==e.data.errorDetailsCode){t.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"warning",popupBody:"stopMeetingFailure",okLabel:"ok"})}else{var s=h.getConferenceSessionById(n);s||(s=f.getConferenceSessionById(n)),s&&(s.active=!1,s.participants=[],g.removeConferenceSession(s),t.$broadcast("ON_CONFERENCE_STATE_EVENT",s))}o(new Error(a))})}):(i.warn("[conferenceService] stopConference missing conf ID !"),e.reject())},g.disconnectsParticipant=function(t,n,r){return e(function(e,o){i.info("[conferenceService] disconnectsParticipant( confId="+t+"participantId="+n+")");var c="";r&&(c="?mediaType="+r),a({method:"DELETE",url:g.conferencesPortalURL+t+"/participants/"+n+c,headers:s.getRequestHeader()}).then(function(){i.info("[conferenceService] disconnectsParticipant( confId="+t+"participantId="+n+") successfully"),e()},function(e){var r=e.data?e.data.errorDetails:e.data,a="disconnectsParticipant( confId="+t+"participantId="+n+") failure: "+r;i.error("[conferenceService] "+a),o(new Error(a))})})},g.updateParticipantState=function(t,n,r){return e(function(e,o){var c="pstnAudio";g.isWebConferenceSessionForEndpoint(t)&&(c="webrtc"),i.info("[conferenceService] updateParticipantState( confId="+t+"participantId="+n+" type="+c+")"),a({method:"PUT",url:g.conferencesPortalURL+t+"/participants/"+n,headers:s.getRequestHeader(),data:{option:r,mediaType:c}}).then(function(r){var a=r.data.data;i.info("[conferenceService] updateParticipantState( confId="+t+"participantId="+n+") successfully"),e(a)},function(e){var r=e.data?e.data.errorDetails:e.data,a="updateParticipantState( confId="+t+"participantId="+n+") failure: "+r;i.error("[conferenceService] "+a),o(new Error(a))})})},g.updateConferenceState=function(t,n){return e(function(e,r){var o="pstnAudio";g.isWebConferenceSessionForEndpoint(t)&&(o="webrtc"),i.info("[conferenceService] updateConferenceState( confId="+t+", type="+o+")"),a({method:"PUT",url:g.conferencesPortalURL+t+"/update",headers:s.getRequestHeader(),data:{option:n,mediaType:o}}).then(function(n){var r=n.data.data;i.info("[conferenceService] updateConferenceState( confId="+t+") successfully"),e(r)},function(e){var n=e.data?e.data.errorDetails:e.data,a="updatsConferenceState( confId="+t+") failure: "+n;i.error("[conferenceService] "+a),r(new Error(a))})})},g.isUserContactInCall=function(){var e=!1;for(var t in f.webConferenceSessions){if(f.webConferenceSessions.hasOwnProperty(t))f.webConferenceSessions[t].isParticipantConnectedByJid(u.userContact.jid)&&(e=!0)}return e},g.isWebConferenceSessionForEndpoint=function(e){var t=f.getConferenceSessionById(e);return t&&"webrtc"===t.type},g.createInstantConference=function(t,n){return e(function(e,r){i.info("[conferenceService] createInstantConference"),a({method:"POST",url:g.portalURL+"conferences",headers:s.getRequestHeader(),data:{confUserId:t,name:n}}).then(function(t){var n=t.data.data,r=c.createFromData(n);n.hasOwnProperty("id")&&("pstnAudio"===n.mediaType?g.pstnConferenceEndpoints[n.id]=r:g.webConferenceEndpoints[n.id]=r),i.info("[conferenceService] createInstantConference successfully"),e(r)},function(e){var t="createInstantConference failure: "+(e.data?e.data.errorDetails:e.data);i.error("[conferenceService] "+t),r(new Error(t))})})},g.createConference=function(t,n,r,o,l){return e(function(e,u){i.info("[conferenceService] createConference"),a({method:"POST",url:g.portalURL+"conferences",headers:s.getRequestHeader(),data:{confUserId:t,name:n,startDate:r,endDate:o,timeZone:l}}).then(function(t){var n=t.data.data,r=c.createFromData(n);n.hasOwnProperty("id")&&("pstnAudio"===n.mediaType?g.pstnConferenceEndpoints[n.id]=r:g.webConferenceEndpoints[n.id]=r),i.info("[conferenceService] createConference successfully"),e(r)},function(e){var t="createConference failure: "+(e.data?e.data.errorDetails:e.data);i.error("[conferenceService] "+t),u(new Error(t))})})},g.updateConference=function(t,n){return i.info("[conferenceService] updateConference"),e(function(e,r){if(t)a({method:"PUT",url:g.portalURL+"conferences/"+t,headers:s.getRequestHeader(),data:n}).then(function(t){var n=t.data.data,r=c.createFromData(n);n.hasOwnProperty("id")&&("pstnAudio"===n.mediaType?(g.pstnConferenceEndpoints[n.id]&&delete g.pstnConferenceEndpoints[n.id],g.pstnConferenceEndpoints[n.id]=r,n.scheduled||(delete g.pstnInstantConferenceEndpoint,g.pstnInstantConferenceEndpoint=r)):g.webConferenceEndpoints[n.id]=r),i.info("[conferenceService] updateConference successfully"),e(r)},function(e){var t="updateConference failure: "+(e.data?e.data.errorDetails:e.data);i.error("[conferenceService] "+t),r(new Error(t))});else{i.error("[conferenceService] updateConference failure : No confEndpoint"),r(new Error("updateConference failure: No confEndpoint"))}})},g.deleteConference=function(t){return e(function(e,n){i.info("[conferenceService] deleteConference"),a({method:"DELETE",url:g.portalURL+"conferences/"+t,headers:s.getRequestHeader()}).then(function(){g.pstnConferenceEndpoints[t]&&g.pstnInstantConferenceEndpoint&&g.pstnInstantConferenceEndpoint.id!==t&&delete g.pstnConferenceEndpoints[t],g.webConferenceEndpoints[t]&&delete g.webConferenceEndpoints[t],i.info("[conferenceService] deleteConference successfully"),e()},function(e){var t="deleteConference failure: "+(e.data?e.data.errorDetails:e.data);i.error("[conferenceService] "+t),n(new Error(t))})})},g.retrieveConferenceUser=function(t){return null!==g.pstnConferenceUser?e.resolve(g.pstnConferenceUser):e(function(e,n){i.info("[conferenceService] retrieveConferenceUser"),a({method:"GET",url:g.portalURL+"users?userId="+t,headers:s.getRequestHeader()}).then(function(t){var n=t.data.data;n&&n.length&&(g.pstnConferenceUser=d(n[0]),i.info("[conferenceService] retrieveConferenceUser successfully")),e(g.pstnConferenceUser)},function(e){var t="retrieveConferenceUser failure: "+(e.data?e.data.errorDetails:e.data);i.error("[conferenceService] "+t),n(new Error(t))})})},g.onMyProfileFeaturesChanged=function(){var n=g.isPstnConferenceAvailable;g.computePstnConferencePremission(),!1===g.isPstnConferenceAvailable&&!0===n&&t.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"information",popupBody:"pgiRightsRemovedWarning",okLabel:"ok"}),g.retrieveConferences().then(function(){return g.pstnInstantConferenceEndpoint?g.retrieveConferenceUser(u.userContact.dbId):e.when()})}}]),angular.module("rainbow").service("profileService",["$q","$rootScope","$log","$http","$interval","Offer","authService","contactService",function(e,t,n,r,i,a,o,s){"use strict";var c=this;c.FeaturesEnum={COMPANY_ADMIN_COUNT:"COMPANY_ADMIN_COUNT",COMPANY_LOGO_MODIFICATION:"COMPANY_LOGO_MODIFICATION",COMPANY_DOMAIN_NAME_MODIFICATION:"COMPANY_DOMAIN_NAME_MODIFICATION",COMPANY_DETAILS_MODIFICATION:"COMPANY_DETAILS_MODIFICATION",WEBRTC_FOR_MOBILE:"WEBRTC_FOR_MOBILE",BUBBLE_PARTICIPANT_COUNT:"BUBBLE_PARTICIPANT_COUNT",CHANNEL_PARTICIPANT_COUNT:"CHANNEL_PARTICIPANT_COUNT",TELEPHONY_BASIC_CALL:"TELEPHONY_BASIC_CALL",TELEPHONY_SECOND_CALL:"TELEPHONY_SECOND_CALL",TELEPHONY_TRANSFER_CALL:"TELEPHONY_TRANSFER_CALL",TELEPHONY_CONFERENCE_CALL:"TELEPHONY_CONFERENCE_CALL",TELEPHONY_DEFLECT_CALL:"TELEPHONY_DEFLECT_CALL",TELEPHONY_PHONE_BOOK:"TELEPHONY_PHONE_BOOK",TELEPHONY_VOICE_MAIL:"TELEPHONY_VOICE_MAIL",TELEPHONY_CALL_FORWARD:"TELEPHONY_CALL_FORWARD",CONFERENCE_PARTICIPANT_COUNT:"CONFERENCE_PARTICIPANT_COUNT",CONFERENCE_PARTICIPANT_ALLOWED:"CONFERENCE_PARTICIPANT_ALLOWED",WEBRTC_CONFERENCE_ALLOWED:"WEBRTC_CONFERENCE_ALLOWED",WEBRTC_CONFERENCE_PARTICIPANT_COUNT:"WEBRTC_CONFERENCE_PARTICIPANT_COUNT",WEBRTC_PARTICIPANT_ALLOWED:"WEBRTC_PARTICIPANT_ALLOWED",CONFERENCE_ALLOWED:"CONFERENCE_ALLOWED",CONFERENCE_DIAL_OUT:"CONFERENCE_DIAL_OUT",CONFERENCE_RECORDING:"CONFERENCE_RECORDING",MSO365_CALENDAR_PRESENCE:"MSO365_CALENDAR_PRESENCE",MSO365_DIRECTORY_SEARCH:"MSO365_DIRECTORY_SEARCH",MS_OUTLOOK_PLUGIN:"MS_OUTLOOK_PLUGIN",MS_SKYPE_PLUGIN:"MS_SKYPE_PLUGIN",FILE_SHARING_QUOTA_GB:"FILE_SHARING_QUOTA_GB",GOOGLE_CALENDAR_PRESENCE:"GOOGLE_CALENDAR_PRESENCE",WEBRTC_P2P_RECORDING:"WEBRTC_P2P_RECORDING",BUBBLE_PROMOTE_MEMBER:"BUBBLE_PROMOTE_MEMBER",BUBBLE_GUESTS_ALLOWED:"BUBBLE_GUESTS_ALLOWED",TELEPHONY_WEBRTC_GATEWAY:"TELEPHONY_WEBRTC_GATEWAY",ANALYTICS_DASHBOARD_EC:"ANALYTICS_DASHBOARD_EC",ANALYTICS_DASHBOARD_BP:"ANALYTICS_DASHBOARD_BP"},c.started=!1,c.start=function(r){n.info(""),n.info("[profileService] === STARTING ==="),c.features={},c.profiles=[],c.mainOffers=[];var i=performance.now();return e(function(e,a){c.getServerProfile().then(function(){c.started=!0;var a=Math.round(performance.now()-i);r.push({service:"profileService",startDuration:a}),n.info("[profileService] === STARTED ("+a+" ms) ==="),t.$broadcast("ON_PROFILE_FEATURES_UPDATED"),t.$on("$destroy",t.$on("ON_PROFILE_FEATURES_UPDATE_NEEDED",c.onUserUpdateNeeded)),e()}).catch(function(e){n.info("[profileService] === STARTING FAILURE === "+e.message),a(e)})})},c.stop=function(){return n.info("[profileService] === STOPPING ==="),c.started=!1,n.info("[profileService] === STOPPED ==="),e.when()},c.restart=function(){n.info("[profileService] === RESTART ==="),c.onUserUpdateNeeded()},c.onUserUpdateNeeded=function(e){c.timer||(c.timer=i(function(){c.getServerProfile().then(function(){t.$broadcast("ON_PROFILE_FEATURES_UPDATED"),c.timer=null}).catch(function(e){c.timer=null,n.info("[profileService] === onUserUpdateNeeded FAILURE === "+e.message)})},3e3,1))},c.getServerProfile=function(){return e.all([c.getServerProfiles(),c.getServerProfilesFeatures()])},c.getServerProfiles=function(){return e(function(e,t){r({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId+"/profiles",headers:o.getRequestHeader()}).then(function(t){c.profiles=[],c.mainOffers=[],t.data.data.forEach(function(e){n.debug("[profileService] getServerProfiles === response ==="+e),c.profiles.push(e);var t=a.createFromProfileData(e);(t.isExclusive||t.isDefault)&&c.mainOffers.push(t)}),c.mainOffers.sort(a.offerComparator),e()},function(e){var r="getServerProfiles failure: no server response";e&&(r="getServerProfiles failure: "+JSON.stringify(e)),n.error("[profileService] "+r),t(new Error(r))})})},c.getServerProfilesFeatures=function(){return e(function(e,t){r({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId+"/profiles/features",headers:o.getRequestHeader()}).then(function(t){c.features={},t.data.data.forEach(function(e){n.debug("[profileService] getServerProfilesFeatures === response ==="+e),e.hasOwnProperty("featureUniqueRef")&&(c.features[e.featureUniqueRef]=e)}),e()},function(e){var r="getServerProfilesFeatures failure: no server response";e&&(r="getServerProfilesFeatures failure: "+JSON.stringify(e)),n.error("[profileService] "+r),t(new Error(r))})})},c.getUserData=function(){return o.getUserData()},c.setUserData=function(t){return e(function(e,i){var a=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+s.userContact.dbId;r({method:"PUT",url:a,headers:o.getRequestHeader(),data:t}).then(function(r){n.info("[profileService] setUserData "+JSON.stringify(t)+" -- success"),e(r.data)},function(e){var t="setUserData failure: no server response";e&&(t="setUserData failure: "+JSON.stringify(e)),n.error("[profileService] "+t),i(new Error(t))})})},c.isFeatureEnabled=function(e){if(c.started&&c.features.hasOwnProperty(e)&&c.features[e].hasOwnProperty("featureType")&&"boolean"===c.features[e].featureType&&c.features[e].hasOwnProperty("isEnabled")){var t=c.features[e].isEnabled;return n.debug("[profileService] isFeatureEnabled("+e+"): "+t),t}return n.info("[profileService] isFeatureEnabled("+e+"): service not started or feature not enabled"),!1},c.getFeatureLimitMax=function(e){if(c.started&&c.features.hasOwnProperty(e)&&c.features[e].hasOwnProperty("featureType")&&"number"===c.features[e].featureType&&c.features[e].hasOwnProperty("limitMax")){var t=c.features[e].limitMax;return n.debug("[profileService] getFeatureLimitMax("+e+"): "+t),t}return n.info("[profileService] getFeatureLimitMax("+e+"): service not started or feature not enabled"),0},c.getFeatureLimitMin=function(e){if(c.started&&c.features.hasOwnProperty(e)&&c.features[e].hasOwnProperty("featureType")&&"number"===c.features[e].featureType&&c.features[e].hasOwnProperty("limitMin")){var t=c.features[e].limitMin;return n.debug("[profileService] getFeatureLimitMin("+e+"): "+t),t}return n.info("[profileService] getFeatureLimitMin("+e+"): service not started or feature not enabled"),0},c.getMyProfileOffer=function(){return c.mainOffers.length>0?c.mainOffers.slice(-1)[0]:null},c.getMyProfileName=function(){var e=this.getMyProfileOffer();return e?e.name:null},c.getMyProfiles=function(){var e=[];return c.started?e=c.profiles:n.warn("[profileService] getMyProfiles(): service not started"),e},c.getMyProfileFeatures=function(){var e={};return c.started?Object.keys(c.features).forEach(function(t){var n=c.features[t],r={};Object.keys(n).filter(function(e){return"featureUniqueRef"===e||"featureType"===e||"limitMin"===e||"limitMax"===e||"isEnabled"===e}).forEach(function(e){r[e]=n[e]}),e[t]=r}):n.warn("[profileService] getMyProfileFeatures(): service not started"),e}}]),angular.module("rainbow").service("updatingService",["$http","$log","$rootScope","$interval","randomString","centralizedService",function(e,t,n,r,i,a){"use strict";var o=this;o.url=window.location.origin+"/app/"+version+"/js/version.js",o.started=!1,o.start=function(){t.info("[updatingService] === STARTING ==="),o.started=!0,t.info("[updatingService] === STARTED ==="),-1===o.url.indexOf("localhost")?(o.interval&&r.cancel(o.interval),o.interval=r(o.checkUpdate,6e5),a.isDesktopApp()&&(o.intervalDesktop&&r.cancel(o.intervalDesktop),o.intervalDesktop=r(o.checkUpdateForDesktop,6e4))):t.info("[updatingService] Do not start on localhost")},o.checkUpdate=function(){t.info("[updatingService] - Checking if a new version is online..."),e({method:"GET",url:o.url+"?rand="+i()}).then(function(){t.info("[updatingService] - The web client is up to date")},function(e){404===e.status?n.$broadcast("ON_AVAILABLE_UPDATE"):t.info("[updatingService] - An unknow error has been encountered.")})},o.checkUpdateForDesktop=function(){var e=a.containerVersion();if(t.info("[updatingService] - Checking if a new desktop version is available... "+e),!e){var r=navigator.userAgent.substring(navigator.userAgent.indexOf("Rainbow"));r&&(e=r.split("/")[1])}if(e){var i=e.split(".");if(parseInt(i[1],10)<35||35===parseInt(i[1],10)&&parseInt(i[2],10)<=4){t.info("[updatingService] - should update from version "+e);var o={popupTitle:"updatingDesktopTitle",popupBody:"updatingDesktopMessage",okLabel:"download",okLink:config.autorizationMicrosoftLink,blockingPopup:!0};navigator.platform.toUpperCase().indexOf("MAC")>=0?o.okLink=config.clientsURL.mac:o.okLink=config.clientsURL.windows,n.$broadcast("ON_OPEN_GLOBAL_POPUP",o)}}else t.error("[updatingService] - no desktop version found !! ")},o.stop=function(){t.info("[updatingService] === STOPPING ==="),o.started=!1,o.interval&&r.cancel(o.interval),o.intervalDesktop&&r.cancel(o.intervalDesktop),t.info("[updatingService] === STOPPED ===")}}]),angular.module("rainbow").service("calendarService",["$q","$rootScope","$window","$log","$http","$localStorage","$interval","authService","contactService","xmppService","errorHelperService","profileService","conversationService","settingsService",function(e,t,n,r,i,a,o,s,c,l,u,d,f,h){"use strict";var p=this;this.started=!1;var v=[];this.start=function(n){r.info(""),r.info("[calendarService] === STARTING ===");var i=performance.now();p.autorizationLink="",p.autorizationPopup=null,p.serviceActivated=!1,p.currentState="";var a=d.isFeatureEnabled(d.FeaturesEnum.MSO365_CALENDAR_PRESENCE)||d.isFeatureEnabled(d.FeaturesEnum.GOOGLE_CALENDAR_PRESENCE);return p.officeCalendarPresenceEnabled=d.isFeatureEnabled(d.FeaturesEnum.MSO365_CALENDAR_PRESENCE),p.googleCalendarPresenceEnabled=d.isFeatureEnabled(d.FeaturesEnum.GOOGLE_CALENDAR_PRESENCE),r.info("Calendar presence status from profileService : "+a),r.info("Calendar presence status from config : "+config.calendarPresence),config.calendarPresence&&v.push(t.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",p.onCalendarPresenceChange)),a&&config.calendarPresence&&(p.attachHandlers(),p.getCalendarState().then(function(e){if("none"!==e.status&&"deleted"!==e.status&&"consent_required"!==e.status){p.started=!0,p.serviceActivated=!0;var t=Math.round(performance.now()-i);n.push({service:"calendarService",startDuration:t}),r.info("[calendarService] === STARTED ("+t+" ms) ===");var a=new Date(e.until),o=!1===e.busy?"online":"busy";p.updateCalendarPresenceForUser(c.userContact.jid,o,a)}else p.showRegisterPopup()}).catch(function(){p.showRegisterPopup()})),o(this.getAutoReplyForEachContact,5e3,1),p.intervalID=o(this.updateAutoReplyForEachContact,9e5),e.when()},this.stop=function(){var t;for(r.info("[calendarService] === STOPPING ==="),this.started=!1,p.serviceActivated=!1,p.currentState="";t=v.pop();)t();return this.messageHandlerRef&&(l.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),null!==p.intervalID&&o.cancel(p.intervalID),r.info("[calendarService] === STOPPED ==="),e.when()},this.updateAutoReplyForEachContact=function(){p.getCalendarState().then(function(e){if("none"!==e.status&&"deleted"!==e.status){p.started=!0,p.serviceActivated=!0,r.info("[calendarService] === STARTED ===");var t=new Date(e.until),n=!1===e.busy?"online":"busy";p.updateCalendarPresenceForUser(c.userContact.jid,n,t)}})},this.getAutoReplyForEachContact=function(){r.info("[calendarService] getAutoReplyForEachContact"),f.getConversations().forEach(function(e){null!==e.contact&&p.getAutoReplyInfoForContact(e.contact)})},this.attachHandlers=function(){r.info("[calendarService] attachHandlers"),this.messageHandlerRef&&(l.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.messageHandlerRef=l.addHandler(function(e){return p.onUpdateMessageReceived(e),!0},"jabber:iq:configuration","message",null)},this.onCalendarPresenceChange=function(e,t){if(c.isTelJid(t.jid)&&"calendar"===c.getRessourceFromJid(t.jid)){r.info("[calendarService] === onCalendarPresenceChange ===");var n=c.getImJid(t.jid);p.updateCalendarPresenceForUser(n,t.status,t.until,t.message)}return!0},this.onUpdateMessageReceived=function(e){var n=$(e).find("calendar");if(n.length){var i=n.attr("status");r.info("[calendarService] === onUpdateMessageReceived with status "+i),p.serviceActivated="enabled"===i,t.$broadcast("ON_CALENDAR_STATUS_CHANGE",p.serviceActivated)}},this.getCalendarState=function(){return r.info("[calendarService] getCalendarState"),e(function(e,t){i({method:"GET",url:config.restServerUrl+"/api/rainbow/calendar/v1.0",headers:s.getRequestHeader()}).then(function(t){r.info("[calendarService] getCalendarState success"),e(t.data)},function(e){r.error("[calendarService] getCalendarState failure"),t()})})},this.getCalendarsData=function(){return e(function(n){p.serviceActivated&&(r.warn("[calendarService] already registered, ignore !"),n());var i=[];p.officeCalendarPresenceEnabled&&i.push(p.getCalendarData("office365")),p.googleCalendarPresenceEnabled&&i.push(p.getCalendarData("googleCalendar")),e.all(i).finally(function(){if(p.autorizationGoogleLink){e={authentMicrosoftUrl:p.autorizationMicrosoftLink,authentGoogleUrl:p.autorizationGoogleLink};t.$broadcast("ON_OPEN_CALENDARSELECTION_POPUP",e)}else{var e={popupTitle:"calendarPopupTitle",popupBody:"calendarPresenceSettings",cancelLabel:"cancel",okLabel:"accept",okLink:p.autorizationMicrosoftLink};t.$broadcast("ON_OPEN_GLOBAL_POPUP",e)}n()})})},this.getCalendarData=function(t){r.info("[calendarService] getCalendarData");var n="o365",a="office365";return"googleCalendar"===t&&(n="gcal",a="google"),e(function(e,o){var c=h.getAppliLanguage().code;i({method:"POST",url:config.restServerUrl+"/api/rainbow/calendar/v1.0/register",headers:s.getRequestHeader(),data:{type:a,callback:window.location.origin+"/redirectO365.html?provider="+n+"&lang="+c}}).then(function(n){r.info("[calendarService] getCalendarData success"),p.autorizationLink=n.data.url,"googleCalendar"===t?p.autorizationGoogleLink=p.autorizationLink:p.autorizationMicrosoftLink=p.autorizationLink,e(p.autorizationLink)},function(e){r.error("[calendarService] getCalendarData failure"),r.error(e),o()})})},this.registerNewCalendar=function(t){return r.info("[calendarService] registerNewCalendar"),e(function(e,n){var a="o365",o="office365";"googleCalendar"===t&&(a="gcal",o="google");var c=h.getAppliLanguage().code;i({method:"POST",url:config.restServerUrl+"/api/rainbow/calendar/v1.0/register",headers:s.getRequestHeader(),data:{type:o,callback:window.location.origin+"/redirectO365.html?provider="+a+"&lang="+c}}).then(function(t){r.info("[calendarService] registerNewCalendar success"),p.autorizationLink=t.data.url,p.openAuthentificationPage(),e()},function(e){r.error("[calendarService] registerNewCalendar failure"),r.error(e),n()})})},this.deactivateCalendar=function(){return r.info("[calendarService] deactivateCalendar"),e(function(e,t){if(!p.serviceActivated)return r.warn("[calendarService] already unregistered, ignore !"),void e();i({method:"DELETE",url:config.restServerUrl+"/api/rainbow/calendar/v1.0",headers:s.getRequestHeader()}).then(function(){r.info("[calendarService] deactivateCalendar success"),p.serviceActivated=!1,p.currentState="",e()},function(e){r.error("[calendarService] deactivateCalendar failure"),r.error(e),t()})})},this.getAutoReplyInfoForContact=function(t){return e(function(e,n){if(!t.calendarState.status)return r.info("[calendarService] getAutoReplyInfoForContact user has no calendar state"),void e();if(t.calendarState.lastUpdate){var a=moment.duration(t.calendarState.lastUpdate.diff(moment()));if(Math.abs(Math.floor(a.asMinutes()))<15)return r.info("[calendarService] getAutoReplyInfoForContact state has been updated in the last 15min"),void e()}t.calendarState.lastUpdate=moment(),i({method:"GET",url:config.restServerUrl+"/api/rainbow/calendar/v1.0/automatic_reply?userid="+t.jid,headers:s.getRequestHeader()}).then(function(n){p.treatOutOfOfficeState(n.data,t),r.info("[calendarService] getAutoReplyInfoForContact success for contact "+t.jid),e()},function(e){var t=u.handleError(e);r.error("[calendarService] "+u.getErrorFullMessage(e,"getAutoReplyInfoForContact")),n(t)})})},this.updateCalendarPresenceForUser=function(e,n,i,a){c.getOrCreateContact(e).then(function(o){o.calendarState.status=n,o.calendarState.message=a,"online"===n||i||(i=new Date);var s=null;i&&(s=moment(i)),o.calendarState.mdate=s,s?s.isSame(moment(),"d")?(o.calendarState.until=s.format("LT"),o.calendarState.untilDate=!1):(o.calendarState.until=s.format("ll"),o.calendarState.untilDate=!0):(i||(i=new Date),o.calendarState.until=i,o.calendarState.untilDate=!1),c.isUserContact(o)?(r.info("[calendarService] updateCalendarPresenceForUser for my user : "+n+" until "+i),p.serviceActivated||"offline"===n||(p.serviceActivated=!0,t.$broadcast("ON_CALENDAR_STATUS_CHANGE",p.serviceActivated)),p.getAutoReplyInfoForContact(c.userContact)):r.info("[calendarService] updateCalendarPresenceForUser for user : "+e+" with : "+n+" until "+i),t.$broadcast("ON_CONTACT_CALENDAR_STATUS_CHANGE",o)}).catch(function(t){r.error("[calendarService] updateCalendarPresenceForUser failure for user "+e+" with error : "+t)})},this.treatOutOfOfficeState=function(e,n){if(r.info("[calendarService] treatOutOfOfficeState for user : "+n.jid+" with data enabled "+e.enabled+" and text "+e.message_text+" and date end "+e.end),e.enabled){if(n.calendarState.autoReplyOn=!0,n.calendarState.autoReplyInfos={},e.message_text&&(n.calendarState.autoReplyInfos.message=": "+e.message_text),e.end){var i=moment(e.end);n.calendarState.autoReplyInfos.mdate=i,i?i.isSame(moment(),"d")?(n.calendarState.autoReplyInfos.until=i.format("LT"),n.calendarState.autoReplyInfos.untilDate=!1):(n.calendarState.autoReplyInfos.until=i.format("ll"),n.calendarState.autoReplyInfos.untilDate=!0):(n.calendarState.autoReplyInfos.until=e.end,n.calendarState.autoReplyInfos.untilDate=!0)}}else n.calendarState.autoReplyOn=!1,n.calendarState.autoReplyInfos={};t.$broadcast("ON_CONTACT_CALENDAR_STATUS_CHANGE",n)},this.isServiceActivated=function(){return p.serviceActivated},this.getAutorizationLink=function(){return p.autorizationLink},this.openAuthentificationPopup=function(){p.autorizationPopup=n.open("","popup","scrollbars=1,resizable=1,height=560,width=770")},this.openAuthentificationPage=function(){p.autorizationPopup.location.href=p.autorizationLink,p.autorizationPopup.focus()},this.openAuthWindow=function(e){n.open(e,"Popup","scrollbars=1,resizable=1,height=560,width=770")},this.showRegisterPopup=function(){a.get(["calendarPresence"]).then(function(e){e.calendarPresence||p.getCalendarsData()})},this.calendarOkCallback=function(e){p.registerNewCalendar(e).then(function(){p.started=!0,r.info("[calendarService] === STARTED ===")}).catch(function(){r.error("[calendarService] === STARTING FAILURE ===")})},this.calendarCancelCallback=function(){p.calendarPresence=!1,a.set({calendarPresence:!0})}}]),function(){"use strict";angular.module("rainbow").service("phonebookService",["$q","$rootScope","$log","$http","contactService","authService","orderByFilter","profileService","conversationService",function(e,t,n,r,i,a,o,s,c){this.search=function(c){return n.info("[phonebookService] search PBXContact from phonebook with text "+c),e(function(e,l){if(config.permitSearchFromPhoneBook||s.isFeatureEnabled(s.FeaturesEnum.TELEPHONY_PHONE_BOOK)){var u=config.restServerUrl+"/api/rainbow/search/v1.0/phonebooks?limit=20&name="+encodeURIComponent(c);r({method:"GET",url:u,headers:a.getRequestHeader()}).then(function(t){var r=t.data.phoneBooks;n.info("[phonebookService] search find "+r.length+" phonebooks contact(s)");var a=[];r.forEach(function(e){var t=i.createBasicContact(null,e.number);t.updateName(e.firstName,e.lastName),t.getAvatar(),a.push(t)}),a=o(a,"_displayName",!1),e(a)},function(e){e.data&&(401===e.data.errorCode&&t.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT"),n.warn("[phonebookService] search failure "+e.data.errorMsg)),l(new Error("phonebook service failure"))})}else{n.info("[phonebookService] search from phonebook not allowed for the user profile");e([])}})}}])}(),angular.module("rainbow").service("adminCompanyService",["$q","$log","$http","$rootScope","authService","errorHelperService","Company","contactService","settingsService","Site","CompanyInvitation","pushImageHelperService","CompanyRequest","companyService",function(e,t,n,r,i,a,o,s,c,l,u,d,f,h){"use strict";var p=this;p.start=function(){return t.info("[adminCompanyService] === STARTING ==="),p.portalURL=config.restServerUrl+"/api/rainbow/admin/v1.0/",t.info("[adminCompanyService] === STARTED ==="),e.when()},p.stop=function(){return t.info("[adminCompanyService] === STOPPING ==="),t.info("[adminCompanyService] === STOPPED ==="),e.when()},p.getCompanies=function(r,c,l,u,d,f,v,m,g,E,S){var C=e.defer(),b=s.userContact;if(!b.isSuperadmin()&&!b.isBPAdmin()&&!b.isOrganizationAdmin())return p.getCompany(b.company.id).then(function(e){return{companies:[e]}});var R=p.portalURL+"companies?format="+(d||"full");return r&&(R+="&organisationId="+r),c&&l&&(R+="&offset="+l*(c-1)),l&&(R+="&limit="+l),u&&(R+="&name="+u),f&&(R+="&bpId="+f),v&&(R+="&status="+v),void 0!==m&&null!==m&&(R+="&isBP="+m),g&&(R+="&bpType="+g),E&&(R+="&offerCanBeSold="+E),S&&(R+="&externalReference="+S),n({method:"GET",url:R,headers:i.getRequestHeader()}).then(function(e){var n=e.data.data;t.info("[adminCompanyService] getCompanies success");var r=[];n.forEach(function(e){var t=o.createFromData(e);h.getCompanyLogo(t),r.push(t)}),C.resolve({companies:r,limit:e.data.limit,offset:e.data.offset,total:e.data.total})},function(e){var n=a.handleError(e);C.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getCompanies"))}),C.promise},p.getAllCompaniesSmall=function(e,t,n,r,i){return p.getAllCompanies(e,t,n,r,i,"small")},p.getAllCompanies=function(t,n,r,i,a,o){return e(function(s,c){p.getCompanies(t,1,1e3,null,o,n,r,i,a).then(function(n){if(n.total>n.limit){for(var r=[],i=Math.ceil(n.total/1e3),a=2;a<=i;a++)r.push(p.getCompanies(t,a,1e3,null,"small").then(function(e){n.companies=n.companies.concat(e.companies),n.limit+=e.limit}));e.all(r).then(function(){s(n)})}else s(n)}).catch(function(e){c(e)})})},p.getCompany=function(r){return e(function(e,s){n({method:"GET",url:p.portalURL+"companies/"+r,headers:i.getRequestHeader()}).then(function(n){t.info("[adminCompanyService] getCompany success");var r=n.data.data,i=o.createFromData(r);h.getCompanyLogo(i),h.getCompanyBanner(i),e(i)},function(e){var n=a.handleError(e);s(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getCompany"))})})},p.getDefaultCompany=function(){return e(function(e,r){n({method:"GET",url:p.portalURL+"companies/default",headers:i.getRequestHeader()}).then(function(n){t.info("[adminCompanyService] getDefaultCompany success");var r=n.data.data,i=o.createFromData(r);e(i)},function(e){var n=a.handleError(e);r(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getDefaultCompany"))})})},p.searchCompanies=function(t){var n=e.defer(),r=t.toLowerCase();return p.getCompanies().then(function(e){var t=e.filter(function(e){return e.name.toLowerCase().indexOf(r)>-1});n.resolve(t)}),n.promise},p.createCompany=function(c){var l=o.prune(c,s.userContact),u=e.defer();return n({method:"POST",url:p.portalURL+"companies",headers:i.getRequestHeader(),data:l}).then(function(e){t.info("[adminCompanyService] createCompany success");var n=o.createFromData(e.data.data);r.$broadcast("ADMIN_COMPANIES_CHANGE"),u.resolve(n)},function(e){var n=a.handleError(e);u.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"createCompany"))}),u.promise},p.createCompanyEndUser=function(r){var c=o.prune(r,s.userContact),l=e.defer();return n({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/companies",headers:i.getRequestHeader(),data:c}).then(function(e){t.info("[adminCompanyService] createCompany success");var n=e.data.data,r=o.createFromData(n);l.resolve(r)},function(e){var n=a.handleError(e);l.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"createCompanyEndUser"))}),l.promise},p.updateCompany=function(c){var l=o.prune(c,s.userContact),u=e.defer();return n({method:"PUT",url:p.portalURL+"companies/"+c.id,headers:i.getRequestHeader(),data:l}).then(function(){t.info("[adminCompanyService] updateCompany success"),u.resolve(),r.$broadcast("ON_COMPANY_CHANGE_EVENT",c.id)},function(e){var n=a.handleError(e);u.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"updateCompany"))}),u.promise},p.addVisibility=function(r,o){var s=e.defer();return n({method:"POST",url:p.portalURL+"companies/"+r+"/visible-by/"+o,headers:i.getRequestHeader()}).then(function(){t.info("[adminCompanyService] addVisibility success"),s.resolve()},function(e){var n=a.handleError(e);s.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"addVisibility"))}),s.promise},p.removeVisibility=function(r,o){var s=e.defer();return n({method:"DELETE",url:p.portalURL+"companies/"+r+"/visible-by/"+o,headers:i.getRequestHeader()}).then(function(){t.info("[adminCompanyService] removeVisibility success"),s.resolve()},function(e){var n=a.handleError(e);s.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"removeVisibility"))}),s.promise},p.getAllSiteCompany=function(r){var o=e.defer();return n({method:"GET",url:p.portalURL+"companies/"+r+"/sites",headers:i.getRequestHeader()}).then(function(e){t.info("[adminCompanyService] getAllSiteCompany success");var n=[];e.data.data.forEach(function(e){var t=l.createFromData(e);n.push(t)}),o.resolve(n)},function(e){var n=a.handleError(e);o.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getAllSiteCompany"))}),o.promise},p.getCompanyAdministrators=function(r){return e(function(e,o){n({method:"GET",url:p.portalURL+"companies/"+r+"/administrators",headers:i.getRequestHeader()}).then(function(n){t.info("[adminCompanyService] getCompanyAdministrators success");var r=[];n.data.data.forEach(function(e){var t={id:e.id};r.push(t)}),e(r)},function(e){var n=a.handleError(e);o(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getCompanyAdministrators"))})})},p.deleteCompany=function(r){var o=e.defer();return n({method:"DELETE",url:p.portalURL+"companies/"+r,headers:i.getRequestHeader()}).then(function(){t.info("[adminCompanyService] deleteCompany success"),o.resolve()},function(e){var n=a.handleError(e);o.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"deleteCompany"))}),o.promise},p.pushLogo=function(n,i,a){return e(function(e,o){var s=p.portalURL+"companies/"+n+"/avatar";return d.pushImage(s,i).then(function(){return r.$broadcast("ON_COMPANY_CHANGE_EVENT",n),p.getCompany(n)}).then(function(e){return e.avatarShape=a,p.updateCompany(e)}).then(function(){t.info("[adminCompanyService] pushLogo success"),e()}).catch(function(e){o(e)})})},p.deleteLogo=function(o){return e(function(e,s){n({method:"DELETE",url:p.portalURL+"companies/"+o+"/avatar",headers:i.getRequestHeader()}).then(function(){r.$broadcast("ON_COMPANY_CHANGE_EVENT",o),p.getCompany(o).then(function(e){return e.avatarShape="circle",p.updateCompany(e)}).then(function(){t.info("[adminCompanyService] deleteLogo success"),e()}).catch(function(e){s(e)})},function(e){var n=a.handleError(e);s(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"deleteLogo"))})})},p.pushBanner=function(t,n,i){return e(function(e,a){var o=p.portalURL+"companies/"+t+"/banner";return d.pushImage(o,n,i).then(function(){r.$broadcast("ON_COMPANY_CHANGE_EVENT",t),e()}).catch(function(e){a(e)})})},p.deleteBanner=function(o){return e(function(e,s){n({method:"DELETE",url:p.portalURL+"companies/"+o+"/banner",headers:i.getRequestHeader()}).then(function(){r.$broadcast("ON_COMPANY_CHANGE_EVENT",o),t.info("[adminCompanyService] deleteBanner success"),e()},function(e){var n=a.handleError(e);s(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"deleteBanner"))})})},p.getCompanyInvitations=function(r,o,s){return e(function(e,c){var l=p.portalURL+"companies/"+r+"/join-companies/invitations?format=medium&status=pending declined&limit="+s;o&&(l+="&offset="+s*(o-1)),n({method:"GET",url:l,headers:i.getRequestHeader()}).then(function(n){var r=[];n.data.data.forEach(function(e){var t=u.createFromData(e);r.push(t)}),t.info("[adminCompanyService] getCompanyInvitations success (found "+r.length+" invitation(s))"),e({invitations:r,total:n.data.total})},function(e){var n=a.handleError(e);c(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getCompanyInvitations"))})})},p.joinCompanyInvitation=function(r,o,s,l,u,d){var f=e.defer(),h={lang:c.getAppliLanguageCodeForServer()};return l&&(h.customMessage=l),s?h.invitedUserId=s:o&&(h.email=o),u&&(h.invitedToBeCompanyAdmin=u),d&&(h.invitedToBeBpAdmin=d),n({method:"POST",url:p.portalURL+"companies/"+r+"/join-companies/invitations",headers:i.getRequestHeader(),data:h}).then(function(){t.info("[adminCompanyService] joinCompanyInvitation success"),f.resolve()},function(e){var n=a.handleError(e);f.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"joinCompanyInvitation"))}),f.promise},p.cancelJoinCompanyInvitation=function(r,o){var s=e.defer();return n({method:"POST",url:p.portalURL+"companies/"+r+"/join-companies/invitations/"+o+"/cancel",headers:i.getRequestHeader()}).then(function(e){var n=u.createFromData(e.data.data);t.info("[adminCompanyService] cancelJoinCompanyInvitation success"),s.resolve(n)},function(e){var n=a.handleError(e);s.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"cancelJoinCompanyInvitation"))}),s.promise},p.resendJoinCompanyInvitation=function(r,o){var s=e.defer();return n({method:"POST",url:p.portalURL+"companies/"+r+"/join-companies/invitations/"+o+"/re-send",headers:i.getRequestHeader()}).then(function(e){var n=u.createFromData(e.data.data);t.info("[adminCompanyService] resendJoinCompanyInvitation success"),s.resolve(n)},function(e){var n=a.handleError(e);s.reject(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"resendJoinCompanyInvitation"))}),s.promise},p.getCompanyJoinRequests=function(r){return e(function(e,o){n({method:"GET",url:p.portalURL+"companies/"+r+"/join-companies/requests?format=medium&status=pending",headers:i.getRequestHeader()}).then(function(n){var r=[];n.data.data.forEach(function(e){var t=f.createFromData(e);r.push(t)}),t.info("[adminCompanyService] getCompanyJoinRequests success (found "+n.data.total+" invitation(s))"),e({companyRequests:r,total:n.data.total})},function(e){var n=a.handleError(e);o(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getCompanyJoinRequests"))})})},p.getJoinCompanyRequest=function(r,o){return e(function(e,s){n({method:"GET",url:p.portalURL+"companies/"+r+"/join-companies/requests/"+o+"?status=pending",headers:i.getRequestHeader()}).then(function(n){var r=f.createFromData(n.data.data);t.info("[adminCompanyService] getJoinCompanyRequest success"),e(r)},function(e){var n=a.handleError(e);s(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getJoinCompanyRequest"))})})},p.acceptCompanyJoinRequests=function(r,o){return e(function(e,s){n({method:"POST",url:p.portalURL+"companies/"+r+"/join-companies/requests/"+o+"/accept",headers:i.getRequestHeader()}).then(function(n){var r=f.createFromData(n.data.data);t.info("[adminCompanyService] acceptCompanyJoinRequests success"),e(r)},function(e){var n=a.handleError(e);t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"acceptCompanyJoinRequests")),s(n)})})},p.declineCompanyJoinRequests=function(r,o){return e(function(e,s){n({method:"POST",url:p.portalURL+"companies/"+r+"/join-companies/requests/"+o+"/decline",headers:i.getRequestHeader()}).then(function(n){var r=f.createFromData(n.data.data);t.info("[adminCompanyService] declineCompanyJoinRequests success"),e(r)},function(e){var n=a.handleError(e);t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"declineCompanyJoinRequests")),s(n)})})},p.getOAuthConsentUrl=function(){var r=c.getAppliLanguage().code;return e(function(e,o){n({method:"GET",url:config.restServerUrl+"/api/rainbow/office365/v1.0/consent?callback="+window.location.origin+"/redirectO365.html?provider=o365&lang="+r,headers:i.getRequestHeader()}).then(function(n){var r=n.data.url;t.info("[adminCompanyService] getOAuthConsentUrl success: "+r),e(r)},function(e){var n=a.handleError(e);t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getOAuthConsentUrl")),o(n)})})},p.getCompanyConferenceSettings=function(r){return e(function(e,o){n({method:"GET",url:p.portalURL+"companies/"+r+"/settings/conferences",headers:i.getRequestHeader()}).then(function(n){t.info("[adminCompanyService] getCompanyConferenceSettings success");var r=n.data.data;e(r)},function(e){var n=a.handleError(e);o(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"getCompanyConferenceSettings"))})})},p.setCompanyConferenceSettings=function(r,o){return e(function(e,s){var c={confDialOutDisabled:!o};n({method:"PUT",url:p.portalURL+"companies/"+r+"/settings/conferences",headers:i.getRequestHeader(),data:c}).then(function(n){t.info("[adminCompanyService] setCompanyConferenceSettings success");var r=n.data.data;e(r)},function(e){var n=a.handleError(e);s(n),t.error("[adminCompanyService] "+a.getErrorFullMessage(e,"setCompanyConferenceSettings"))})})}}]),angular.module("rainbow").service("adminUserService",["$q","$log","$http","authService","errorHelperService","Company","User","Site","Organisation","userInfoService","contactService","PhoneNumber",function(e,t,n,r,i,a,o,s,c,l,u,d){"use strict";var f=this;f.start=function(){return t.info("[adminUserService] === STARTING ==="),f.portalURL=config.restServerUrl+"/api/rainbow/admin/v1.0/",t.info("[adminUserService] === STARTED ==="),e.when()},f.stop=function(){return t.info("[adminUserService] === STOPPING ==="),t.info("[adminUserService] === STOPPED ==="),e.when()},f.getUsers=function(l,u,d,h,p){return e(function(e,v){var m=f.portalURL+"users?format=full&limit="+d;l&&l instanceof c&&(m+="&organisationId="+l.id),l&&l instanceof a&&(m+="&companyId="+l.id),l&&l instanceof s&&(m+="&siteId="+l.id),u&&(m+="&offset="+d*(u-1)),h&&(m+="&displayName="+h),void 0!==p&&null!==p&&(m+="&isTerminated="+p),n({method:"GET",url:m,headers:r.getRequestHeader()}).then(function(n){var r=n.data.data;t.info("[adminUserService] getUsers success (find "+n.data.total+" user(s))");var i=[];r.forEach(function(e){var t=o.createFromData(e);i.push(t)}),e({users:i,total:n.data.total})},function(e){var n=i.handleError(e);v(n),t.error("[adminOfferSubscriptionService] "+i.getErrorFullMessage(e,"getUsers"))})})},f.searchUsers=function(a,s,c,l){return e(function(e,u){var d=config.restServerUrl+"/api/rainbow/enduser/v1.0/search?format=full&limit="+c+"&user="+encodeURIComponent(l);a&&(d+="&companyId="+a.id),s&&(d+="&offset="+c*(s-1)),n({method:"GET",url:d,headers:r.getRequestHeader()}).then(function(n){var r=n.data.users;t.info("[adminUserService] searchUser success (find "+n.data.total+" user(s))");var i=[];r.forEach(function(e){var t=o.createFromData(e);i.push(t)}),e({users:i,total:n.data.total})},function(e){var n=i.handleError(e);u(n),t.error("[adminOfferSubscriptionService] "+i.getErrorFullMessage(e,"searchUsers"))})})},f.getUser=function(a){var s=e.defer();return n({method:"GET",url:f.portalURL+"users/"+a,headers:r.getRequestHeader()}).then(function(e){t.info("[adminUserService] getUser success");var n=e.data.data,r=o.createFromData(n);s.resolve(r)},function(e){var n=i.handleError(e);s.reject(n),t.error("[adminUserService] "+i.getErrorFullMessage(e,"getUser"))}),s.promise},f.createUser=function(a){var s=o.prune(a,u.userContact),c=e.defer();return n({method:"POST",url:f.portalURL+"users",headers:r.getRequestHeader(),data:s}).then(function(e){var n=o.createFromData(e.data.data);t.info("[adminUserService] createUser success"),c.resolve(n)},function(e){var n=i.handleError(e);c.reject(n),t.error("[adminUserService] "+i.getErrorFullMessage(e,"createUser"))}),c.promise},f.deleteUser=function(a){var o=e.defer();return n({method:"DELETE",url:f.portalURL+"users/"+a.id,headers:r.getRequestHeader()}).then(function(){t.info("[adminUserService] deleteUser success"),o.resolve()},function(e){var n=i.handleError(e);o.reject(n),t.error("[adminUserService] "+i.getErrorFullMessage(e,"deleteUser"))}),o.promise},f.updateUser=function(a){var s=o.prune(a,u.userContact),c=e.defer();return n({method:"PUT",url:f.portalURL+"users/"+a.id,headers:r.getRequestHeader(),data:s}).then(function(){t.info("[adminUserService] updateUser success"),c.resolve()},function(e){var n=i.handleError(e);c.reject(n),t.error("[adminUserService] "+i.getErrorFullMessage(e,"updateUser"))}),c.promise},f.getUserAvatar=function(e){var t=l.computeUserColor(e.firstName+" "+e.lastName).color;l.getAvatarImage(e.id,e.initials,t,50,e.lastAvatarUpdateDate).then(function(t){e.image=t})},f.expandTelephonyInfo=function(e){var t={};return e.phoneNumbers&&e.phoneNumbers.forEach(function(e){var n=e.number,r=e.numberE164,i=e.deviceType;switch(e.type){case"work":"landline"===i&&(t.phoneProNumber&&t.phoneProNumber.systemId||(t.phonePro=n,t.phoneProCan=r,t.phoneProExt=e.shortNumber,t.phoneProIsMonitored=e.isMonitored,t.phoneProNumber=d.createFromData(e))),"mobile"===i&&(t.mobilePro=n,t.mobileProCan=r);break;case"home":"landline"===i&&(t.phonePerso=n,t.phonePersoCan=r),"mobile"===i&&(t.mobilePerso=n,t.mobilePersoCan=r)}}),t}}]),function(){"use strict";angular.module("rainbow").filter("emojione",["$sce","$sanitize",function(e,t){return function(n){if(!angular.isString(n))return n;var r=emojione.shortnameToImage(n);return t(e.trustAsHtml(r))}}]),angular.module("rainbow").filter("emojiUnicodeToShort",["$sce","$sanitize",function(e,t){return function(e){return angular.isString(e)?emojione.toShort(e):e}}]),angular.module("rainbow").filter("emojiShortToUnicode",["$sce","$sanitize",function(e,t){return function(e){return angular.isString(e)?emojione.shortnameToUnicode(e):e}}])}(),angular.module("rainbow").factory("PromiseQueue",["$log",function(e){"use strict";function t(){var t=this;this.queue=[],this.started=!1,this.add=function(e){this.queue.push(e),this.started||(this.started=!0,this.execute())},this.execute=function(){var n=this.queue.shift();n?n().catch(function(t){var n=t&&t.message?t.message:"Unknown error";e.error("[PromiseQueue] execute failure -- "+n)}).finally(function(){t.execute()}):this.started=!1}}return t.create=function(){return new t},t}]),angular.module("rainbow").factory("TransfertPromiseQueue",["$log","$q",function(e,t){"use strict";function n(){var n=this;n.fileQueue=[],n.clearContext=function(){n.currentQueue=[],n.promiseCompletion=void 0,n.promiseReject=void 0,n.initialQueueSize=0,n.promisesDone=0,n.chunkErrorCounter=0,n.currentPromise=void 0},n.clearContext(),n.addPromiseArray=function(r,i,a){e.debug("[TransfertPromiseQueue] adding promiseArray");var o={};return o.promiseArray=r,o.promiseCompletion=i,o.promiseReject=a,0!==n.fileQueue.length||n.currentPromise?(n.fileQueue.push(o),e.debug("[TransfertPromiseQueue] adding PromiseArray in FileQueue: "+n.fileQueue.length)):(e.debug("[TransfertPromiseQueue] configuring file to transfert: "+o.promiseArray.length),n.fileQueue.push(o),n.popFileQueue()),e.debug("[TransfertPromiseQueue] adding promise on FileQueue: "+n.fileQueue.length),t},n.popFileQueue=function(){if(n.fileQueue.length>0){e.debug("[TransfertPromiseQueue] go to next file");var t=n.fileQueue.shift();n.currentQueue=t.promiseArray,n.promiseCompletion=t.promiseCompletion,n.promiseReject=t.promiseReject,n.initialQueueSize=n.currentQueue.length,n.promisesDone=0,n.chunkErrorCounter=0,n.currentPromise=n.currentQueue.shift(),n.execute()}else e.debug("[TransfertPromiseQueue] no more file to transfert"),n.clearContext()},n.execute=function(){e.debug("[TransfertPromiseQueue] execute"),n.currentPromise?(e.debug("[TransfertPromiseQueue] performing promise: "+n.promisesDone),n.currentPromise().then(function(){e.debug("[TransfertPromiseQueue] promise success go to next one"),n.promisesDone++,n.chunkErrorCounter=0,n.promisesDone>=n.initialQueueSize?(n.promiseCompletion(),n.popFileQueue()):(n.currentPromise=n.currentQueue.shift(),n.execute())}).catch(function(t){var r=t&&t.message?t.message:"Unknown error";e.error("[TransfertPromiseQueue] failure executing promise -- "+r),n.chunkErrorCounter++,t.errorDetailsCode>=500&&n.chunkErrorCounter<=3?n.execute():(e.error("[TransfertPromiseQueue] 3 chunk failed - ABORT File Upload"),n.promiseReject(t),n.popFileQueue())})):(e.debug("[TransfertPromiseQueue] no promise to perform"),n.currentPromise=void 0)},n.isTransferInProgress=function(){return e.debug("[TransfertPromiseQueue] >isTransferInProgress: "+n.fileQueue.length+"/"+n.currentQueue.length),n.fileQueue.length>0||n.currentQueue.length>0||n.currentPromise},n.cancelAllTransfers=function(){e.debug("[TransfertPromiseQueue] cancelAllTransfers"),n.fileQueue=[],n.currentQueue=[]}}return n.create=function(){return e.debug("[TransfertPromiseQueue] >create"),new n},n}]),window.sdk=angular.module("sdk",["pascalprecht.translate","ngSanitize","angularRandomString","ngFileSaver","angular-jwt","uuid4","rainbow","rainbowAdmin"],function(){"use strict"});var code={OK:1,ERROR:-1,ERRORUNAUTHORIZED:-2,ERRORXMPP:-4,ERRORXMPPJID:-8,ERRORBADREQUEST:-16,ERRORUNSUPPORTED:-32,ERRORNOTFOUND:-64};sdk.constant("SDK",code),sdk.remoteConsole={debug:!1,log:!1,info:!1,warn:!1,error:!1},sdk.hasVerboseLog=!1,sdk.useAngularEvents=!1,sdk.hasBeenLaunchedFromConfig=!1,sdk.key={appID:"",appSecret:"",host:"openrainbow.com"},sdk.config(["consoleLogsProvider","$provide","$httpProvider","$translateProvider",function(e,t,n,r){"use strict";var i=function(e){return e.toDateString()+" "+("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2)};t.decorator("$log",["$delegate",function(t){var n=t.debug;t.debug=function(){var t=[].slice.call(arguments);sdk.remoteConsole.debug&&console.re.debug(t[0]),n.apply(null,t),e.setLogs(["["+i(new Date)+"]"]+"debug : "+t+"\n")};var r=t.log;t.log=function(){var t=[].slice.call(arguments);sdk.remoteConsole.log&&console.re.log(t[0]),r.apply(null,t),e.setLogs(["["+i(new Date)+"]"]+"log : "+t+"\n")};var a=t.info;t.info=function(){var t=[].slice.call(arguments);sdk.remoteConsole.info&&console.re.info(t[0]),a.apply(null,t),e.setLogs(["["+i(new Date)+"]"]+"info : "+t+"\n")};var o=t.warn;t.warn=function(){var t=[].slice.call(arguments);sdk.remoteConsole.warn&&console.re.warn(t[0]),o.apply(null,t),e.setLogs(["["+i(new Date)+"]"]+"warn : "+t+"\n")};var s=t.error;return t.error=function(){var t=[].slice.call(arguments);sdk.remoteConsole.error&&console.re.error(t[0]),s.apply(null,t),e.setLogs(["["+i(new Date)+"]"]+"error : "+t+"\n")},t.webrtc=function(){var t=[].slice.call(arguments),r="rtcweb : "+t[0];t[0]="%c "+i(new Date)+" | RTCWEB | "+t[0],t[t.length]="color:green",sdk.remoteConsole.log&&console.re.log(t[0]),n.apply(null,t),e.setLogs(["["+i(new Date)+"]"]+r+"\n")},t.sdk=function(){var t=[].slice.call(arguments),r="RBW-SDK : "+t[0];t[0]="%c "+i(new Date)+" | RBW-SDK | "+t[0],t[t.length]="color:green",sdk.remoteConsole.log&&console.re.log(t[0]),n.apply(null,t),e.setLogs(["["+i(new Date)+"]"]+r+"\n")},t}]),n.defaults.useXDomain=!0,r.useSanitizeValueStrategy(null)}]),sdk.run([function(){"use strict"}]),sdk.provider("consoleLogs",[function(){"use strict";this.logsBuffer=[],this.logsMaxLength=2e6,this.$get=function(){var e=this.logsBuffer;return{getLogs:function(){return e}}},this.cleanBuffer=function(){this.logsBuffer.length>this.logsMaxLength&&(this.logsBuffer=this.logsBuffer.slice(-this.logsMaxLength))},this.setLogs=function(e){1e3===this.logsBuffer&&this.logsBuffer.shift(),this.logsBuffer.push(e)}}]),window.config={xmpp:{protocol:"wss",server:"sandbox.openrainbow.com",port:"443",pingInterval:"60000"},webservices:{protocol:"https",server:"sandbox.openrainbow.com",port:"443"},cpaas:{protocol:"https",server:"",port:"8887"}},angular.module("sdk").service("connectionService",["$q","$log","$rootScope","authService","xmppService","companyService","contactService","botService","fileTransfertService","fileServerService","fileStorageService","roomService","groupService","videoService","webrtcServiceEventHandler","telephonyService","pstnConferenceService","webConferenceService","conversationService","callLogService","platformService","invitationService","adminCompanyService","adminUserService","profileService","channelService","cpaasService","SDK",function(e,t,n,r,i,a,o,s,c,l,u,d,f,h,p,v,m,g,E,S,C,b,R,y,N,T,A,I){"use strict";var O=this,D="ConnectSrv | ",w="disconnected";this.RAINBOW_ONCONNECTIONSTATECHANGED="rainbowconnectionstatechanged",this.RAINBOW_ONSTARTED="started",this.RAINBOW_ONSTOPPED="stopped",this.RAINBOW_CONNECTIONINPROGRESS="inProgress",this.RAINBOW_ONUSERTOKENRENEW="userTokenRenew",this.RAINBOW_ONUSERTOKENRENEWFAILED="userTokenRenewFailed",this.RAINBOW_ONAPPTOKENRENEW="applicationTokenRenew",this.RAINBOW_ONAPPTOKENRENEWFAILED="applicationTokenRenewFailed",this.RAINBOW_CONNECTIONCONNECTED="connected",this.RAINBOW_CONNECTIONDISCONNECTED="disconnected",this.RAINBOW_OFFICIAL_HOST="openrainbow.com",this.RAINBOW_BETA_HOST="openrainbow.net",this.RAINBOW_DEV_HOST="openrainbow.org",this.RAINBOW_SANDBOX_HOST="sandbox.openrainbow.com";var _=this.RAINBOW_SANDBOX_HOST;this.RAINBOW_CPAASPREPROD_HOST="cpaaspreprod.openrainbow.net";_=this.RAINBOW_CPAASPREPROD_HOST;this.signin=function(e,t){return _=this.RAINBOW_SANDBOX_HOST,P(e,t,null)},this.signinOnRainbowOfficial=function(e,t){return _=this.RAINBOW_OFFICIAL_HOST,P(e,t,null)},this.signinOnRainbowBeta=function(e,t){return _=this.RAINBOW_BETA_HOST,P(e,t,null)},this.signinOnRainbowCPaasPreProd=function(e,t){return _=this.RAINBOW_CPAASPREPROD_HOST,P(e,t,null)},this.signinOnRainbowDev=function(e,t){return _=this.RAINBOW_DEV_HOST,P(e,t,null)},this.signinOnRainbowHosted=function(e,t,n){return _=n,P(e,t,null)},this.signinSandBoxWithToken=function(e){return _=this.RAINBOW_SANDBOX_HOST,P(null,null,e)},this.signinOnRainbowOfficialWithToken=function(e){return _=this.RAINBOW_OFFICIAL_HOST,P(null,null,e)},this.signinOnRainbowBetaWithToken=function(e){return _=this.RAINBOW_BETA_HOST,P(null,null,e)},this.signinOnRainbowDevWithToken=function(e){return _=this.RAINBOW_DEV_HOST,P(null,null,e)},this.signinOnRainbowHostedWithToken=function(e,t){return _=t,P(null,null,e)},this.signout=function(){var r=e.defer(),C={code:I.OK,label:"OK"};return t.sdk(D+"[signout    ] :: Try to sign-out..."),h.stop().then(function(){return t.sdk(D+"[signout    ] :: Video service stopped"),p.stop()}).then(function(){return t.sdk(D+"[signout    ] :: WebRTCEventHandler service stopped"),o.stop()}).then(function(){return t.sdk(D+"[signout    ] :: Contact service stopped"),s.stop()}).then(function(){return t.sdk(D+"[signout    ] :: Bot service stopped"),N.stop()}).then(function(){return t.sdk(D+"[signout    ] :: Profile service stopped"),E.stop()}).then(function(){return t.sdk(D+"[signout    ] :: Conversation service stopped"),g.stop()}).then(function(){return t.sdk(D+"[signout    ] :: Web Conference service stopped"),m.stop()}).then(function(){return t.sdk(D+"[signout    ] :: PTSN Conference service stopped"),S.stop()}).then(function(){return t.sdk(D+"[signout    ] :: ChannelService service stopped"),T.stop()}).then(function(){return t.sdk(D+"[signout    ] :: CallLog service stopped"),v.stop()}).then(function(){return t.sdk(D+"[signout    ] :: Telephony service stopped"),c.stop()}).then(function(){return t.sdk(D+"[signout    ] :: FileTransfert service stopped"),l.stop()}).then(function(){return t.sdk(D+"[signout    ] :: FileServer service stopped"),u.stop()}).then(function(){return t.sdk(D+"[signout    ] :: FileStorage service stopped"),b.stop()}).then(function(){return t.sdk(D+"[signout    ] :: Group service stopped"),f.stop()}).then(function(){return t.sdk(D+"[signout    ] :: Room service stopped"),d.stop()}).then(function(){return t.sdk(D+"[signout    ] :: Company service stopped"),a.stop()}).then(function(){return t.sdk(D+"[signout    ] :: Admin Company service stopped"),R.stop()}).then(function(){return t.sdk(D+"[signout    ] :: Admin User service stopped"),y.stop()}).then(function(){return t.sdk(D+"[signout    ] :: Invitation service stopped"),i.stop()}).then(function(){t.sdk(D+"[signout    ] :: XMPP service stopped"),t.sdk(D+"[signout    ] :: Services Successfully unloaded!"),sdk.useAngularEvents?n.$broadcast(O.RAINBOW_ONSTOPPED):$(document).trigger(O.RAINBOW_ONSTOPPED,null),r.resolve(C)}).catch(function(e){return t.sdk(D+"[signout    ] :: Error during signout..."),r.reject(e),r.promise}),r.promise},this.getState=function(){return w},this.getToken=function(){return r.token};var P=function(A,w,P){var U=e.defer(),F=!1;if(P)F=!0,A=null,w=null;else{if(!A)return U.reject({code:I.ERRORBADREQUEST,label:"Parameter 'login' is missing or empty"});if(!w)return U.reject({code:I.ERRORBADREQUEST,label:"Parameter 'password' is missing or empty"})}t.sdk(D+"[signin     ] :: Rainbow host used "+_),F?t.sdk(D+"[signin     ] :: Try to sign-in with given token"):t.sdk(D+"[signin     ] :: Try to sign-in with "+A+"...");var L={code:I.OK,label:"",account:null};return r.removeCredentials(),r.authenticateOnHost(A,w,_,{appId:sdk.key.appID,appSecret:sdk.key.appSecret},P).then(function(e){L.account={},L.label="ok",L.account.userId=r.userId,L.account.companyId=r.companyId,L.account.loginEmail=r.login,L.account.roles=r.roles,L.token=r.token;var w=[];t.sdk(D+"[signin     ] :: Successfully sign-in with "+A+" | "+r.jidIm),r.startTokenSurvey(),t.sdk(D+"[signin     ] :: Start services..."),i.disconnectionHandler=M,i.start(w).then(function(){return t.sdk(D+"[signin     ] :: XMPP service ready!"),a.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: Company service ready!"),R.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: Admin company service ready!"),y.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: Admin user service ready!"),o.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: Contact service ready!"),N.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: Profile service ready!"),c.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: FileTransfert service ready!"),l.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: FileServer service ready!"),u.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: FileStorage service ready!"),d.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: Room service ready!"),h.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: Video service ready!"),p.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: WebRTCEventHandler service ready!"),v.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: Telephony service ready!"),m.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: PSTN Conference service ready!"),g.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: Web Conference service ready!"),E.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: Conversation service ready!"),b.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: Invitation service ready!"),f.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: Group service ready!"),S.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: CallLog service ready!"),s.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: Bot service ready!"),T.start(w)}).then(function(){return t.sdk(D+"[signin     ] :: Channel service ready!"),t.sdk(D+"[signin     ] :: Send initial presence"),o.sendPresenceFromConfiguration()}).then(function(){return t.sdk(D+"[signin     ] :: Initial presence sent !"),C.start(w)}).then(function(){t.sdk(D+"[signin     ] :: Platform service ready!"),t.sdk(D+"[signin     ] :: Services Successfully loaded!"),n.$broadcast("ON_CONNECTION_STATE_CHANGE_EVENT","connected"),sdk.useAngularEvents?n.$broadcast(O.RAINBOW_ONSTARTED):$(document).trigger(O.RAINBOW_ONSTARTED,null),U.resolve(L)}).catch(function(e){t.sdk(D+"[signin     ] :: Error during signin"),L.code=I.ERRORXMPP,L.label="errorXMPP",L.account=null,U.reject(L)})}).catch(function(e){t.sdk(D+"[signin     ] :: Error during signin"),L.code=I.ERRORUNAUTHORIZED,L.label="errorUnauthorized",U.reject(L)}),U.promise},M=function(){t.sdk(D+"[discHandler] :: Disconnected from the XMPP Rainbow Cloud Services")},U=function(e,r){t.sdk(D+"[onChange   ] :: Connection state changed to "+r),w=r,sdk.useAngularEvents?n.$broadcast(O.RAINBOW_ONCONNECTIONSTATECHANGED,r):$(document).trigger(O.RAINBOW_ONCONNECTIONSTATECHANGED,[r])};n.$on("$destroy",n.$on("ON_CONNECTION_STATE_CHANGE_EVENT",U)),n.$on("$destroy",n.$on("ON_AUTH_TOKEN_RENEW",function(e){sdk.useAngularEvents?n.$broadcast(O.RAINBOW_ONUSERTOKENRENEW):$(document).trigger(O.RAINBOW_ONUSERTOKENRENEW)})),n.$on("$destroy",n.$on("ON_AUTH_TOKEN_EXPIRE",function(e){sdk.useAngularEvents?n.$broadcast(O.RAINBOW_ONUSERTOKENRENEWFAILED):$(document).trigger(O.RAINBOW_ONUSERTOKENRENEWFAILED,null),signout()})),n.$on("$destroy",n.$on("ON_AUTH_TOKEN_RENEW",function(e){sdk.useAngularEvents?n.$broadcast(O.RAINBOW_ONAPPTOKENRENEW):$(document).trigger(O.RAINBOW_ONAPPTOKENRENEW,null)})),n.$on("$destroy",n.$on("ON_AUTH_TOKEN_EXPIRE",function(e){sdk.useAngularEvents?n.$broadcast(O.RAINBOW_ONAPPTOKENRENEWFAILED):$(document).trigger(O.RAINBOW_ONAPPTOKENRENEWFAILED,null),signout()}))}]),angular.module("sdk").service("presenceService",["$log","$rootScope","xmppService","contactService","SDK",function(e,t,n,r,i){"use strict";var a=this,o="PresenceSvr| ";this.RAINBOW_PRESENCE_ONLINE="online",this.RAINBOW_PRESENCE_AWAY="xa",this.RAINBOW_PRESENCE_DONOTDISTURB="dnd",this.RAINBOW_PRESENCE_OFFLINE="offline",this.RAINBOW_PRESENCE_BUSY="busy",this.RAINBOW_PRESENCE_UNKNOW="unknow",this.RAINBOW_ONCONTACTPRESENCECHANGED="rainbowcontactpresencechanged",this.RAINBOW_ONPRESENCECHANGED="rainbowpresencechanged",this.setPresenceTo=function(t){return t!==this.RAINBOW_PRESENCE_DONOTDISTURB&&t!==this.RAINBOW_PRESENCE_AWAY&&t!==this.RAINBOW_PRESENCE_ONLINE?{code:i.ERRORBADREQUEST,label:"Parameter 'strPresenceState' should be 'dnd', 'xa' or 'online'"}:(e.sdk(o+"[setPresTo  ] :: Set presence to "+t),r.changeMyPresence(t),{code:i.OK,label:"OK"})};t.$on("$destroy",t.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",function(r,i){var s=i.message||"''";i.jid===n.fullJid?(e.sdk(o+"[onChange   ] :: Presence changed for me ("+i.jid+") to  "+i.status+" | "+s),sdk.useAngularEvents?t.$broadcast(a.RAINBOW_ONPRESENCECHANGED,i):$(document).trigger(a.RAINBOW_ONPRESENCECHANGED,[i])):(e.sdk(o+"[onChange   ] :: Presence changed for contact ("+i.jid+") to  "+i.status+" | "+s),sdk.useAngularEvents?t.$broadcast(a.RAINBOW_ONCONTACTPRESENCECHANGED,i):$(document).trigger(a.RAINBOW_ONCONTACTPRESENCECHANGED,[i]))}))}]),angular.module("sdk").service("userProfileService",["$q","$log","$rootScope","contactService","xmppService","profileService","adminUserService","SDK",function(e,t,n,r,i,a,o,s){"use strict";var c="UserProfile| ";this.getProfile=function(){var n=e.defer();return a.getUserData().then(function(e){t.sdk(c+"[getProfile] :: got");var r={name:e.lastName,firstName:e.firstName,phoneNumbers:e.phoneNumbers};n.resolve(r)}).catch(function(e){t.sdk(c+"[getProfile] :: Error when trying to get Profile - "+e),n.reject(e)}),n.promise},this.updateFirstName=function(n){var r=e.defer();if(!n||"string"!=typeof n||n.length<1)r.reject({code:s.ERRORBADREQUEST,label:"Parameter 'strFirstname' is missing, empty or null"});else{var i={firstName:n};a.setUserData(i).then(function(e){t.sdk(c+"[updateFirstName] :: First name updated");var n={lastName:e.data.lastName,firstName:e.data.firstName,phoneNumbers:e.data.phoneNumbers};r.resolve(n)}).catch(function(e){t.sdk(c+"[updateFirstName] :: Error when updating first name - "+e),r.reject(e)})}return r.promise},this.updateLastName=function(n){var r=e.defer();if(!n||"string"!=typeof n||n.length<1)r.reject({code:s.ERRORBADREQUEST,label:"Parameter 'strName' is missing, empty or null"});else{var i={lastName:n};a.setUserData(i).then(function(e){t.sdk(c+"[updateName] :: Name updated");var n={lastName:e.data.lastName,firstName:e.data.firstName,phoneNumbers:e.data.phoneNumbers};r.resolve(n)}).catch(function(e){t.sdk(c+"[updateName] :: Error when updating name - "+e),r.reject(e)})}return r.promise},this.updatePhoneNumber=function(n,r,i,o){var l=e.defer();if((!n||"string"!=typeof n||["home","work","other"].indexOf(n)<0)&&l.reject({code:s.ERRORBADREQUEST,label:"Parameter 'type' is missing or not in 'home', 'work', 'other'"}),!r||"string"!=typeof r||["landline","mobile","fax","other"].indexOf(r)<0)l.reject({code:s.ERRORBADREQUEST,label:"Parameter 'deviceType' is missing or not in 'landline', 'mobile', 'fax', 'other'"});else if(i&&"string"==typeof i){var u={phoneNumbers:[{type:n,deviceType:r,number:i}]};o&&"string"==typeof o&&(u.country=o),a.getUserData().then(function(e){if(e.phoneNumbers.length){if(!e.phoneNumbers.some(function(e){return e.type===n&&e.deviceType===r&&(e.number=i,!0)})){var t={type:n,deviceType:r,number:i};e.phoneNumbers.push(t)}return a.setUserData(e)}return a.setUserData(u)}).then(function(e){t.sdk(c+"[updatePhoneNumber] :: Phone number updated");var n={lastName:e.data.lastName,firstName:e.data.firstName,phoneNumbers:e.data.phoneNumbers};l.resolve(n)}).catch(function(e){t.sdk(c+"[updatePhoneNumber] :: Error when updating phone number - "+e),l.reject(e)})}else l.reject({code:s.ERRORBADREQUEST,label:"Parameter 'strPhoneNumber' is missing, empty or null"});return l.promise},this.updatePhotoFromUrl=function(n){var i=e.defer();return!n||"string"!=typeof n||n.length<1?i.reject({code:s.ERRORBADREQUEST,label:"Parameter 'imgUrl' is missing, empty or null"}):r.pushAvatarImage(n).then(function(){t.sdk(c+"[updatePhotoFromUrl] :: Photo updated"),i.resolve()}).catch(function(e){t.sdk(c+"[updatePhotoFromUrl] :: Error when updating Photo - "+e),i.reject(e)}),i.promise}}]),angular.module("sdk").service("contactsService",["$log","$q","$rootScope","contactService","directoryService","invitationService","SDK",function(e,t,n,r,i,a,o){"use strict";var s=this,c="ContactsSrv| ";this.RAINBOW_ONCONTACTINFORMATIONCHANGED="rainbowcontactinformationchanged",this.RAINBOW_ONINFORMATIONCHANGED="rainbowinformationchanged",this.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED="rainbowsubscriptionnumberchanged",this.RAINBOW_ONCONTACTINVITATIONRECEIVED="rainbowinvitationreceived",this.getContactByJID=function(e){return e?r.getContactByJid(e):{code:o.ERRORBADREQUEST,label:"Parameter 'strJID' is missing or empty"}},this.getContactById=function(e){return e?r.getContactById(e):{code:o.ERRORBADREQUEST,label:"Parameter 'strId' is missing or empty"}},this.getAll=function(){return r.getContacts().filter(function(e){return e.id!==r.userContact.id&&!e.isBot})},this.getConnectedUser=function(){return r.userContact||null},this.getConnectedUserPhone=function(){return r.userContact?0===r.userContact.pbxId.length?null:{phoneNumber:r.userContact.phonePbx,pbxId:r.userContact.pbxId}:null},this.searchByName=function(e){var n=t.defer();return e?i.search(e,!0).then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:"Parameter 'strName' is missing or empty"}),n.promise},this.searchByLogin=function(e){var n=t.defer();return e?i.searchUserByLogin(e).then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:"Parameter 'strLogin' is missing or empty"}),n.promise},this.searchByJid=function(e){var n=t.defer();return e?i.searchUserByJid(e).then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:"Parameter 'strJid' is missing or empty"}),n.promise},this.searchById=function(e){var n=t.defer();return e?r.getContactByDBId(e,!0).then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:"Parameter 'strId' is missing or empty"}),n.promise},this.acceptInvitation=function(e){var n=t.defer();return e?a.acceptInvitation(e).then(function(){n.resolve(e)}).catch(function(e){n.reject(e)}):n.reject({code:o.ERRORBADREQUEST,label:"Parameter 'invitation' is missing or null"}),n.promise},this.declineInvitation=function(e){var n=t.defer();return e?(a.declineInvitation(e).then(function(){n.resolve(e)}).catch(function(e){n.reject(e)}),n.promise):{code:o.ERRORBADREQUEST,label:"Parameter 'invitation' is missing or null"}},this.addToContactsList=function(e){var n=t.defer();return e?(a.joinContactInvitation(e).then(function(){n.resolve(e)}).catch(function(e){n.reject(e)}),n.promise):{code:o.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}},this.removeFromContactsList=function(e){return e?r.removeContact(e):{code:o.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}},this.getInvitationById=function(e){return e?a.getInvitation(e):{code:o.ERRORBADREQUEST,label:"Parameter 'strInvitationId' is missing or null"}},this.getInvitationsReceived=function(){return a.getReceivedInvitations()},this.getInvitationsSent=function(){return a.getSentInvitations()};n.$on("$destroy",n.$on("ON_CONTACT_UPDATED_EVENT",function(t,r){e.sdk(c+"[onChange   ] :: Information changed for contact "+r.displayNameForLog()),sdk.useAngularEvents?n.$broadcast(s.RAINBOW_ONCONTACTINFORMATIONCHANGED,r):$(document).trigger(s.RAINBOW_ONCONTACTINFORMATIONCHANGED,[r])})),n.$on("$destroy",n.$on("ON_USER_CONTACT_UPDATED_EVENT",function(t,r){e.sdk(c+"[onChange   ] :: Information changed for me ("+r.displayNameForLog()+")"),sdk.useAngularEvents?n.$broadcast(s.RAINBOW_ONINFORMATIONCHANGED,r):$(document).trigger(s.RAINBOW_ONINFORMATIONCHANGED,[r])})),n.$on("$destroy",n.$on("ON_INVITATIONS_NUMBER_UPDATED",function(t){e.sdk(c+"[onChange   ] :: Invitation number changed"),sdk.useAngularEvents?n.$broadcast(s.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED):$(document).trigger(s.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED,[])})),n.$on("$destroy",n.$on("ON_INVITATION_CHANGED",function(t,r){e.sdk(c+"[onChange   ] :: Invitation received"),sdk.useAngularEvents?n.$broadcast(s.RAINBOW_ONCONTACTINVITATIONRECEIVED,r):$(document).trigger(s.RAINBOW_ONCONTACTINVITATIONRECEIVED,[r])}))}]),angular.module("sdk").service("pbxService",["$q","$log","$rootScope","telephonyService","Call","SDK",function(e,t,n,r,i,a){"use strict";var o=this;this.RAINBOW_ONTELEPHONYCALLSTATECHANGED="rainbowontelephonycallstatechanged",this.RAINBOW_ONTELEPHONYSTARTED="rainbowontelephonystarted",this.RAINBOW_ONTELEPHONYSTOPPED="rainbowontelephonystopped",this.RAINBOW_TELEPHONYDIALING="dialing",this.RAINBOW_TELEPHONYRINGINGOUTGOING="ringingOutgoing",this.RAINBOW_TELEPHONYINCOMING="incomingCall",this.RAINBOW_TELEPHONYACTIVE="active",this.RAINBOW_TELEPHONYRELEASING="releasing",this.RAINBOW_TELEPHONYUNKNOW="Unknown",this.isTelephonyAvailable=function(){return r.started},this.getAgentVersion=function(){return r.agentStatus.agentVersion||"unknown"},this.getXMPPAgentStatus=function(){return r.agentStatus.xmppAgent||"unknown"},this.getPhoneAPIStatus=function(){return r.agentStatus.phoneApi||"unknown"},this.callByNumber=function(t){var n=e.defer();return t?r.makeCallByPhoneNumber(t).then(function(){n.resolve({code:a.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'strPhoneNumber' is missing or empty"}),n.promise},this.calls=function(){return r.calls},this.release=function(t){var n=e.defer();return t?r.releaseCall(t).then(function(){n.resolve({code:a.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),n.promise},this.deflectToVM=function(t){var n=e.defer();return t?r.deflectCallToVM(t).then(function(){n.resolve({code:a.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),n.promise},this.forwardToDevice=function(t){var n=e.defer();return t&&"string"==typeof t&&0!==t.length?r.forwardToDevice(t).then(function(){n.resolve({code:a.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'strPhoneNumber' is missing or empty"}),n.promise},this.forwardToVoicemail=function(){var t=e.defer();return r.forwardToVoicemail().then(function(){t.resolve({code:a.OK,label:"OK"})}).catch(function(e){t.reject(e)}),t.promise},this.cancelForward=function(){var t=e.defer();return r.cancelForward().then(function(){t.resolve({code:a.OK,label:"OK"})}).catch(function(e){t.reject(e)}),t.promise},this.getForwardStatus=function(){var t=e.defer();return r.getForwardStatus().then(function(){t.resolve({code:a.OK,label:"OK"})}).catch(function(e){t.reject(e)}),t.promise},this.answer=function(t){var n=e.defer();return t?r.answerCall(t).then(function(){n.resolve({code:a.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),n.promise},this.hold=function(t){var n=e.defer();return t?r.holdCall(t).then(function(){n.resolve({code:a.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),n.promise},this.retrieve=function(t){var n=e.defer();return t?r.retrieveCall(t).then(function(){n.resolve({code:a.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:a.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}),n.promise};n.$on("$destroy",n.$on("ON_TELEPHONY_STATUS_CHANGED_EVENT",function(e,r){t.sdk("TelphonySrv| [onChange   ] :: PBX state changed to "+r),"started"===r?sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONTELEPHONYSTARTED):$(document).trigger(o.RAINBOW_ONTELEPHONYSTARTED,null):sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONTELEPHONYSTOPPED):$(document).trigger(o.RAINBOW_ONTELEPHONYSTOPPED,null)})),n.$on("$destroy",n.$on("ON_CALL_UPDATED_EVENT",function(e,r){r.type.value===i.Type.PHONE.value&&(t.sdk("TelphonySrv| [onTelChange] :: Telephony state changed to "+r),sdk.useAngularEvents?n.$broadcast(o.RAINBOW_ONTELEPHONYCALLSTATECHANGED,r):$(document).trigger(o.RAINBOW_ONTELEPHONYCALLSTATECHANGED,[r]))}))}]),angular.module("sdk").service("conversationsService",["$q","$log","$rootScope","conversationService","SDK",function(e,t,n,r,i){"use strict";var a=this,o="ConversSrv | ";this.RAINBOW_ONCONVERSATIONREMOVED="rainbowconversationremoved",this.RAINBOW_ONCONVERSATIONCHANGED="rainbowconversationchanged",this.RAINBOW_ONCONVERSATIONSCHANGED="rainbowconversationschanged",this.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED="rainbowconversationsmissedcounterchanged";this.getAllConversations=function(){var e=[];return r.getConversations().forEach(function(t){e.push(t)}),e},this.getCallById=function(e){if(!e)return{code:i.ERRORBADREQUEST,label:"Parameter 'strCallId' is missing or empty"};var t=null;return r.getConversations().forEach(function(n){n.videoCall&&n.videoCall.id===e?t=n.videoCall:n.audioCall&&n.audioCall.id===e&&(t=n.audioCall)}),t},this.getConversationById=function(e){return e?r.getConversationById(e):{code:i.ERRORBADREQUEST,label:"Parameter 'callId' is missing or empty"}},this.getConversationByBubbleId=function(e){return e?r.getConversationByRoomDbId(e):{code:i.ERRORBADREQUEST,label:"Parameter 'strBubbleId' is missing or empty"}},this.openConversationForContact=function(n){var a=e.defer();return n?(t.sdk(o+"[createConve] :: Try to create of get a conversation with "+n.lastname+" "+n.firstname),r.getOrCreateOneToOneConversation(n.jid).then(function(e){t.sdk(o+"[createConve] :: Conversation retrieved or created "+e.id),a.resolve(e)}).catch(function(e){t.sdk(o+"[createConve] :: Error"),a.reject(e)})):a.reject({code:i.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),a.promise},this.openConversationForBubble=function(n){var a=e.defer();return n?(t.sdk(o+"[createConve] :: Try to create or get a conversation for a bubble "+n.name+"("+n.id+")"),r.getRoomConversation(n.jid).then(function(e){t.sdk(o+"[createConve] :: Conversation retrieved or created "+e.id),a.resolve(e)}).catch(function(e){t.sdk(o+"[createConve] :: Error"),a.reject(e)})):a.reject({code:i.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),a.promise},this.closeConversation=function(t){var n=e.defer();return t?r.closeConversation(t).then(function(){n.resolve(null)}).catch(function(e){n.reject(e)}):n.reject({code:i.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}),n.promise},n.$on("$destroy",n.$on("ON_CONVERSATIONS_UPDATED_EVENT",function(e,t){t?sdk.useAngularEvents?n.$broadcast(a.RAINBOW_ONCONVERSATIONSCHANGED,t):$(document).trigger(a.RAINBOW_ONCONVERSATIONSCHANGED,[t]):sdk.useAngularEvents?n.$broadcast(a.RAINBOW_ONCONVERSATIONSCHANGED,null):$(document).trigger(a.RAINBOW_ONCONVERSATIONSCHANGED,null)})),n.$on("$destroy",n.$on("ON_CONVERSATION_REMOVE_EVENT",function(e,t){sdk.useAngularEvents?n.$broadcast(a.RAINBOW_ONCONVERSATIONREMOVED,t):$(document).trigger(a.RAINBOW_ONCONVERSATIONREMOVED,[t])})),n.$on("$destroy",n.$on("ON_CONVERSATION_UPDATED_EVENT",function(e,t){sdk.useAngularEvents?n.$broadcast(a.RAINBOW_ONCONVERSATIONCHANGED,t):$(document).trigger(a.RAINBOW_ONCONVERSATIONCHANGED,[t])})),n.$on("$destroy",n.$on("ON_MISSED_COUNTER_CHANGED_EVENT",function(e,t){sdk.useAngularEvents?n.$broadcast(a.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED,t):$(document).trigger(a.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED,[t])}))}]),angular.module("sdk").service("imService",["$q","$rootScope","$log","fileStorageService","conversationService","Conversation","Message","SDK",function(e,t,n,r,i,a,o,s){"use strict";var c=this;this.RAINBOW_ONNEWIMMESSAGERECEIVED="rainbownewimmessagereceived",this.RAINBOW_ONNEWIMRECEIPTRECEIVED="rainbownewimreceiptreceived",this.getMessagesFromConversation=function(t,n){var r=e.defer();return t?(n=n?Math.min(n,100):30,i.getHistoryPage(t,n)):(r.reject({code:s.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}),r.promise)},this.getMessageFromConversationById=function(e,t){if(!e)return{code:s.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"};if(!t)return{code:s.ERRORBADREQUEST,label:"Parameter 'strMessageId' is missing or empty"};var n=e.getMessageById(t);return n&&n.fileId&&(n.shortFileDescriptor=r.getFileDescriptorById(n.fileId)),n},this.getMessageFromBubbleById=function(e,t){if(!e)return{code:s.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"};if(!t)return{code:s.ERRORBADREQUEST,label:"Parameter 'strMessageId' is missing or empty"};var n=i.getConversationByRoomDbId(e.dbId);if(!n)return{code:s.ERRORBADREQUEST,label:"Parameter 'bubble' don't have a conversation"};if(n.type!==a.Type.ROOM)return{code:s.ERRORBADREQUEST,label:"Parameter 'conversation' is not a bubble conversation"};var o=n.getMessageById(t);return o&&o.fileId&&(o.shortFileDescriptor=r.getFileDescriptorById(o.fileId)),o},this.sendMessageToConversation=function(e,t){return n.sdk("IMSrv      | [sendMessage] :: Try to send a message..."),e?t?t.length>1024?{code:s.ERRORBADREQUEST,label:"Parameter 'strMessage' should be lower than 1024 characters"}:i.sendChatMessage(e,t):{code:s.ERRORBADREQUEST,label:"Parameter 'strMessage' is missing or empty"}:{code:s.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.sendMessageToBubble=function(t,n){var r=e.defer();return t?n?n.length>1024?r.reject({code:s.ERRORBADREQUEST,label:"Parameter 'strMessage' should be lower than 1024 characters"}):i.getRoomConversation(t.jid).then(function(e){if(e){var t=i.sendChatMessage(e,n);r.resolve(t)}else r.reject({code:s.ERRORNOTFOUND,label:"No 'conversation' found"})}):r.reject({code:s.ERRORBADREQUEST,label:"Parameter 'strMessage' is missing or empty"}):r.reject({code:s.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),r.promise},this.removeAllMessagesFromConversation=function(t){var n=e.defer();return t?t.type!==a.Type.ONE_TO_ONE?n.reject({code:s.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):i.removeAllMessages(t).then(function(){n.resolve({code:s.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:s.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}),n.promise},this.markMessageFromConversationAsRead=function(e,t){return t?e?t.receiptStatus===o.ReceiptStatus.READ?{code:s.ERRORBADREQUEST,label:"Parameter 'message' is aldready marked as read"}:(e.sendAckReadMessage(t).receiptStatus===o.ReceiptStatus.READ&&i.decreaseMissedIMCounterForConversation(e),{code:s.OK,label:"OK"}):{code:s.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}:{code:s.ERRORBADREQUEST,label:"Parameter 'message' is missing or empty"}},t.$on("$destroy",t.$on("ON_CONVERSATION_MESSAGE_RECEIVED",function(e,n,r,i){sdk.useAngularEvents?t.$broadcast(c.RAINBOW_ONNEWIMMESSAGERECEIVED,n,r,i):$(document).trigger(c.RAINBOW_ONNEWIMMESSAGERECEIVED,[n,r,i])})),t.$on("$destroy",t.$on("ON_CONVERSATION_RECEIPT_RECEIVED",function(e,n,r,i){sdk.useAngularEvents?t.$broadcast(c.RAINBOW_ONNEWIMRECEIPTRECEIVED,n,r,i):$(document).trigger(c.RAINBOW_ONNEWIMRECEIPTRECEIVED,[n,r,i])}))}]),angular.module("sdk").service("webRTCService",["$q","$log","$rootScope","videoService","platformService","settingsService","xmppService","extensionSharingService","Call","SDK",function(e,t,n,r,i,a,o,s,c,l){"use strict";var u=this,d="webRTCSrv  | ";this.isChromeExtensionInstalled=!1,this.RAINBOW_ONWEBRTCCALLSTATECHANGED="rainbowonwebrtccallstatechanged",this.RAINBOW_ONWEBRTCMEDIADEVICECHANGED="rainbowonwebrtcmediadevicechanged",this.RAINBOW_ONWEBRTCERRORHANDLED="rainbowonwebrtcerrorhandled",this.RAINBOW_ONWEBRTCSTREAMADDED="rainbowonwebrtcstreamadded",this.RAINBOW_ONWEBRTCTRACKCHANGED="rainbowonwebrtctrackchanged",this.RAINBOW_ONWEBRTCTMEDIAERROROCCURED="rainbowonwebrtcmediaerroroccured",this.setChromeExtensionIdForSharing=function(e){return e?(s.setExtensionId(e),{code:l.OK,label:"OK"}):{code:l.ERRORBADREQUEST,label:"Parameter 'strExtensionId' is missing or empty"}},this.callInAudio=function(e){return e?this.canMakeAudioVideoCall()?(r.makeCall(e,"audio"),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:l.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}},this.callInVideo=function(e){return e?this.canMakeAudioVideoCall()?(r.makeCall(e,"video"),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:l.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}},this.callInSharing=function(t){var n=e.defer();return t?this.canMakeDesktopSharingCall().then(function(){r.makeDesktopSharingCall(t,"sharingOnly"),n.resolve({code:l.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:l.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),n.promise},this.callinAudioWithSharing=function(t){var n=e.defer();return t?this.canMakeDesktopSharingCall().then(function(){r.makeDesktopSharingCall(t),n.resolve({code:l.OK,label:"OK"})}).catch(function(e){n.reject(e)}):n.reject({code:l.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),n.promise},this.answerInAudio=function(e){return e?this.canMakeAudioVideoCall()?(r.answerCall(e,"audio"),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:l.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.answerInVideo=function(e){return e?this.canMakeAudioVideoCall()?(r.answerCall(e,"video"),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:l.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.showLocalVideo=function(){return this.canMakeAudioVideoCall()?(r.attachLocalMediaStream(!0),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}},this.hideLocalVideo=function(){return this.canMakeAudioVideoCall()?(r.attachLocalMediaStream(!1),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}},this.showRemoteVideo=function(e){return e?this.canMakeAudioVideoCall()?(r.attachDistantMediaStream(!0,e),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:l.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.hideRemoteVideo=function(e){return e?this.canMakeAudioVideoCall()?(r.attachDistantMediaStream(!1,e),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:l.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.escaladeToVideoCall=function(e){return this.canMakeAudioVideoCall()?(r.escalateToVideoCall(e),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}},this.escaladeToSharingCall=function(t){var n=e.defer();return this.canMakeDesktopSharingCall().then(function(){r.escaladeToSharingCall(t),n.resolve({code:l.OK,label:"OK"})}).catch(function(e){n.reject(e)}),n.promise},this.reverseToAudioCall=function(e){return this.canMakeAudioVideoCall()||this.isChromeExtensionInstalled?(r.reverseToAudioCall(e),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}},this.release=function(e){return e?this.canMakeAudioVideoCall()?(r.rejectCall(e),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:l.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.reject=function(e){return e?this.canMakeAudioVideoCall()?(r.rejectCall(e),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:l.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}},this.muteAudioCall=function(e){return e?this.canMakeAudioVideoCall()?(r.muteAudio(e,!0),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.muteVideoCall=function(e){return e?this.canMakeAudioVideoCall()?(r.muteVideo(e,!0),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.unmuteAudioCall=function(e){return e?this.canMakeAudioVideoCall()?(r.muteAudio(e,!1),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.unmuteVideoCall=function(e){return e?this.canMakeAudioVideoCall()?(r.muteVideo(e,!1),{code:l.OK,label:"OK"}):{code:l.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:l.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}},this.canMakeAudioVideoCall=function(){return"https:"===location.protocol&&DetectRTC.isWebRTCSupported&&DetectRTC.isGetUserMediaSupported},this.hasAMicrophone=function(){return DetectRTC.hasMicrophone},this.hasACamera=function(){return DetectRTC.hasWebcam},this.useMicrophone=function(e){return e?(a.setSetting("microphone",e),a.setSetting("headsetMicrophone",e),{code:l.OK,label:"OK"}):{code:l.ERRORBADREQUEST,label:"Parameter 'strMicrophoneId' is missing or empty"}},this.useSpeaker=function(e){return e?(a.setSetting("speaker",e),a.setSetting("headsetSpeaker",e),a.setSetting("ringingSpeaker",e),i.setSpeakerForElement(document.getElementById("largevideo"),e),{code:l.OK,label:"OK"}):{code:l.ERRORBADREQUEST,label:"Parameter 'strSpeakerId' is missing or empty"}},this.useCamera=function(e){return e?(a.setSetting("camera",e),{code:l.OK,label:"OK"}):{code:l.ERRORBADREQUEST,label:"Parameter 'strCameraId' is missing or empty"}},this.getLocalStreamsFromCall=function(e){if(!(e&&"id"in e))return{code:l.ERRORBADREQUEST,label:"Parameter 'call' is missing or empty"};if(e.type!==c.Type.WEBRTC)return{code:l.ERRORNOTFOUND,label:"This call is not an audio or audio/video call"};var t=o.connection.jingle.sessions[e.id];return t?t.localStreams:[]},this.getRemoteStreamsFromCall=function(e){if(!(e&&"id"in e))return{code:l.ERRORBADREQUEST,label:"Parameter 'call' is missing or empty"};if(e.type!==c.Type.WEBRTC)return{code:l.ERRORNOTFOUND,label:"This call is not an audio or audio/video call"};var t=o.connection.jingle.sessions[e.id];return t?t.remoteStreams:[]},this.canMakeDesktopSharingCall=function(){var t=e.defer();return s.isExtensionInstalled().then(function(e){e?(u.isChromeExtensionInstalled=!0,t.resolve({code:l.OK,label:"OK"})):(u.isChromeExtensionInstalled=!1,t.reject({code:l.ERRORUNSUPPORTED,label:"Not Chrome Extension installed for desktop sharing"}))}).catch(function(e){t.reject(e)}),t.promise};n.$on("$destroy",n.$on("ON_CALL_UPDATED_EVENT",function(e,r){r.type.value===c.Type.WEBRTC.value&&(t.sdk(d+"[onRTCChange] :: WebRTC state changed to "+r),sdk.useAngularEvents?n.$broadcast(u.RAINBOW_ONWEBRTCCALLSTATECHANGED,r):$(document).trigger(u.RAINBOW_ONWEBRTCCALLSTATECHANGED,[r]))})),n.$on("$destroy",n.$on("ON_WEBRTC_CALL_ERROR_EVENT",function(e,r){t.sdk(d+"[onRTCError ] :: WebRTC Error"),sdk.useAngularEvents?n.$broadcast(u.RAINBOW_ONWEBRTCERRORHANDLED,r):$(document).trigger(u.RAINBOW_ONWEBRTCERRORHANDLED,[r])})),n.$on("$destroy",n.$on("ON_WEBRTC_REMOTE_STREAM_ADDED",function(e,r){t.sdk(d+"[onRTCStream] :: WebRTC remote stream added"),sdk.useAngularEvents?n.$broadcast(u.RAINBOW_ONWEBRTCSTREAMADDED,r):$(document).trigger(u.RAINBOW_ONWEBRTCSTREAMADDED,[r])})),n.$on("$destroy",n.$on("ON_WEBRTC_CALL_ESCALATION_SUCCESS",function(e,r){t.sdk(d+"[onRTCEsc   ] :: WebRTC Escalade"),sdk.useAngularEvents?n.$broadcast(u.RAINBOW_ONWEBRTCTRACKCHANGED,r):$(document).trigger(u.RAINBOW_ONWEBRTCTRACKCHANGED,[r])})),n.$on("$destroy",n.$on("ON_WEBRTC_GETUSERMEDIA_ERROR",function(e,r){t.sdk(d+"[onRTCError ] :: WebRTC getUserMedia error"),sdk.useAngularEvents?n.$broadcast(u.RAINBOW_ONWEBRTCTMEDIAERROROCCURED,r):$(document).trigger(u.RAINBOW_ONWEBRTCMEDIAERROROCCURED,[r])}))}]),angular.module("sdk").service("bubblesService",["$q","$rootScope","$log","roomService","Room","conversationService","contactService","PromiseQueue","SDK",function(e,t,n,r,i,a,o,s,c){"use strict";var l=this,u="BubbleSrv  | ";this.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED="rainbowbubblerequesttojoin",this.RAINBOW_ONBUBBLEUPDATED="rainbowbubbleupdated",this.createBubble=function(t,i,o){var s=e.defer(),l=null,d=i||"",f="none";return o&&(f="all"),t?r.createRoom(t,d,f).then(function(e){return l=e,a.getRoomConversation(l.jid)}).then(function(e){n.sdk(u+"[create     ] :: New bubble "+t+" created successfully"),r.sendInitialRoomPresence(e.room),s.resolve(l)}).catch(function(e){n.sdk(u+"[create     ] :: Error when creating a bubble"),s.reject(e)}):s.reject({code:c.ERRORBADREQUEST,label:"Parameter 'strName' is missing or empty"}),s.promise},this.deleteBubble=function(t){var n=e.defer();return t?this.closeBubble(t).then(function(e){return r.ownerDeleteRoom(e)}).then(function(e){n.resolve(e)}).catch(function(e){n.reject(e)}):n.reject({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),n.promise},this.deleteAllBubbles=function(){var e=s.create();return r.getMyRooms().forEach(function(t){e.add(function(){return l.deleteBubble(t)})}),e.execute()},this.inviteContactToBubble=function(t,a,o,s){var l=e.defer();if(t)if(a){var d=i.Privilege.USER;o&&(d=i.Privilege.MODERATOR);var f=!1;"boolean"==typeof s&&(f=!s);var h=!1,p=!1,v=!1,m=!1,g=!1;a.users.forEach(function(e){if(e.contact.id===t.id)switch(e.status){case"invited":v=!0;break;case"accepted":h=!0;break;case"unsubscribed":p=!0;break;case"rejected":m=!0;break;case"deleted":g=!0}}),h||v?l.reject({code:c.ERRORBADREQUEST,label:"Contact has been already invited or is already a member of the room"}):p||m?r.ownerReinviteRejectedUser(a,t,null,d,f).then(function(e){e.updateAvatarInfo(),l.resolve(e)}).catch(function(e){n.sdk(u+"[invite     ] :: Error when inviting a contact"),l.reject(e)}):g?r.ownerReinviteDeletedUser(a,t,null,d).then(function(e){e.updateAvatarInfo(),l.resolve(e)}).catch(function(e){n.sdk(u+"[invite     ] :: Error when inviting a contact"),l.reject(e)}):r.addRoomUser(a,t,null,d,f).then(function(e){e.updateAvatarInfo(),l.resolve(e)}).catch(function(e){n.sdk(u+"[invite     ] :: Error when inviting a contact"),l.reject(e)})}else l.reject({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});else l.reject({code:c.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});return l.promise},this.removeContactFromBubble=function(t,i){var a=e.defer();if(t)if(i){var o="";switch(i.users.forEach(function(e){e.contact.id===t.id&&(o=e.status)}),o){case r.RoomUserStatus.INVITED:r.ownerDeletesUserFromRoom(i,t).then(function(e){e.updateAvatarInfo(),a.resolve(e)}).catch(function(e){n.sdk(u+"[invite     ] :: Error when removing a contact"),a.reject(e)});break;case r.RoomUserStatus.ACCEPTED:r.unsubscribeUserFromRoom(i,t).then(function(e){e.updateAvatarInfo(),a.resolve(e)}).catch(function(e){n.sdk(u+"[invite     ] :: Error when removing a contact"),a.reject(e)});break;default:a.resolve(i)}}else a.reject({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or is null"});else a.reject({code:c.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});return a.promise},this.acceptInvitationToJoinBubble=function(t){var i=e.defer();return t?r.acceptRoomInvitation(t).then(function(){i.resolve(t)}).catch(function(e){n.sdk(u+"[invite     ] :: Error when joining a bubble"),i.reject(e)}):i.reject({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),i.promise},this.declineInvitationToJoinBubble=function(t){var i=e.defer();return t?r.declineRoomInvitation(t).then(function(e){i.resolve(e)}).catch(function(e){n.sdk(u+"[invite     ] :: Error when joining a bubble"),i.reject(e)}):i.reject({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),i.promise},this.leaveBubble=function(t){var i=e.defer();if(t){var a=!1;if(t.users.forEach(function(e){o.isUserContact(e)||"moderator"===e.privilege&&"accepted"===e.status&&(a=!0)}),a)switch(t.status){case r.RoomUserStatus.UNSUBSCRIBED:r.participantCloseRoom(t).then(function(e){i.resolve(e)}).catch(function(e){n.sdk(u+"[invite     ] :: Error when leaving a bubble"),i.reject(e)});break;default:r.unsubscribeMeFromRoom(t).then(function(e){i.resolve(e)}).catch(function(e){n.sdk(u+"[invite     ] :: Error when leaving a bubble"),i.reject(e)})}else i.reject({code:c.ERRORBADREQUEST,label:"Can't leave the bubble. No other moderator"})}else i.reject({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});return i.promise},this.closeBubble=function(t){var i=e.defer();return t?this.isBubbleArchived()?i.resolve(t):r.ownerArchiveRoom(t).then(function(e){i.resolve(e)}).catch(function(e){n.sdk(u+"[invite     ] :: Error when closing a bubble"),i.reject(e)}):i.reject({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"}),i.promise},this.isBubbleArchived=function(e){var t=!0;return e?e.status!==r.RoomUserStatus.UNSUBSCRIBED?t=!1:e.users.forEach(function(e){e.status!==r.RoomUserStatus.UNSUBSCRIBED&&e.status!==r.RoomUserStatus.DELETED&&(t=!1)}):t=!1,t},this.getAllBubbles=function(){return r.getRooms()},this.getAllOwnedBubbles=function(){return r.getMyRooms()},this.getAllPendingBubbles=function(){return r.getRooms().filter(function(e){return"invited"===e.status})},this.getBubbleById=function(e){return e?r.getRoomById(e):{code:c.ERRORBADREQUEST,label:"Parameter 'strBubbleId' is missing or empty"}},this.updateDescriptionForBubble=function(t,n){var i=e.defer();return t?n?(n.desc=t,r.ownerUpdateRoom(n).then(function(e){i.resolve(e)}).catch(function(e){i.reject(e)})):i.reject({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}):i.reject({code:c.ERRORBADREQUEST,label:"Parameter 'strDescription' is missing or empty"}),i.promise},this.updateCustomDataForBubble=function(t,n){var i=e.defer();return t?n?(n.customData=t,r.ownerUpdateRoomCustomData(n).then(function(e){n.customData=e,i.resolve(n)}).catch(function(e){i.reject(e)})):i.reject({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}):i.reject({code:c.ERRORBADREQUEST,label:"Parameter 'customData' is missing or empty"}),i.promise},this.deleteCustomDataForBubble=function(t){var n=e.defer();return t?(t.customData={},r.ownerUpdateRoomCustomData(t).then(function(e){t.customData=e,n.resolve(t)}).catch(function(e){n.reject(e)})):n.reject({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}),n.promise},t.$on("$destroy",t.$on(r.ROOM_UPDATE_EVENT,function(e,n){sdk.useAngularEvents?t.$broadcast(l.RAINBOW_ONBUBBLEUPDATED,n):$(document).trigger(l.RAINBOW_ONBUBBLEUPDATED,[n])})),t.$on("$destroy",t.$on(r.ROOM_INVITATION,function(e,n){sdk.useAngularEvents?t.$broadcast(l.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED,n):$(document).trigger(l.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED,[n])}))}]),angular.module("sdk").service("groupsService",["$q","$rootScope","$log","groupService","Group","contactService","PromiseQueue","SDK",function(e,t,n,r,i,a,o,s){"use strict";var c=this,l="GroupSrv  | ";this.RAINBOW_ONGROUPCREATED="rainbowgroupcreated",this.RAINBOW_ONGROUPUPDATED="rainbowgroupupdated",this.RAINBOW_ONGROUPDELETED="rainbowgroupdeleted",this.RAINBOW_ONGROUPUSERADDED="rainbowgroupuseradded",this.RAINBOW_ONGROUPUSERREMOVED="rainbowgroupuserdeleted",this.createGroup=function(t,a,o){var c=e.defer(),u=null,d=!1;return"boolean"==typeof o&&(d=o),t?(u=new i(null,t,a||"",d),r.addGroup(u).then(function(e){n.sdk(l+"[create     ] :: New group "+t+" created successfully"),c.resolve(e)}).catch(function(e){n.sdk(l+"[create     ] :: Error when creating a group"),c.reject(e)})):c.reject({code:s.ERRORBADREQUEST,label:"Parameter 'strName' is missing or empty"}),c.promise},this.deleteGroup=function(t){var i=e.defer(),a=t.name;return r.removeGroup(t.id).then(function(){n.sdk(l+"[delete     ] :: Group "+a+" deleted successfully"),i.resolve()}).catch(function(e){n.sdk(l+"[delete     ] :: Error when deleting a group"),i.reject(e)}),i.promise},this.deleteAllGroups=function(){var e=o.create();return r.getGroupsAsArray().forEach(function(t){e.add(function(){return c.deleteBubble(t)})}),e.execute()},this.getGroups=function(){return r.getGroupsAsArray()},this.getGroupById=function(e){var t=null;return r.getGroupsAsArray().some(function(n){return e===n.id&&(t=n,!0)}),t},this.addContactInGroup=function(t,i){var a=e.defer();return t?i?r.addGroupUser(i,t).then(function(e){var t=e?e.name?e.name:"[error NULL group name]":"[error NULL group]";n.sdk(l+"[addContactInGroup] :: Group "+t+" successfully"),a.resolve(e.id)}).catch(function(e){n.sdk(l+"[addContactInGroup] :: Error when adding a contact in a group"),a.reject(e)}):a.reject({code:s.ERRORBADREQUEST,label:"Parameter 'group' is missing or null"}):a.reject({code:s.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}),a.promise},this.removeContactFromGroup=function(t,n){var i=e.defer();if(t){if(n)return r.removeGroupUser(n.id,t);i.reject({code:s.ERRORBADREQUEST,label:"Parameter 'group' is missing or null"})}else i.reject({code:s.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});return i.promise},t.$on("$destroy",t.$on(r.ON_UPDATE_GROUP_EVENT,function(e,n,r,i,a){sdk.useAngularEvents?t.$broadcast(c.RAINBOW_ONGROUPUPDATED,n,r,i,a):$(document).trigger(c.RAINBOW_ONGROUPUPDATED,[n,r,i,a])})),t.$on("$destroy",t.$on(r.ON_CREATED_GROUP_EVENT,function(e,n){sdk.useAngularEvents?t.$broadcast(c.RAINBOW_ONGROUPCREATED,n):$(document).trigger(c.RAINBOW_ONGROUPCREATED,[n])})),t.$on("$destroy",t.$on(r.ON_REMOVED_GROUP_EVENT,function(e,n){sdk.useAngularEvents?t.$broadcast(c.RAINBOW_ONGROUPDELETED,n):$(document).trigger(c.RAINBOW_ONGROUPDELETED,[n])})),t.$on("$destroy",t.$on(r.ON_ADD_GROUP_USER_EVENT,function(e,n,r){sdk.useAngularEvents?t.$broadcast(c.RAINBOW_ONGROUPUSERADDED,n,r):$(document).trigger(c.RAINBOW_ONGROUPUSERADDED,[n,r])})),t.$on("$destroy",t.$on(r.ON_REMOVE_GROUP_USER_EVENT,function(e,n,r){sdk.useAngularEvents?t.$broadcast(c.RAINBOW_ONGROUPUSERREMOVED,n,r):$(document).trigger(c.RAINBOW_ONGROUPUSERREMOVED,[n,r])}))}]),angular.module("sdk").service("callsLogService",["$q","$rootScope","$log","callLogService",function(e,t,n,r){"use strict";var i=this,a=!1;this.RAINBOW_ONCALLLOGUPDATED="rainbowcalllogupdated",this.RAINBOW_ONCALLLOGACKUPDATED="rainbowcalllogackupdated",this.getAll=function(){r.orderCallLogsFunction();for(var e=r.getSimplifiedCallLogs(),t=0;t<e.length;t++){var n=0,i=e[t].duration;if(i&&"string"==typeof i&&i.match(/^(?:(?:([01]?\d|2[0-3])h )?([0-5]?\d)m )?([0-5]?\ds)$/)){for(var a=(i=i.replace(/[hms]/g,"")).split(" ").reverse(),o=0;o<a.length;o++)n+=a[o]*Math.pow(60,o);e[t].duration=1e3*n}}return e},this.getMissedCallLogCounter=function(){return r.getMissedCallLogCounter()},this.deleteOneCallLog=function(e){return r.deleteOneCallLog(e)},this.deleteCallLogsForContact=function(e){return r.deleteCallLogsForContact(e)},this.deleteAllCallLogs=function(){return r.deleteAllCallLogs()},this.markCallLogAsRead=function(e){return r.markCallLogAsRead(e)},this.markAllCallsLogsAsRead=function(){return r.markAllCallsLogsAsRead()},this.isInitialized=function(){return a},t.$on("$destroy",t.$on("ON_CALL_LOG_UPDATED",function(e,n){a=!0,sdk.useAngularEvents?t.$broadcast(i.RAINBOW_ONCALLLOGUPDATED,n):$(document).trigger(i.RAINBOW_ONCALLLOGUPDATED,[n])})),t.$on("$destroy",t.$on("ON_CALL_LOG_ACK_UPDATED",function(e,n){a=!0,sdk.useAngularEvents?t.$broadcast(i.RAINBOW_ONCALLLOGACKUPDATED,n):$(document).trigger(i.RAINBOW_ONCALLLOGACKUPDATED,[n])}))}]),angular.module("sdk").service("cpaasService",["$q","$log","$rootScope","$http","SDK",function(e,t,n,r,i){"use strict";var a=this,o="CPaaSSrv   | ",s="",c="",l="",u="openrainbow.com";this.isAuthenticated=!1,this.hasSession=!1,this.RAINBOW_ONCPAAS_SESSION_CREATED="rainbowoncpaassessioncreated",this.authenticate=function(n,i,l){var d=e.defer();if(t.sdk(o+"[authent    ] :: Try to authenticate application "+n),n.length>0){var f=btoa(n+":"+i);l&&(u=l),r({method:"GET",url:"https://"+u+":443/api/rainbow/applications/v1.0/authentication/login",headers:{Accept:"application/json",Authorization:"Basic "+f}}).success(function(e){t.sdk(o+"[authent    ] :: Authentication is successfull for application "+e.loggedInApplication.id),s=e.token,c=e.loggedInApplication.id,a.isAuthenticated=!0,d.resolve(e.data)}).error(function(e){t.sdk(o+"[authent    ] :: Authentication fails: "+e.errorDetails),d.resolve()})}else d.resolve();return d.promise},this.createSession=function(n,i){var s=e.defer();return t.sdk(o+"[session    ] :: Try to create a new session for userID"+n+" on app "+c),this.isAuthenticated?r({method:"POST",url:"https://"+u+":443/api/v1.0/sdk/applications/"+c+"/sessions",headers:d(),data:{event:"session_start",data:{localUserURI:n,localUserSessionURI:i}}}).success(function(e){t.sdk(o+"[session    ] :: Session successfully created "+e.data.session.id),l=e.data.session.id,a.hasSession=!0,s.resolve(e.data)}).error(function(e){s.reject(e)}):t.sdk(o+"[session    ] :: Warning, the application is not authenticated. No way to track sessions..."),s.promise},this.appToken=function(){return s},this.updateSession=function(n){var i=e.defer();return t.sdk(o+"[session    ] :: Try to update information on the session "+l),this.isAuthenticated&&this.hasSession?r({method:"PUT",url:"https://"+u+":443/api/v1.0/sdk/applications/"+c+"/sessions/"+l+"/info",headers:d(),data:{event:"session_info",data:n}}).success(function(e){t.sdk(o+"[session    ] :: Information successfully updated for session "+l),i.resolve(e.data)}).error(function(e){i.reject(e)}):t.sdk(o+"[session    ] :: Warning, the application is not authenticated. No way to track sessions..."),i.promise};var d=function(){return{"x-access-sdk-token":s,Accept:"application/json"}};n.$on("$destroy",function(){null})}]),angular.module("sdk").service("filesStorageService",["$q","$rootScope","$log","Conversation","fileStorageService","fileServerService","conversationService","contactService","SDK",function(e,t,n,r,i,a,o,s,c){"use strict";var l=this,u="StorageSrv   | ";this.RAINBOW_ONFILEUPLOADED="rainbowfileuploaded",this.RAINBOW_ONFILEUPLOADED_ERROR="rainbowfileuploadederror",this.RAINBOW_ONFILEDOWNLOADED="rainbowfiledownloaded",this.RAINBOW_ONFILEDOWNLOADED_ERROR="rainbowfiledownloadederror";var d={success:{download:this.RAINBOW_ONFILEDOWNLOADED,upload:this.RAINBOW_ONFILEUPLOADED},error:{download:this.RAINBOW_ONFILEDOWNLOADED_ERROR,upload:this.RAINBOW_ONFILEUPLOADED_ERROR}};this._addFileToConversation=function(t,n,r){return e(function(i,a){return e(function(e){if("string"==typeof n){var t=new XMLHttpRequest;t.open("GET",n,!0),t.onreadystatechange=function(){if(t.readyState===XMLHttpRequest.DONE){var r=t.response,i=new File([r],n.replace(/^.*[\\\/]/,""),{type:"",lastModified:Date.now()});e(i)}},t.responseType="blob",t.send()}else e(n)}).then(function(e){e.size>1e8?a({code:c.ERRORBADREQUEST,label:"The file is to large (limited to 100MB)"}):o.sendFSMessage(t,e,r).then(function(e){i(e)})})})},this.uploadFileToConversation=function(e,t,i){return new Promise(function(a,o){e?t?e.type!==r.Type.ONE_TO_ONE?o({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):(n.sdk(u+"[addFileCnv ] ::  Try to add a file "+t+" to the conversation "+e.id),l._addFileToConversation(e,t,i).then(function(e){n.sdk(u+"[addFileCnv ] ::  file added"),a(e)}).catch(function(e){o(e)})):o({code:c.ERRORBADREQUEST,label:"Parameter 'file' is missing or null"}):o({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})})},this.uploadFileToBubble=function(e,t,i){return new Promise(function(a,s){if(e)if(t){var d=o.getConversationByRoomDbId(e.dbId);d?d.type!==r.Type.ROOM?s({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is not a bubble conversation"}):(n.sdk(u+"[addFileBub ] ::  Try to add a file "+t+" to the bubble "+e.dbId),l._addFileToConversation(d,t,i).then(function(e){n.sdk(u+"[addFileBub ] ::  file added"),a(e)}).catch(function(e){s(e)})):s({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' don't have a conversation"})}else s({code:c.ERRORBADREQUEST,label:"Parameter 'file' is missing or null"});else s({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"})})},this.downloadFile=function(e){return new Promise(function(t,r){if(e){n.sdk(u+"[getFile    ] ::  Try to get a file "+e.filename);var i={url:e.url||config.restServerUrl+"/api/rainbow/fileserver/v1.0/files/"+e.id,mime:e.mime||e.typeMime,filesize:e.filesize||e.size,filename:e.filename||e.fileName};a.getBlobFromUrlWithOptimization(i.url,i.mime,i.filesize,i.filename).then(function(e){n.sdk(u+"[getFile    ] ::  file downloaded"),t(e)}).catch(function(e){r(e)})}else r({code:c.ERRORBADREQUEST,label:"Parameter 'fileDescriptor' is missing or null"})})},this.removeFile=function(e){return new Promise(function(t,r){if(e||r({code:c.ERRORBADREQUEST,label:"Parameter 'fileDescriptor' is missing or null"}),e.id||e.url){n.sdk(u+"[removeFile ] ::  Try to remove a file "+e.filename);var a=e.id;if(!a){var o=e.url.split("/");a=o.pop()||o.pop()}i.deleteFileDescriptor(a).then(function(){n.sdk(u+"[getFile    ] ::  file removed"),t({code:c.OK,label:"OK"})}).catch(function(e){r(e)})}else r({code:c.ERRORBADREQUEST,label:"Parameter 'fileDescriptor' don't contain information to remove the file"})})},this.getFileDescriptorFromId=function(e){return n.sdk(u+"[getFileDescriptorFromId] ::  get file descriptor "+e),i.getFileDescriptorById(e)},this.getFilesReceivedInConversation=function(e){return new Promise(function(t,a){e?e.type!==r.Type.ONE_TO_ONE?a({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):(n.sdk(u+"[getFilesRcv] ::  get files received in conversation "+e.id+"..."),i.retrieveFilesReceivedFromPeer(s.userContact.dbId,e.contact.dbId).then(function(e){n.sdk(u+"[getFilesRcv] ::  shared "+e.length),t(e)}).catch(function(e){a(e)})):a({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})})},this.getFilesReceivedInBubble=function(e){return new Promise(function(t,r){e?(n.sdk(u+"[getFilesRcv] ::  get files received in bubble "+e.dbId+"..."),i.retrieveReceivedFilesForRoom(e.dbId).then(function(e){n.sdk(u+"[getFilesRcv] ::  shared "+e.length),t(e)}).catch(function(e){r(e)})):r({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"})})},this.getFilesSentInConversation=function(e){return new Promise(function(t,a){e?e.type!==r.Type.ONE_TO_ONE?a({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):(n.sdk(u+"[getFilesSnd] ::  get files sent in conversation "+e.id+"..."),i.retrieveSentFiles(e.contact.dbId).then(function(e){n.sdk(u+"[getFilesSnd] ::  shared "+e.length),t(e)}).catch(function(e){a(e)})):a({code:c.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})})},this.getFilesSentInBubble=function(e){return new Promise(function(t,r){e?(n.sdk(u+"[getFilesRcv] ::  get files received in bubble "+e.dbId+"..."),i.retrieveSentFiles(e.dbId).then(function(e){n.sdk(u+"[getFilesSnd] ::  shared "+e.length),t(e)}).catch(function(e){r(e)})):r({code:c.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"})})},this.getUserQuotaConsumption=function(){return new Promise(function(e,t){i.retrieveUserConsumption().then(function(t){e(t)})})},this.getAllFilesSent=function(){return i.getDocuments()},this.getAllFilesReceived=function(){return i.getReceivedDocuments()};t.$on("$destroy",t.$on("ON_FILE_TRANSFER_EVENT",function(e,r){r.result&&r.type&&(n.sdk(u+"[OnFileTrans] ::  file transfered..."),sdk.useAngularEvents?t.$broadcast(d[r.result][r.type],r):$(document).trigger(d[r.result][r.type],[r]))}))}]),angular.module("sdk").service("capabilitiesService",["profileService",function(e){"use strict";this.getAll=function(){return e.getMyProfileFeatures()},this.hasS4BExtensionEnabled=function(){return e.isFeatureEnabled("MS_SKYPE_PLUGIN")},this.hasOutlookExtensionEnabled=function(){return e.isFeatureEnabled("MS_OUTLOOK_PLUGIN")},this.hasCalendarPresenceEnabled=function(){return e.isFeatureEnabled("MSO365_CALENDAR_PRESENCE")},this.hasTelephonyBasicCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_BASIC_CALL")},this.hasTelephonySecondCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_SECOND_CALL")},this.hasTelephonyTransferCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_TRANSFER_CALL")},this.hasTelephonyConferenceCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_CONFERENCE_CALL")},this.hasTelephonyDeflectCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_DEFLECT_CALL")},this.hasTelephonyForwardCallEnabled=function(){return e.isFeatureEnabled("TELEPHONY_FORWARD_CALL")},this.hasTelephonyPhoneBookEnabled=function(){return e.isFeatureEnabled("TELEPHONY_PHONE_BOOK")},this.hasTelephonyVoiceMailEnabled=function(){return e.isFeatureEnabled("TELEPHONY_VOICE_MAIL")},this.hasWebRTCAudioMobileEnabled=function(){return e.isFeatureEnabled("WEBRTC_FOR_MOBILE")},this.hasWebRTCVideoMobileEnabled=function(){return e.isFeatureEnabled("WEBRTC_FOR_MOBILE_VIDEO")},this.hasBridgeConferenceEnabled=function(){return e.isFeatureEnabled("CONFERENCE_ALLOWED")},this.hasBridgeConferenceRecordEnabled=function(){return e.isFeatureEnabled("CONFERENCE_RECORDING")},this.hasBridgeConferenceDialOutEnabled=function(){return e.isFeatureEnabled("CONFERENCE_DIAL_OUT")},this.maxParticipantsPerBubbleAllowed=function(){return e.getFeatureLimitMax("BUBBLE_PARTICIPANT_COUNT")},this.maxParticipantsPerBridgeConferenceAllowed=function(){return e.getFeatureLimitMax("CONFERENCE_PARTICIPANT_COUNT")},this.maxFileStorageQuotaAllowed=function(){return e.getFeatureLimitMax("FILE_SHARING_QUOTA_GB")}}]),angular.module("sdk").service("adminService",["$q","$rootScope","$log","Company","User","adminCompanyService","adminUserService","SDK",function(e,t,n,r,i,a,o,s){"use strict";this.createEssentialCompany=function(t,n){var i=e.defer(),o=r.create(null,"");return o.name=t,o.country=n,a.createCompanyEndUser(o).then(function(e){i.resolve(e)}).catch(function(e){i.reject(e)}),i.promise},this.createCompany=function(t,n){var i=e.defer(),o=r.create(null,"");return o.name=t,o.country=n,o.economicActivityClassification="",a.createCompany(o).then(function(e){i.resolve(e)}).catch(function(e){i.reject(e)}),i.promise},this.removeCompany=function(t){var n=e.defer();return a.deleteCompany(t.id).then(function(){n.resolve(t)}).catch(function(e){n.reject(e)}),n.promise},this.createUserForCompany=function(t,n,r,a,s){var c=e.defer(),l=i.create();return l.loginEmail=t,l.firstName=n,l.lastName=r,l.password=a,l.language="en",l.companyId=s.id,l.adminType="undefined",l.isActive=!0,l.isInitialized=!0,o.createUser(l).then(function(e){c.resolve(e)}).catch(function(e){c.reject(e)}),c.promise},this.removeUserFromCompany=function(t){var n=e.defer();return o.deleteUser(t).then(function(){n.resolve(t)}).catch(function(e){n.reject(e)}),n.promise},this.setVisibilityForCompany=function(t,n){var r=e.defer();return a.addVisibility(t.id,n.id).then(function(){r.resolve(t)}).catch(function(e){r.reject(e)}),r.promise}}]),angular.module("sdk").service("channelsService",["$log","$q","$rootScope","channelService","SDK",function(e,t,n,r,i){"use strict";this.RAINBOW_ONCHANNELMESSAGE="rainbowchannelmessage",this.getMyChannels=function(){return r.getMyChannels()},this.createChannel=function(e,t,n,i,a){return r.createChannel(e,t,n,i,a)},this.deleteChannel=function(e){return r.deleteChannel(e)},this.findChannels=function(e){return r.findChannels(e)},this.getChannel=function(e){return r.getChannel(e)},this.publishToChannel=function(e,t,n,i){return r.publishToChannel(e,t,n,i)},this.subscribeToChannel=function(e){return r.subscribeToChannel(e)},this.unsubscribeToChannel=function(e){return r.unsubscribeToChannel(e)},this.updateChannel=function(e,t,n,i,a){return r.updateChannel(e,t,n,i,a)},this.getChannelUsers=function(e,t){return r.getChannelUsers(e,t)},this.removeAllUsersFromChannel=function(e){return r.removeAllUsersFromChannel(e,options)},this.updateChannelUsers=function(e,t){return r.updateChannelUsers(e,t)}}]),angular.module("sdk").service("rainbowSDK",["$log","$q","$rootScope","connectionService","presenceService","contactsService","conversationsService","imService","pbxService","webRTCService","bubblesService","groupsService","callsLogService","userProfileService","settingsService","cpaasService","filesStorageService","capabilitiesService","channelsService","adminService","SDK",function(e,t,n,r,i,a,o,s,c,l,u,d,f,h,p,v,m,g,E,S,C){"use strict";var b=this,R=null;this.isReady=!1,this.RAINBOW_ONREADY="ready",this.RAINBOW_ONLOADED="loaded",this.connection=r,this.presence=i,this.contacts=a,this.conversations=o,this.im=s,this.telephony=c,this.webRTC=l,this.bubbles=u,this.groups=d,this.callsLog=f,this.userProfile=h,this.fileStorage=m,this.caps=g,this.channels=E,this.admin=S,this.version=function(){return window.version},this.mode=function(){return p.getSetting("apiMode")},this.setVerboseLog=function(e){return sdk.hasVerboseLog=e,sdk.hasVerboseLog},this.useAngularEvents=function(e){return sdk.useAngularEvents=e,sdk.useAngularEvents},this.setKeyFromConfig=function(t,n){return e.sdk("SDKSrv     | [initialize ] :: Linked to application ID "+t+" from configuration file"),sdk.key.appID=t,sdk.key.appSecret=n,!0},this.hasBeenLaunchedFromConfig=function(t){var n=t?"YES":"NO";return e.sdk("SDKSrv     | [initialize ] :: SDK lauched from a configuration file "+n),sdk.hasBeenLaunchedFromConfig=t,sdk.hasBeenLaunchedFromConfig},this.initialize=function(n,r){var i=t.defer();return n&&n.length>0?(sdk.key.appID=n,e.sdk("SDKSrv     | [initialize ] :: Initialize the SDK for the application"+sdk.key.appID+"...")):e.sdk("SDKSrv     | [initialize ] :: Initialize the SDK without an application key..."),r&&r.length>0&&(sdk.key.appSecret=r),y().then(function(){e.sdk("SDKSrv     | [initialize ] :: Initialize step 1/2 ok"),N().then(function(){e.sdk("SDKSrv     | [initialize ] :: Initialize step 2/2 ok"),e.sdk("SDKSrv     | [initialize ] :: SDK Initialized successfully!"),i.resolve()})}),i.promise};var y=function(){var e=t.defer();if(b.isReady)e.resolve();else var r=n.$on("RAINBOW_INTERNAL_READY",function(){r(),e.resolve()});return e.promise},N=function(){var e=t.defer();return DetectRTC.load(function(){T(),e.resolve()}),e.promise};this.load=function(){e.sdk("SDKSrv     | [initialize ] :: Rainbow SDK loaded!"),sdk.useAngularEvents?n.$broadcast(b.RAINBOW_ONLOADED):$(document).trigger(b.RAINBOW_ONLOADED,null)},this.ready=function(){e.sdk("SDKSrv     | [initialize ] :: Rainbow SDK ready!"),sdk.useAngularEvents?n.$broadcast(b.RAINBOW_ONREADY):$(document).trigger(b.RAINBOW_ONREADY,null)};var T=function(){e.sdk("SDKSrv     | [initialize ] :: Initializing the Rainbow SDK..."),e.sdk("SDKSrv     | [initialize ] :: -----------------------------"),e.sdk("SDKSrv     | [initialize ] :: Platform    | "+DetectRTC.osName+" "+DetectRTC.osVersion),e.sdk("SDKSrv     | [initialize ] :: Screen      | "+window.screen.width+"x"+window.screen.height),e.sdk("SDKSrv     | [initialize ] :: Cookie      | "+navigator.cookieEnabled),e.sdk("SDKSrv     | [initialize ] :: Java        | "+navigator.javaEnabled()),e.sdk("SDKSrv     | [initialize ] :: Server      | "+config.webservices.server),e.sdk("SDKSrv     | [initialize ] :: Version WEB | "+window.version),e.sdk("SDKSrv     | [initialize ] :: Version SDK | "+window.sdkversion),e.sdk("SDKSrv     | [initialize ] :: Browser     | "+DetectRTC.browser.name+" "+DetectRTC.browser.fullVersion),e.sdk("SDKSrv     | [initialize ] :: Microphone  | "+DetectRTC.hasMicrophone),e.sdk("SDKSrv     | [initialize ] :: Camera      | "+DetectRTC.hasWebcam),e.sdk("SDKSrv     | [initialize ] :: Speakers    | "+DetectRTC.hasSpeakers),e.sdk("SDKSrv     | [initialize ] :: WebRTC      | "+DetectRTC.isWebRTCSupported),e.sdk("SDKSrv     | [initialize ] :: Mode        | "+b.mode()),e.sdk("SDKSrv     | [initialize ] :: verboseLog  | "+sdk.hasVerboseLog),e.sdk("SDKSrv     | [initialize ] :: ng-events   | "+sdk.useAngularEvents),e.sdk("SDKSrv     | [initialize ] :: launcher    | "+sdk.hasBeenLaunchedFromConfig),e.sdk("SDKSrv     | [initialize ] :: appID       | "+sdk.key.appID),e.sdk("SDKSrv     | [initialize ] :: -----------------------------"),e.sdk("SDKSrv     | [initialize ] :: Initialized!"),b.ready()},A=function(){R();var e={browser:{name:DetectRTC.browser.name,fullVersion:DetectRTC.browser.fullVersion,version:DetectRTC.browser.version},screen:{displayResolution:DetectRTC.displayResolution},os:{name:DetectRTC.osName,version:DetectRTC.osVersion,isMobileDevice:!1},ua:navigator.userAgent};v.updateSession(e).then(function(){}).catch(function(){})};e.sdk("SDKSrv     | [           ] :: Welcome to the Rainbow SDK for Web!"),window.rainbowSDK=b,p.setSetting("apiMode","sdk"),config.webservices.currentServer=config.webservices.server,R=n.$on(v.RAINBOW_ONCPAAS_SESSION_CREATED,A),b.isReady=!0,n.$broadcast("RAINBOW_INTERNAL_READY"),n.$on("$destroy",function(){R&&R()})}]);